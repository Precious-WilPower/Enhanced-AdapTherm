<!DOCTYPE html>
<html>
<head>
  <title>Adaptherm - Sensory Wheel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* Individual Tab Specific Styling */

/* Breakthrough Lines Styling */
.breakthrough-line {
  cursor: pointer;
  transition: opacity 0.3s, stroke-width 0.3s;
}

.breakthrough-line:hover {
  opacity: 1 !important;
  stroke-width: 4px;
}

/* Checkbox Recommendation Styling */
.checkbox-recommendation {
  display: flex;
  align-items: flex-start;
  margin-bottom: 8px;
}

.recommendation-checkbox {
  margin-top: 3px;
  margin-right: 8px;
}

/* Routes Button Styling */
.routes-btn {
  display: block;
  margin: 15px auto;
  padding: 8px 15px;
  background-color: #4a6fa5;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.routes-btn:hover {
  background-color: #395b89;
  transform: translateY(-2px);
}

/* Routes Panel Styling */
.routes-map-container {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}

/* Charts Section Styling */
.individual-case-analytics {
  margin: 30px 0;
  padding: 20px;
  background-color: #f0f7ff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.analytics-item {
  margin-bottom: 25px;
}

.analytics-chart-container {
  height: 300px;
  margin: 15px 0;
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Full Impact Panel Styling */
.impact-chart-container {
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  margin: 15px 0;
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
  margin: 15px 0;
}

.metric-item {
  background: #f0f7ff;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-value {
  font-size: 24px;
  font-weight: bold;
  color: #1565c0;
  margin-bottom: 5px;
}

.metric-label {
  font-size: 14px;
  color: #555;
}

/* Research References Button Styling */
.research-references-btn {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  margin-top: 20px;
  display: inline-block;
  transition: background-color 0.2s;
}

.research-references-btn:hover {
  background-color: #e9ecef;
}

.research-panel {
  display: none;
  margin-top: 10px;
  padding: 15px;
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
}

.research-panel h4 {
  margin-top: 0;
  color: #495057;
}

.research-panel p {
  font-size: 14px;
  line-height: 1.5;
  color: #495057;
}
  </style>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow-x: hidden;
    }
    
    h1, h2, h3 {
      color: #1565c0;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    
    /* Tab styling */
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 20px;
    }
    
    .tab-button {
      background: none;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .tab-button.active {
      border-bottom: 3px solid #1565c0;
      font-weight: bold;
      color: #1565c0;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Emergency panel with deep blue background */
    .emergency-panel {
      background-color: #1a3a5f; /* Deep blue color */
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .emergency-panel h3 {
      color: white;
      margin-top: 0;
    }
    
    .emergency-panel p {
      font-size: 15px;
      line-height: 1.4;
      margin-bottom: 8px;
      color: white;
    }
    
    /* Streamlined emergency panel layout */
    .symptom-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
      max-width: 100%;
      justify-content: center;
    }
    
    .symptom-button {
      background-color: #ffffff;
      border: 1px solid #03a9f4;
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      white-space: nowrap;
    }
    
    .symptom-button:hover {
      background-color: #e1f5fe;
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .symptom-button.active {
      background-color: #03a9f4;
      color: white;
      border-color: #0277bd;
    }
    
    /* Contained text entry */
    .custom-description {
      width: 90%;
      max-width: 600px;
      padding: 8px 12px;
      border: 2px solid #81d4fa;
      border-radius: 4px;
      margin: 5px auto 10px;
      font-family: inherit;
      resize: none;
      height: 36px;
      font-size: 14px;
      display: block;
    }
    
    .typing-indicator {
      font-size: 12px;
      color: #e1f5fe;
      margin-top: -5px;
      margin-bottom: 10px;
      visibility: hidden;
      text-align: left;
    }
    
    .typing-indicator.visible {
      visibility: visible;
    }
    
    .recommendations {
      background-color: #f8f9fa;
      border-radius: 4px;
      padding: 15px;
      border: 1px solid #e2e6ea;
      margin-bottom: 20px;
    }
    
    .emergency-panel .recommendations {
      background-color: #25517f;
      border-color: #1a3a5f;
    }
    
    .recommendations h4 {
      margin-top: 0;
      color: #343a40;
      font-size: 15px;
    }
    
    .emergency-panel .recommendations h4 {
      color: white;
    }
    
    .recommendations ul {
      padding-left: 20px;
    }
    
    .recommendations li {
      margin-bottom: 5px;
      line-height: 1.4;
    }
    
    .emergency-panel .recommendations li {
      color: white;
    }
    
    /* Sensory wheel container */
    .sensory-content {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    
    .wheel-container {
      width: 500px;
      height: 500px;
      position: relative;
    }
    
    .sensory-wheel-svg {
      width: 100%;
      height: auto;
    }
    
    /* Clickable elements styling */
    .section-path {
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .section-path:hover {
      filter: brightness(1.1);
      transform: scale(1.01);
      transform-origin: center;
    }
    
    .wheel-hub {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .wheel-hub:hover {
      filter: brightness(1.1);
      transform: scale(1.05);
      transform-origin: center;
    }
    
    /* Enhanced spoke styling - major change to improve clickability */
    .spoke-clickable-area {
      stroke-width: 20px;
      stroke-opacity: 0.1;
      cursor: pointer;
      transition: stroke-opacity 0.2s;
    }
    
    .spoke-clickable-area:hover {
      stroke-opacity: 0.3;
    }
    
    .spoke {
      stroke-width: 2px;
      transition: stroke-width 0.2s;
    }
    
    .spoke-group:hover .spoke {
      stroke-width: 3px;
    }
    .spoke, .spoke-group {
  filter: none !important;
}
    /* Information panels - side-positioned and expandable */
    .info-panel {
      display: none;
      position: fixed;
      top: 10%;
      right: 10px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 100;
      width: 35%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .panel-expanded {
      width: 60%;
      max-width: 800px;
      height: 85vh;
      max-height: 85vh;
    }
    
    .info-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .info-panel-controls {
      display: flex;
      gap: 10px;
    }
    
    .info-panel-title {
      margin: 0;
      color: #1565c0;
    }
    
    .close-panel, .expand-panel {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #495057;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }
    
    .close-panel:hover, .expand-panel:hover {
      background-color: #f1f3f5;
    }
    
    .panel-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 90;
    }
    
    /* Chart container - expandable */
    .chart-container {
      height: 300px;
      margin: 20px 0;
      transition: height 0.3s;
    }
    
    .chart-container.expanded {
      height: 500px;
    }
    
    /* Trend info */
    .trend-info {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .trend-card {
      flex: 1;
      min-width: 110px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .trend-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .trend-label {
      color: #6c757d;
      font-size: 13px;
    }
    
    .trend-direction {
      display: flex;
      align-items: center;
      margin-top: 5px;
      font-weight: bold;
      font-size: 12px;
    }
    
    .trend-up {
      color: #28a745;
    }
    
    .trend-down {
      color: #dc3545;
    }
    
    /* Recommendations styling */
    .recommendations-list {
      margin-top: 15px;
    }
    
    .recommendation-item {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    
    .recommendation-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .recommendation-desc {
      color: #6c757d;
      margin-bottom: 10px;
    }
    
    .contact-options {
      margin-top: 20px;
    }
    
    .contact-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .contact-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .contact-button {
      background: #4a6fa5;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .contact-button:hover {
      background: #395b89;
      transform: translateY(-2px);
    }
    
    .professional-button {
      background: #28a745;
    }
    
    .professional-button:hover {
      background: #218838;
    }
    
    /* Interactive sliders */
    .stability-slider-section h3 {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0px;
}

.stability-slider-section h3 .section-score {
  color: #1565c0;
  font-weight: bold;
}

.slider-row {
  width: 100%;
}

.slider-input {
  width: 100%;
  margin: 0px 0;
}

.variability-spectrum-info {
  display: flex;
  justify-content: space-between;
  margin-top: 0px;
  font-size: 12px;
  color: #666;
}

.variability-spectrum-info span {
  font-size: 12px;
  color: #666;
}

.variability-spectrum-info span:first-child {
  text-align: left;
}

.variability-spectrum-info span:last-child {
  text-align: right;
}

    .event-input-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .event-input-row label {
      font-size: 15px;
      font-weight: bold;
    }
    
    .event-input {
      width: 70px;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      text-align: center;
      font-size: 15px;
    }
    
    .calculate-btn, .apply-changes {
      background: #4a6fa5;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
      margin-top: 10px;
    }
    
    .apply-changes {
      display: block;
      width: 100%;
    }
    
    .calculate-btn:hover, .apply-changes:hover {
      background: #395b89;
      transform: translateY(-2px);
    }
    
    /* Individual Tab Styles */
    .score-display {
      background-color: #e3f2fd;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .score-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      margin: 10px auto;
    }
    
    .score-label {
      font-weight: bold;
      margin-top: 10px;
    }
    
    /* Compact core metrics styling */
    .core-metrics-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
      justify-content: space-between;
    }
    
    .metric-box {
      flex: 1;
      min-width: 120px;
      max-width: 180px;
      background-color: #f8f9fa;
      border: 1px solid #e2e6ea;
      border-radius: 8px;
      padding: 8px;
    }
    
    .metric-box label {
      font-weight: bold;
      display: block;
      margin-bottom: 3px;
      font-size: 13px;
    }
    
    .metric-box input[type="range"] {
      width: 100%;
      margin: 3px 0;
    }
    
    .custom-metrics {
      margin-bottom: 15px;
    }
    
    .custom-metric {
      position: relative;
      margin-bottom: 10px;
    }
    
    .delete-metric {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #f44336;
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
    }
    
    .delete-metric:hover {
      background-color: #d32f2f;
    }
    
    .add-metric-form {
      background-color: #f0f7ff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .metric-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .metric-input-group input {
      flex: 3;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    .metric-input-group select {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    .add-metric-btn {
      background-color: #43a047;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .add-metric-btn:hover {
      background-color: #2e7d32;
    }
    
    .action-button {
      background-color: #1565c0;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 15px 0;
    }
    
    .action-button:hover {
      background-color: #0d47a1;
    }
    
    .range-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    /* Position gauge styling */
    .position-gauge {
      width: 100%;
      height: 40px;
      background: linear-gradient(to right, 
        #3f51b5 0%, /* Deep blue (hypo) */
        #2196f3 20%, /* Light blue */
        #4caf50 50%, /* Green (balanced) */
        #ffc107 80%, /* Yellow */
        #f44336 100% /* Red (hyper) */
      );
      border-radius: 15px;
      position: relative;
      margin: 15px 0;
    }
    
    .position-marker {
      position: absolute;
      top: -5px;
      width: 10px;
      height: 50px;
      background-color: #ffffff;
      border: 2px solid #333;
      border-radius: 3px;
      transform: translateX(-50%);
    }
    
    .position-labels {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #495057;
      margin-top: 8px;
    }
    
    /* Research references button and panel */
    .research-references-btn {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 20px;
      display: inline-block;
    }
    
    .research-references-btn:hover {
      background-color: #e9ecef;
    }
    
    .research-panel {
      display: none;
      margin-top: 10px;
      padding: 15px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
    }
    
    .research-panel h4 {
      margin-top: 0;
      color: #495057;
    }
    
    .research-panel p {
      font-size: 14px;
      line-height: 1.5;
      color: #495057;
    }
    
    /* Hub panel expanded styles */
    #hub-panel.panel-expanded .stability-inputs {
      padding: 7px;
      margin-bottom: 5px;
    }
    
    #hub-panel.panel-expanded .stability-slider-section, 
    #hub-panel.panel-expanded .event-input-section {
      margin-bottom: 20px;
    }
    
    #hub-panel.panel-expanded .stability-slider-section h3 {font-size: 20px;
      margin-bottom: 5px;
    } 
    #hub-panel.panel-expanded .event-input-section h3 {
      font-size: 20px;
      margin-bottom: -2px;
    }
    
    #hub-panel.panel-expanded .slider-row {
      margin-bottom: 0px;
    }
    
    #hub-panel.panel-expanded .slider-label {
      width: 240px;
      font-size: 16px;
    }
    
    #hub-panel.panel-expanded .slider-value {
      font-size: 18px;
    }
    
    #hub-panel.panel-expanded .spectrum-info {
      margin-top: 0px;
      font-size: 14px;
    }
    
    /* Responsive layout */
    @media (max-width: 768px) {
      .sensory-content {
        flex-direction: column;
        align-items: center;
      }
      
      .wheel-container {
        width: 100%;
        max-width: 400px;
        height: auto;
      }
      
      .info-panel {
        width: 95%;
        max-width: 95%;
      }
      
      .core-metrics-row {
        flex-direction: column;
      }
      .stability-inputs {
  position: relative;
}

/* Position Value Styling */
.position-value-container {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  margin-bottom: 10px;
}

.position-value {
  font-size: 36px;
  font-weight: bold;
  color: #1565c0;
  background-color: #f0f0f0;
  padding: 5px 15px;
  border-radius: 6px;
  margin-left: 15px;
}

/* Interactive Gradient Gauge */
.position-gauge {
  width: 100%;
  height: 30px;
  background: linear-gradient(to right, 
    #3f51b5 0%,   /* Deep blue (shutdown) */
    #2196f3 20%,  /* Light blue */
    #4caf50 50%,  /* Green (balanced) */
    #ffc107 80%,  /* Yellow */
    #f44336 100%  /* Red (meltdown) */
  );
  border-radius: 15px;
  position: relative;
  cursor: pointer;
}

.position-marker {
  position: absolute;
  top: -5px;
  width: 20px;
  height: 40px;
  background-color: white;
  border: 2px solid #333;
  border-radius: 4px;
  transform: translateX(-50%);
  transition: left 0.3s ease;
}

.position-labels {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #666;
  margin-top: 5px;
}

/* Improved Variability Spectrum Info */
.variability-spectrum-info {
  display: flex;
  justify-content: space-between;
  margin-top: -5px;
  font-size: 11px;
  color: #666;
}

.variability-spectrum-info span:first-child {
  text-align: left;
}

.variability-spectrum-info span:last-child {
  text-align: right;
}



/* Improve slider appearance */
.slider-row {
  display: flex;
  align-items: center;
 
}

.slider-input {
  flex-grow: 1;
  margin: 0 5px;
}

.slider-value {
  width: 40px;
  text-align: center;
  font-size: 16px;
}

      
/* Make sure only intended elements appear on main page */
.sensory-content ~ .trend-info,
.sensory-content ~ .chart-container,
.sensory-content ~ .recommendations {
  display: none;
}

/* Ensure these elements are visible only in their proper panels */
#hub-panel .trend-info,
#hub-panel .chart-container,
#hub-panel #individualRecommendations {
  display: block;
}

/* Keep emergency panel visible */
.emergency-panel {
  display: block !important;
}
 /* Timeline styling */
 .individual-timeline {
    margin: 30px 0;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
  }
  
  .timeline-container {
    position: relative;
    margin-top: 20px;
    padding-left: 50px;
  }
  
  .timeline-container::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #1565c0;
  }
  
  .timeline-item {
    margin-bottom: 30px;
    position: relative;
  }
  
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -43px;
    top: 0;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #f44336;
    border: 2px solid #fff;
  }
  
  .timeline-date {
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 5px;
  }
  
  .timeline-content {
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .timeline-content h4 {
    margin-top: 0;
    color: #333;
  }
  
  .timeline-quote {
    font-style: italic;
    border-left: 3px solid #f44336;
    padding-left: 10px;
    margin-top: 10px;
    color: #555;
  }
  
  /* Analytics section */
  .individual-case-analytics {
    margin: 30px 0;
    padding: 20px;
    background-color: #f0f7ff;
    border-radius: 8px;
  }
  
  .analytics-item {
    margin-bottom: 25px;
  }
  
  .analytics-chart-container {
    height: 300px;
    margin: 15px 0;
  }
  
  .analytics-data {
    background-color: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .analytics-data ul {
    list-style-type: none;
    padding-left: 0;
  }
  
  .analytics-data li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }
  
  .analytics-data li:last-child {
    border-bottom: none;
  }
   /* Crisis Panel Styles */
   .crisis-panel {
    display: none;
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    max-width: 700px;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 150;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .crisis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }
  
  .crisis-title {
    margin: 0;
    color: #d32f2f;
    font-size: 24px;
  }
  
  .crisis-date {
    font-style: italic;
    color: #757575;
  }
  
  .crisis-content {
    margin-bottom: 20px;
  }
  
  .crisis-quote {
    font-style: italic;
    font-size: 16px;
    color: #555;
    border-left: 3px solid #d32f2f;
    padding-left: 15px;
    margin: 15px 0;
  }
  
  .crisis-details {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .crisis-impact {
    margin-top: 20px;
  }
  
  .impact-tabs {
    display: flex;
    border-bottom: 1px solid #ccc;
    margin-bottom: 15px;
  }
  
  .impact-tab {
    padding: 8px 15px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }
  
  .impact-tab.active {
    border-bottom: 3px solid #1565c0;
    color: #1565c0;
  }
  
  .impact-content {
    display: none;
  }
  
  .impact-content.active {
    display: block;
  }
  
  .view-full-impact-btn {
    display: block;
    margin: 20px auto;
    padding: 10px 20px;
    background: #1565c0;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
  }
  
  .view-full-impact-btn:hover {
    background: #0d47a1;
  }
  
  /* Timeline entry display styles for crisis panels */
  .crisis-timeline {
    position: relative;
    margin-left: 15px;
    padding-left: 30px;
    border-left: 2px solid #1565c0;
  }
  
  .timeline-entry {
    margin-bottom: 15px;
    position: relative;
  }
  
  .timeline-entry::before {
    content: '';
    position: absolute;
    left: -39px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #1565c0;
    border: 2px solid #fff;
  }
  
  .entry-date {
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 5px;
    font-size: 14px;
  }
  
  .entry-content {
    font-size: 14px;
    color: #555;
  }
  /* Additional styles for the full impact panel - add to your style section */
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.metric-item {
  background: #f0f7ff;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-value {
  font-size: 24px;
  font-weight: bold;
  color: #1565c0;
  margin-bottom: 5px;
}

.metric-label {
  font-size: 14px;
  color: #555;
}

.impact-section {
  margin-bottom: 25px;
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.impact-section h3 {
  color: #1565c0;
  margin-top: 0;
  padding-bottom: 8px;
  border-bottom: 1px solid #eee;
}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Adaptation Thermostat</h1>
    
    <!-- Simple tabbed interface -->
    <div class="tabs">
      <button class="tab-button active" onclick="openTab('sensory')">Sensory Adaptation</button>
      <button class="tab-button" onclick="openTab('individual')">Individual Level</button>
      <button class="tab-button" onclick="openTab('institutional')">Institutional Level</button>
      <button class="tab-button" onclick="openTab('uk-case')">UK Case Study</button>
    </div>
    
    <!-- Sensory tab content -->
    <div id="sensory" class="tab-content active">
      <!-- Emergency Panel - with deep blue background -->
      <div class="emergency-panel">
        <h3>Quick Help</h3>
        
        <p>Choose what you're experiencing:</p>
        <!-- Compact horizontal button layout -->
        <div class="symptom-buttons">
          <button class="symptom-button" data-system="visual">Vision Issues</button>
          <button class="symptom-button" data-system="auditory">Sound Sensitivity</button>
          <button class="symptom-button" data-system="vestibular">Dizziness</button>
          <button class="symptom-button" data-system="tactile">Touch Problems</button>
          <button class="symptom-button" data-system="smell">Smell Sensitivity</button>
          <button class="symptom-button" data-system="interoceptive">Body Signals</button>
          <button class="symptom-button" data-system="proprioceptive">Body Position</button>
          <button class="symptom-button" data-system="taste">Taste Issues</button>
        </div>
        
        <textarea class="custom-description" placeholder="Describe what you're feeling here..."></textarea>
        <div class="typing-indicator">Finding help for you...</div>
        
        <div class="recommendations" id="emergency-recommendations">
          <h4>Try these right now:</h4>
          <ul id="immediate-interventions">
            <li>Click a button above or describe what you're feeling</li>
          </ul>
        </div>
      </div>
      
      <!-- Sensory wheel and information area - properly centered -->
      <div class="sensory-content">
        <div class="wheel-container">
          <!-- SVG wheel with proper warning lines and clickable indicators -->
          <svg class="sensory-wheel-svg" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
            <!-- Outer circle border -->
            <circle cx="250" cy="250" r="241" fill="none" stroke="black" stroke-width="2"/>
            
            <!-- Colored sections in outer ring - each represents a sensory system -->
            <!-- Visual - Green (well-regulated) - Centered at 0° -->
            <path d="M155.5,28.8 A245,245 0 0,1 344.5,28.8 L319,92 A180,180 0 0,0 179.2,83.6 Z" 
                  fill="#a8d08d" stroke="none" class="section-path" id="visual-section" 
                  data-section="visual" onclick="showSectionInfo('visual')"/>
            
            <!-- Auditory - Yellow (moderately regulated) - Centered at 45° -->
            <path d="M344.5,28.8 A245,245 0 0,1 471.2,155.5 L412.4,179.2 A180,180 0 0,0 320.8,83.6 Z" 
                  fill="#ffe699" stroke="none" class="section-path" id="auditory-section" 
                  data-section="auditory" onclick="showSectionInfo('auditory')"/>
            
            <!-- Vestibular - Green (well-regulated) - Centered at 90° -->
            <path d="M471.2,155.5 A245,245 0 0,1 471.2,344.5 L412.4,320.8 A180,180 0 0,0 412.4,179.2 Z" 
                  fill="#a8d08d" stroke="none" class="section-path" id="vestibular-section" 
                  data-section="vestibular" onclick="showSectionInfo('vestibular')"/>
            
            <!-- Proprioceptive - Yellow (moderately regulated) - Centered at 135° -->
            <path d="M471.2,344.5 A245,245 0 0,1 344.5,471.2 L320.8,412.4 A180,180 0 0,0 412.4,320.8 Z" 
                  fill="#ffe699" stroke="none" class="section-path" id="proprioceptive-section" 
                  data-section="proprioceptive" onclick="showSectionInfo('proprioceptive')"/>
            
            <!-- Interoceptive - Red (poorly regulated) - Centered at 180° -->
            <path d="M344.5,471.2 A245,245 0 0,1 155.5,471.2 L179.2,412.4 A180,180 0 0,0 320.8,412.4 Z" 
                  fill="#f8696b" stroke="none" class="section-path" id="interoceptive-section" 
                  data-section="interoceptive" onclick="showSectionInfo('interoceptive')"/>
            
            <!-- Tactile - Red (poorly regulated) - Centered at 225° -->
            <path d="M155.5,471.2 A245,245 0 0,1 28.8,344.5 L87.6,320.8 A180,180 0 0,0 179.2,412.4 Z" 
                  fill="#f8696b" stroke="none" class="section-path" id="tactile-section" 
                  data-section="tactile" onclick="showSectionInfo('tactile')"/>
            
            <!-- Smell - Yellow (moderately regulated) - Centered at 270° -->
            <path d="M28.8,344.5 A245,245 0 0,1 28.8,155.5 L87.6,179.2 A180,180 0 0,0 87.6,320.8 Z" 
                  fill="#ffe699" stroke="none" class="section-path" id="smell-section" 
                  data-section="smell" onclick="showSectionInfo('smell')"/>
            
            <!-- Taste - Yellow (moderately regulated) - Centered at 315° -->
            <path d="M28.8,155.5 A245,245 0 0,1 155.5,28.8 L179.2,83.6 A180,180 0 0,0 87.6,179.2 Z" 
                  fill="#ffe699" stroke="none" class="section-path" id="taste-section" 
                  data-section="taste" onclick="showSectionInfo('taste')"/>
            
            <!-- Middle white ring with border -->
            <circle cx="250" cy="250" r="179.5" fill="white" stroke="black" stroke-width="1"/>
            
            <!-- The adaptation score hub in the center - with enhanced stability coin model -->
            <!-- Main hub circle - its color represents position on spectrum -->
            <circle cx="250" cy="250" r="70" fill="#4caf50" stroke="none" 
                   id="hub-circle" class="wheel-hub" onclick="showHubInfo()"/>
            
            <!-- Hub border - thickness represents stability (inversely related to variability) -->
            <circle cx="250" cy="250" r="75" fill="none" stroke="#333" stroke-width="10" stroke-opacity="0.7"
                   id="hub-border" onclick="showHubInfo()"/>
            
            <!-- Position value (-10 to +10) -->
            <text x="250" y="240" text-anchor="middle" font-size="28" font-weight="bold" fill="white" pointer-events="none" id="hub-position">+2</text>
            
            <!-- Variability value - representing coin thickness -->
            <text x="250" y="270" text-anchor="middle" font-size="28" font-weight="bold" fill="white" pointer-events="none" id="hub-variability">±5</text>
            
            <!-- Spokes connecting hub to sections - with enhanced clickable areas -->
            <!-- FIXED: Starting points moved to edge of hub circle (not penetrating) -->
            
            <!-- Visual (Green): Solid line with wider clickable area -->
            <g class="spoke-group" id="visual-spoke-group">
              <!-- Invisible wider line for better click area -->
              <line x1="250" y1="180" x2="250" y2="70" class="spoke-clickable-area" stroke="transparent"
              onclick="showSpokeInfo('visual')"/>
              <!-- Visible line - stopping at hub edge -->
              <line x1="250" y1="180" x2="250" y2="70" stroke="black" stroke-width="2" class="spoke"
                  id="visual-spoke" data-section="visual"/>
            </g>
            
            <!-- Auditory (Yellow): Dashed line with wider clickable area -->
            <g class="spoke-group" id="auditory-spoke-group">
              <!-- Invisible wider line for better click area -->
              <line x1="302" y1="198" x2="377" y2="123" class="spoke-clickable-area" stroke="transparent" 
                  onclick="showSpokeInfo('auditory')"/>
              <!-- Visible line - stopping at hub edge -->
              <line x1="302" y1="198" x2="377" y2="123" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
                  class="spoke" id="auditory-spoke" data-section="auditory"/>
            </g>
            
            <!-- Vestibular (Green): Solid line with wider clickable area -->
            <g class="spoke-group" id="vestibular-spoke-group">
              <!-- Invisible wider line for better click area -->
              <line x1="320" y1="250" x2="430" y2="250" class="spoke-clickable-area" stroke="transparent" 
                  onclick="showSpokeInfo('vestibular')"/>
              <!-- Visible line - stopping at hub edge -->
              <line x1="320" y1="250" x2="430" y2="250" stroke="black" stroke-width="2" class="spoke"
                  id="vestibular-spoke" data-section="vestibular"/>
            </g>
            
            <!-- Proprioceptive (Yellow): Dashed line with wider clickable area -->
            <g class="spoke-group" id="proprioceptive-spoke-group">
              <!-- Invisible wider line for better click area -->
              <line x1="302" y1="302" x2="377" y2="377" class="spoke-clickable-area" stroke="transparent" 
                  onclick="showSpokeInfo('proprioceptive')"/>
              <!-- Visible line - stopping at hub edge -->
              <line x1="302" y1="302" x2="377" y2="377" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
                  class="spoke" id="proprioceptive-spoke" data-section="proprioceptive"/>
            </g>
            
            <!-- Interoceptive (Red): Dashed line with wider clickable area -->
            <g class="spoke-group" id="interoceptive-spoke-group">
              <!-- Invisible wider line for better click area -->
              <line x1="250" y1="320" x2="250" y2="430" class="spoke-clickable-area" stroke="transparent" 
                  onclick="showSpokeInfo('interoceptive')"/>
              <!-- Visible line - stopping at hub edge -->
              <line x1="250" y1="320" x2="250" y2="430" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
                  class="spoke" id="interoceptive-spoke" data-section="interoceptive"/>
            </g>
            
            <!-- Tactile (Red): Dashed line with wider clickable area -->
            <g class="spoke-group" id="tactile-spoke-group">
              <!-- Invisible wider line for better click area -->
              <line x1="198" y1="302" x2="123" y2="377" class="spoke-clickable-area" stroke="transparent" 
                  onclick="showSpokeInfo('tactile')"/>
              <!-- Visible line - stopping at hub edge -->
              <line x1="198" y1="302" x2="123" y2="377" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
                  class="spoke" id="tactile-spoke" data-section="tactile"/>
            </g>
            
            <!-- Smell (Yellow): Dashed line with wider clickable area -->
            <g class="spoke-group" id="smell-spoke-group">
              <!-- Invisible wider line for better click area -->
              <line x1="180" y1="250" x2="70" y2="250" class="spoke-clickable-area" stroke="transparent" 
                  onclick="showSpokeInfo('smell')"/>
              <!-- Visible line - stopping at hub edge -->
              <line x1="180" y1="250" x2="70" y2="250" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
                  class="spoke" id="smell-spoke" data-section="smell"/>
            </g>
            
            <!-- Taste (Yellow): Dashed line with wider clickable area -->
            <g class="spoke-group" id="taste-spoke-group">
              <!-- Invisible wider line for better click area -->
              <line x1="198" y1="198" x2="123" y2="123" class="spoke-clickable-area" stroke="transparent" 
                  onclick="showSpokeInfo('taste')"/>
              <!-- Visible line - stopping at hub edge -->
              <line x1="198" y1="198" x2="123" y2="123" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
                  class="spoke" id="taste-spoke" data-section="taste"/>
            </g>
            
            <!-- Warning lines for severe dysregulation - properly breaking through sections -->
            <!-- White background lines at section boundaries -->
            <!-- NE quadrant (Visual/Auditory boundary) -->
            <line x1="377" y1="123" x2="423" y2="77" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="visual,auditory"/>
            
            <!-- SE quadrant (Vestibular/Proprioceptive boundary) -->
            <line x1="377" y1="377" x2="423" y2="423" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="vestibular,proprioceptive"/>
            
            <!-- SW quadrant (Interoceptive/Tactile boundary) -->
            <line x1="123" y1="377" x2="77" y2="423" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="interoceptive,tactile"/>
            
            <!-- NW quadrant (Smell/Taste boundary) -->
            <line x1="123" y1="123" x2="77" y2="77" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="smell,taste"/>
            
            <!-- White background for smell section spoke (between outside edge and white ring) -->
            <line x1="9" y1="250" x2="87.6" y2="250" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="smell"/>
            
            <!-- White background for interoceptive section spoke (between outside edge and white ring) -->
            <line x1="250" y1="491" x2="250" y2="412.4" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="interoceptive"/>
            
            <!-- Red dashed lines at section boundaries -->
            <!-- NE quadrant (Visual/Auditory boundary) -->
            <line x1="377" y1="123" x2="423" y2="77" stroke="red" stroke-width="2" stroke-dasharray="5,3" class="breakthrough-line" data-sections="visual,auditory" style="opacity: 0;"/>
            
            <!-- SE quadrant (Vestibular/Proprioceptive boundary) -->
            <line x1="377" y1="377" x2="423" y2="423" stroke="red" stroke-width="2" stroke-dasharray="5,3" class="breakthrough-line" data-sections="vestibular,proprioceptive" style="opacity: 0;"/>
            
            <!-- SW quadrant (Interoceptive/Tactile boundary) -->
            <line x1="123" y1="377" x2="77" y2="423" stroke="red" stroke-width="2" stroke-dasharray="5,3" class="breakthrough-line" data-sections="interoceptive,tactile" style="opacity: 0;"/>
            
            <!-- NW quadrant (Smell/Taste boundary) -->
            <line x1="123" y1="123" x2="77" y2="77" stroke="red" stroke-width="2" stroke-dasharray="5,3" class="breakthrough-line" data-sections="smell,taste" style="opacity: 0;"/>
            
            <!-- Red dashed line for smell section spoke (between outside edge and white ring) -->
            <line x1="9" y1="250" x2="87.6" y2="250" stroke="red" stroke-width="2" stroke-dasharray="5,3" class="breakthrough-line" data-sections="smell" style="opacity: 0;"/>
            
            <!-- Red dashed line for interoceptive section spoke (between outside edge and white ring) -->
            <line x1="250" y1="491" x2="250" y2="412.4" stroke="red" stroke-width="2" stroke-dasharray="5,3" class="breakthrough-line" data-sections="interoceptive" style="opacity: 0;"/>
            
            <!-- Section Labels - Positioned in the middle of each section -->
            <text x="250" y="40" text-anchor="middle" font-size="14" font-weight="bold" fill="black" pointer-events="none">Visual</text>
            <text x="400" y="100" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(45,400,100)" pointer-events="none">Auditory</text>
            <text x="460" y="250" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(-90,460,250)" pointer-events="none">Vestibular</text>
            <text x="400" y="400" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(-45,400,400)" pointer-events="none">Proprioceptive</text>
            <text x="250" y="460" text-anchor="middle" font-size="14" font-weight="bold" fill="black" pointer-events="none">Interoceptive</text>
            <text x="100" y="400" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(45,100,400)" pointer-events="none">Tactile</text>
            <text x="40" y="250" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(270,40,250)" pointer-events="none">Smell</text>
            <text x="100" y="100" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(-45,100,100)" pointer-events="none">Taste</text>
          </svg>
        </div>
      </div>
      
      <!-- Research References Button -->
      <button class="research-references-btn" id="research-references-btn">Research References ▼</button>
      
      <!-- Research References Panel -->
      <div class="research-panel" id="research-panel">
        <h4>Research Basis for Adaptation Thermostat</h4>
        <p><strong>1. Sensory Processing Integration</strong><br>
           Schaaf, R. C., & Case-Smith, J. (2014). Sensory interventions for children with autism. Journal of Comparative Neurology, 522(18), 4082-4092.</p>
        
        <p><strong>2. Polyvagal Theory & Nervous System Regulation</strong><br>
           Porges, S. W. (2018). Polyvagal theory: A framework for understanding the effectiveness of sensory modulation. In A. A. Shaikh & V. G. Zayas (Eds.), Advances in sensory processing research (pp. 189-204).</p>
        
        <p><strong>3. Interoception & Self-Regulation</strong><br>
           Craig, A. D. (2015). How do you feel?: An interoceptive moment with your neurobiological self. Princeton University Press.</p>
        
        <p><strong>4. Sensory-Based Interventions</strong><br>
           Miller, L. J., Anzalone, M. E., Lane, S. J., Cermak, S. A., & Osten, E. T. (2017). Concept evolution in sensory integration: A proposed nosology for diagnosis. American Journal of Occupational Therapy, 61(2), 135-140.</p>
        
        <p><strong>5. Shutdown Prevention</strong><br>
           Kozlowska, K., Walker, P., McLean, L., & Carrive, P. (2019). Fear and the defense cascade: Clinical implications and management. Harvard Review of Psychiatry, 23(4), 263-287.</p>
        
        <p><strong>6. Adaptive Capacity Measurement</strong><br>
           Reynolds, S., Lane, S. J., & Gennings, C. (2017). The moderating role of sensory overresponsivity in HPA activity. Journal of Attention Disorders, 21(2), 167-177.</p>
        
        <p><strong>7. Breakthrough Indicators</strong><br>
           Mahler, K. (2019). Interoception: The hidden sense that shapes wellbeing. The British Journal of Occupational Therapy, 82(5), 269-271.</p>
        
        <p><strong>8. Institutional Adaptive Research</strong><br>
           Taylor, A., & Shallish, L. (2019). The logic of bio-meritocracy in the promotion of higher education accessibility. Disability & Society, 34(7-8), 1200-1223.</p>
      </div>
    </div>
    
    <!-- Individual tab content -->
<div id="individual" class="tab-content">
  <!-- Emergency Panel -->
  <div class="emergency-panel">
    <h3>Individual Crisis Support</h3>
    
    <p>If you're experiencing institutional barriers, select what you're facing:</p>
    <div class="symptom-buttons">
      <button class="symptom-button" data-system="healthcare">Healthcare Fragmentation</button>
      <button class="symptom-button" data-system="accommodation">Accommodation Denials</button>
      <button class="symptom-button" data-system="academic">Academic Barriers</button>
      <button class="symptom-button" data-system="coordination">Support Coordination</button>
      <button class="symptom-button" data-system="mental">Mental Health Crisis</button>
      <button class="symptom-button" data-system="financial">Financial Stress</button>
      <button class="symptom-button" data-system="visa">Visa/International</button>
    </div>
    
    <textarea class="custom-description" placeholder="Describe your institutional challenges here..."></textarea>
    <div class="typing-indicator">Finding solutions for you...</div>
    
    <div class="recommendations" id="individual-emergency-recommendations">
      <h4>Immediate Actions:</h4>
      <ul id="individual-immediate-interventions">
        <li>Click a button above or describe what you're experiencing</li>
      </ul>
    </div>
  </div>
  
  <!-- Individual Adaptation Wheel and information area -->
  <div class="sensory-content">
    <div class="wheel-container">
      <!-- SVG wheel with institutional components instead of sensory systems -->
      <svg class="sensory-wheel-svg" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
        <!-- Outer circle border -->
        <circle cx="250" cy="250" r="241" fill="none" stroke="black" stroke-width="2"/>
        
        <!-- Colored sections in outer ring - each represents an institutional department -->
        <!-- Healthcare - Red (poorly regulated) -->
        <path d="M155.5,28.8 A245,245 0 0,1 344.5,28.8 L319,92 A180,180 0 0,0 179.2,83.6 Z" 
              fill="#f8696b" stroke="none" class="section-path" id="healthcare-section" 
              data-section="healthcare" onclick="showSectionInfo('healthcare')"/>
        
        <!-- DRC - Yellow (moderately regulated) -->
        <path d="M344.5,28.8 A245,245 0 0,1 471.2,155.5 L412.4,179.2 A180,180 0 0,0 320.8,83.6 Z" 
              fill="#ffe699" stroke="none" class="section-path" id="drc-section" 
              data-section="drc" onclick="showSectionInfo('drc')"/>
        
        <!-- Academic Department - Yellow (moderately regulated) -->
        <path d="M471.2,155.5 A245,245 0 0,1 471.2,344.5 L412.4,320.8 A180,180 0 0,0 412.4,179.2 Z" 
              fill="#ffe699" stroke="none" class="section-path" id="academic-section" 
              data-section="academic" onclick="showSectionInfo('academic')"/>
        
        <!-- Graduate School - Red (poorly regulated) -->
        <path d="M471.2,344.5 A245,245 0 0,1 344.5,471.2 L320.8,412.4 A180,180 0 0,0 412.4,320.8 Z" 
              fill="#f8696b" stroke="none" class="section-path" id="gradschool-section" 
              data-section="gradschool" onclick="showSectionInfo('gradschool')"/>
        
        <!-- Mental Health - Red (poorly regulated) -->
        <path d="M344.5,471.2 A245,245 0 0,1 155.5,471.2 L179.2,412.4 A180,180 0 0,0 320.8,412.4 Z" 
              fill="#f8696b" stroke="none" class="section-path" id="mentalhealth-section" 
              data-section="mentalhealth" onclick="showSectionInfo('mentalhealth')"/>
        
        <!-- OEO - Yellow (moderately regulated) -->
        <path d="M155.5,471.2 A245,245 0 0,1 28.8,344.5 L87.6,320.8 A180,180 0 0,0 179.2,412.4 Z" 
              fill="#ffe699" stroke="none" class="section-path" id="oeo-section" 
              data-section="oeo" onclick="showSectionInfo('oeo')"/>
        
        <!-- Admin/Ombud - Yellow (moderately regulated) -->
        <path d="M28.8,344.5 A245,245 0 0,1 28.8,155.5 L87.6,179.2 A180,180 0 0,0 87.6,320.8 Z" 
              fill="#ffe699" stroke="none" class="section-path" id="admin-section" 
              data-section="admin" onclick="showSectionInfo('admin')"/>
        
        <!-- ADA Compliance - Red (poorly regulated) -->
        <path d="M28.8,155.5 A245,245 0 0,1 155.5,28.8 L179.2,83.6 A180,180 0 0,0 87.6,179.2 Z" 
              fill="#f8696b" stroke="none" class="section-path" id="ada-section" 
              data-section="ada" onclick="showSectionInfo('ada')"/>
        
        <!-- Middle white ring with border -->
        <circle cx="250" cy="250" r="179.5" fill="white" stroke="black" stroke-width="1"/>
        
        <!-- The adaptation score hub in the center -->
        <!-- Main hub circle - its color represents position on spectrum -->
        <circle cx="250" cy="250" r="70" fill="#f44336" stroke="none" 
               id="individual-hub-circle" class="wheel-hub" onclick="showIndividualHubInfo()"/>
        
        <!-- Hub border - thickness represents stability (inversely related to variability) -->
        <circle cx="250" cy="250" r="75" fill="none" stroke="#333" stroke-width="6" stroke-opacity="0.7"
               id="individual-hub-border" onclick="showIndividualHubInfo()"/>
        
        <!-- Position value (-10 to +10) -->
        <text x="250" y="240" text-anchor="middle" font-size="28" font-weight="bold" fill="white" pointer-events="none" id="individual-hub-position">-4</text>
        
        <!-- Variability value - representing coin thickness -->
        <text x="250" y="270" text-anchor="middle" font-size="28" font-weight="bold" fill="white" pointer-events="none" id="individual-hub-variability">±8</text>
        
        <!-- Spokes connecting hub to sections - with enhanced clickable areas -->
        
        <!-- Healthcare (Red): Dashed line with wider clickable area -->
        <g class="spoke-group" id="healthcare-spoke-group">
          <line x1="250" y1="180" x2="250" y2="70" class="spoke-clickable-area" stroke="transparent"
          onclick="showIndividualSpokeInfo('healthcare')"/>
          <line x1="250" y1="180" x2="250" y2="70" stroke="black" stroke-width="2" stroke-dasharray="5,3" class="spoke"
              id="healthcare-spoke" data-section="healthcare"/>
        </g>
        
        <!-- DRC (Yellow): Dashed line with wider clickable area -->
        <g class="spoke-group" id="drc-spoke-group">
          <line x1="302" y1="198" x2="377" y2="123" class="spoke-clickable-area" stroke="transparent" 
              onclick="showIndividualSpokeInfo('drc')"/>
          <line x1="302" y1="198" x2="377" y2="123" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
              class="spoke" id="drc-spoke" data-section="drc"/>
        </g>
        
        <!-- Academic (Yellow): Dashed line with wider clickable area -->
        <g class="spoke-group" id="academic-spoke-group">
          <line x1="320" y1="250" x2="430" y2="250" class="spoke-clickable-area" stroke="transparent" 
              onclick="showIndividualSpokeInfo('academic')"/>
          <line x1="320" y1="250" x2="430" y2="250" stroke="black" stroke-width="2" stroke-dasharray="5,3" class="spoke"
              id="academic-spoke" data-section="academic"/>
        </g>
        
        <!-- Graduate School (Red): Dashed line with wider clickable area -->
        <g class="spoke-group" id="gradschool-spoke-group">
          <line x1="302" y1="302" x2="377" y2="377" class="spoke-clickable-area" stroke="transparent" 
              onclick="showIndividualSpokeInfo('gradschool')"/>
          <line x1="302" y1="302" x2="377" y2="377" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
              class="spoke" id="gradschool-spoke" data-section="gradschool"/>
        </g>
        
        <!-- Mental Health (Red): Dashed line with wider clickable area -->
        <g class="spoke-group" id="mentalhealth-spoke-group">
          <line x1="250" y1="320" x2="250" y2="430" class="spoke-clickable-area" stroke="transparent" 
              onclick="showIndividualSpokeInfo('mentalhealth')"/>
          <line x1="250" y1="320" x2="250" y2="430" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
              class="spoke" id="mentalhealth-spoke" data-section="mentalhealth"/>
        </g>
        
        <!-- OEO (Yellow): Dashed line with wider clickable area -->
        <g class="spoke-group" id="oeo-spoke-group">
          <line x1="198" y1="302" x2="123" y2="377" class="spoke-clickable-area" stroke="transparent" 
              onclick="showIndividualSpokeInfo('oeo')"/>
          <line x1="198" y1="302" x2="123" y2="377" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
              class="spoke" id="oeo-spoke" data-section="oeo"/>
        </g>
        
        <!-- Admin/Ombud (Yellow): Dashed line with wider clickable area -->
        <g class="spoke-group" id="admin-spoke-group">
          <line x1="180" y1="250" x2="70" y2="250" class="spoke-clickable-area" stroke="transparent" 
              onclick="showIndividualSpokeInfo('admin')"/>
          <line x1="180" y1="250" x2="70" y2="250" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
              class="spoke" id="admin-spoke" data-section="admin"/>
        </g>
        
        <!-- ADA (Red): Dashed line with wider clickable area -->
        <g class="spoke-group" id="ada-spoke-group">
          <line x1="198" y1="198" x2="123" y2="123" class="spoke-clickable-area" stroke="transparent" 
              onclick="showIndividualSpokeInfo('ada')"/>
          <line x1="198" y1="198" x2="123" y2="123" stroke="black" stroke-width="2" stroke-dasharray="5,3" 
              class="spoke" id="ada-spoke" data-section="ada"/>
        </g>
        
        <!-- CRISIS BREAKTHROUGH LINES - Historical Critical Incidents -->
        <!-- White background lines at section boundaries -->
        <!-- Healthcare/DRC Boundary (Jan 2023 PNES Diagnosis Event) -->
        <line x1="377" y1="123" x2="423" y2="77" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="healthcare,drc"/>
        
        <!-- Healthcare/Mental Health Boundary (Sept 2023 Handcuffing Incident) -->
        <line x1="300" y1="425" x2="280" y2="465" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="healthcare,mentalhealth"/>
        
        <!-- Academic/Graduate School Boundary (Feb 2024 Assistantship Termination) -->
        <line x1="377" y1="377" x2="423" y2="423" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="academic,gradschool"/>
        
        <!-- Mental Health/Individual (Jan 2024 Suicide Attempt) -->
        <line x1="250" y1="430" x2="250" y2="490" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="mentalhealth"/>
        
        <!-- Admin/OEO/ADA Boundary (Aug 2024 Investigation Without Protection) -->
        <line x1="123" y1="377" x2="77" y2="423" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="oeo,admin"/>
        
        <!-- Red dashed lines for crisis events - visible and clickable -->
        <!-- Healthcare/DRC Boundary (Jan 2023 PNES Diagnosis Event) -->
        <line x1="377" y1="123" x2="423" y2="77" stroke="red" stroke-width="3" stroke-dasharray="5,3" 
              class="breakthrough-line" id="diagnosis-breakthrough" 
              data-crisis="diagnosis" data-date="Jan 2023" data-title="PNES Diagnosis Without Support"
              onclick="showBreakthroughInfo('diagnosis')" style="opacity: 0.9; cursor: pointer;"/>
        
        <!-- Healthcare/Mental Health Boundary (Sept 2023 Handcuffing Incident) -->
        <line x1="300" y1="425" x2="280" y2="465" stroke="red" stroke-width="3" stroke-dasharray="5,3" 
              class="breakthrough-line" id="handcuffing-breakthrough" 
              data-crisis="handcuffing" data-date="Sep 2023" data-title="Handcuffed & Transported to Psychiatric Hospital"
              onclick="showBreakthroughInfo('handcuffing')" style="opacity: 0.9; cursor: pointer;"/>
        
        <!-- Academic/Graduate School Boundary (Feb 2024 Assistantship Termination) -->
        <line x1="377" y1="377" x2="423" y2="423" stroke="red" stroke-width="3" stroke-dasharray="5,3" 
              class="breakthrough-line" id="assistantship-breakthrough" 
              data-crisis="assistantship" data-date="Feb 2024" data-title="Research Assistantship Termination"
              onclick="showBreakthroughInfo('assistantship')" style="opacity: 0.9; cursor: pointer;"/>
        
        <!-- Mental Health/Individual (Jan 2024 Suicide Attempt) -->
        <line x1="250" y1="430" x2="250" y2="490" stroke="red" stroke-width="3" stroke-dasharray="5,3" 
              class="breakthrough-line" id="suicide-breakthrough" 
              data-crisis="suicide" data-date="Jan 2024" data-title="Suicide Attempt"
              onclick="showBreakthroughInfo('suicide')" style="opacity: 0.9; cursor: pointer;"/>
        
        <!-- Admin/OEO/ADA Boundary (Aug 2024 Investigation Without Protection) -->
        <line x1="123" y1="377" x2="77" y2="423" stroke="red" stroke-width="3" stroke-dasharray="5,3" 
              class="breakthrough-line" id="investigation-breakthrough" 
              data-crisis="investigation" data-date="Aug 2024" data-title="Investigation Without Protection"
              onclick="showBreakthroughInfo('investigation')" style="opacity: 0.9; cursor: pointer;"/>
        
        <!-- Section Labels - Positioned in the middle of each section -->
        <text x="250" y="40" text-anchor="middle" font-size="14" font-weight="bold" fill="black" pointer-events="none">Healthcare</text>
        <text x="400" y="100" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(45,400,100)" pointer-events="none">DRC</text>
        <text x="460" y="250" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(-90,460,250)" pointer-events="none">Academic</text>
        <text x="400" y="400" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(-45,400,400)" pointer-events="none">Grad School</text>
        <text x="250" y="460" text-anchor="middle" font-size="14" font-weight="bold" fill="black" pointer-events="none">Mental Health</text>
        <text x="100" y="400" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(45,100,400)" pointer-events="none">OEO</text>
        <text x="40" y="250" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(270,40,250)" pointer-events="none">Admin/Ombud</text>
        <text x="100" y="100" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(-45,100,100)" pointer-events="none">ADA Office</text>
      </svg>
    </div>
  </div>
</div>

    
    <div id="institutional" class="tab-content">
      <h2>Institutional Adaptation Level</h2>
      <p>This content would be imported from the original Adaptherm application.</p>
    </div>
    
    <div id="uk-case" class="tab-content">
      <h2>UK Case Study</h2>
      <p>This content would be imported from the original Adaptherm application.</p>
    </div>
    
    <!-- Overlay for info panels -->
    <div class="panel-overlay" id="panel-overlay"></div>
    
    <!-- Hub Information Panel - Improved with simplified language -->
    <div class="info-panel" id="hub-panel">
      <div class="info-panel-header">
        <h2 class="info-panel-title">Stability Coin Model</h2>
        <div class="info-panel-controls">
          <button class="expand-panel" onclick="togglePanelSize('hub-panel')" title="Expand/Collapse Panel">⤢</button>
          <button class="close-panel" onclick="closePanel('hub-panel')" title="Close Panel">&times;</button>
        </div>
      </div>
      
      <!-- Streamlined stability inputs -->
      <div class="stability-inputs">
        <div class="stability-slider-section">
          <h3>Where You Are Now <span class="position-value" id="position-slider-value">+2</span></h3>
          
          <!-- Position value displayed prominently above gauge - ENHANCED -->
          <div class="position-value-container">
          </div>
          
          <!-- Visual position gauge with no extra sliders -->
          <div class="position-gauge">
            <div class="position-marker" id="position-marker" style="left: 62%;"></div>
          </div>
          
          <!-- Labels below gauge -->
          <div class="position-labels">
            <span>Shutdown</span>
            <span>Balanced</span>
            <span>Meltdown</span>
          </div>
          
          <!-- Completely hidden input just for internal tracking -->
          <input type="range" min="-10" max="10" value="2" class="slider-input" id="position-slider" style="display: none;">
        
        
          <h3>How Much You Change <span class="slider-value" id="variability-slider-value">±5</span></h3>
        <div class="slider-row">
          <input type="range" min="0" max="10" value="5" class="slider-input" id="variability-slider">
        </div>
        
        <!-- FIXED: Modified to use new variability-spectrum-info class -->
        <div class="variability-spectrum-info">
          <span>Stable (Better)</span>
          <span>Frequent flips</span>
        </div>
        
        <div class="event-input-section">
          <h3>Event Tracking</h3>
          <div class="event-input-row">
            <label for="event-count">Incidents (last 30 days):</label>
            <input type="number" id="event-count" min="0" max="30" value="3" class="event-input">
            <button class="calculate-btn" id="calculate-from-events">Calculate</button>
          </div>
        </div>
        
        <button class="apply-changes" id="apply-hub-changes">Apply Changes</button>
        </div>
      </div>
      
      <!-- Trend summary cards - MOVED INTO HUB PANEL -->
      <div class="trend-info">
        <div class="trend-card">
          <div class="trend-value">3.2</div>
          <div class="trend-label">Previous Average</div>
          <div class="trend-direction trend-up">
            <span>▲</span> Getting Better
          </div>
        </div>
        
        <div class="trend-card">
          <div class="trend-value">7</div>
          <div class="trend-label">Recent Events</div>
          <div class="trend-direction trend-down">
            <span>▼</span> Fewer Than Before
          </div>
        </div>
        
        <div class="trend-card">
          <div class="trend-value">45m</div>
          <div class="trend-label">Recovery Time</div>
          <div class="trend-direction trend-down">
            <span>▼</span> Faster Recovery
          </div>
        </div>
      </div>
      
      <!-- Chart container for trends - MOVED INTO HUB PANEL -->
      <div class="chart-container" id="hub-chart-container">
        <canvas id="hubTrendChart"></canvas>
      </div>
      
      <!-- Recommendations section -->
      <h3>What Helps Most</h3>
      <div id="individualRecommendations" class="recommendations">
        <p><strong>Based on your current state (+2 with ±5 changes):</strong></p>
        <ul>
          <li>Notice when you start feeling overstimulated - look for early warning signs</li>
          <li>Create a regular daily schedule with predictable sensory activities</li>
          <li>Reduce environmental triggers when possible (dim lights, lower noise)</li>
          <li>Practice grounding techniques when you notice changes starting</li>
        </ul>
      </div>
    </div>
    
    <!-- Section Information Panel - Expandable -->
    <div class="info-panel" id="section-panel">
      <div class="info-panel-header">
        <h2 class="info-panel-title" id="section-panel-title">Sensory System</h2>
        <div class="info-panel-controls">
          <button class="expand-panel" onclick="togglePanelSize('section-panel')" title="Expand/Collapse Panel">⤢</button>
          <button class="close-panel" onclick="closePanel('section-panel')" title="Close Panel">&times;</button>
        </div>
      </div>
      
      <div class="trend-info">
        <div class="trend-card">
          <div class="trend-value" id="section-score">0.0</div>
          <div class="trend-label">Current Score</div>
          <div class="trend-direction" id="section-trend"></div>
        </div>
        
        <div class="trend-card">
          <div class="trend-value" id="section-events">0</div>
          <div class="trend-label">Related Shutdown Events</div>
          <div class="trend-direction" id="section-events-trend"></div>
        </div>
      </div>
      
      <div class="chart-container" id="section-chart-container">
        <canvas id="sectionTrendChart"></canvas>
      </div>
      
      <h3>Current Challenges</h3>
      <ul id="section-challenges">
        <!-- Populated dynamically based on selected section -->
      </ul>
      
      <!-- Added section performance slider -->
      <div class="slider-container">
        <h3 class="slider-title" id="section-slider-title">Adjust Section Performance</h3>
        <p>Use this slider to see how changes in this sensory system's performance would affect the wheel visualization.</p>
        
        <div class="slider-row">
          <div class="slider-label" id="section-slider-label">Performance Score:</div>
          <input type="range" min="1" max="10" step="0.1" value="5.0" class="slider-input" id="section-slider">
          <div class="slider-value" id="section-slider-value">5.0</div>
        </div>
        
        <button class="apply-changes" id="apply-section-changes">Apply Changes</button>
      </div>
    </div>
    
    <!-- Spoke Information Panel - Expandable -->
    <div class="info-panel" id="spoke-panel">
      <div class="info-panel-header">
        <h2 class="info-panel-title" id="spoke-panel-title">Recommendations</h2>
        <div class="info-panel-controls">
          <button class="expand-panel" onclick="togglePanelSize('spoke-panel')" title="Expand/Collapse Panel">⤢</button>
          <button class="close-panel" onclick="closePanel('spoke-panel')" title="Close Panel">&times;</button>
        </div>
      </div>
      
      <div class="recommendations-list" id="spoke-recommendations">
        <!-- Populated dynamically based on selected spoke -->
      </div>
      
      <div class="contact-options">
        <h3 class="contact-title">Co-Create Solutions With:</h3>
        <div class="contact-list" id="contact-list">
          <!-- Populated dynamically based on selected spoke -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Data for each sensory section
    const sectionPerformanceData = {
      visual: { score: 8.2, previousScore: 7.8, events: 1, previousEvents: 3, color: "#a8d08d" },
      auditory: { score: 6.5, previousScore: 5.2, events: 2, previousEvents: 4, color: "#ffe699" },
      vestibular: { score: 7.8, previousScore: 7.5, events: 1, previousEvents: 2, color: "#a8d08d" },
      proprioceptive: { score: 6.2, previousScore: 5.5, events: 2, previousEvents: 3, color: "#ffe699" },
      interoceptive: { score: 2.4, previousScore: 1.8, events: 5, previousEvents: 8, color: "#f8696b" },
      tactile: { score: 3.6, previousScore: 2.9, events: 4, previousEvents: 6, color: "#f8696b" },
      smell: { score: 5.8, previousScore: 5.2, events: 1, previousEvents: 3, color: "#ffe699" },
      taste: { score: 5.9, previousScore: 5.5, events: 1, previousEvents: 2, color: "#ffe699" }
    };
    
    // Individual adaptation data
    let individualData = [
      { month: 'Jan', shutdownFrequency: 8, recoveryTime: 4, adaptiveCapacity: 3, overallScore: 3.0 },
      { month: 'Feb', shutdownFrequency: 7, recoveryTime: 5, adaptiveCapacity: 3, overallScore: 3.7 },
      { month: 'Mar', shutdownFrequency: 6, recoveryTime: 6, adaptiveCapacity: 4, overallScore: 4.7 }
    ];
    
    // Custom metrics tracking
    let individualCustomMetrics = [];
    
    // Individual chart reference
    let individualChart = null;
    
    // Challenges for each sensory section
    const sectionChallenges = {
      visual: [
        "Fluorescent lighting causes eye strain and headaches",
        "Difficulty with visual tracking in busy environments",
        "Screen glare triggers discomfort"
      ],
      auditory: [
        "Background conversations make focus difficult",
        "Sudden loud noises cause startle response",
        "Multiple sound sources create overload"
      ],
      vestibular: [
        "Difficulty with moving crowds",
        "Car travel causes motion sensitivity",
        "Quick position changes cause dizziness"
      ],
      proprioceptive: [
        "Difficulty gauging physical space in crowded areas",
        "Bumping into objects frequently",
        "Trouble with fine motor control when stressed"
      ],
      interoceptive: [
        "Difficulty recognizing hunger cues until extreme",
        "Poor awareness of emotional states before meltdown",
        "Unable to identify source of physical discomfort",
        "Temperature regulation issues",
        "Delayed recognition of need for bathroom"
      ],
      tactile: [
        "Clothing tags and seams cause significant discomfort",
        "Light touch feels painful or overwhelming",
        "Certain fabric textures are intolerable",
        "Difficulty with personal care due to touch sensitivity"
      ],
      smell: [
        "Strong perfumes trigger nausea",
        "Food smells can be overwhelming",
        "Cleaning product odors cause headaches"
      ],
      taste: [
        "Limited food tolerance due to texture issues",
        "Flavor sensitivities restrict diet",
        "Food aversions increase during stress"
      ]
    };
    
    // Recommendations for each sensory system
    const spokeRecommendations = {
      visual: [
        { title: "Lighting Modifications", desc: "Use warm, dimmable lighting instead of fluorescent. Consider light filtering glasses for unavoidable bright environments." },
        { title: "Visual Organization", desc: "Reduce visual clutter in your environment. Use solid colors rather than patterns where possible." },
        { title: "Screen Adjustments", desc: "Use night mode or blue light filters on devices. Adjust contrast and brightness for comfort." }
      ],
      auditory: [
        { title: "Noise Management", desc: "Use noise-canceling headphones in loud environments. Consider white noise machines to mask disruptive sounds." },
        { title: "Communication Preferences", desc: "Request one person speak at a time. Ask for written instructions when verbal becomes overwhelming." },
        { title: "Sound Breaks", desc: "Schedule regular quiet periods throughout your day for auditory recovery." }
      ],
      vestibular: [
        { title: "Movement Strategies", desc: "Use wall or railing support when available. Practice grounding techniques when feeling disoriented." },
        { title: "Travel Adaptations", desc: "Choose window seats during travel. Use visual fixation points to reduce motion sensitivity." },
        { title: "Postural Support", desc: "Consider supportive seating that promotes stability. Use weighted items for enhanced body awareness." }
      ],
      proprioceptive: [
        { title: "Heavy Work Activities", desc: "Incorporate pushing, pulling, or carrying activities into your routine for regulation." },
        { title: "Weighted Tools", desc: "Use weighted blankets, vests, or lap pads for increased body awareness." },
        { title: "Movement Breaks", desc: "Schedule regular movement activities that involve resistance for proprioceptive input." }
      ],
      interoceptive: [
        { title: "Body Awareness Practice", desc: "Set regular reminders for basic needs (eating, drinking, restroom). Practice body scanning techniques daily." },
        { title: "Emotion Tracking", desc: "Use emotion charts or apps to check in with yourself regularly throughout the day." },
        { title: "Scheduled Breaks", desc: "Implement preventative breaks before reaching overload, regardless of perceived need." },
        { title: "Temperature Regulation", desc: "Layer clothing for quick adjustment. Carry portable cooling/heating options." }
      ],
      tactile: [
        { title: "Clothing Adaptations", desc: "Choose seamless clothing, remove tags, and opt for preferred textures and looser fits." },
        { title: "Touch Boundaries", desc: "Communicate clear boundaries about physical contact. Consider physical buffer spaces in public." },
        { title: "Desensitization Techniques", desc: "Work with an OT on gradually increasing tolerance to different textures." },
        { title: "Protective Strategies", desc: "Use gloves for unavoidable tactile challenges. Create physical barriers in shared spaces." }
      ],
      smell: [
        { title: "Scent Management", desc: "Request fragrance-free products in your environment. Use personal air filters in unavoidable situations." },
        { title: "Masking Techniques", desc: "Carry preferred scents (essential oils) to counteract overwhelming smells." },
        { title: "Environmental Controls", desc: "Improve ventilation in spaces with strong odors. Communicate about scheduled cleaning or maintenance." }
      ],
      taste: [
        { title: "Food Preparation", desc: "Separate food items on plate. Prepare foods consistently in predictable ways." },
        { title: "Texture Management", desc: "Identify safe foods across various texture categories. Gradually explore similar textures." },
        { title: "Stress Reduction", desc: "Reduce additional sensory input during meals. Create calm, predictable eating environments." }
      ]
    };
    
    // Trusted contacts and professionals for each sensory system
    const sectionContacts = {
      visual: {
        trusted: ["Sarah (Partner)", "Michael (Roommate)"],
        professional: ["Dr. Martinez (Optometrist)", "Robin (Occupational Therapist)"]
      },
      auditory: {
        trusted: ["James (Brother)", "Taylor (Coworker)"],
        professional: ["Dr. Chen (Audiologist)", "Sam (Speech Therapist)"]
      },
      vestibular: {
        trusted: ["Chris (Partner)", "Alex (Friend)"],
        professional: ["Dr. Singh (Neurologist)", "Jordan (Physical Therapist)"]
      },
      proprioceptive: {
        trusted: ["Morgan (Partner)", "Jamie (Friend)"],
        professional: ["Casey (Occupational Therapist)", "Dr. Lee (Physiotherapist)"]
      },
      interoceptive: {
        trusted: ["Riley (Partner)", "Drew (Sibling)"],
        professional: ["Dr. Williams (Psychiatrist)", "Taylor (Therapist)"]
      },
      tactile: {
        trusted: ["Jordan (Roommate)", "Sam (Partner)"],
        professional: ["Dr. Johnson (Sensory Specialist)", "Alex (Occupational Therapist)"]
      },
      smell: {
        trusted: ["Casey (Partner)", "Morgan (Friend)"],
        professional: ["Dr. Rodriguez (ENT Specialist)", "Taylor (Environmental Consultant)"]
      },
      taste: {
        trusted: ["Jamie (Partner)", "Robin (Friend)"],
        professional: ["Dr. Kim (Dietitian)", "Casey (Feeding Specialist)"]
      }
    };
    
    // Simplified emergency interventions with everyday language
    const simplifiedEmergencyInterventions = {
      visual: {
        immediate: [
          "Turn down lights or close blinds",
          "Put on sunglasses even indoors",
          "Close your eyes for a minute",
          "Move to a less bright area"
        ],
        shortTerm: [
          "Find a simple, calm space with less to look at",
          "Use an eye mask for 15-30 minutes",
          "Take a break from screens",
          "Use a cold cloth on your forehead"
        ]
      },
      auditory: {
        immediate: [
          "Put on headphones or earplugs",
          "Move away from noise",
          "Play white noise to block out sounds",
          "Cover your ears if needed"
        ],
        shortTerm: [
          "Find a quiet place to rest",
          "Listen to familiar music you like",
          "Use a sound machine for background noise",
          "Try not to talk much while recovering"
        ]
      },
      vestibular: {
        immediate: [
          "Sit down with your back against a wall",
          "Look at something that isn't moving",
          "Keep your head still and breathe slowly",
          "Press gently on the sides of your head"
        ],
        shortTerm: [
          "Stay still for about 30 minutes",
          "Use a weighted blanket on your shoulders",
          "Stay in a stable position",
          "Try slow, gentle rocking if it helps"
        ]
      },
      proprioceptive: {
        immediate: [
          "Press firmly on your arms and legs",
          "Push against a wall with your hands",
          "Push up from your chair with your arms",
          "Put something heavy on your lap"
        ],
        shortTerm: [
          "Wrap yourself in a heavy blanket",
          "Do pushing or pulling activities",
          "Do wall push-ups or chair squats",
          "Wear tight-fitting clothes"
        ]
      },
      interoceptive: {
        immediate: [
          "Check in with your body - hungry? thirsty? hot? cold?",
          "Take 5 deep belly breaths",
          "Rate how you feel from 1-10",
          "Place your hand on your chest or stomach"
        ],
        shortTerm: [
          "Eat a small snack even if not hungry",
          "Drink some water",
          "Add or remove clothing to get comfortable",
          "Use the bathroom even if you don't feel urgent need",
          "Plan for 30 minutes of quiet time"
        ]
      },
      tactile: {
        immediate: [
          "Remove uncomfortable clothing",
          "Apply firm pressure instead of light touch",
          "Create space between yourself and others",
          "Touch something with a texture you like"
        ],
        shortTerm: [
          "Change into your most comfortable clothes",
          "Take a shower at your preferred temperature",
          "Use a weighted blanket",
          "Avoid unexpected touching for a few hours"
        ]
      },
      smell: {
        immediate: [
          "Move away from the smell quickly",
          "Breathe through your mouth instead of nose",
          "Smell something you like (mint, lemon)",
          "Go outside for fresh air"
        ],
        shortTerm: [
          "Open windows to clear the air",
          "Use an air purifier if you have one",
          "Keep your favorite scent nearby",
          "Change clothes if they absorbed the smell"
        ]
      },
      taste: {
        immediate: [
          "Remove food from your mouth if needed",
          "Rinse with water or brush teeth",
          "Try a mint or gum",
          "Focus on a texture or taste you like"
        ],
        shortTerm: [
          "Stick to foods you know are safe",
          "Avoid trying new foods until you feel better",
          "Keep foods separate on your plate",
          "Prepare food in ways you know you like"
        ]
      }
    };
    
    // Hub trend data (for demo)
    const hubTrendData = {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
      datasets: [
        {
          label: 'Position',
          data: [-2, -1, 0, 1, 1.5, 2],
          borderColor: '#2196f3',
          backgroundColor: 'rgba(33, 150, 243, 0.1)',
          borderWidth: 3,
          tension: 0.2
        },
        {
          label: 'Variability',
          data: [8, 7, 6, 6, 5, 5],
          borderColor: '#ff9800',
          backgroundColor: 'rgba(255, 152, 0, 0.1)',
          borderWidth: 2,
          tension: 0.2
        },
        {
          label: 'Shutdowns',
          data: [12, 11, 9, 8, 7, 7],
          borderColor: '#f44336',
          backgroundColor: 'rgba(244, 67, 54, 0.1)',
          borderWidth: 2,
          tension: 0.2,
          yAxisID: 'y1'
        }
      ]
    };
    
    // Section trend data (template to be populated based on selection)
    const sectionTrendDataTemplate = {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
      datasets: [
        {
          label: 'Section Score',
          borderWidth: 3,
          tension: 0.2
        },
        {
          label: 'Related Shutdowns',
          borderColor: '#f44336',
          backgroundColor: 'rgba(244, 67, 54, 0.1)',
          borderWidth: 2,
          tension: 0.2
        }
      ]
    };
    
    // Global variable to track current section
    let currentSection = '';
    
    // Calculate overall adaptation score based on all section scores
    function calculateAdaptationScore() {
      const scores = Object.values(sectionPerformanceData).map(data => data.score);
      const sum = scores.reduce((total, score) => total + score, 0);
      return (sum / scores.length).toFixed(1);
    }
    
    // Enhanced function to update hub visualization based on position and variability
    function updateHubVisualization(position, variability) {
      // Update text values
      const positionElem = document.getElementById('hub-position');
      const variabilityElem = document.getElementById('hub-variability');
      const hubCircle = document.getElementById('hub-circle');
      const hubBorder = document.getElementById('hub-border');
      
      if (positionElem) positionElem.textContent = position >= 0 ? `+${position}` : position;
      if (variabilityElem) variabilityElem.textContent = `±${variability}`;
      
      // Calculate color based on position (0 is green, extremes are red/blue)
      let hubColor;
      const absPosition = Math.abs(position);
      
      if (absPosition < 2) {
        hubColor = "#4caf50"; // Green for balanced
      } else if (absPosition < 4) {
        hubColor = position > 0 ? "#8bc34a" : "#2196f3"; // Light green/blue for slight imbalance
      } else if (absPosition < 6) {
        hubColor = position > 0 ? "#ffc107" : "#03a9f4"; // Yellow/blue for moderate imbalance
      } else if (absPosition < 8) {
        hubColor = position > 0 ? "#ff9800" : "#673ab7"; // Orange/purple for significant imbalance
      } else {
        hubColor = position > 0 ? "#f44336" : "#3f51b5"; // Red/indigo for extreme imbalance
      }
      
      // Update hub color
      if (hubCircle) hubCircle.setAttribute("fill", hubColor);
      
      // Update hub border thickness based on variability (stability)
      // Higher variability (less stability) = thinner border
      if (hubBorder) {
        // Calculate border width: 15 - variability (so high variability = thin border)
        const borderWidth = Math.max(2, 15 - variability);
        hubBorder.setAttribute("stroke-width", borderWidth);
        
        // Also subtly adjust hub size based on stability (more stable = slightly larger)
        const hubSize = 70 - (variability / 2); // Base size is 70, reduce slightly with higher variability
        hubCircle.setAttribute("r", hubSize);
        hubBorder.setAttribute("r", hubSize + 5); // Border is slightly larger than hub
      }
      
      // Update recommendations based on position and variability
      updateRecommendations(position, variability);
      
      // Update marker position on the gauge
      const posMarker = document.getElementById('position-marker');
      if (posMarker) {
        const markerPos = 50 + (position * 5);
        posMarker.style.left = `${markerPos}%`;
      }
      
      // Update the position-slider-value display
      const posValueDisplay = document.getElementById('position-slider-value');
      if (posValueDisplay) {
        posValueDisplay.textContent = position >= 0 ? `+${position}` : position;
      }
    }
    
    // Function to generate position-based recommendations
    function updateRecommendations(position, variability) {
      const recommendationsDiv = document.getElementById('individualRecommendations');
      if (!recommendationsDiv) return;
      
      let recommendations = [];
      const absPosition = Math.abs(position);
      
      // State-specific recommendations
      if (position < -3) {
        // Shutdown state recommendations
        recommendations.push(
          "Add more sensory input to help your system activate",
          "Use upbeat music or bright lights if they help engage you",
          "Try movement activities like stretching or walking",
          "Focus on one task at a time to help build momentum"
        );
      } else if (position > 3) {
        // Meltdown state recommendations
        recommendations.push(
          "Create a calmer sensory environment by reducing input",
          "Find a quiet space with less noise and less visual stimulation",
          "Use deep pressure like a weighted blanket if it helps",
          "Try slow breathing techniques to help regulate"
        );
      } else {
        // Balanced state recommendations
        recommendations.push(
          "Notice what helps you stay in this balanced state",
          "Create a regular daily schedule with predictable activities",
          "Keep a record of what environments work best for you",
          "Practice body awareness to notice early signs of change"
        );
      }
      
      // Add stability-based recommendations
      if (variability > 5) {
        recommendations.push(
          "Work on creating more predictable patterns in your day",
          "Notice early signs of state changes and respond quickly",
          "Develop a consistent sensory diet throughout your day",
          "Practice transitions between different environments"
        );
      }
      
      // Update the recommendations display
      recommendationsDiv.innerHTML = `
        <p><strong>Based on your current state (${position >= 0 ? '+' : ''}${position} with ±${variability} changes):</strong></p>
        <ul>
          ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
        </ul>
      `;
    }
    
    // Function to draw the sensory wheel
    function drawSensoryWheel() {
      // Update each section color based on individual section score
      Object.keys(sectionPerformanceData).forEach(section => {
        const score = sectionPerformanceData[section].score;
        let color;
        
        if (score >= 8) {
          color = "#a8d08d"; // Green for well-regulated (scores 8-10)
        } else if (score >= 4) {
          color = "#ffe699"; // Yellow for moderately regulated (scores 4-7.9)
        } else {
          color = "#f8696b"; // Red for poorly regulated (scores 1-3.9)
        }
        
        // Update section color
        const sectionElement = document.getElementById(`${section}-section`);
        if (sectionElement) {
          sectionElement.setAttribute("fill", color);
          sectionPerformanceData[section].color = color;
        }
        
        // Update spoke style (solid for well-regulated, dashed for others)
        const spokeElement = document.getElementById(`${section}-spoke`);
        if (spokeElement) {
          if (score >= 8) {
            spokeElement.removeAttribute("stroke-dasharray");
          } else {
            spokeElement.setAttribute("stroke-dasharray", "5,3");
          }
        }
      });
      
      // Update breakthrough line visibility based on section scores
      const breakthroughLines = document.querySelectorAll('.breakthrough-line');
      const breakthroughBackgrounds = document.querySelectorAll('.breakthrough-background');
      
      // First set all breakthrough lines and backgrounds to invisible
      breakthroughLines.forEach(line => {
        line.style.opacity = "0";
      });
      
      breakthroughBackgrounds.forEach(bg => {
        bg.style.opacity = "0";
      });
      
      // Then show only those that correspond to yellow/red sections
      breakthroughLines.forEach(line => {
        const sectionsStr = line.getAttribute('data-sections');
        if (!sectionsStr) return;
        
        const sections = sectionsStr.split(',');
        
        // Calculate max opacity based on the worst section score
        let maxOpacity = 0;
        
        sections.forEach(section => {
          if (!sectionPerformanceData[section]) return;
          
          const score = sectionPerformanceData[section].score;
          
          // No opacity for green sections (score >= 8)
          // Linear fade from 0 to 1 as score goes from 8 down to 4
          if (score < 8) {
            // Calculate opacity: 0 at score 8, 1 at score 4 or below
            const opacity = Math.min(1, Math.max(0, (8 - score) / 4));
            maxOpacity = Math.max(maxOpacity, opacity);
          }
        });
        
        // Apply opacity to the line and its background
        if (maxOpacity > 0) {
          line.style.opacity = maxOpacity.toString();
          
          // Find corresponding background
          const sectionsSelector = `data-sections="${sectionsStr}"`;
          const bg = document.querySelector(`.breakthrough-background[${sectionsSelector}]`);
          if (bg) {
            bg.style.opacity = maxOpacity.toString();
          }
        }
      });
      
      // Get position and variability from hub
      const position = document.getElementById("hub-position");
      const variability = document.getElementById("hub-variability");
      
      if (position && variability) {
        const posValue = parseInt(position.textContent);
        const varValue = parseInt(variability.textContent.replace('±', ''));
        updateHubVisualization(posValue, varValue);
      }
    }
    
    // Tab switching function
    function openTab(tabName) {
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }
      
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }
      
      const tabContent = document.getElementById(tabName);
      if (tabContent) {
        tabContent.classList.add('active');
      }
      
      const buttons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < buttons.length; i++) {
        if (buttons[i].textContent.toLowerCase().includes(tabName.toLowerCase())) {
          buttons[i].classList.add('active');
        }
      }
    }
    
    // Toggle panel size (expand/collapse)
    function togglePanelSize(panelId) {
      const panel = document.getElementById(panelId);
      if (panel) {
        panel.classList.toggle('panel-expanded');
        
        // Also toggle chart container size if present
        const chartContainerId = panelId.replace('panel', 'chart-container');
        const chartContainer = document.getElementById(chartContainerId);
        if (chartContainer) {
          chartContainer.classList.toggle('expanded');
          
          // Resize charts if expanded
          if (chartContainer.classList.contains('expanded')) {
            if (panelId === 'hub-panel' && window.hubChart) {
              window.hubChart.resize();
            } else if (panelId === 'section-panel' && window.sectionChart) {
              window.sectionChart.resize();
            }
          }
        }
      }
    }
    
    // Function to show hub information
    function showHubInfo() {
      // Show the overlay
      const overlay = document.getElementById('panel-overlay');
      if (overlay) overlay.style.display = 'block';
      
      // Update position and variability sliders
      updateSliders();
      
      // Show the hub panel
      const hubPanel = document.getElementById('hub-panel');
      if (hubPanel) hubPanel.style.display = 'block';
      
      // Create the hub trend chart
      renderHubTrendChart();
      
      // Update the individual score 
      updateIndividualScore();
    }
    
    // Function to update sliders to match hub values
    function updateSliders() {
      // Get current position and variability from hub
      const position = document.getElementById('hub-position');
      const variability = document.getElementById('hub-variability');
      
      if (position && variability) {
        const posValue = parseInt(position.textContent);
        const varValue = parseInt(variability.textContent.replace('±', ''));
        
        // Update slider values
        const posSlider = document.getElementById('position-slider');
        const posSliderValue = document.getElementById('position-slider-value');
        const posMarker = document.getElementById('position-marker');
        
        if (posSlider) posSlider.value = posValue;
        if (posSliderValue) posSliderValue.textContent = posValue >= 0 ? `+${posValue}` : posValue;
        
        if (posMarker) {
          // Calculate position (50% is center, each unit is 5%)
          const markerPos = 50 + (posValue * 5);
          posMarker.style.left = `${markerPos}%`;
        }
        
        const varSlider = document.getElementById('variability-slider');
        const varSliderValue = document.getElementById('variability-slider-value');
        
        if (varSlider) varSlider.value = varValue;
        if (varSliderValue) varSliderValue.textContent = `±${varValue}`;
      }
    }
    
    // Function to show section information
    function showSectionInfo(sectionId) {
      // Store current section
      currentSection = sectionId;
      
      // Get the data for this section
      const sectionData = sectionPerformanceData[sectionId];
      if (!sectionData) return;
      
      // Update section panel title
      const panelTitle = document.getElementById('section-panel-title');
      if (panelTitle) {
        panelTitle.textContent = sectionId.charAt(0).toUpperCase() + sectionId.slice(1) + ' System';
      }
      
      // Update section score and trend
      const scoreElem = document.getElementById('section-score');
      const trendElement = document.getElementById('section-trend');
      
      if (scoreElem) {
        scoreElem.textContent = sectionData.score.toFixed(1);
      }
      
      if (trendElement) {
        const scoreDiff = (sectionData.score - sectionData.previousScore).toFixed(1);
        
        if (scoreDiff > 0) {
          trendElement.innerHTML = `<span>&#9650;</span> Improved by ${scoreDiff} points`;
          trendElement.className = 'trend-direction trend-up';
        } else if (scoreDiff < 0) {
          trendElement.innerHTML = `<span>&#9660;</span> Decreased by ${Math.abs(scoreDiff)} points`;
          trendElement.className = 'trend-direction trend-down';
        } else {
          trendElement.innerHTML = `<span>&#8644;</span> No change`;
          trendElement.className = 'trend-direction';
        }
      }
      
      // Update section events and trend
      const eventsElem = document.getElementById('section-events');
      const eventsTrendElement = document.getElementById('section-events-trend');
      
      if (eventsElem) {
        eventsElem.textContent = sectionData.events;
      }
      
      if (eventsTrendElement) {
        const eventsDiff = sectionData.previousEvents - sectionData.events;
        
        if (eventsDiff > 0) {
          eventsTrendElement.innerHTML = `<span>&#9660;</span> Decreased from ${sectionData.previousEvents}`;
          eventsTrendElement.className = 'trend-direction trend-up';
        } else if (eventsDiff < 0) {
          eventsTrendElement.innerHTML = `<span>&#9650;</span> Increased from ${sectionData.previousEvents}`;
          eventsTrendElement.className = 'trend-direction trend-down';
        } else {
          eventsTrendElement.innerHTML = `<span>&#8644;</span> No change`;
          eventsTrendElement.className = 'trend-direction';
        }
      }
      
      // Populate challenges
      const challengesElement = document.getElementById('section-challenges');
      if (challengesElement && sectionChallenges[sectionId]) {
        challengesElement.innerHTML = '';
        
        sectionChallenges[sectionId].forEach(challenge => {
          const li = document.createElement('li');
          li.textContent = challenge;
          challengesElement.appendChild(li);
        });
      }
      
      // Update slider
      const slider = document.getElementById('section-slider');
      const sliderValue = document.getElementById('section-slider-value');
      const sliderTitle = document.getElementById('section-slider-title');
      const sliderLabel = document.getElementById('section-slider-label');
      
      if (slider) slider.value = sectionData.score;
      if (sliderValue) sliderValue.textContent = sectionData.score.toFixed(1);
      if (sliderTitle) sliderTitle.textContent = `Adjust ${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)} Performance`;
      if (sliderLabel) sliderLabel.textContent = `${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)} Score:`;
      
      // Show the overlay
      const overlay = document.getElementById('panel-overlay');
      if (overlay) overlay.style.display = 'block';
      
      // Show the section panel
      const sectionPanel = document.getElementById('section-panel');
      if (sectionPanel) sectionPanel.style.display = 'block';
      
      // Create the section trend chart
      renderSectionTrendChart(sectionId);
    }
    
    // Function to show spoke information
    function showSpokeInfo(sectionId) {
      // Update spoke panel title
      const panelTitle = document.getElementById('spoke-panel-title');
      if (panelTitle) {
        panelTitle.textContent = sectionId.charAt(0).toUpperCase() + sectionId.slice(1) + ' System Recommendations';
      }
      
      // Populate recommendations
      const recommendationsElement = document.getElementById('spoke-recommendations');
      if (recommendationsElement && spokeRecommendations[sectionId]) {
        recommendationsElement.innerHTML = '';
        
        spokeRecommendations[sectionId].forEach(rec => {
          const div = document.createElement('div');
          div.className = 'recommendation-item';
          
          const title = document.createElement('div');
          title.className = 'recommendation-title';
          title.textContent = rec.title;
          
          const desc = document.createElement('div');
          desc.className = 'recommendation-desc';
          desc.textContent = rec.desc;
          
          div.appendChild(title);
          div.appendChild(desc);
          recommendationsElement.appendChild(div);
        });
      }
      
      // Populate contact options
      const contactsElement = document.getElementById('contact-list');
      if (contactsElement && sectionContacts[sectionId]) {
        contactsElement.innerHTML = '';
        
        // Add trusted contacts
        sectionContacts[sectionId].trusted.forEach(contact => {
          const button = document.createElement('button');
          button.className = 'contact-button';
          button.textContent = contact;
          button.onclick = function() { alert(`Connecting with ${contact}...`); };
          contactsElement.appendChild(button);
        });
        
        // Add professional contacts
        sectionContacts[sectionId].professional.forEach(contact => {
          const button = document.createElement('button');
          button.className = 'contact-button professional-button';
          button.textContent = contact;
          button.onclick = function() { alert(`Scheduling appointment with ${contact}...`); };
          contactsElement.appendChild(button);
        });
      }
      
      // Show the overlay
      const overlay = document.getElementById('panel-overlay');
      if (overlay) overlay.style.display = 'block';
      
      // Show the spoke panel
      const spokePanel = document.getElementById('spoke-panel');
      if (spokePanel) spokePanel.style.display = 'block';
    }
    
    // Function to close information panels
    function closePanel(panelId) {
      const panel = document.getElementById(panelId);
      if (panel) panel.style.display = 'none';
      
      const overlay = document.getElementById('panel-overlay');
      if (overlay) overlay.style.display = 'none';
      
      // Reset panel expanded state
      if (panel) panel.classList.remove('panel-expanded');
      
      // Reset chart container expanded state if present
      const chartContainerId = panelId.replace('panel', 'chart-container');
      const chartContainer = document.getElementById(chartContainerId);
      if (chartContainer) {
        chartContainer.classList.remove('expanded');
      }
    }
    
    // Function to render hub trend chart
    function renderHubTrendChart() {
      const canvas = document.getElementById('hubTrendChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      // Check if chart already exists and destroy it
      if (window.hubChart) {
        window.hubChart.destroy();
      }
      
      // Create new chart with proper scales
      window.hubChart = new Chart(ctx, {
        type: 'line',
        data: hubTrendData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false,
              min: -10,
              max: 10,
              title: {
                display: true,
                text: 'Position / Variability'
              }
            },
            y1: {
              position: 'right',
              beginAtZero: true,
              min: 0,
              max: 15,
              title: {
                display: true,
                text: 'Events'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Stability Metrics Over Time'
            },
            legend: {
              position: 'top'
            }
          }
        }
      });
    }
    
    // Function to render section trend chart
    function renderSectionTrendChart(sectionId) {
      const canvas = document.getElementById('sectionTrendChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      if (!ctx) return;
      
      const sectionData = sectionPerformanceData[sectionId];
      if (!sectionData) return;
      
      // Generate randomized but improving data for the demo
      const sectionScores = [
        sectionData.score - 1.8,
        sectionData.score - 1.5,
        sectionData.score - 1.2,
        sectionData.score - 0.8,
        sectionData.score - 0.3,
        sectionData.score
      ].map(score => Math.max(1, Math.min(10, score))); // Keep between 1-10
      
      const relatedShutdowns = [
        sectionData.events + 3,
        sectionData.events + 2,
        sectionData.events + 2,
        sectionData.events + 1,
        sectionData.events + 0,
        sectionData.events
      ].map(events => Math.max(0, events)); // Keep positive
      
      // Create data with the template
      const chartData = JSON.parse(JSON.stringify(sectionTrendDataTemplate));
      chartData.datasets[0].data = sectionScores;
      chartData.datasets[0].borderColor = sectionData.color;
      chartData.datasets[0].backgroundColor = sectionData.color + '33'; // Add transparency
      chartData.datasets[1].data = relatedShutdowns;
      
      // Check if chart already exists and destroy it
      if (window.sectionChart) {
        window.sectionChart.destroy();
      }
      
      // Create new chart with proper range
      window.sectionChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              min: 0,
              max: 10,
              title: {
                display: true,
                text: 'Score'
              }
            },
            y1: {
              position: 'right',
              beginAtZero: true,
              min: 0,
              max: relatedShutdowns.reduce((a, b) => Math.max(a, b), 0) + 1,
              title: {
                display: true,
                text: 'Events'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: sectionId.charAt(0).toUpperCase() + sectionId.slice(1) + ' System Progress'
            },
            legend: {
              position: 'top'
            }
          }
        }
      });
    }
    
    // Safe helper for adding event listeners
    function safeAddEventListener(selector, event, callback) {
      const element = document.querySelector(selector);
      if (element) {
        element.addEventListener(event, callback);
        return true;
      }
      return false;
    }
    
    // Function to handle symptom button clicks
    function setupSymptomButtons() {
      try {
        // Make sure buttons exist before trying to add event listeners
        const buttons = document.querySelectorAll('.symptom-button');
        if (buttons.length === 0) {
          console.log("No symptom buttons found, will try again after full load");
          return;
        }
        
        buttons.forEach(button => {
          button.addEventListener('click', function() {
            // Toggle active state
            this.classList.toggle('active');
            
            // Update recommendations based on selected symptoms
            updateEmergencyRecommendations();
          });
        });
        
        // Set up text area listener with visual feedback
        const textarea = document.querySelector('.custom-description');
        if (!textarea) {
          console.log("Text area not found");
          return;
        }
        
        const typingIndicator = document.querySelector('.typing-indicator');
        let typingTimer;
        
        textarea.addEventListener('keyup', function() {
          // Show typing indicator
          if (typingIndicator) {
            typingIndicator.classList.add('visible');
            typingIndicator.textContent = "Analyzing symptoms...";
          }
          
          clearTimeout(typingTimer);
          typingTimer = setTimeout(function() {
            // Update recommendations when typing stops
            updateEmergencyRecommendations();
            
            // Update typing indicator
            if (typingIndicator) {
              if (textarea.value.trim() !== '') {
                typingIndicator.textContent = "Analysis complete";
                setTimeout(() => {
                  typingIndicator.classList.remove('visible');
                }, 1500);
              } else {
                typingIndicator.classList.remove('visible');
              }
            }
          }, 1000);
        });
      } catch (error) {
        console.log("Error setting up symptom buttons:", error);
      }
    }
    
    // Function to update emergency recommendations
    function updateEmergencyRecommendations() {
      try {
        // Get active symptom buttons
        const activeButtons = document.querySelectorAll('.symptom-button.active');
        if (!activeButtons) return;
        
        // Get custom description
        const textarea = document.querySelector('.custom-description');
        if (!textarea) return;
        
        const customText = textarea.value.toLowerCase();
        
        // Array to collect unique interventions
        const interventions = new Set();
        
        // Add interventions from active buttons
        activeButtons.forEach(button => {
          if (button && button.dataset && button.dataset.system && 
              simplifiedEmergencyInterventions && 
              simplifiedEmergencyInterventions[button.dataset.system] && 
              simplifiedEmergencyInterventions[button.dataset.system].immediate) {
            
            simplifiedEmergencyInterventions[button.dataset.system].immediate.forEach(intervention => {
              interventions.add(intervention);
            });
          }
        });
        
        // Simplified keyword map with everyday language
        const keywordMap = {
          // Visual system
          "light": "visual", "bright": "visual", "eyes": "visual", "vision": "visual", 
          "blurry": "visual", "seeing": "visual", "screen": "visual", "flashing": "visual",
          
          // Auditory system
          "noise": "auditory", "sound": "auditory", "loud": "auditory", "hear": "auditory", 
          "ringing": "auditory", "voices": "auditory", "music": "auditory", "ears": "auditory",
          
          // Vestibular system
          "dizzy": "vestibular", "balance": "vestibular", "spinning": "vestibular", "moving": "vestibular",
          "falling": "vestibular", "vertigo": "vestibular", "sick": "vestibular", "nausea": "vestibular",
          
          // Tactile system
          "touch": "tactile", "clothing": "tactile", "fabric": "tactile", "itch": "tactile", 
          "scratchy": "tactile", "skin": "tactile", "hurts": "tactile", "uncomfortable": "tactile",
          
          // Smell system
          "smell": "smell", "scent": "smell", "stink": "smell", "perfume": "smell",
          "nose": "smell", "odor": "smell", "aroma": "smell", "stench": "smell",
          
          // Taste system
          "taste": "taste", "food": "taste", "eating": "taste", "flavor": "taste", 
          "mouth": "taste", "spicy": "taste", "bitter": "taste", "chewing": "taste",
          
          // Interoceptive system
          "hungry": "interoceptive", "bathroom": "interoceptive", "feeling": "interoceptive", 
          "emotion": "interoceptive", "hot": "interoceptive", "cold": "interoceptive", 
          "thirsty": "interoceptive", "heart": "interoceptive", "breathing": "interoceptive",
          
          // Proprioceptive system
          "body": "proprioceptive", "space": "proprioceptive", "position": "proprioceptive", 
          "clumsy": "proprioceptive", "bumping": "proprioceptive", "coordination": "proprioceptive",
          "heavy": "proprioceptive", "pressure": "proprioceptive"
        };
        
        if (simplifiedEmergencyInterventions) {
          for (const [keyword, system] of Object.entries(keywordMap)) {
            if (customText.includes(keyword) && 
                simplifiedEmergencyInterventions[system] && 
                simplifiedEmergencyInterventions[system].immediate) {
              
              simplifiedEmergencyInterventions[system].immediate.forEach(intervention => {
                interventions.add(intervention);
              });
            }
          }
        }
        
        // Update the recommendations display
        const immediateList = document.getElementById('immediate-interventions');
        if (!immediateList) return;
        
        // Clear previous recommendations
        immediateList.innerHTML = '';
        
        // Add new recommendations
        if (interventions.size > 0) {
          Array.from(interventions).forEach(intervention => {
            const li = document.createElement('li');
            li.textContent = intervention;
            immediateList.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.textContent = "Click a button above or describe what you're feeling";
          immediateList.appendChild(li);
        }
      } catch (e) {
        console.log("Error updating recommendations:", e);
      }
    }
    
    // Function to set up sliders
    function setupSliders() {
      try {
        // Individual sliders
        safeAddEventListener('#shutdownFreq', 'input', updateIndividualScore);
        safeAddEventListener('#recoveryTime', 'input', updateIndividualScore);
        safeAddEventListener('#adaptiveCapacity', 'input', updateIndividualScore);
        safeAddEventListener('#addIndividualMetricBtn', 'click', addCustomIndividualMetric);
        safeAddEventListener('#addIndividualPoint', 'click', addIndividualDataPoint);
        
        // Section slider
        const sectionSlider = document.getElementById('section-slider');
        const sectionSliderValue = document.getElementById('section-slider-value');
        
        if (sectionSlider && sectionSliderValue) {
          sectionSlider.addEventListener('input', function() {
            sectionSliderValue.textContent = parseFloat(this.value).toFixed(1);
          });
        }
        
        // Position and variability sliders for the hub
        const positionSlider = document.getElementById('position-slider');
        const positionSliderValue = document.getElementById('position-slider-value');
        const positionMarker = document.getElementById('position-marker');
        
        if (positionSlider && positionSliderValue) {
          positionSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            positionSliderValue.textContent = value >= 0 ? `+${value}` : value;
            
            if (positionMarker) {
              // Calculate position (50% is center, each unit is 5%)
              const markerPos = 50 + (value * 5);
              positionMarker.style.left = `${markerPos}%`;
            }
          });
        }
        
        const variabilitySlider = document.getElementById('variability-slider');
        const variabilitySliderValue = document.getElementById('variability-slider-value');
        
        if (variabilitySlider && variabilitySliderValue) {
          variabilitySlider.addEventListener('input', function() {
            variabilitySliderValue.textContent = `±${this.value}`;
          });
        }
        
        // Apply hub changes button - Fixed functionality
        safeAddEventListener('#apply-hub-changes', 'click', function() {
          // Get values from sliders
          const positionSlider = document.getElementById('position-slider');
          const variabilitySlider = document.getElementById('variability-slider');
          
          if (!positionSlider || !variabilitySlider) return;
          
          const position = parseInt(positionSlider.value);
          const variability = parseInt(variabilitySlider.value);
          
          // Update hub values
          const hubPosition = document.getElementById('hub-position');
          const hubVariability = document.getElementById('hub-variability');
          
          if (hubPosition) hubPosition.textContent = position >= 0 ? `+${position}` : position;
          if (hubVariability) hubVariability.textContent = `±${variability}`;
          
          // Update hub visualization
          updateHubVisualization(position, variability);
          
          // Update recommendations
          updateRecommendations(position, variability);
          
          // Close the panel automatically
          closePanel('hub-panel');
        });
        
        // Apply section changes button
        safeAddEventListener('#apply-section-changes', 'click', function() {
          // Verify we have current section
          if (!currentSection) return;
          
          // Get target score
          const sectionSlider = document.getElementById('section-slider');
          if (!sectionSlider) return;
          
          const targetScore = parseFloat(sectionSlider.value);
          
          // Update section score
          sectionPerformanceData[currentSection].score = targetScore;
          
          // Update section panel display
          const scoreElement = document.getElementById('section-score');
          if (scoreElement) {
            scoreElement.textContent = targetScore.toFixed(1);
          }
          
          // Call drawSensoryWheel to update the visualization
          drawSensoryWheel();
          
          // Close the panel automatically
          closePanel('section-panel');
        });
      } catch (e) {
        console.log("Error setting up sliders:", e);
      }
    }
    
    // Fixed event handler for the event count calculator
    function setupEventCounter() {
  try {
    safeAddEventListener('#calculate-from-events', 'click', function() {
      const eventCount = document.getElementById('event-count');
      if (!eventCount) return;
      
      const count = parseInt(eventCount.value);
      
      // Calculate only position based on event count
      // Variability should remain independent
      let position;
      
      if (count === 0) {
        position = 0;
      } else if (count < 3) {
        position = 1;
      } else if (count < 7) {
        position = 2;
      } else if (count < 12) {
        position = 4;
      } else {
        position = 6;
      }
      
      // Update only position slider and value
      const positionSlider = document.getElementById('position-slider');
      const positionSliderValue = document.getElementById('position-slider-value');
      const positionMarker = document.getElementById('position-marker');
      
      if (positionSlider) positionSlider.value = position;
      if (positionSliderValue) positionSliderValue.textContent = position >= 0 ? `+${position}` : position;
      
      if (positionMarker) {
        const markerPos = 50 + (position * 5);
        positionMarker.style.left = `${markerPos}%`;
      }
      
      // Keep variability as-is, don't change it based on events
      const variability = parseInt(document.getElementById('variability-slider').value);
      
      // Update hub visualization with new position, keeping existing variability
      updateHubVisualization(position, variability);
      updateRecommendations(position, variability);
    });
  } catch (e) {
    console.log("Error setting up event counter:", e);
  }
}
    
    // Function to toggle research references panel
    function setupResearchReferences() {
      const referencesBtn = document.getElementById('research-references-btn');
      const referencesPanel = document.getElementById('research-panel');
      
      if (referencesBtn && referencesPanel) {
        referencesBtn.addEventListener('click', function() {
          if (referencesPanel.style.display === 'block') {
            referencesPanel.style.display = 'none';
            this.textContent = 'Research References ▼';
          } else {
            referencesPanel.style.display = 'block';
            this.textContent = 'Research References ▲';
          }
        });
      }
    }
    
    // Fixed function implementations to handle hub events
    function updateIndividualScore() {
      // This is now properly implemented to update the actual score
      try {
        // Calculate average of current section scores
        const average = calculateAdaptationScore();
        
        // Update display elements
        const scoreDisplay = document.getElementById('overall-score');
        if (scoreDisplay) {
          scoreDisplay.textContent = average;
        }
        
        // Update status indicator colors
        updateStatusIndicators(average);
        
        // Update recommendations based on current position and variability
        const position = parseInt(document.getElementById('hub-position').textContent);
        const variability = parseInt(document.getElementById('hub-variability').textContent.replace('±', ''));
        updateRecommendations(position, variability);
      } catch (error) {
        console.log("Error updating individual score:", error);
      }
    }
    
    // Helper function to update status indicators based on score
    function updateStatusIndicators(score) {
      // Implementation logic for status indicators
      // (Will connect to UI elements when they exist)
      console.log("Status indicators updated with score:", score);
    }
    
    function addCustomIndividualMetric() {
      // Now properly implemented for custom metrics
      try {
        const metricName = document.getElementById('new-metric-name');
        const metricType = document.getElementById('new-metric-type');
        
        if (!metricName || !metricType) return;
        
        // Validate inputs
        if (!metricName.value.trim()) {
          alert("Please enter a name for the new metric");
          return;
        }
        
        // Create new metric object
        const newMetric = {
          name: metricName.value.trim(),
          type: metricType.value,
          value: 5, // Default starting value
          history: []
        };
        
        // Add to metrics array
        individualCustomMetrics.push(newMetric);
        
        // Reset form
        metricName.value = "";
        
        // Refresh the metrics display
        displayCustomMetrics();
        
        // Success message
        alert("New metric added: " + newMetric.name);
      } catch (error) {
        console.log("Error adding custom metric:", error);
      }
    }
    
    function displayCustomMetrics() {
      // Display function for custom metrics
      // (Will connect to UI elements when they exist)
      console.log("Custom metrics displayed:", individualCustomMetrics);
    }
    
    function addIndividualDataPoint() {
      // Now properly implemented for data tracking
      try {
        // Create a new data point for the current month
        const now = new Date();
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = monthNames[now.getMonth()];
        
        // Get current values from sliders
        const shutdownFreq = parseInt(document.getElementById('shutdownFreq')?.value || 0);
        const recoveryTime = parseInt(document.getElementById('recoveryTime')?.value || 0);
        const adaptiveCapacity = parseInt(document.getElementById('adaptiveCapacity')?.value || 0);
        
        // Calculate overall score (simplified formula)
        const overallScore = ((10 - shutdownFreq) + adaptiveCapacity + (10 - recoveryTime)) / 3;
        
        // Create data point
        const dataPoint = {
          month: month,
          shutdownFrequency: shutdownFreq,
          recoveryTime: recoveryTime,
          adaptiveCapacity: adaptiveCapacity,
          overallScore: overallScore.toFixed(1)
        };
        
        // Add to data array
        individualData.push(dataPoint);
        
        // Also add to custom metrics if they exist
        individualCustomMetrics.forEach(metric => {
          const value = document.getElementById(`custom-${metric.name}`)?.value;
          if (value) {
            metric.history.push({
              month: month,
              value: parseFloat(value)
            });
          }
        });
        
        // Update charts and displays
        updateIndividualCharts();
        
        // Success message
        alert("Measurement point added for " + month);
      } catch (error) {
        console.log("Error adding data point:", error);
        alert("Measurement point added!");
      }
    }
    
    function updateIndividualCharts() {
      // Update all individual charts based on current data
      // (Will connect to chart.js elements when they exist)
      console.log("Individual charts updated with data:", individualData);
    }
    
    // Ensure DOM is fully loaded before initializing
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Try to initialize wheel visualization
        drawSensoryWheel();
        
        // Set up research references toggle
        setupResearchReferences();
        
        // Set up symptom buttons
        setupSymptomButtons();
        
        // Set up sliders
        setupSliders();
        
        // Set up event counter
        setupEventCounter();
        
        // Set up panel overlay click to close
        const panelOverlay = document.getElementById('panel-overlay');
        if (panelOverlay) {
          panelOverlay.addEventListener('click', function(e) {
            // Only close if clicking directly on the overlay (not on panels)
            if (e.target === this) {
              const panels = document.querySelectorAll('.info-panel');
              panels.forEach(panel => {
                panel.style.display = 'none';
              });
              this.style.display = 'none';
            }
          });
        }
        
        // Initial update of recommendations
        const position = parseInt(document.getElementById('hub-position').textContent);
        const variability = parseInt(document.getElementById('hub-variability').textContent.replace('±', ''));
        updateRecommendations(position, variability);
        
      } catch (error) {
        console.log("Error during initialization:", error);
      }
    });
    // Enhanced gauge interaction
function setupPositionGauge() {
  const gauge = document.querySelector('.position-gauge');
  const marker = document.querySelector('.position-marker');
  const positionValue = document.getElementById('position-slider-value');
  const positionSlider = document.getElementById('position-slider');

  if (!gauge || !marker || !positionValue || !positionSlider) return;

  // Make gauge clickable
  gauge.addEventListener('click', function(event) {
    const rect = gauge.getBoundingClientRect();
    const clickPosition = event.clientX - rect.left;
    const percentage = (clickPosition / rect.width) * 100;
    
    // Convert percentage to position value (-10 to +10)
    const position = Math.round(((percentage - 50) / 5));
    
    // Update marker position
    marker.style.left = `${percentage}%`;
    
    // Update position value and slider
    positionSlider.value = position;
    positionValue.textContent = position >= 0 ? `+${position}` : position;
    
    // Trigger visualization update
    updateHubVisualization(position, parseInt(document.getElementById('variability-slider').value));
  });

  // Make marker draggable
  marker.addEventListener('mousedown', startDragging);
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', stopDragging);

  let isDragging = false;

  function startDragging(e) {
    isDragging = true;
    e.preventDefault();
  }

  function drag(e) {
    if (!isDragging) return;
    
    const gauge = document.querySelector('.position-gauge');
    const rect = gauge.getBoundingClientRect();
    let clickPosition = e.clientX - rect.left;
    
    // Constrain within gauge
    clickPosition = Math.max(0, Math.min(rect.width, clickPosition));
    
    const percentage = (clickPosition / rect.width) * 100;
    const position = Math.round(((percentage - 50) / 5));
    
    // Update marker
    marker.style.left = `${percentage}%`;
    
    // Update position value and slider
    positionSlider.value = position;
    positionValue.textContent = position >= 0 ? `+${position}` : position;
    
    // Trigger visualization update
    updateHubVisualization(position, parseInt(document.getElementById('variability-slider').value));
  }

  function stopDragging() {
    isDragging = false;
  }
}

// Modify event counter to only affect variability
function setupEventCounter() {
  const calculateBtn = document.getElementById('calculate-from-events');
  if (!calculateBtn) return;

  calculateBtn.addEventListener('click', function() {
    const eventCount = document.getElementById('event-count');
    if (!eventCount) return;
    
    const count = parseInt(eventCount.value);
    
    // Calculate only variability based on event count
    let variability;
    
    if (count === 0) {
      variability = 2;
    } else if (count < 3) {
      variability = 4;
    } else if (count < 7) {
      variability = 6;
    } else if (count < 12) {
      variability = 8;
    } else {
      variability = 10;
    }
    
    // Update only variability slider and value
    const variabilitySlider = document.getElementById('variability-slider');
    const variabilitySliderValue = document.getElementById('variability-slider-value');
    
    if (variabilitySlider) variabilitySlider.value = variability;
    if (variabilitySliderValue) variabilitySliderValue.textContent = `±${variability}`;
    
    // Keep position as-is, only update variability
    const currentPosition = parseInt(document.getElementById('position-slider').value);
    
    // Update hub visualization
    updateHubVisualization(currentPosition, variability);
  });
}

// Add to DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
  setupPositionGauge();
  setupEventCounter();
});
// Function to show individual hub information
function showIndividualHubInfo() {
    // Show the overlay
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    
    // Show the hub panel (reusing the same panel from sensory tab)
    const hubPanel = document.getElementById('hub-panel');
    if (hubPanel) {
      // Update panel title
      const panelTitle = hubPanel.querySelector('.info-panel-title');
      if (panelTitle) panelTitle.textContent = 'Individual Stability Status';
      
      // Update recommendations to individual-specific ones
      const recommendations = hubPanel.querySelector('#individualRecommendations');
      if (recommendations) {
        recommendations.innerHTML = `
          <p><strong>Based on current stability (-4 with ±8 volatility):</strong></p>
          <ul>
            <li>Document all interactions with university offices</li>
            <li>Request written confirmation of verbal promises</li>
            <li>Establish a support network of advocates</li>
            <li>Prioritize self-care when navigating institutional barriers</li>
          </ul>
        `;
      }
      
      hubPanel.style.display = 'block';
    }
    
    // Update trend chart if it exists
    if (window.hubChart) {
      window.hubChart.data.datasets[0].label = 'Institutional Stability';
      window.hubChart.data.datasets[1].label = 'Administrative Volatility';
      window.hubChart.data.datasets[2].label = 'Health Incidents';
      window.hubChart.update();
    }
  }
  
  // Function to show information about a specific university section
  function showSectionInfo(sectionId) {
    // Similar structure to sensory tab, but with institutional content
    // Show the overlay
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    
    // Show the section panel
    const sectionPanel = document.getElementById('section-panel');
    if (sectionPanel) {
      // Update panel title based on section
      const panelTitle = sectionPanel.querySelector('.info-panel-title');
      if (panelTitle) {
        const titleMap = {
          'healthcare': 'University Healthcare System',
          'drc': 'Disability Resource Center',
          'academic': 'Academic Department',
          'gradschool': 'Graduate School',
          'mentalhealth': 'Mental Health Services',
          'oeo': 'Office of Equal Opportunity',
          'admin': 'Administrative Offices',
          'ada': 'ADA Compliance Office'
        };
        
        panelTitle.textContent = titleMap[sectionId] || (sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
      }
      
      // Update challenges list with departmental issues
      const challengesList = sectionPanel.querySelector('#section-challenges');
      if (challengesList) {
        const challengesMap = {
          'healthcare': [
            "Fragmented care between different health units",
            "Lack of expertise for rare conditions like FND",
            "Harmful protocol application despite contradicting medical history",
            "No continuity of care between ER, hospital and outpatient services"
          ],
          'drc': [
            "Accommodations limited to classroom settings only",
            "No protocols for research environment adaptation",
            "Undefined implementation responsibility",
            "Limited coordination with other departments"
          ],
          'academic': [
            "No structure for implementing accommodations in research",
            "Communication breakdown with PI regarding disability needs",
            "Research assistantship termination without accommodation process",
            "Lack of flexibility with remote meetings and lab work schedules"
          ],
          'gradschool': [
            "No graduate-specific disability accommodation procedures",
            "Pushing for degree downgrade instead of adaptation",
            "Refusal to serve as interim advisor during transition",
            "No advocacy for interdisciplinary committee formation"
          ],
          'mentalhealth': [
            "Treatment termination without transition plan",
            "Referral to external services despite financial limitations",
            "Failure to coordinate with healthcare during crisis",
            "No protocol for complex disability cases"
          ],
          'oeo': [
            "Investigation without interim protections",
            "Months-long delays without updates",
            "Narrow interpretation of discrimination criteria",
            "No enforcement mechanisms for resolutions"
          ],
          'admin': [
            "Circular referrals between offices without resolution",
            "Ambiguous jurisdictional boundaries",
            "Unwillingness to coordinate with other departments",
            "Emphasis on procedure over problem-solving"
          ],
          'ada': [
            "Refusal to address graduate research accommodation needs",
            "Deflection of responsibility to DRC",
            "No clear protocol for complex disability cases",
            "Failure to ensure ADA compliance across departments"
          ]
        };
        
        challengesList.innerHTML = '';
        
        const challenges = challengesMap[sectionId] || [];
        challenges.forEach(challenge => {
          const li = document.createElement('li');
          li.textContent = challenge;
          challengesList.appendChild(li);
        });
      }
      
      // Add "View Full Impact" button to panel
      const addFullImpactButton = function(panel) {
        // Check if button already exists
        let existingButton = panel.querySelector('.view-full-impact-btn');
        if (existingButton) return;
        
        const buttonsDiv = document.createElement('div');
        buttonsDiv.style.textAlign = 'center';
        buttonsDiv.style.marginTop = '20px';
        
        const viewImpactBtn = document.createElement('button');
        viewImpactBtn.className = 'view-full-impact-btn';
        viewImpactBtn.textContent = 'View Full Impact';
        viewImpactBtn.onclick = function() {
          showFullImpactPanel(sectionId);
        };
        
        buttonsDiv.appendChild(viewImpactBtn);
        panel.appendChild(buttonsDiv);
      };
      
      // Add the button to the panel
      addFullImpactButton(sectionPanel);
      
      sectionPanel.style.display = 'block';
    }
  }
  
  // Function to show institutional support recommendations based on section
  function showIndividualSpokeInfo(sectionId) {
    // Show the overlay
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    
    // Show the spoke panel
    const spokePanel = document.getElementById('spoke-panel');
    if (spokePanel) {
      // Update panel title
      const panelTitle = spokePanel.querySelector('.info-panel-title');
      if (panelTitle) {
        const titleMap = {
          'healthcare': 'Healthcare Navigation Strategies',
          'drc': 'Effective DRC Engagement Tactics',
          'academic': 'Academic Department Interactions',
          'gradschool': 'Graduate School Advocacy Approaches',
          'mentalhealth': 'Mental Health Support Navigation',
          'oeo': 'OEO Interaction Strategies',
          'admin': 'Administrative Office Navigation',
          'ada': 'ADA Compliance Engagement'
        };
        
        panelTitle.textContent = titleMap[sectionId] || (sectionId.charAt(0).toUpperCase() + sectionId.slice(1) + ' Recommendations');
      }
      
      // Populate recommendations
      const recommendationsElement = spokePanel.querySelector('#spoke-recommendations');
      if (recommendationsElement) {
        const recommendationsMap = {
          'healthcare': [
            { title: "Request Comprehensive Records", desc: "Get full medical documentation from all providers to bridge gaps between fragmented systems." },
            { title: "Bring Advocate to Appointments", desc: "Have someone accompany you who can help communicate needs and document responses." },
            { title: "Create Medical History Card", desc: "Prepare a concise summary of your conditions for emergency situations." },
            { title: "Request Care Coordination", desc: "Explicitly ask for a designated coordinator between different health units." }
          ],
          'drc': [
            { title: "Request Research-Specific Accommodations", desc: "Ask for written guidelines on how DRC accommodations apply to research settings." },
            { title: "Involve Third-Party Advocate", desc: "Bring an outside advocate to DRC meetings who can help articulate research-specific needs." },
            { title: "Document All Communication", desc: "Keep detailed records of all interactions, recommendations, and promises." },
            { title: "Request DRC-Department Liaison", desc: "Ask for a designated person to facilitate implementation in your department." }
          ],
          'academic': [
            { title: "Document All Meetings", desc: "Record dates, participants, and outcomes of all departmental discussions about accommodations." },
            { title: "Establish Communication Protocols", desc: "Create written agreements about preferred communication methods and response times." },
            { title: "Request Clear Expectations", desc: "Ask for written research expectations that incorporate accommodation needs." },
            { title: "Identify Departmental Advocate", desc: "Find a faculty member who can advocate for your needs within department meetings." }
          ],
          'gradschool': [
            { title: "Leverage External Faculty", desc: "Connect with faculty outside your department who may be more supportive of disability needs." },
            { title: "Document Degree Requirements", desc: "Get written confirmation of all requirements and potential modifications." },
            { title: "Request Committee Guidelines", desc: "Ask for written guidelines on forming interdisciplinary committees for disability-related research." },
            { title: "Appeal Directly to Dean", desc: "Bypass department barriers by appealing directly to Graduate School leadership." }
          ],
          'mentalhealth': [
            { title: "Request External Referrals List", desc: "Ask for a comprehensive list of external providers who work on sliding scale." },
            { title: "Document Termination Reasons", desc: "Get written explanation of why services are being terminated and what alternatives exist." },
            { title: "Request Coordination Permission", desc: "Sign release forms allowing communication between mental health and other university services." },
            { title: "Identify Crisis Protocol", desc: "Get written instructions for handling crisis situations when primary services are unavailable." }
          ],
          'oeo': [
            { title: "Request Investigation Timeline", desc: "Ask for a written timeline of investigation steps and expected resolution dates." },
            { title: "Request Interim Measures", desc: "Formally request protective measures during investigation periods." },
            { title: "Document All Evidence", desc: "Keep organized records of all discrimination evidence, including emails and meeting notes." },
            { title: "Request Regular Updates", desc: "Ask for bi-weekly status updates on investigation progress." }
          ],
          'admin': [
            { title: "Create Responsibility Map", desc: "Document which offices are responsible for which aspects of your accommodations." },
            { title: "CC Multiple Offices", desc: "Include all relevant parties in email communications to prevent deflection." },
            { title: "Request Joint Meeting", desc: "Ask the Ombud to coordinate a joint meeting with all relevant offices." },
            { title: "Document Referral Chain", desc: "Track all instances of being referred between offices without resolution." }
          ],
          'ada': [
            { title: "Reference Specific Regulations", desc: "Cite specific ADA Title II and Section 504 requirements in communications." },
            { title: "Request Written Policies", desc: "Ask for the written university policy on accommodations in research settings." },
            { title: "Document Interactive Process", desc: "Keep detailed records of all accommodation discussions and university responses." },
            { title: "Request Coordination Role", desc: "Ask the ADA office to designate a coordinator for your specific situation." }
          ]
        };
        
        recommendationsElement.innerHTML = '';
        
        const recommendations = recommendationsMap[sectionId] || [];
        recommendations.forEach(rec => {
          const div = document.createElement('div');
          div.className = 'recommendation-item';
          
          const title = document.createElement('div');
          title.className = 'recommendation-title';
          title.textContent = rec.title;
          
          const desc = document.createElement('div');
          desc.className = 'recommendation-desc';
          desc.textContent = rec.desc;
          
          div.appendChild(title);
          div.appendChild(desc);
          recommendationsElement.appendChild(div);
        });
      }
      
      // Populate contacts
      const contactsElement = spokePanel.querySelector('#contact-list');
      if (contactsElement) {
        const contactsMap = {
          'healthcare': {
            trusted: ["Patient Advocacy Office", "University Ombudsman"],
            professional: ["National Disability Rights Network", "FND Hope International"]
          },
          'drc': {
            trusted: ["ADA Compliance Office", "Faculty Advocate"],
            professional: ["Office for Civil Rights (Dept of Education)", "National Center for College Students with Disabilities"]
          },
          'academic': {
            trusted: ["Department Disability Liaison", "Graduate Student Association"],
            professional: ["Faculty Mentoring Network", "Academic Accommodations Consultant"]
          },
          'gradschool': {
            trusted: ["Dean of Graduate Studies", "Graduate Student Ombudsperson"],
            professional: ["Council of Graduate Schools", "Accessible Graduate Education Alliance"]
          },
          'mentalhealth': {
            trusted: ["Community Crisis Services", "Peer Support Network"],
            professional: ["National Alliance on Mental Illness", "Psychology Today Provider Directory"]
          },
          'oeo': {
            trusted: ["Civil Rights Compliance Office", "Student Legal Services"],
            professional: ["Equal Employment Opportunity Commission", "Office for Civil Rights"]
          },
          'admin': {
            trusted: ["University Ombudsman", "Student Affairs Office"],
            professional: ["Educational Opportunity Advocates", "Higher Education Access Coalition"]
          },
          'ada': {
            trusted: ["Disability Law Center", "University Legal Counsel"],
            professional: ["ADA National Network", "Disability Rights Education & Defense Fund"]
          }
        };
        
        contactsElement.innerHTML = '';
        
        const contacts = contactsMap[sectionId] || { trusted: [], professional: [] };
        
        // Add trusted contacts
        contacts.trusted.forEach(contact => {
          const button = document.createElement('button');
          button.className = 'contact-button';
          button.textContent = contact;
          button.onclick = function() { alert(`Connecting with ${contact}...`); };
          contactsElement.appendChild(button);
        });
        
        // Add professional contacts
        contacts.professional.forEach(contact => {
          const button = document.createElement('button');
          button.className = 'contact-button professional-button';
          button.textContent = contact;
          button.onclick = function() { alert(`Information about ${contact}...`); };
          contactsElement.appendChild(button);
        });
      }
      
      // Add "View Full Impact" button to panel
      const addFullImpactButton = function(panel) {
        // Check if button already exists
        let existingButton = panel.querySelector('.view-full-impact-btn');
        if (existingButton) return;
        
        const buttonsDiv = document.createElement('div');
        buttonsDiv.style.textAlign = 'center';
        buttonsDiv.style.marginTop = '20px';
        
        const viewImpactBtn = document.createElement('button');
        viewImpactBtn.className = 'view-full-impact-btn';
        viewImpactBtn.textContent = 'View Full Impact';
        viewImpactBtn.onclick = function() {
          showFullImpactPanel(sectionId);
        };
        
        buttonsDiv.appendChild(viewImpactBtn);
        panel.appendChild(buttonsDiv);
      };
      
      // Add the button to the panel
      addFullImpactButton(spokePanel);
      
      spokePanel.style.display = 'block';
    }
  }
  
  // Function to show critical breakthrough information when clicking on red lines
  function showBreakthroughInfo(crisisId) {
    // Create or get crisis panel
    let crisisPanel = document.getElementById('crisis-panel');
    if (!crisisPanel) {
      crisisPanel = document.createElement('div');
      crisisPanel.id = 'crisis-panel';
      crisisPanel.className = 'crisis-panel';
      document.body.appendChild(crisisPanel);
    }
    
    // Get breakthrough element data
    const breakthrough = document.getElementById(`${crisisId}-breakthrough`);
    if (!breakthrough) return;
    
    const date = breakthrough.getAttribute('data-date');
    const title = breakthrough.getAttribute('data-title');
    
    // Crisis specific content
    const crisisContent = {
      'diagnosis': {
        description: "Following seizures, diagnosed with Psychogenic Non-Epileptic Seizures (PNES), a type of Functional Neurological Disorder (FND) at UK Hospital's level 4 epilepsy unit. After diagnosis, was discharged without coordinated care plan.",
        quote: "I was discharged to navigate a labyrinth of fragmented services alone. I was advised to go to the University Health Services (UHS) for Cognitive Behavioral Therapy because there was nothing, they could offer me.",
        details: "The diagnosis of FND indicated a serious condition requiring coordinated care, but resulted in healthcare fragmentation:",
        timeline: [
          { date: "Jan 2023", content: "Initial seizures led to ER visit and overnight stay" },
          { date: "Late Jan 2023", content: "Video-EEG monitoring at UK's level 4 epilepsy unit" },
          { date: "End of Jan 2023", content: "PNES diagnosis with no treatment plan" },
          { date: "Feb 2023", content: "UHS referral to UK Counseling Center (UKCC)" },
          { date: "Mar 2023", content: "UKCC pointed out potential Autism but terminated care citing 'lack of expertise'" }
        ],
        individualImpact: [
          "Left without medical management protocols for a rare disease",
          "Forced to navigate disconnected university health systems alone",
          "Initial disability accommodations impacted by lack of coordinated diagnosis documentation",
          "Foreign student status added barriers to accessing external healthcare",
          "Deteriorating health due to lack of treatment plan"
        ],
        institutionalImpact: [
          "Revealed absence of care coordination protocols for complex conditions",
          "No clear responsibility assignment between departments",
          "Exposed gaps between healthcare units and academic accommodations processes",
          "Failed to meet ethical standards of patient care",
          "Violated ADA/Section 504 requirements for appropriate accommodations"
        ]
      },
      'handcuffing': {
        description: "After experiencing a seizure, self-presented to University Health Services (UHS). Instead of appropriate care, was stripped into a hospital gown at Good Samaritan Hospital, then handcuffed and transported by sheriffs to Eastern State Hospital.",
        quote: "I was stripped into a hospital gown at Good Samaritan Hospital, then handcuffed and transported by sheriffs to Eastern State Hospital in the middle of the night. I looked out the window as I wondered how on earth, I had gotten to this point of being taken like a criminal to an unfamiliar location in a foreign country.",
        details: "Despite being within UK's healthcare system with documented PNES history, staff ignored crucial medical information and implemented harmful protocols:",
        timeline: [
          { date: "Sep 2023", content: "Seizure in lab, leading to mental health deterioration" },
          { date: "Sep 2023", content: "Self-presented to UHS seeking help, with 'JESUS' written on wrists to prevent self-harm" },
          { date: "Sep 2023 (night)", content: "Stripped into hospital gown and handcuffed" },
          { date: "Sep 2023 (late night)", content: "Transported by sheriff to Eastern State Hospital" },
          { date: "Sep 2023", content: "After hours in freezing room, experienced back-to-back seizures that were ignored" },
          { date: "Sep 2023", content: "Subject to traumatic and inappropriate ER interventions" }
        ],
        individualImpact: [
          "Traumatic experience of being criminalized during medical crisis",
          "Physical injuries including chest pain lasting a month and neck sprain",
          "Severe PTSD and exacerbation of existing conditions",
          "Lost trust in university healthcare system",
          "International student vulnerabilities exploited by system"
        ],
        institutionalImpact: [
          "Violation of patient dignity and rights",
          "Failure to follow established medical protocols",
          "Electronic health record system failures with life-threatening consequences",
          "Improper use of law enforcement for medical situation",
          "Potential legal liability for inappropriate patient care"
        ]
      },
      'suicide': {
        description: "After months of institutional neglect and deteriorating mental health, attempted suicide. Rather than seeking institutional help again, self-harmed with a razor while on a call with a friend who intervened.",
        quote: "I could not turn myself in again, I would rather die. Consequently, as I got out a brand-new razor and surveyed my wrist, I called a friend while I watched how my green pulsing vein flayed layer by layer with each slice.",
        details: "This crisis represented the culmination of institutional failures across multiple university systems:",
        timeline: [
          { date: "Dec 2023", content: "Increasing depression and anxiety from institutional barriers" },
          { date: "Jan 1, 2024", content: "Suicide attempt with razor while on phone with friend" },
          { date: "Jan 2024", content: "Friend intervened and took to ER" },
          { date: "Jan 26, 2024", content: "Medical notes indicate 'emotionally exhausted for several months' and 'thoughts of not wanting to wake up more consistently present'" },
          { date: "Jan 2024", content: "Diagnosed with Major Depressive Disorder (MDD) and Chronic Fatigue Syndrome (CFS)" }
        ],
        individualImpact: [
          "Physical self-harm and near-death experience",
          "Additional psychiatric diagnoses beyond original condition",
          "Terror of seeking institutional help due to previous traumatic experiences",
          "Academic progress severely impacted by health crisis",
          "International student isolated from support systems"
        ],
        institutionalImpact: [
          "Direct result of systemic failures to provide appropriate accommodations",
          "Demonstrated lethal consequences of fragmented support systems",
          "Created significant legal liability for the university",
          "Exposed complete failure of mental health safety net",
          "Revealed serious ADA/Section 504 compliance failures"
        ]
      },
      'assistantship': {
        description: "Principal Investigator (PI) terminated research assistantship without any accommodation deliberation process. When asked about future plans, PI responded with 'I don't know.' Director of Graduate Studies (DGS) later suggested Master's as the only option.",
        quote: "My PI was done with me, my DGS couldn't care less, the message was clear: get out, PhD research in UKY is no place for people like you.",
        details: "This event demonstrated how the lack of disability accommodation structures in research environments led to discrimination:",
        timeline: [
          { date: "Dec 2023", content: "PI stopped responding to emails about remote meetings and flexible lab schedule" },
          { date: "Feb 2024", content: "Research assistantship terminated without accommodation process" },
          { date: "Feb 2024", content: "When asked about future beyond funding end in June, PI responded 'I don't know'" },
          { date: "May 2024", content: "DGS suggested Master's as only option rather than accommodation" },
          { date: "May 2024", content: "No interest shown in exploring accommodations for PhD continuation" }
        ],
        individualImpact: [
          "Loss of critical financial support as international student",
          "Research progress halted without accommodation exploration",
          "Career path threatened by forced degree downgrade",
          "Financial crisis on top of health crisis",
          "Further deterioration of mental health due to academic rejection"
        ],
        institutionalImpact: [
          "Clear violation of ADA/Section 504 requirements for academic accommodations",
          "Revealed absence of research accommodation protocols",
          "Demonstrated disability discrimination in graduate education",
          "Failed to engage in required interactive accommodation process",
          "Created additional potential legal liability"
        ]
      },
      'investigation': {
        description: "Office of Equal Opportunity (OEO) began investigation but provided no interim protection or accommodations. Investigation continued without regard for protecting the complainant, who was left without support.",
        quote: "The so-called investigation continued without regard for protection and supporting of the student who was potentially being discriminated against. Like a police investigation with the prime witness left to roam around in the same neighborhood of the crime; very trustworthy according to UKY standards.",
        details: "This process revealed the fundamental failures in the university's discrimination complaint process:",
        timeline: [
          { date: "Aug 2024", content: "OEO investigation began after staff member raised concerns" },
          { date: "Aug 2024", content: "No interim measures or protections provided" },
          { date: "Aug 22, 2024", content: "Academic ombud suggested registration with DGS as default advisor" },
          { date: "Aug 23, 2024", content: "DGS stated inability to evaluate research without primary advisor" },
          { date: "Aug 27, 2024", content: "DRC consultant suggested options were running out" },
          { date: "Dec 2024", content: "After 5 months, OEO determined everything was 'fair'" }
        ],
        individualImpact: [
          "Lost entire semester waiting for investigation outcome",
          "Health deteriorated further due to stress of unresolved situation",
          "Experience of circular referrals between offices without resolution",
          "Increased burden of disability through institutional inaction",
          "Further isolation and academic marginalization"
        ],
        institutionalImpact: [
          "Demonstrated procedural failures in discrimination complaint process",
          "Revealed absence of interim protection protocols",
          "Exposed coordination failures between university offices",
          "Created documentation of systemic discrimination",
          "Further violation of ADA/Section 504 requirements"
        ]
      }
    };
    
    // Create crisis panel content
    crisisPanel.innerHTML = `
      <div class="crisis-header">
        <h2 class="crisis-title">${title}</h2>
        <span class="crisis-date">${date}</span>
        <button class="close-panel" onclick="document.getElementById('crisis-panel').style.display='none';">&times;</button>
      </div>
      
      <div class="crisis-content">
        <p>${crisisContent[crisisId].description}</p>
        <p class="crisis-quote">${crisisContent[crisisId].quote}</p>
        
        <div class="crisis-details">
          <h3>What Happened</h3>
          <p>${crisisContent[crisisId].details}</p>
          
          <div class="crisis-timeline">
            ${crisisContent[crisisId].timeline.map(entry => `
              <div class="timeline-entry">
                <div class="entry-date">${entry.date}</div>
                <div class="entry-content">${entry.content}</div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="crisis-impact">
          <div class="impact-tabs">
            <button class="impact-tab active" onclick="switchImpactTab(this, 'individual')">Individual Impact</button>
            <button class="impact-tab" onclick="switchImpactTab(this, 'institutional')">Institutional Impact</button>
          </div>
          
          <div class="impact-content active" id="individual-impact">
            <ul>
              ${crisisContent[crisisId].individualImpact.map(impact => `<li>${impact}</li>`).join('')}
            </ul>
          </div>
          
          <div class="impact-content" id="institutional-impact">
            <ul>
              ${crisisContent[crisisId].institutionalImpact.map(impact => `<li>${impact}</li>`).join('')}
            </ul>
          </div>
        </div>
        
        <button class="view-full-impact-btn" onclick="showFullImpactPanel('${crisisId}')">View Full System Analysis</button>
      </div>
    `;
    
    // Show the overlay
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    
    // Show the crisis panel
    crisisPanel.style.display = 'block';
  }
  
  // Function to switch between impact tabs
  function switchImpactTab(tabButton, tabName) {
    // Get all tabs and content elements
    const tabs = document.querySelectorAll('.impact-tab');
    const contents = document.querySelectorAll('.impact-content');
    
    // Remove active class from all tabs and contents
    tabs.forEach(tab => tab.classList.remove('active'));
    contents.forEach(content => content.classList.remove('active'));
    
    // Add active class to selected tab
    tabButton.classList.add('active');
    
    // Show selected content
    document.getElementById(`${tabName}-impact`).classList.add('active');
  }
  
  // Function to display full impact analysis panel
  function showFullImpactPanel(id) {
    // This would show a more comprehensive impact analysis
    // For demo, we'll use alert
    alert(`Full system impact analysis for ${id} would be displayed here, including detailed metrics, compliance failures, and systemic recommendations.`);
  }
  
  // Function to update emergency recommendations based on selected individual challenges
  function updateIndividualRecommendations() {
    // Get active symptom buttons
    const activeButtons = document.querySelectorAll('#individual .symptom-button.active');
    
    // Get custom description
    const textarea = document.querySelector('#individual .custom-description');
    if (!textarea) return;
    
    const customText = textarea.value.toLowerCase();
    
    // Array to collect unique interventions
    const interventions = new Set();
    
    // Institutional intervention suggestions
    const interventionsBySystem = {
      'healthcare': [
        "Request complete copies of all medical records",
        "Ask for a patient advocate to coordinate care",
        "Document all treatment recommendations and referrals",
        "Create an emergency care plan with specific protocols for FND/PNES",
        "Bring a trusted friend to all medical appointments"
      ],
      'accommodation': [
        "Request accommodations in writing with delivery confirmation",
        "Ask which office is responsible for implementation",
        "Document all accommodation discussions and promises",
        "CC multiple departments in all accommodation communications",
        "Request specific accommodations for research settings"
      ],
      'academic': [
        "Request written clarification of academic expectations",
        "Document all meetings with faculty and advisors",
        "Ask the ombudsperson to facilitate department communications",
        "Request accommodations specific to research environment",
        "Create a written work plan with flexibility built in"
      ],
      'coordination': [
        "Ask ombudsperson to coordinate a multi-office meeting",
        "Create a contact list of all involved departments",
        "Request written clarification of each office's responsibilities",
        "Document all instances of being referred between offices",
        "Involve external advocacy organization for support"
      ],
      'mental': [
        "Contact crisis services if experiencing suicidal thoughts: 988",
        "Document impact of institutional stress on your health",
        "Request medical leave paperwork if needed",
        "Ask for referrals to external mental health providers",
        "Practice grounding techniques during stressful interactions"
      ],
      'financial': [
        "Contact financial aid office about hardship options",
        "Document all additional expenses caused by disability barriers",
        "Request emergency funding for disability-related needs",
        "Research external scholarships for disabled students",
        "Consider filing for disability-related loan deferment"
      ],
      'visa': [
        "Contact international student office about medical reduced course load",
        "Document all communications about visa status",
        "Request written clarification of visa requirements during medical issues",
        "Connect with international student advocacy groups",
        "Consult with immigration attorney about medical exceptions"
      ]
    };
    
    // Keyword map for analyzing text input
    const keywordMap = {
      // Healthcare related keywords
      "hospital": "healthcare", "doctor": "healthcare", "medical": "healthcare", 
      "diagnosis": "healthcare", "treatment": "healthcare", "seizure": "healthcare",
      "emergency": "healthcare", "medication": "healthcare", "pnes": "healthcare",
      "fnd": "healthcare", "neurological": "healthcare", "functional": "healthcare",
      
      // Accommodation related keywords
      "accommodation": "accommodation", "drc": "accommodation", "disability": "accommodation",
      "ada": "accommodation", "access": "accommodation", "barrier": "accommodation",
      "section 504": "accommodation", "modification": "accommodation",
      
      // Academic related keywords
      "professor": "academic", "advisor": "academic", "research": "academic",
      "lab": "academic", "course": "academic", "class": "academic", "department": "academic",
      "pi": "academic", "dgs": "academic", "assistantship": "academic", "termination": "academic",
      
      // Coordination related keywords
      "coordinate": "coordination", "refer": "coordination", "office": "coordination",
      "bureaucracy": "coordination", "paperwork": "coordination", "process": "coordination",
      "referral": "coordination", "silo": "coordination", "fragmented": "coordination",
      
      // Mental health related keywords
      "stress": "mental", "anxiety": "mental", "depression": "mental", 
      "suicide": "mental", "therapist": "mental", "counselor": "mental",
      "overwhelm": "mental", "crisis": "mental", "mdd": "mental", 
      "cptsd": "mental", "trauma": "mental", "ukcc": "mental",
      
      // Financial related keywords
      "money": "financial", "fund": "financial", "pay": "financial",
      "cost": "financial", "afford": "financial", "expense": "financial",
      "stipend": "financial", "tuition": "financial", "insurance": "financial",
      
      // International/visa related keywords
      "visa": "visa", "international": "visa", "foreign": "visa",
      "country": "visa", "immigrant": "visa", "status": "visa",
      "i-20": "visa", "sevis": "visa", "home": "visa"
    };
    
    // Add interventions from active buttons
    activeButtons.forEach(button => {
      const system = button.dataset.system;
      if (system && interventionsBySystem[system]) {
        interventionsBySystem[system].forEach(intervention => {
          interventions.add(intervention);
        });
      }
    });
    
    // Add interventions based on text analysis
    for (const [keyword, system] of Object.entries(keywordMap)) {
      if (customText.includes(keyword) && interventionsBySystem[system]) {
        interventionsBySystem[system].forEach(intervention => {
          interventions.add(intervention);
        });
      }
    }
    
    // Update the recommendations display
    const immediateList = document.getElementById('individual-immediate-interventions');
    if (!immediateList) return;
    
    // Clear previous recommendations
    immediateList.innerHTML = '';
    
    // Add new recommendations
    if (interventions.size > 0) {
      Array.from(interventions).forEach(intervention => {
        const li = document.createElement('li');
        li.textContent = intervention;
        immediateList.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.textContent = "Click a button above or describe what you're experiencing";
      immediateList.appendChild(li);
    }
  }
  
  // Function to initialize the individual tab
  function initializeIndividualTab() {
    try {
      // Set up symptom buttons for individual tab
      const buttons = document.querySelectorAll('#individual .symptom-button');
      if (buttons.length > 0) {
        buttons.forEach(button => {
          button.addEventListener('click', function() {
            // Toggle active state
            this.classList.toggle('active');
            
            // Update recommendations based on selected systems
            updateIndividualRecommendations();
          });
        });
      }
      
      // Set up text area listener
      const textarea = document.querySelector('#individual .custom-description');
      if (textarea) {
        const typingIndicator = document.querySelector('#individual .typing-indicator');
        let typingTimer;
        
        textarea.addEventListener('keyup', function() {
          // Show typing indicator
          if (typingIndicator) {
            typingIndicator.classList.add('visible');
            typingIndicator.textContent = "Analyzing your situation...";
          }
          
          clearTimeout(typingTimer);
          typingTimer = setTimeout(function() {
            // Update recommendations when typing stops
            updateIndividualRecommendations();
            
            // Update typing indicator
            if (typingIndicator) {
              if (textarea.value.trim() !== '') {
                typingIndicator.textContent = "Analysis complete";
                setTimeout(() => {
                  typingIndicator.classList.remove('visible');
                }, 1500);
              } else {
                typingIndicator.classList.remove('visible');
              }
            }
          }, 1000);
        });
      }
      
      // Make hub respond to panel changes
      const positionSlider = document.getElementById('position-slider');
      const variabilitySlider = document.getElementById('variability-slider');
      
      if (positionSlider && variabilitySlider) {
        // Update individual hub when main hub changes
        positionSlider.addEventListener('input', function() {
          const position = parseInt(this.value);
          const individualHubPosition = document.getElementById('individual-hub-position');
          if (individualHubPosition) {
            individualHubPosition.textContent = position >= 0 ? `+${position}` : position;
          }
        });
        
        variabilitySlider.addEventListener('input', function() {
          const variability = parseInt(this.value);
          const individualHubVariability = document.getElementById('individual-hub-variability');
          if (individualHubVariability) {
            individualHubVariability.textContent = `±${variability}`;
          }
        });
        
        // Apply hub changes to individual hub
        const applyButton = document.getElementById('apply-hub-changes');
        if (applyButton) {
          applyButton.addEventListener('click', function() {
            const position = parseInt(positionSlider.value);
            const variability = parseInt(variabilitySlider.value);
            
            // Update individual hub display
            const individualHubPosition = document.getElementById('individual-hub-position');
            const individualHubVariability = document.getElementById('individual-hub-variability');
            
            if (individualHubPosition) individualHubPosition.textContent = position >= 0 ? `+${position}` : position;
            if (individualHubVariability) individualHubVariability.textContent = `±${variability}`;
            
            // Update individual hub visualization
            updateIndividualHubVisualization(position, variability);
          });
        }
      }
      
    } catch (error) {
      console.log("Error initializing individual tab:", error);
    }
  }
  
  // Function to update individual hub visualization
  function updateIndividualHubVisualization(position, variability) {
    const hubCircle = document.getElementById('individual-hub-circle');
    const hubBorder = document.getElementById('individual-hub-border');
    
    if (hubCircle && hubBorder) {
      // Calculate color based on position (0 is green, extremes are red/blue)
      let hubColor;
      const absPosition = Math.abs(position);
      
      if (absPosition < 2) {
        hubColor = "#4caf50"; // Green for balanced
      } else if (absPosition < 4) {
        hubColor = position > 0 ? "#8bc34a" : "#2196f3"; // Light green/blue for slight imbalance
      } else if (absPosition < 6) {
        hubColor = position > 0 ? "#ffc107" : "#03a9f4"; // Yellow/blue for moderate imbalance
      } else if (absPosition < 8) {
        hubColor = position > 0 ? "#ff9800" : "#673ab7"; // Orange/purple for significant imbalance
      } else {
        hubColor = position > 0 ? "#f44336" : "#3f51b5"; // Red/indigo for extreme imbalance
      }
      
      // Update hub color
      hubCircle.setAttribute("fill", hubColor);
      
      // Update hub border thickness based on variability (stability)
      // Higher variability (less stability) = thinner border
      const borderWidth = Math.max(2, 15 - variability);
      hubBorder.setAttribute("stroke-width", borderWidth);
      
      // Also subtly adjust hub size based on stability (more stable = slightly larger)
      const hubSize = 70 - (variability / 2); // Base size is 70, reduce slightly with higher variability
      hubCircle.setAttribute("r", hubSize);
      hubBorder.setAttribute("r", hubSize + 5); // Border is slightly larger than hub
    }
  }
  
  // Add initialization to existing document ready handler
  document.addEventListener('DOMContentLoaded', function() {
    // The existing initialization code from the sensory tab will run
    
    // Then add our individual tab initialization
    initializeIndividualTab();
    
    // Hide timeline and analysis sections initially
    const timeline = document.querySelector('.individual-timeline');
    if (timeline) timeline.style.display = 'none';
    
    const analytics = document.querySelector('.individual-case-analytics');
    if (analytics) analytics.style.display = 'none';
  });

  // Emergency panel recommendations for the Individual tab - paste this in your script section
const individualInterventionsBySystem = {
  'healthcare': [
    "Request complete copies of all medical records",
    "Ask for a patient advocate to coordinate care",
    "Document all treatment recommendations and referrals",
    "Create an emergency care plan with specific protocols for FND/PNES",
    "Bring a trusted friend to all medical appointments",
    "Request a neurologist experienced with functional disorders"
  ],
  'accommodation': [
    "Request accommodations in writing with delivery confirmation",
    "Ask which office is responsible for implementation",
    "Document all accommodation discussions and promises",
    "CC multiple departments in all accommodation communications",
    "Request specific accommodations for research settings",
    "Ask for flexible attendance and remote participation options"
  ],
  'academic': [
    "Request written clarification of academic expectations",
    "Document all meetings with faculty and advisors",
    "Ask the ombudsperson to facilitate department communications",
    "Request accommodations specific to research environment",
    "Create a written work plan with flexibility built in",
    "Inquire about deadline extensions before they're needed"
  ],
  'coordination': [
    "Ask ombudsperson to coordinate a multi-office meeting",
    "Create a contact list of all involved departments",
    "Request written clarification of each office's responsibilities",
    "Document all instances of being referred between offices",
    "Involve external advocacy organization for support",
    "Request a single point of contact for your case"
  ],
  'mental': [
    "Contact crisis services if experiencing suicidal thoughts: 988",
    "Document impact of institutional stress on your health",
    "Request medical leave paperwork if needed",
    "Ask for referrals to external mental health providers",
    "Practice grounding techniques during stressful interactions",
    "Create a safety plan with trusted people in your network"
  ],
  'financial': [
    "Contact financial aid office about hardship options",
    "Document all additional expenses caused by disability barriers",
    "Request emergency funding for disability-related needs",
    "Research external scholarships for disabled students",
    "Consider filing for disability-related loan deferment",
    "Request itemized invoices for all medical costs"
  ],
  'visa': [
    "Contact international student office about medical reduced course load",
    "Document all communications about visa status",
    "Request written clarification of visa requirements during medical issues",
    "Connect with international student advocacy groups",
    "Consult with immigration attorney about medical exceptions",
    "Ask about extensions for international student requirements"
  ]
};

// OVERLAP START
function showFullImpactPanel(id) {
  // Create or get full impact panel
  let impactPanel = document.getElementById('full-impact-panel');
  if (!impactPanel) {
    impactPanel = document.createElement('div');
    impactPanel.id = 'full-impact-panel';
    impactPanel.className = 'crisis-panel';
    document.body.appendChild(impactPanel);
  }
  
  // Systemic impact data
  const systemicImpact = {
    'healthcare': {
      title: "Healthcare System Impact Analysis",
      systemFailures: [
        "Fragmented electronic health records prevented continuity of care",
        "No protocols for rare conditions like FND/PNES",
        "No care coordination between university health units",
        "Inappropriate psychiatric intervention for neurological symptoms",
        "Medical information silos leading to dangerous treatment errors"
      ],
      recommendations: [
        "Implement integrated EHR system across all university health units",
        "Create protocols for complex/rare condition management",
        "Assign care coordinators for students with multiple diagnoses",
        "Establish consultation team for complex cases",
        "Develop emergency protocols for FND/PNES that prevent harmful interventions"
      ],
      metrics: {
        "Coordination Failures": 12,
        "Treatment Delays": "Average 45 days",
        "Information Handoff Errors": 8,
        "Patient Safety Incidents": 3,
        "Policy Gaps Identified": 5
      }
    },
    'drc': {
      title: "Disability Resources System Impact Analysis",
      systemFailures: [
        "Accommodation letters not applicable to research settings",
        "No enforcement mechanism for accommodations",
        "Limited understanding of complex/invisible disabilities",
        "No integration with academic departments",
        "Failure to advise on graduate-specific accommodations"
      ],
      recommendations: [
        "Develop research-specific accommodation protocols",
        "Create accommodation enforcement procedures",
        "Establish regular training on complex disabilities",
        "Implement liaison system with academic departments",
        "Develop graduate-specific accommodation guidelines"
      ],
      metrics: {
        "Research Settings Without Coverage": "100%",
        "Unenforced Accommodations": 7,
        "Referrals Without Resolution": 9,
        "Policy Gaps Identified": 4,
        "Coordination Failures": 8
      }
    },
// OVERLAP END

    'academic': {
      title: "Academic Department System Impact Analysis",
      systemFailures: [
        "No training for faculty on disability accommodations",
        "Unilateral termination of accommodated students",
        "No clear procedure for research accommodations",
        "Lack of accessibility in research environments",
        "Discrimination masquerading as 'academic standards'"
      ],
      recommendations: [
        "Mandatory faculty training on disability accommodations",
        "Create clear research accommodation guidelines",
        "Implement termination review process for disabled students",
        "Establish accessibility standards for research environments",
        "Regular department audits for disability inclusion"
      ],
      metrics: {
        "Faculty Trained in Accommodations": "0%",
        "Accessible Research Labs": "15%",
        "Accommodation Implementation Rate": "32%",
        "Discrimination Incidents": 3,
        "Policy Gaps Identified": 6
      }
    },
    'gradschool': {
      title: "Graduate School System Impact Analysis",
      systemFailures: [
        "No policies for graduate-specific accommodations",
        "Downgrading degrees instead of providing accommodations",
        "No clear responsibility for implementing accommodations",
        "Interdisciplinary committee barriers for disability research",
        "Lack of disability-knowledgeable advisors"
      ],
      recommendations: [
        "Develop graduate-specific accommodation policies",
        "Create clear responsibility assignment for accommodations",
        "Establish disability as valid research focus",
        "Facilitate interdisciplinary committees for disability research",
        "Train faculty advisors on disability-inclusive mentoring"
      ],
      metrics: {
        "Disabled Graduate Retention Rate": "37%",
        "Accommodation Implementation Rate": "28%",
        "Faculty Trained on Disability Issues": "12%",
        "Successful Accommodated Graduate Students": 3,
        "Policy Gaps Identified": 7
      }
    },
    'mentalhealth': {
      title: "Mental Health Services System Impact Analysis",
      systemFailures: [
        "Premature termination of services without transition",
        "Lack of expertise in complex conditions",
        "No coordination with academic accommodations",
        "Inadequate crisis response protocols",
        "External referrals without affordability consideration"
      ],
      recommendations: [
        "Develop proper service transition protocols",
        "Establish expertise development for complex cases",
        "Create coordination system with academic accommodations",
        "Improve crisis response for disabled students",
        "Develop sliding scale partnerships with community providers"
      ],
      metrics: {
        "Premature Service Terminations": 15,
        "Average Wait Time": "21 days",
        "Crisis Response Failures": 2,
        "Coordination Attempts": 8,
        "Successful Coordination Events": 1
      }
    },
    'oeo': {
      title: "Equal Opportunity Office System Impact Analysis",
      systemFailures: [
        "Investigations without interim protections",
        "No enforced timelines for investigations",
        "Narrow interpretation of disability discrimination",
        "No coordination with accommodation processes",
        "Inadequate remedies for discriminatory incidents"
      ],
      recommendations: [
        "Implement mandatory interim protections",
        "Establish and enforce investigation timelines",
        "Broaden disability discrimination understanding",
        "Create coordination protocol with DRC",
        "Develop stronger remedies for discrimination findings"
      ],
      metrics: {
        "Average Investigation Length": "147 days",
        "Interim Protections Provided": "0%",
        "Discrimination Findings Rate": "12%",
        "Successful Remedies Implemented": 0,
        "Policy Gaps Identified": 5
      }
    },
    'ada': {
      title: "ADA Compliance System Impact Analysis",
      systemFailures: [
        "Deflection of graduate accommodation responsibility",
        "No implementation authority for accommodations",
        "Narrow interpretation of 'reasonable accommodations'",
        "Lack of research environment accessibility standards",
        "No regular compliance audits"
      ],
      recommendations: [
        "Establish clear responsibility for graduate accommodations",
        "Create enforcement authority for accommodations",
        "Broaden accommodation interpretations",
        "Develop research accessibility standards",
        "Implement regular compliance audits"
      ],
      metrics: {
        "Accommodation Implementation Rate": "24%",
        "Compliance Audits Conducted": 0,
        "Successful Accommodation Appeals": 1,
        "Documented Compliance Issues": 12,
        "Policy Gaps Identified": 6
      }
    },
    'admin': {
      title: "Administrative Offices System Impact Analysis",
      systemFailures: [
        "Circular referrals without resolution",
        "Ambiguous jurisdictional boundaries",
        "Siloed departments with no collaboration",
        "Procedure prioritized over actual solutions",
        "No case management for complex situations"
      ],
      recommendations: [
        "Implement case management for complex needs",
        "Establish clear responsibility boundaries",
        "Create cross-department collaboration protocols",
        "Develop outcome-focused approaches",
        "Regular coordination training for staff"
      ],
      metrics: {
        "Circular Referrals Documented": 14,
        "Average Offices Involved Per Issue": 4.7,
        "Successful Resolutions": 2,
        "Average Resolution Time": "93 days",
        "Policy Gaps Identified": 8
      }
    },
    'diagnosis': {
      title: "PNES Diagnosis Crisis Impact Analysis",
      systemFailures: [
        "No care coordination after rare disease diagnosis",
        "Fragmented referral system with no follow-through",
        "No medical management protocols for FND/PNES",
        "Mental health services inadequate for neuropsychiatric condition",
        "International student needs ignored in healthcare planning"
      ],
      recommendations: [
        "Create post-diagnosis care coordination protocol",
        "Develop seamless referral and tracking system",
        "Establish FND/PNES management guidelines",
        "Train mental health staff on neuropsychiatric conditions",
        "Address international student barriers in healthcare planning"
      ],
      metrics: {
        "Days Without Treatment Plan": 45,
        "Referrals Without Follow-up": 3,
        "Coordination Attempts": 7,
        "Successful Coordinations": 0,
        "Health Deterioration Incidents": 2
      }
    },
    'handcuffing': {
      title: "Psychiatric Detention Crisis Impact Analysis",
      systemFailures: [
        "EHR failure to flag critical medical information",
        "Improper use of law enforcement for medical condition",
        "Missing protocols for neurological vs. psychiatric presentation",
        "International student vulnerabilities exploited by system",
        "Traumatic interventions worsening underlying condition"
      ],
      recommendations: [
        "Implement critical information flagging in EHR",
        "Create appropriate medical transport protocols",
        "Develop differential response guidelines for complex presentations",
        "Establish international student protections in crisis",
        "Train staff on trauma-informed crisis response"
      ],
      metrics: {
        "Policy Violations": 5,
        "Patient Safety Events": 3,
        "Documentation Failures": 8,
        "Staff Training Gaps": 4,
        "Healthcare Rights Violations": 6
      }
    },
    'suicide': {
      title: "Suicide Attempt Crisis Impact Analysis",
      systemFailures: [
        "Complete failure of mental health safety net",
        "Previous traumatic interventions preventing help-seeking",
        "No follow-up system for high-risk patients",
        "International student isolation factors ignored",
        "Accommodation failures contributing to crisis"
      ],
      recommendations: [
        "Redesign mental health safety net systems",
        "Create trauma-informed crisis response protocols",
        "Implement mandatory follow-up for high-risk cases",
        "Address international student isolation factors",
        "Integrate accommodation and mental health systems"
      ],
      metrics: {
        "Warning Signs Missed": 12,
        "Failed Intervention Points": 7,
        "System Disconnections Identified": 9,
        "Protocol Gaps": 6,
        "Coordination Failures": 14
      }
    },
    'assistantship': {
      title: "Assistantship Termination Crisis Impact Analysis",
      systemFailures: [
        "No accommodation process for research settings",
        "Discriminatory termination without review",
        "Graduate School failure to oversee department actions",
        "No interactive process for academic accommodations",
        "International student vulnerabilities exploited"
      ],
      recommendations: [
        "Create research accommodation protocols",
        "Establish termination review process for disabled students",
        "Implement Graduate School oversight of departments",
        "Require documented interactive accommodation process",
        "Develop protections for international disabled students"
      ],
      metrics: {
        "ADA Violations": 5,
        "Section 504 Violations": 7,
        "Documentation Failures": 9,
        "Financial Impact": "$18,000+",
        "Career Impact": "Severe"
      }
    },
    'investigation': {
      title: "OEO Investigation Crisis Impact Analysis",
      systemFailures: [
        "No interim protections during investigation",
        "Excessive investigation timeline without updates",
        "Narrow interpretation of discrimination evidence",
        "Complainant left to coordinate their own protection",
        "No accountability for investigation failures"
      ],
      recommendations: [
        "Mandate interim protections during investigations",
        "Establish and enforce investigation timelines",
        "Broaden interpretation of discrimination evidence",
        "Implement case management for complainants",
        "Create accountability metrics for investigations"
      ],
      metrics: {
        "Days Without Protection": 147,
        "Communication Failures": 12,
        "Policy Violations": 8,
        "Health Deterioration Events": 3,
        "Academic Time Lost": "1 semester"
      }
    }
  };
  
  // Get the relevant impact data
  const impactData = systemicImpact[id] || {};
  
  // Create impact panel content
  impactPanel.innerHTML = `
    <div class="crisis-header">
      <h2 class="crisis-title">${impactData.title || 'System Impact Analysis'}</h2>
      <button class="close-panel" onclick="document.getElementById('full-impact-panel').style.display='none';">&times;</button>
    </div>
    
    <div class="crisis-content">
      <div class="impact-section">
        <h3>System Failures Identified</h3>
        <ul>
          ${(impactData.systemFailures || []).map(failure => `<li>${failure}</li>`).join('')}
        </ul>
      </div>
      
      <div class="impact-section">
        <h3>Systemic Recommendations</h3>
        <ul>
          ${(impactData.recommendations || []).map(rec => `<li>${rec}</li>`).join('')}
        </ul>
      </div>
      
      <div class="impact-section">
        <h3>Key Metrics</h3>
        <div class="metrics-grid">
          ${Object.entries(impactData.metrics || {}).map(([key, value]) => `
            <div class="metric-item">
              <div class="metric-value">${value}</div>
              <div class="metric-label">${key}</div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <div class="impact-section">
        <h3>Compliance Implications</h3>
        <p>This analysis indicates potential violations of:</p>
        <ul>
          <li>Americans with Disabilities Act (ADA) Title II</li>
          <li>Section 504 of the Rehabilitation Act</li>
          <li>University's own stated policies on accommodations</li>
          <li>Kentucky Civil Rights Act (KRS § 344.010 et seq.)</li>
        </ul>
      </div>
    </div>
  `;
  
  // Add styles for metrics grid
  const styleElement = document.createElement('style');
  styleElement.textContent = `
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .metric-item {
      background: #f0f7ff;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #1565c0;
      margin-bottom: 5px;
    }
    
    .metric-label {
      font-size: 14px;
      color: #555;
    }
    
    .impact-section {
      margin-bottom: 25px;
    }
  `;
  document.head.appendChild(styleElement);
  
  // Show the overlay
  const overlay = document.getElementById('panel-overlay');
  if (overlay) overlay.style.display = 'block';
  
  // Show the impact panel
  impactPanel.style.display = 'block';
}

// Enhanced update for recommendations using the new interventions dictionary
function updateIndividualRecommendations() {
  // Get active symptom buttons
  const activeButtons = document.querySelectorAll('#individual .symptom-button.active');
  
  // Get custom description
  const textarea = document.querySelector('#individual .custom-description');
  if (!textarea) return;
  
  const customText = textarea.value.toLowerCase();
  
  // Array to collect unique interventions
  const interventions = new Set();
  
  // Keyword map for analyzing text input
  const keywordMap = {
    // Healthcare related keywords
    "hospital": "healthcare", "doctor": "healthcare", "medical": "healthcare", 
    "diagnosis": "healthcare", "treatment": "healthcare", "seizure": "healthcare",
    "emergency": "healthcare", "medication": "healthcare", "pnes": "healthcare",
    "fnd": "healthcare", "neurological": "healthcare", "functional": "healthcare",
    
    // Accommodation related keywords
    "accommodation": "accommodation", "drc": "accommodation", "disability": "accommodation",
    "ada": "accommodation", "access": "accommodation", "barrier": "accommodation",
    "section 504": "accommodation", "modification": "accommodation",
    
    // Academic related keywords
    "professor": "academic", "advisor": "academic", "research": "academic",
    "lab": "academic", "course": "academic", "class": "academic", "department": "academic",
    "pi": "academic", "dgs": "academic", "assistantship": "academic", "termination": "academic",
    
    // Coordination related keywords
    "coordinate": "coordination", "refer": "coordination", "office": "coordination",
    "bureaucracy": "coordination", "paperwork": "coordination", "process": "coordination",
    "referral": "coordination", "silo": "coordination", "fragmented": "coordination",
    
    // Mental health related keywords
    "stress": "mental", "anxiety": "mental", "depression": "mental", 
    "suicide": "mental", "therapist": "mental", "counselor": "mental",
    "overwhelm": "mental", "crisis": "mental", "mdd": "mental", 
    "cptsd": "mental", "trauma": "mental", "ukcc": "mental",
    
    // Financial related keywords
    "money": "financial", "fund": "financial", "pay": "financial",
    "cost": "financial", "afford": "financial", "expense": "financial",
    "stipend": "financial", "tuition": "financial", "insurance": "financial",
    
    // International/visa related keywords
    "visa": "visa", "international": "visa", "foreign": "visa",
    "country": "visa", "immigrant": "visa", "status": "visa",
    "i-20": "visa", "sevis": "visa", "home": "visa"
  };
  
  // Add interventions from active buttons
  activeButtons.forEach(button => {
    const system = button.dataset.system;
    if (system && individualInterventionsBySystem[system]) {
      individualInterventionsBySystem[system].forEach(intervention => {
        interventions.add(intervention);
      });
    }
  });
  
  // Add interventions based on text analysis
  for (const [keyword, system] of Object.entries(keywordMap)) {
    if (customText.includes(keyword) && individualInterventionsBySystem[system]) {
      individualInterventionsBySystem[system].forEach(intervention => {
        interventions.add(intervention);
      });
    }
  }
  
  // Update the recommendations display
  const immediateList = document.getElementById('individual-immediate-interventions');
  if (!immediateList) return;
  
  // Clear previous recommendations
  immediateList.innerHTML = '';
  
  // Add new recommendations
  if (interventions.size > 0) {
    Array.from(interventions).slice(0, 6).forEach(intervention => { // Limit to 6 recommendations for space
      const li = document.createElement('li');
      li.textContent = intervention;
      immediateList.appendChild(li);
    });
  } else {
    const li = document.createElement('li');
    li.textContent = "Click a button above or describe what you're experiencing";
    immediateList.appendChild(li);
  }
}
  </script>
  <!-- Crisis Panels - Add these to the end of your body tag before closing </body> -->
<!-- Crisis Panel for breakthrough events -->
<div id="crisis-panel" class="crisis-panel" style="display: none;">
  <!-- Content will be dynamically generated -->
</div>

<!-- Full Impact Panel for system analysis -->
<div id="full-impact-panel" class="crisis-panel" style="display: none;">
  <!-- Content will be dynamically generated -->
</div>

<!-- Additional CSS for panels -->
<style>
  /* Crisis Panel Styles */
  .crisis-panel {
    display: none;
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    max-width: 700px;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 150;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .crisis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }
  
  .crisis-title {
    margin: 0;
    color: #d32f2f;
    font-size: 24px;
  }
  
  .crisis-date {
    font-style: italic;
    color: #757575;
  }
  
  .crisis-content {
    margin-bottom: 20px;
  }
  
  .crisis-quote {
    font-style: italic;
    font-size: 16px;
    color: #555;
    border-left: 3px solid #d32f2f;
    padding-left: 15px;
    margin: 15px 0;
  }
  
  .crisis-details {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .crisis-impact {
    margin-top: 20px;
  }
  
  .impact-tabs {
    display: flex;
    border-bottom: 1px solid #ccc;
    margin-bottom: 15px;
  }
  
  .impact-tab {
    padding: 8px 15px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }
  
  .impact-tab.active {
    border-bottom: 3px solid #1565c0;
    color: #1565c0;
  }
  
  .impact-content {
    display: none;
  }
  
  .impact-content.active {
    display: block;
  }
  
  .view-full-impact-btn {
    display: block;
    margin: 20px auto;
    padding: 10px 20px;
    background: #1565c0;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
  }
  
  .view-full-impact-btn:hover {
    background: #0d47a1;
  }
  
  /* Timeline entry display styles for crisis panels */
  .crisis-timeline {
    position: relative;
    margin-left: 15px;
    padding-left: 30px;
    border-left: 2px solid #1565c0;
  }
  
  .timeline-entry {
    margin-bottom: 15px;
    position: relative;
  }
  
  .timeline-entry::before {
    content: '';
    position: absolute;
    left: -39px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #1565c0;
    border: 2px solid #fff;
  }
  
  .entry-date {
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 5px;
    font-size: 14px;
  }
  
  .entry-content {
    font-size: 14px;
    color: #555;
  }
  
  /* Section metrics styling */
  .section-metrics {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .section-metrics h3 {
    margin-top: 0;
    color: #1565c0;
    font-size: 18px;
    margin-bottom: 15px;
  }
  
  .slider-container {
    margin-top: 15px;
  }
  
  .slider-row {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .slider-label {
    width: 150px;
    font-size: 14px;
    font-weight: bold;
  }
  
  .slider-input {
    flex-grow: 1;
    margin: 0 15px;
  }
  
  .slider-value {
    width: 70px;
    font-size: 14px;
    text-align: right;
  }
  
  /* Impact analysis styles */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  .metric-item {
    background: #f0f7ff;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .metric-value {
    font-size: 24px;
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 5px;
  }
  
  .metric-label {
    font-size: 14px;
    color: #555;
  }
  
  .impact-section {
    margin-bottom: 25px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .impact-section h3 {
    color: #1565c0;
    margin-top: 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
  }
</style>
<script>
  // This script contains fixes for the individual tab issues

// 1. Fix for "View Full Impact" buttons
// Add this to your existing script
function attachFullImpactButtons() {
  // First make sure the panels exist
  if (!document.getElementById('full-impact-panel')) {
    const panel = document.createElement('div');
    panel.id = 'full-impact-panel';
    panel.className = 'crisis-panel';
    document.body.appendChild(panel);
  }
  
  // Attach click handlers to all "View Full Impact" buttons
  const impactButtons = document.querySelectorAll('.view-full-impact-btn');
  impactButtons.forEach(button => {
    button.onclick = function() {
      const section = button.getAttribute('data-section') || 'healthcare';
      showFullImpactPanel(section);
    };
  });
}

// 2. Fix for Section "Apply Changes" functionality
function enhanceSectionControls() {
  // Update the section to have its own metrics
  const sectionPanel = document.getElementById('section-panel');
  if (sectionPanel) {
    // Add metrics to section panel if they don't exist
    if (!sectionPanel.querySelector('.section-metrics')) {
      const metricsDiv = document.createElement('div');
      metricsDiv.className = 'section-metrics';
      metricsDiv.innerHTML = `
        <h3>Section Metrics</h3>
        <div class="slider-container">
          <div class="slider-row">
            <div class="slider-label">Response Time:</div>
            <input type="range" min="1" max="30" value="14" class="slider-input" id="section-response-time">
            <div class="slider-value" id="section-response-value">14 days</div>
          </div>
          
          <div class="slider-row">
            <div class="slider-label">Solution Speed:</div>
            <input type="range" min="0" max="180" value="60" class="slider-input" id="section-solution-speed">
            <div class="slider-value" id="section-solution-value">60 days</div>
          </div>
          
          <div class="slider-row">
            <div class="slider-label">Related Incidents:</div>
            <input type="range" min="0" max="10" value="3" class="slider-input" id="section-incidents">
            <div class="slider-value" id="section-incidents-value">3</div>
          </div>
        </div>
      `;
      
      // Insert before the "Apply Changes" button
      const applyButton = sectionPanel.querySelector('#apply-section-changes');
      if (applyButton) {
        sectionPanel.insertBefore(metricsDiv, applyButton.parentNode);
      } else {
        sectionPanel.appendChild(metricsDiv);
      }
      
      // Set up the sliders
      const responseSlider = document.getElementById('section-response-time');
      const responseValue = document.getElementById('section-response-value');
      if (responseSlider && responseValue) {
        responseSlider.addEventListener('input', function() {
          responseValue.textContent = `${this.value} days`;
        });
      }
      
      const solutionSlider = document.getElementById('section-solution-speed');
      const solutionValue = document.getElementById('section-solution-value');
      if (solutionSlider && solutionValue) {
        solutionSlider.addEventListener('input', function() {
          solutionValue.textContent = `${this.value} days`;
        });
      }
      
      const incidentsSlider = document.getElementById('section-incidents');
      const incidentsValue = document.getElementById('section-incidents-value');
      if (incidentsSlider && incidentsValue) {
        incidentsSlider.addEventListener('input', function() {
          incidentsValue.textContent = this.value;
        });
      }
    }
    
    // Enhance apply button functionality
    const applyButton = document.getElementById('apply-section-changes');
    if (applyButton) {
      applyButton.onclick = function() {
        const sectionSlider = document.getElementById('section-slider');
        if (!sectionSlider) return;
        
        const sectionId = currentSection;
        if (!sectionId) return;
        
        // Get current section element
        const sectionElement = document.getElementById(`${sectionId}-section`);
        if (!sectionElement) return;
        
        // Update color based on performance score
        const score = parseFloat(sectionSlider.value);
        let newColor;
        
        if (score >= 8) {
          newColor = "#a8d08d"; // Green for high performance (8-10)
        } else if (score >= 4) {
          newColor = "#ffe699"; // Yellow for medium performance (4-7.9)
        } else {
          newColor = "#f8696b"; // Red for poor performance (0-3.9)
        }
        
        // Update section color
        sectionElement.setAttribute("fill", newColor);
        
        // Update spoke style
        const spokeElement = document.getElementById(`${sectionId}-spoke`);
        if (spokeElement) {
          if (score >= 8) {
            spokeElement.removeAttribute("stroke-dasharray");
          } else {
            spokeElement.setAttribute("stroke-dasharray", "5,3");
          }
        }
        
        // Update data in memory
        if (sectionPerformanceData && sectionPerformanceData[sectionId]) {
          sectionPerformanceData[sectionId].score = score;
          sectionPerformanceData[sectionId].color = newColor;
        }
        
        // Update metrics
        const responseTime = document.getElementById('section-response-time');
        const solutionSpeed = document.getElementById('section-solution-speed');
        const incidents = document.getElementById('section-incidents');
        
        if (responseTime && solutionSpeed && incidents) {
          // This would update some global metrics for this section
          console.log(`Updated ${sectionId} metrics: Response=${responseTime.value}, Solution=${solutionSpeed.value}, Incidents=${incidents.value}`);
        }
        
        // Close the panel
        closePanel('section-panel');
        
        // Show a brief success message
        const messageDiv = document.createElement('div');
        messageDiv.style.position = 'fixed';
        messageDiv.style.top = '20px';
        messageDiv.style.left = '50%';
        messageDiv.style.transform = 'translateX(-50%)';
        messageDiv.style.background = '#4caf50';
        messageDiv.style.color = 'white';
        messageDiv.style.padding = '10px 20px';
        messageDiv.style.borderRadius = '4px';
        messageDiv.style.zIndex = '1000';
        messageDiv.textContent = `${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)} section updated!`;
        document.body.appendChild(messageDiv);
        
        // Remove the message after 3 seconds
        setTimeout(function() {
          messageDiv.remove();
        }, 3000);
      };
    }
  }
}

// 3. Update Research References to include your story instead of academic references
function updateResearchReferences() {
  // Create the research panel content with your story
  const researchPanel = document.getElementById('individual-research-panel');
  if (researchPanel) {
    researchPanel.innerHTML = `
      <h4>My Journey Through the Institution</h4>
      
      <p><strong>I: Initial Crisis (January 2023 - Diagnosis)</strong><br>
      When you grow up watching gas flares turn night into toxic day in Nigeria's Niger Delta, you
      learn early that systems meant to bring light can destroy life. Regardless, you also learn
      something more powerful, how communities innovate to thrive despite systemic barriers. I am
      Chiziterem Onyenekwe, and my journey from setting the highest academic record in my
      Nigerian university department's history to fighting for disability rights at the University of
      Kentucky isn't just about institutional failure. It's about transforming systemic violence into
      revolutionary change.</p>
      
      <p>I arrived at Kentucky's Biomedical Engineering PhD program already fluent in adaptation,
      daughter of a Biafran war veteran, graduate of a nation where scarcity breeds innovation,
      international scholar selected by EducationUSA. Maintaining a 3.9 GPA while navigating
      American academia showcased not just excellence, but resilience. I didn't know then that my
      intersectional identity as an African, international and disabled woman in STEM would soon
      collide with systemic discrimination in ways that would both endanger and transform me.</p>
      
      <p><strong>II: Healthcare Fragmentation (September 2023 Suicide attempt)</strong><br>
      I did not know what to do, I could not even afford $50 dollar a session especially when FND
      means no knowledge or cure guarantee. My friend encouraged me, and I found an external
      therapist who took me on charity. She confirmed that I was Autistic and being undiagnosed
      contributed to cPTSD and FND exacerbation.</p>
      
      <p>What followed was my final initiation into the reality behind the illusion of care and support. I was stripped into a hospital gown at Good Samaritan Hospital, then handcuffed and transported by sheriffs to Eastern State Hospital in the middle of the night. I looked out the window as I wondered how on earth, I had gotten to this point of being taken like a criminal to an unfamiliar location in a foreign country.</p>
      
      <p><strong>III: Academic Impact (Fall 2023 - Spring 2024)</strong><br>
      It was at this time I realized and accepted that I needed to register with the DRC to get academic
      support. I registered with the Disability Resource Center (DRC) in fall 2023 to obtain academic accommodations. 
      Despite registering with the Disability Resource Center, I discovered that being a disabled
      graduate student meant navigating another endless maze of fragmented offices. Accommodation
      meant having to use my limited capacity to coordinate offices to get some flexibility which ends
      up being spent on coordinating.</p>
      
      <p>In February 2024, my PI ended my research assistantship without any
      official accommodation deliberation. I would be paid till June "and afterwards?", I asked my PI
      and he said "I don't know". The
      Director of Graduate Studies (DGS) came in later in May 2024, and they both told me that a
      master's was the best option I had. They both had no interest in cooperating with me to find a
      way to get what I came for, I was not asked what I wanted. My PI was done with me, my DGS
      couldn't care less, the message was clear: get out, PhD research in UKY is no place for people
      like you.</p>
      
      <p><strong>IV: Institutional Response (2024-2025)</strong><br>
      As I looked around the institution for any form of help because the DGS claimed he could not
      approve my fellowship and I had no assistantship or any idea of exactly how I was capable, a
      concerned staff triggered an investigation with the Office of Equal Opportunity. Here is how the deflection merry-go-round began...</p>
      
      <p>The so-called investigation continued without regard for protection and supporting of the student
      who was potentially being discriminated against. Like a police investigation with the prime
      witness left to roam around in the same neighborhood of the crime; very trustworthy according
      to UKY standards.</p>
      
      <p>As you can imagine, it felt like hearing echoes of my voice in a drum after being told I could find
      water there. The ADA Compliance Office refused to implement DRC compliance and asked me
      to report the same problem in the same breath, another dead end.</p>
      
      <p><strong>V: CONCLUSION</strong><br>
      University of Kentucky almost killed me, but I am still here fighting for everyone who believes
      in me and themselves, that everyone's potential should not be abandoned in light of their
      struggles. Struggles are what makes us human and brings the best out of us. I am here now
      saying I will do my PhD research to design products for acute recovery from dissociative or
      shutdown states in emergency situations, sediment the answers to the why and how of FND and
      co-occurring conditions, and most importantly, leave a legacy on which no other disabled
      graduate student would ever have to suffer like I did because of institutional fragmentation and
      neglect.</p>
    `;
  }
  
  // Update button to show/hide research panel
  const researchBtn = document.getElementById('individual-research-btn');
  if (researchBtn) {
    researchBtn.innerHTML = 'My Story ▼';
    
    researchBtn.onclick = function() {
      const panel = document.getElementById('individual-research-panel');
      if (panel) {
        if (panel.style.display === 'block') {
          panel.style.display = 'none';
          this.innerHTML = 'My Story ▼';
        } else {
          panel.style.display = 'block';
          this.innerHTML = 'My Story ▲';
        }
      }
    };
  }
}

// 4. Fix for charts - ensure they're initialized properly
function initializeCharts() {
  // Only initialize if Chart.js is available
  if (typeof Chart === 'undefined') {
    console.log("Chart.js is not available");
    return;
  }
  
  // Response times chart
  const responseTimesCtx = document.getElementById('responseTimesChart');
  if (responseTimesCtx) {
    new Chart(responseTimesCtx, {
      type: 'bar',
      data: {
        labels: ['Healthcare', 'DRC', 'Academic', 'Grad School', 'OEO', 'ADA Office'],
        datasets: [{
          label: 'Response Time (days)',
          data: [14, 7, 21, 28, 45, 30],
          backgroundColor: '#1565c0'
        }, {
          label: 'Solution Time (days)',
          data: [30, 60, 90, 180, 0, 0], // 0 means no solution provided
          backgroundColor: '#f44336'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Days'
            }
          }
        }
      }
    });
  }
  
  // Failures by department chart
  const failuresCtx = document.getElementById('failuresByDeptChart');
  if (failuresCtx) {
    new Chart(failuresCtx, {
      type: 'pie',
      data: {
        labels: ['Healthcare', 'DRC', 'Academic', 'Grad School', 'Mental Health', 'OEO', 'Admin/Ombud', 'ADA Office'],
        datasets: [{
          data: [25, 15, 20, 15, 10, 5, 5, 5],
          backgroundColor: [
            '#f44336', // Healthcare
            '#ff9800', // DRC
            '#ffeb3b', // Academic
            '#4caf50', // Grad School
            '#2196f3', // Mental Health
            '#9c27b0', // OEO
            '#795548', // Admin
            '#607d8b'  // ADA
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }
}

// 5. Fix for emergency panel buttons
function fixEmergencyPanel() {
  // Set up symptom buttons for individual tab
  const buttons = document.querySelectorAll('#individual .symptom-button');
  if (buttons.length > 0) {
    buttons.forEach(button => {
      // First remove any existing event listeners
      const newButton = button.cloneNode(true);
      button.parentNode.replaceChild(newButton, button);
      
      // Add new event listener
      newButton.addEventListener('click', function() {
        // Toggle active state
        this.classList.toggle('active');
        
        // Update recommendations based on selected systems
        updateIndividualRecommendations();
      });
    });
  }
  
  // Set up text area listener
  const textarea = document.querySelector('#individual .custom-description');
  if (textarea) {
    // First remove any existing event listeners
    const newTextarea = textarea.cloneNode(true);
    textarea.parentNode.replaceChild(newTextarea, textarea);
    
    const typingIndicator = document.querySelector('#individual .typing-indicator');
    let typingTimer;
    
    newTextarea.addEventListener('keyup', function() {
      // Show typing indicator
      if (typingIndicator) {
        typingIndicator.classList.add('visible');
        typingIndicator.textContent = "Analyzing your situation...";
      }
      
      clearTimeout(typingTimer);
      typingTimer = setTimeout(function() {
        // Update recommendations when typing stops
        updateIndividualRecommendations();
        
        // Update typing indicator
        if (typingIndicator) {
          if (newTextarea.value.trim() !== '') {
            typingIndicator.textContent = "Analysis complete";
            setTimeout(() => {
              typingIndicator.classList.remove('visible');
            }, 1500);
          } else {
            typingIndicator.classList.remove('visible');
          }
        }
      }, 1000);
    });
  }
  
  // Add predefined interventions if not already defined
  if (typeof individualInterventionsBySystem === 'undefined') {
    window.individualInterventionsBySystem = {
      'healthcare': [
        "Request complete copies of all medical records",
        "Ask for a patient advocate to coordinate care",
        "Document all treatment recommendations and referrals",
        "Create an emergency care plan with specific protocols for FND/PNES",
        "Bring a trusted friend to all medical appointments",
        "Request a neurologist experienced with functional disorders"
      ],
      'accommodation': [
        "Request accommodations in writing with delivery confirmation",
        "Ask which office is responsible for implementation",
        "Document all accommodation discussions and promises",
        "CC multiple departments in all accommodation communications",
        "Request specific accommodations for research settings",
        "Ask for flexible attendance and remote participation options"
      ],
      'academic': [
        "Request written clarification of academic expectations",
        "Document all meetings with faculty and advisors",
        "Ask the ombudsperson to facilitate department communications",
        "Request accommodations specific to research environment",
        "Create a written work plan with flexibility built in",
        "Inquire about deadline extensions before they're needed"
      ],
      'coordination': [
        "Ask ombudsperson to coordinate a multi-office meeting",
        "Create a contact list of all involved departments",
        "Request written clarification of each office's responsibilities",
        "Document all instances of being referred between offices",
        "Involve external advocacy organization for support",
        "Request a single point of contact for your case"
      ],
      'mental': [
        "Contact crisis services if experiencing suicidal thoughts: 988",
        "Document impact of institutional stress on your health",
        "Request medical leave paperwork if needed",
        "Ask for referrals to external mental health providers",
        "Practice grounding techniques during stressful interactions",
        "Create a safety plan with trusted people in your network"
      ],
      'financial': [
        "Contact financial aid office about hardship options",
        "Document all additional expenses caused by disability barriers",
        "Request emergency funding for disability-related needs",
        "Research external scholarships for disabled students",
        "Consider filing for disability-related loan deferment",
        "Request itemized invoices for all medical costs"
      ],
      'visa': [
        "Contact international student office about medical reduced course load",
        "Document all communications about visa status",
        "Request written clarification of visa requirements during medical issues",
        "Connect with international student advocacy groups",
        "Consult with immigration attorney about medical exceptions",
        "Ask about extensions for international student requirements"
      ]
    };
  }
}

// Call all functions when the document is loaded
document.addEventListener('DOMContentLoaded', function() {
  // First apply all the fixes
  fixEmergencyPanel();
  enhanceSectionControls();
  updateResearchReferences();
  attachFullImpactButtons();
  
  // Then initialize charts
  setTimeout(initializeCharts, 500);
  
  // Make sure individual emergency panel gets recommendations
  updateIndividualRecommendations();
});
</script>
<script>
  // Final fixes for the Individual tab

// 1. Add the Research Reference button if it doesn't exist
function addResearchButton() {
  // Check if button already exists
  if (!document.getElementById('individual-research-btn')) {
    const individualTab = document.getElementById('individual');
    if (individualTab) {
      // Create research panel if it doesn't exist
      if (!document.getElementById('individual-research-panel')) {
        const researchPanel = document.createElement('div');
        researchPanel.id = 'individual-research-panel';
        researchPanel.className = 'research-panel';
        researchPanel.style.display = 'none';
        individualTab.appendChild(researchPanel);
      }
      
      // Create and add the button
      const researchBtn = document.createElement('button');
      researchBtn.id = 'individual-research-btn';
      researchBtn.className = 'research-references-btn';
      researchBtn.textContent = 'My Story ▼';
      individualTab.appendChild(researchBtn);
      
      // Add click event
      researchBtn.addEventListener('click', function() {
        const panel = document.getElementById('individual-research-panel');
        if (panel) {
          if (panel.style.display === 'block') {
            panel.style.display = 'none';
            this.textContent = 'My Story ▼';
          } else {
            panel.style.display = 'block';
            this.textContent = 'My Story ▲';
          }
        }
      });
    }
  }
  
  // Update research panel content
  updateResearchReferences();
}

// 2. Fix Apply Changes functionality
function fixApplyChanges() {
  // Define a global current section variable if it doesn't exist
  if (typeof window.currentSection === 'undefined') {
    window.currentSection = '';
  }
  
  // Override showSectionInfo function to set the currentSection
  const originalShowSectionInfo = window.showSectionInfo;
  window.showSectionInfo = function(sectionId) {
    // Set the current section
    window.currentSection = sectionId;
    
    // Call the original function if it exists
    if (typeof originalShowSectionInfo === 'function') {
      originalShowSectionInfo(sectionId);
    }
    
    // Make sure the section panel has our metrics
    enhanceSectionPanel(sectionId);
  };
  
  // Function to add metrics to section panel
  function enhanceSectionPanel(sectionId) {
    const sectionPanel = document.getElementById('section-panel');
    if (!sectionPanel) return;
    
    // Add metrics if they don't exist
    if (!sectionPanel.querySelector('.section-metrics')) {
      const metricsDiv = document.createElement('div');
      metricsDiv.className = 'section-metrics';
      metricsDiv.innerHTML = `
        <h3>Section Metrics</h3>
        <div class="slider-container">
          <div class="slider-row">
            <div class="slider-label">Response Time:</div>
            <input type="range" min="1" max="30" value="14" class="slider-input" id="section-response-time">
            <div class="slider-value" id="section-response-value">14 days</div>
          </div>
          
          <div class="slider-row">
            <div class="slider-label">Solution Speed:</div>
            <input type="range" min="0" max="180" value="60" class="slider-input" id="section-solution-speed">
            <div class="slider-value" id="section-solution-value">60 days</div>
          </div>
          
          <div class="slider-row">
            <div class="slider-label">Related Incidents:</div>
            <input type="range" min="0" max="10" value="3" class="slider-input" id="section-incidents">
            <div class="slider-value" id="section-incidents-value">3</div>
          </div>
        </div>
      `;
      
      // Add the metrics div to the panel
      const applyButton = document.getElementById('apply-section-changes');
      if (applyButton) {
        sectionPanel.insertBefore(metricsDiv, applyButton.parentNode);
      } else {
        const sliderContainer = sectionPanel.querySelector('.slider-container');
        if (sliderContainer) {
          sliderContainer.parentNode.insertBefore(metricsDiv, sliderContainer.nextSibling);
        } else {
          sectionPanel.appendChild(metricsDiv);
        }
      }
      
      // Set up sliders
      setupMetricsSliders();
    }
    
    // Make sure apply button exists and works
    let applyButton = document.getElementById('apply-section-changes');
    if (!applyButton) {
      applyButton = document.createElement('button');
      applyButton.id = 'apply-section-changes';
      applyButton.className = 'apply-changes';
      applyButton.textContent = 'Apply Changes';
      
      // Add it to the panel
      sectionPanel.appendChild(applyButton);
    }
    
    // Remove any existing click handlers
    const newApplyButton = applyButton.cloneNode(true);
    applyButton.parentNode.replaceChild(newApplyButton, applyButton);
    
    // Add the click handler
    newApplyButton.addEventListener('click', function() {
      applyChangesToSection(window.currentSection);
    });
  }
  
  // Function to set up metrics sliders
  function setupMetricsSliders() {
    const responseSlider = document.getElementById('section-response-time');
    const responseValue = document.getElementById('section-response-value');
    if (responseSlider && responseValue) {
      responseSlider.addEventListener('input', function() {
        responseValue.textContent = `${this.value} days`;
      });
    }
    
    const solutionSlider = document.getElementById('section-solution-speed');
    const solutionValue = document.getElementById('section-solution-value');
    if (solutionSlider && solutionValue) {
      solutionSlider.addEventListener('input', function() {
        solutionValue.textContent = `${this.value} days`;
      });
    }
    
    const incidentsSlider = document.getElementById('section-incidents');
    const incidentsValue = document.getElementById('section-incidents-value');
    if (incidentsSlider && incidentsValue) {
      incidentsSlider.addEventListener('input', function() {
        incidentsValue.textContent = this.value;
      });
    }
  }
  
  // Function to apply changes to a section
  function applyChangesToSection(sectionId) {
    if (!sectionId) {
      console.log("No section selected");
      return;
    }
    
    console.log("Applying changes to section:", sectionId);
    
    // Get the section element
    const sectionElement = document.getElementById(`${sectionId}-section`);
    if (!sectionElement) {
      console.log("Section element not found:", sectionId);
      return;
    }
    
    // Get input values
    const sectionSlider = document.getElementById('section-slider');
    if (!sectionSlider) {
      console.log("Section slider not found");
      return;
    }
    
    // Get score from slider
    const score = parseFloat(sectionSlider.value);
    
    // Update color based on score
    let newColor;
    if (score >= 8) {
      newColor = "#a8d08d"; // Green for high performance (8-10)
    } else if (score >= 4) {
      newColor = "#ffe699"; // Yellow for medium performance (4-7.9)
    } else {
      newColor = "#f8696b"; // Red for poor performance (0-3.9)
    }
    
    // Update section color
    sectionElement.setAttribute("fill", newColor);
    
    // Update spoke style
    const spokeElement = document.getElementById(`${sectionId}-spoke`);
    if (spokeElement) {
      if (score >= 8) {
        spokeElement.removeAttribute("stroke-dasharray");
      } else {
        spokeElement.setAttribute("stroke-dasharray", "5,3");
      }
    }
    
    // Get additional metrics
    const responseTime = document.getElementById('section-response-time');
    const solutionSpeed = document.getElementById('section-solution-speed');
    const incidents = document.getElementById('section-incidents');
    
    if (responseTime && solutionSpeed && incidents) {
      // Log the metrics (in a real app, these would update some data structure)
      console.log(`Updated ${sectionId} metrics:`, {
        score: score,
        responseTime: responseTime.value,
        solutionSpeed: solutionSpeed.value,
        incidents: incidents.value
      });
    }
    
    // Show a success message
    const messageDiv = document.createElement('div');
    messageDiv.style.position = 'fixed';
    messageDiv.style.top = '20px';
    messageDiv.style.left = '50%';
    messageDiv.style.transform = 'translateX(-50%)';
    messageDiv.style.background = '#4caf50';
    messageDiv.style.color = 'white';
    messageDiv.style.padding = '10px 20px';
    messageDiv.style.borderRadius = '4px';
    messageDiv.style.zIndex = '1000';
    messageDiv.textContent = `${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)} section updated!`;
    document.body.appendChild(messageDiv);
    
    // Remove the message after 3 seconds
    setTimeout(function() {
      messageDiv.remove();
    }, 3000);
    
    // Close the panel
    closePanel('section-panel');
  }
}

// 3. Enhance the Full Impact panel
function enhanceFullImpactPanel() {
  // Define the full impact data with timeline and prevention strategies
  window.fullImpactData = {
    'healthcare': {
      title: "Healthcare System Impact Analysis",
      timeline: [
        { date: "Jan 2023", event: "PNES Diagnosis without support plan", impact: "Navigating fragmented services alone" },
        { date: "Sep 2023", event: "Psychiatric detention crisis", impact: "Criminal treatment of medical condition" },
        { date: "Jan 2024", event: "Medical crisis without appropriate care", impact: "Worsening symptoms with no coordination" },
        { date: "Present", event: "Ongoing medical needs", impact: "Continued fragmentation of care" },
        { date: "Future", event: "Without intervention", impact: "Deteriorating health outcomes, potential medical harm" }
      ],
      individualLosses: [
        "Health stability and predictable care",
        "Trust in medical institutions",
        "Access to appropriate treatments",
        "Ability to focus on academics due to health concerns",
        "Physical wellbeing and reduced symptoms"
      ],
      systemLosses: [
        "Experienced neurodiversity researchers",
        "Opportunity to improve rare disease protocols",
        "Prevent future liability from similar cases",
        "Develop innovative care models",
        "Build inclusive medical education practices"
      ],
      preventionWithAdaptherm: [
        "Coordinated care across departments with clear handoffs",
        "Medical management protocols specifically for PNES/FND",
        "Emergency protocols that prevent traumatic interventions",
        "Continuity of care between different health services",
        "Integration between healthcare and academic accommodations"
      ]
    },
    'drc': {
      title: "Disability Resources Impact Analysis",
      timeline: [
        { date: "Fall 2023", event: "DRC registration with classroom-only accommodations", impact: "No research environment support" },
        { date: "Dec 2023", event: "Lack of lab accommodation protocol", impact: "Deteriorating relationship with PI" },
        { date: "Feb 2024", event: "No coordination with academic department", impact: "Loss of research assistantship" },
        { date: "Present", event: "No effective accommodations for research", impact: "Delayed academic progress" },
        { date: "Future", event: "Without intervention", impact: "Degree downgrade or program dismissal" }
      ],
      individualLosses: [
        "Equal access to graduate research opportunities",
        "Academic progress and career development",
        "Field-specific accommodation strategies",
        "Self-advocacy energy diverted to basic access needs",
        "Dignity and professional standing"
      ],
      systemLosses: [
        "Innovative disability research perspectives",
        "Opportunity to develop research accommodation models",
        "Diverse STEM researchers",
        "Institutional knowledge about complex accommodation needs",
        "Compliance with federal disability laws"
      ],
      preventionWithAdaptherm: [
        "Research-specific accommodation protocols",
        "Clear implementation responsibility assignment",
        "Coordination with academic departments",
        "Adaptive strategies for laboratory environments",
        "Monitoring system for accommodation effectiveness"
      ]
    },
    'academic': {
      title: "Academic Department Impact Analysis",
      timeline: [
        { date: "Dec 2023", event: "Communication breakdown with PI", impact: "Increasing isolation in research" },
        { date: "Feb 2024", event: "Research assistantship terminated", impact: "Loss of funding and research progress" },
        { date: "May 2024", event: "DGS suggests degree downgrade", impact: "Career path threatened" },
        { date: "Present", event: "No clear academic pathway", impact: "Stalled research progress" },
        { date: "Future", event: "Without intervention", impact: "Talent waste, potential program dismissal" }
      ],
      individualLosses: [
        "Research contributions and academic development",
        "Professional mentorship and growth",
        "Field-specific expertise building",
        "Research assistantship income",
        "Career trajectory in chosen field"
      ],
      systemLosses: [
        "Diverse perspectives in biomedical engineering",
        "Innovation from lived experience with disability",
        "Opportunity to develop inclusive lab practices",
        "Connection between neuroscience and disability",
        "Institutional knowledge about disability accommodation"
      ],
      preventionWithAdaptherm: [
        "Clear accommodation protocols for graduate research",
        "Faculty training on disability inclusion",
        "Structured communication protocols for labs",
        "Alternative research arrangements for disabled students",
        "Mentorship matching based on accommodation needs"
      ]
    },
    'gradschool': {
      title: "Graduate School Impact Analysis",
      timeline: [
        { date: "Feb 2024", event: "No graduate-specific accommodation protocol", impact: "Department left to improvise" },
        { date: "May 2024", event: "Master's suggested as only option", impact: "Academic goals undermined" },
        { date: "Aug 2024", event: "DGS unable to serve as interim advisor", impact: "Academic limbo" },
        { date: "Present", event: "No clear pathway to PhD completion", impact: "Stalled academic progress" },
        { date: "Future", event: "Without intervention", impact: "Permanent career limitation" }
      ],
      individualLosses: [
        "PhD level career opportunities",
        "Academic achievement matching capabilities",
        "Research development and contributions",
        "Professional identity as researcher",
        "Return on educational investment"
      ],
      systemLosses: [
        "Diverse faculty pipeline",
        "Institutional innovation in graduate education",
        "Compliance with federal disability laws",
        "International reputation for inclusion",
        "Opportunity to develop accommodation best practices"
      ],
      preventionWithAdaptherm: [
        "Graduate-specific accommodation policies",
        "Interdisciplinary committee facilitation",
        "Clear graduate accommodation implementation protocols",
        "Emergency advisor assignment system",
        "Regular compliance reviews of graduate programs"
      ]
    },
    'mentalhealth': {
      title: "Mental Health Services Impact Analysis",
      timeline: [
        { date: "Feb 2023", event: "UKCC refers out without transition plan", impact: "Treatment disruption" },
        { date: "Sep 2023", event: "Crisis intervention with handcuffing", impact: "Trauma and worsening symptoms" },
        { date: "Jan 2024", event: "Suicide attempt", impact: "Life-threatening mental health crisis" },
        { date: "Present", event: "Complex diagnoses without coordinated care", impact: "Ongoing psychological burden" },
        { date: "Future", event: "Without intervention", impact: "Continued mental health deterioration, risk of crisis" }
      ],
      individualLosses: [
        "Mental health stability necessary for academic success",
        "Recovery from trauma and crisis",
        "Psychological resources for navigating challenges",
        "Effective treatment for complex conditions",
        "Sense of safety and support"
      ],
      systemLosses: [
        "Opportunity to develop protocols for complex cases",
        "Knowledge about neurodevelopmental and neuropsychiatric intersection",
        "Prevention of crisis leading to legal liability",
        "Development of trauma-informed approaches",
        "Integration of mental health and academic supports"
      ],
      preventionWithAdaptherm: [
        "Coordinated care between mental health and academic support",
        "Crisis protocols that avoid traumatic interventions",
        "Transition planning between services",
        "Specialized knowledge for neuropsychiatric conditions",
        "Regular follow-up system for high-risk individuals"
      ]
    },
    'oeo': {
      title: "Office of Equal Opportunity Impact Analysis",
      timeline: [
        { date: "Aug 2024", event: "Investigation begins without protection", impact: "Continued vulnerability during investigation" },
        { date: "Aug-Dec 2024", event: "Months-long investigation", impact: "Lost semester with continued discrimination" },
        { date: "Dec 2024", event: "Finding of no discrimination", impact: "Continued institutional barriers" },
        { date: "Present", event: "No structural changes despite evidence", impact: "Ongoing discrimination" },
        { date: "Future", event: "Without intervention", impact: "Pattern of disability discrimination continues" }
      ],
      individualLosses: [
        "Equal educational opportunity",
        "Protection from continued discrimination",
        "Academic time lost during investigation",
        "Energy diverted to fighting discrimination",
        "Faith in institutional justice"
      ],
      systemLosses: [
        "Opportunity to address systemic discrimination",
        "Development of effective investigation protocols",
        "Prevention of future legal liability",
        "Compliance with federal disability laws",
        "Institutional reputation for inclusive excellence"
      ],
      preventionWithAdaptherm: [
        "Interim protection protocols during investigations",
        "Clear investigation timelines with enforcement",
        "Case management for complainants",
        "Regular review of discrimination patterns",
        "Training on disability discrimination for investigators"
      ]
    },
    'ada': {
      title: "ADA Compliance Office Impact Analysis",
      timeline: [
        { date: "Fall 2023", event: "No research accommodation protocols", impact: "Unsupported in research environment" },
        { date: "Feb 2024", event: "No enforcement of accommodations", impact: "Assistantship terminated without accommodation process" },
        { date: "Aug 2024", event: "Deflection to DRC without coordination", impact: "Circular referrals without resolution" },
        { date: "Present", event: "No clear responsibility assignment", impact: "Continued lack of effective accommodations" },
        { date: "Future", event: "Without intervention", impact: "Ongoing ADA/Section 504 violations" }
      ],
      individualLosses: [
        "Legal right to equal educational access",
        "Accommodations necessary for academic success",
        "Energy diverted to basic access fights",
        "Protection from disability discrimination",
        "Opportunity to succeed despite disability"
      ],
      systemLosses: [
        "Legal compliance with ADA and Section 504",
        "Prevention of OCR complaints and lawsuits",
        "Opportunity to develop model accommodation processes",
        "Integration of accommodation throughout university",
        "Institutional knowledge about disability inclusion"
      ],
      preventionWithAdaptherm: [
        "Clear responsibility assignment for accommodations",
        "Research-specific accommodation protocols",
        "Regular compliance monitoring",
        "Coordination between accommodation offices",
        "Enforcement mechanisms for accommodations"
      ]
    },
    'admin': {
      title: "Administrative Offices Impact Analysis",
      timeline: [
        { date: "Fall 2023", event: "Circular referrals begin", impact: "No resolution to accommodation needs" },
        { date: "Aug 2024", event: "Multiple offices defer responsibility", impact: "Energy diverted to navigating bureaucracy" },
        { date: "Dec 2024", event: "No resolution after multiple attempts", impact: "Lost academic time and progress" },
        { date: "Present", event: "Continued office silos", impact: "Unresolved accommodation needs" },
        { date: "Future", event: "Without intervention", impact: "Administrative barriers block academic success" }
      ],
      individualLosses: [
        "Time and energy wasted on administrative navigation",
        "Timely resolution of urgent needs",
        "Clarity about processes and responsibilities",
        "Effective advocacy within system",
        "Academic progress during administrative delays"
      ],
      systemLosses: [
        "Efficiency in addressing student needs",
        "Prevention of problems through coordination",
        "Opportunity to develop integrated support systems",
        "Strategic approach to complex student needs",
        "Institutional reputation for responsiveness"
      ],
      preventionWithAdaptherm: [
        "Case management system for complex student needs",
        "Clear responsibility boundaries between offices",
        "Regular cross-department coordination meetings",
        "Single point of contact for intersecting needs",
        "Process mapping to eliminate circular referrals"
      ]
    },
    'diagnosis': {
      title: "PNES Diagnosis Impact Analysis",
      timeline: [
        { date: "Jan 2023", event: "PNES diagnosis without care plan", impact: "Abandoned to navigate complex condition alone" },
        { date: "Feb 2023", event: "Fragmented referrals", impact: "No coordinated care approach" },
        { date: "Fall 2023", event: "Deteriorating condition without management", impact: "Academic and personal disruption" },
        { date: "Present", event: "Still no coordinated care plan", impact: "Ongoing health challenges" },
        { date: "Future", event: "Without intervention", impact: "Progressive health deterioration" }
      ],
      individualLosses: [
        "Health stability necessary for academic success",
        "Early intervention opportunity",
        "Symptom management knowledge and skills",
        "Coordinated approach to complex condition",
        "Prevention of crisis escalation"
      ],
      systemLosses: [
        "Knowledge development about rare conditions",
        "Opportunity to create model protocols",
        "Prevention of higher-cost crisis interventions",
        "Integration of care across health units",
        "Institutional knowledge about neuropsychiatric conditions"
      ],
      preventionWithAdaptherm: [
        "Post-diagnosis coordination protocol",
        "Care management for complex conditions",
        "Integration between healthcare and academic support",
        "Regular monitoring and follow-up system",
        "Clear responsibility assignment for care coordination"
      ]
    },
    'handcuffing': {
      title: "Psychiatric Detention Impact Analysis",
      timeline: [
        { date: "Sep 2023", event: "Handcuffed and transported to psychiatric hospital", impact: "Traumatic criminalization of medical condition" },
        { date: "Sep 2023", event: "PNES history ignored during crisis", impact: "Inappropriate and harmful interventions" },
        { date: "Sep-Dec 2023", event: "Post-traumatic stress from experience", impact: "Fear of seeking help, worsening symptoms" },
        { date: "Present", event: "Continued trauma from experience", impact: "Distrust of university health system" },
        { date: "Future", event: "Without intervention", impact: "Lasting healthcare avoidance, untreated conditions" }
      ],
      individualLosses: [
        "Trust in healthcare system",
        "Willingness to seek help when needed",
        "Freedom from unnecessary trauma",
        "Recovery from existing conditions",
        "Sense of safety and dignity"
      ],
      systemLosses: [
        "Legal liability from inappropriate interventions",
        "Opportunity to develop appropriate crisis protocols",
        "Trust from vulnerable populations",
        "Integration of medical information across systems",
        "Development of trauma-informed approaches"
      ],
      preventionWithAdaptherm: [
        "Medical information integration across health units",
        "Crisis protocols specific to neurological conditions",
        "Training on appropriate interventions for PNES/FND",
        "Trauma-informed approaches to health crises",
        "Regular review of crisis intervention outcomes"
      ]
    },
    'suicide': {
      title: "Suicide Attempt Impact Analysis",
      timeline: [
        { date: "Jan 2024", event: "Suicide attempt", impact: "Life-threatening mental health crisis" },
        { date: "Jan-Feb 2024", event: "Additional diagnoses following attempt", impact: "Complex condition without coordinated care" },
        { date: "Spring 2024", event: "Academic disruption due to health crisis", impact: "Delayed progress, threatened status" },
        { date: "Present", event: "Ongoing recovery without coordinated support", impact: "Continued vulnerability" },
        { date: "Future", event: "Without intervention", impact: "Risk of recurrence, permanent academic derailment" }
      ],
      individualLosses: [
        "Life safety and wellbeing",
        "Academic momentum and progress",
        "Recovery resources and support",
        "Trust in institutional safety net",
        "Psychological stability necessary for success"
      ],
      systemLosses: [
        "Prevention of life-threatening crises",
        "Legal liability from foreseeable harm",
        "Opportunity to develop crisis prevention systems",
        "Knowledge about mental health warning signs",
        "Integration of mental health and academic support"
      ],
      preventionWithAdaptherm: [
        "Early warning system for mental health crises",
        "Coordination between healthcare and academic support",
        "Follow-up protocols for vulnerable students",
        "Clear crisis response pathways",
        "Trauma-informed approaches to institutional stress"
      ]
    },
    'assistantship': {
      title: "Assistantship Termination Impact Analysis",
      timeline: [
        { date: "Dec 2023", event: "Communication breakdown with PI", impact: "Research isolation and uncertainty" },
        { date: "Feb 2024", event: "Assistantship terminated without accommodation process", impact: "Loss of funding and research opportunity" },
        { date: "May 2024", event: "No alternative assignment provided", impact: "Financial and academic crisis" },
        { date: "Present", event: "No clear research pathway", impact: "Stalled academic progress" },
        { date: "Future", event: "Without intervention", impact: "Inability to complete PhD research" }
      ],
      individualLosses: [
        "Financial support necessary for studies",
        "Research development and progress",
        "Academic mentorship and guidance",
        "Career preparation in chosen field",
        "Professional standing in department"
      ],
      systemLosses: [
        "Diverse research perspectives",
        "Innovation from disability research",
        "Compliance with ADA/Section 504",
        "Development of inclusive research environments",
        "Prevention of disability discrimination precedent"
      ],
      preventionWithAdaptherm: [
        "Research accommodation protocols",
        "Clear responsibility for implementation",
        "Alternative research arrangements",
        "Interim advisor assignments during transitions",
        "Faculty training on inclusive research mentorship"
      ]
    },
    'investigation': {
      title: "OEO Investigation Impact Analysis",
      timeline: [
        { date: "Aug 2024", event: "Investigation begins without protection", impact: "Continued vulnerability to discrimination" },
        { date: "Aug-Dec 2024", event: "Extended investigation without updates", impact: "Lost semester, continued stress" },
        { date: "Dec 2024", event: "No substantial findings despite evidence", impact: "Systemic issues unaddressed" },
        { date: "Present", event: "No accountability for investigation failures", impact: "Continued institutional barriers" },
        { date: "Future", event: "Without intervention", impact: "Pattern of discrimination continues unchecked" }
      ],
      individualLosses: [
        "Protection from ongoing discrimination",
        "Academic time lost during investigation",
        "Energy diverted from studies to advocacy",
        "Faith in institutional justice",
        "Equal educational opportunity"
      ],
      systemLosses: [
        "Opportunity to address systemic discrimination",
        "Compliance with federal civil rights laws",
        "Prevention of legal liability",
        "Development of effective investigation protocols",
        "Institutional reputation for justice"
      ],
      preventionWithAdaptherm: [
        "Interim protection protocols during investigations",
        "Clear investigation timelines with accountability",
        "Coordination between investigating office and support services",
        "Regular pattern analysis of discrimination complaints",
        "Training on disability discrimination for investigators"
      ]
    }
  };
  
  // Override the showFullImpactPanel function
  window.showFullImpactPanel = function(id) {
    // Create or get full impact panel
    let impactPanel = document.getElementById('full-impact-panel');
    if (!impactPanel) {
      impactPanel = document.createElement('div');
      impactPanel.id = 'full-impact-panel';
      impactPanel.className = 'crisis-panel';
      document.body.appendChild(impactPanel);
    }
    
    // Get the relevant impact data
    const impactData = window.fullImpactData[id] || {};
    
    // Create impact panel content
    impactPanel.innerHTML = `
      <div class="crisis-header">
        <h2 class="crisis-title">${impactData.title || 'System Impact Analysis'}</h2>
        <button class="close-panel" onclick="document.getElementById('full-impact-panel').style.display='none';">&times;</button>
      </div>
      
      <div class="crisis-content">
        <div class="impact-section">
          <h3>Timeline of Impact</h3>
          <div class="crisis-timeline">
            ${(impactData.timeline || []).map(item => `
              <div class="timeline-entry">
                <div class="entry-date">${item.date}</div>
                <div class="entry-content">
                  <strong>${item.event}</strong>
                  <p>${item.impact}</p>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="impact-section">
          <h3>What Is Being Lost: Individual</h3>
          <ul>
            ${(impactData.individualLosses || []).map(loss => `<li>${loss}</li>`).join('')}
          </ul>
        </div>
        
        <div class="impact-section">
          <h3>What Is Being Lost: System</h3>
          <ul>
            ${(impactData.systemLosses || []).map(loss => `<li>${loss}</li>`).join('')}
          </ul>
        </div>
        
        <div class="impact-section">
          <h3>What AdapTherm Would Prevent</h3>
          <ul>
            ${(impactData.preventionWithAdaptherm || []).map(prevention => `<li>${prevention}</li>`).join('')}
          </ul>
        </div>
      </div>
    `;
    
    // Show the overlay
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    
    // Show the impact panel
    impactPanel.style.display = 'block';
  };
  
  // Make sure 'View Full Impact' buttons pass the right section ID
  function fixFullImpactButtons() {
    // Function to add buttons to panels
    function addButtonToPanel(panel, sectionId) {
      // Check if button already exists
      let existingButton = panel.querySelector('.view-full-impact-btn');
      if (existingButton) {
        // Update its data attribute
        existingButton.setAttribute('data-section', sectionId);
        existingButton.onclick = function() {
          showFullImpactPanel(sectionId);
        };
        return;
      }
      
      // Create a new button
      const buttonsDiv = document.createElement('div');
      buttonsDiv.style.textAlign = 'center';
      buttonsDiv.style.marginTop = '20px';
      
      const viewImpactBtn = document.createElement('button');
      viewImpactBtn.className = 'view-full-impact-btn';
      viewImpactBtn.textContent = 'View Full Impact';
      viewImpactBtn.setAttribute('data-section', sectionId);
      viewImpactBtn.onclick = function() {
        showFullImpactPanel(sectionId);
      };
      
      buttonsDiv.appendChild(viewImpactBtn);
      panel.appendChild(buttonsDiv);
    }
    
    // Override the showSectionInfo function to add the button
    const originalShowSectionInfo = window.showSectionInfo;
    window.showSectionInfo = function(sectionId) {
      // Call the original function
      if (typeof originalShowSectionInfo === 'function') {
        originalShowSectionInfo(sectionId);
      }
      
      // Add the full impact button
      setTimeout(function() {
        const sectionPanel = document.getElementById('section-panel');
        if (sectionPanel) {
          addButtonToPanel(sectionPanel, sectionId);
        }
      }, 200);
    };
    
    // Override the showIndividualSpokeInfo function to add the button
    const originalShowIndividualSpokeInfo = window.showIndividualSpokeInfo;
    window.showIndividualSpokeInfo = function(sectionId) {
      // Call the original function
      if (typeof originalShowIndividualSpokeInfo === 'function') {
        originalShowIndividualSpokeInfo(sectionId);
      }
      
      // Add the full impact button
      setTimeout(function() {
        const spokePanel = document.getElementById('spoke-panel');
        if (spokePanel) {
          addButtonToPanel(spokePanel, sectionId);
        }
      }, 200);
    };
    
    // Override the showBreakthroughInfo function to add the button
    const originalShowBreakthroughInfo = window.showBreakthroughInfo;
    window.showBreakthroughInfo = function(crisisId) {
      // Call the original function
      if (typeof originalShowBreakthroughInfo === 'function') {
        originalShowBreakthroughInfo(crisisId);
      }
      
      // Add the full impact button
      setTimeout(function() {
        const crisisPanel = document.getElementById('crisis-panel');
        if (crisisPanel) {
          // Find and update any existing button
          const existingButton = crisisPanel.querySelector('.view-full-impact-btn');
          if (existingButton) {
            existingButton.setAttribute('data-section', crisisId);
            existingButton.onclick = function() {
              showFullImpactPanel(crisisId);
            };
          }
        }
      }, 200);
    };
  }
  
  // Call the fix function
  fixFullImpactButtons();
}

// 4. Enhance emergency panel quick buttons
function enhanceEmergencyPanel() {
  // Add checkboxes to emergency panel recommendations
  function addCheckboxesToRecommendations() {
    // Override the updateIndividualRecommendations function
    window.updateIndividualRecommendations = function() {
      // Get active symptom buttons
      const activeButtons = document.querySelectorAll('#individual .symptom-button.active');
      
      // Get custom description
      const textarea = document.querySelector('#individual .custom-description');
      if (!textarea) return;
      
      const customText = textarea.value.toLowerCase();
      
      // Array to collect unique interventions with categories
      const categorizedInterventions = {};
      
      // Institutional intervention suggestions
      const interventionsBySystem = window.individualInterventionsBySystem || {
        'healthcare': [
          "Request complete copies of all medical records",
          "Ask for a patient advocate to coordinate care",
          "Document all treatment recommendations and referrals",
          "Create an emergency care plan with specific protocols for FND/PNES",
          "Bring a trusted friend to all medical appointments",
          "Request a neurologist experienced with functional disorders"
        ],
        'accommodation': [
          "Request accommodations in writing with delivery confirmation",
          "Ask which office is responsible for implementation",
          "Document all accommodation discussions and promises",
          "CC multiple departments in all accommodation communications",
          "Request specific accommodations for research settings",
          "Ask for flexible attendance and remote participation options"
        ],
        'academic': [
          "Request written clarification of academic expectations",
          "Document all meetings with faculty and advisors",
          "Ask the ombudsperson to facilitate department communications",
          "Request accommodations specific to research environment",
          "Create a written work plan with flexibility built in",
          "Inquire about deadline extensions before they're needed"
        ],
        'coordination': [
          "Ask ombudsperson to coordinate a multi-office meeting",
          "Create a contact list of all involved departments",
          "Request written clarification of each office's responsibilities",
          "Document all instances of being referred between offices",
          "Involve external advocacy organization for support",
          "Request a single point of contact for your case"
        ],
        'mental': [
          "Contact crisis services if experiencing suicidal thoughts: 988",
          "Document impact of institutional stress on your health",
          "Request medical leave paperwork if needed",
          "Ask for referrals to external mental health providers",
          "Practice grounding techniques during stressful interactions",
          "Create a safety plan with trusted people in your network"
        ],
        'financial': [
          "Contact financial aid office about hardship options",
          "Document all additional expenses caused by disability barriers",
          "Request emergency funding for disability-related needs",
          "Research external scholarships for disabled students",
          "Consider filing for disability-related loan deferment",
          "Request itemized invoices for all medical costs"
        ],
        'visa': [
          "Contact international student office about medical reduced course load",
          "Document all communications about visa status",
          "Request written clarification of visa requirements during medical issues",
          "Connect with international student advocacy groups",
          "Consult with immigration attorney about medical exceptions",
          "Ask about extensions for international student requirements"
        ]
      };
      
      // Keyword map for analyzing text input
      const keywordMap = {
        // Healthcare related keywords
        "hospital": "healthcare", "doctor": "healthcare", "medical": "healthcare", 
        "diagnosis": "healthcare", "treatment": "healthcare", "seizure": "healthcare",
        "emergency": "healthcare", "medication": "healthcare", "pnes": "healthcare",
        "fnd": "healthcare", "neurological": "healthcare", "functional": "healthcare",
        
        // Accommodation related keywords
        "accommodation": "accommodation", "drc": "accommodation", "disability": "accommodation",
        "ada": "accommodation", "access": "accommodation", "barrier": "accommodation",
        "section 504": "accommodation", "modification": "accommodation",
        
        // Academic related keywords
        "professor": "academic", "advisor": "academic", "research": "academic",
        "lab": "academic", "course": "academic", "class": "academic", "department": "academic",
        "pi": "academic", "dgs": "academic", "assistantship": "academic", "termination": "academic",
        
        // Coordination related keywords
        "coordinate": "coordination", "refer": "coordination", "office": "coordination",
        "bureaucracy": "coordination", "paperwork": "coordination", "process": "coordination",
        "referral": "coordination", "silo": "coordination", "fragmented": "coordination",
        
        // Mental health related keywords
        "stress": "mental", "anxiety": "mental", "depression": "mental", 
        "suicide": "mental", "therapist": "mental", "counselor": "mental",
        "overwhelm": "mental", "crisis": "mental", "mdd": "mental", 
        "cptsd": "mental", "trauma": "mental", "ukcc": "mental",
        
        // Financial related keywords
        "money": "financial", "fund": "financial", "pay": "financial",
        "cost": "financial", "afford": "financial", "expense": "financial",
        "stipend": "financial", "tuition": "financial", "insurance": "financial",
        
        // International/visa related keywords
        "visa": "visa", "international": "visa", "foreign": "visa",
        "country": "visa", "immigrant": "visa", "status": "visa",
        "i-20": "visa", "sevis": "visa", "home": "visa"
      };
      
      // Add interventions from active buttons
      activeButtons.forEach(button => {
        const system = button.dataset.system;
        if (system && interventionsBySystem[system]) {
          if (!categorizedInterventions[system]) {
            categorizedInterventions[system] = [];
          }
          
          // Add unique interventions
          interventionsBySystem[system].forEach(intervention => {
            if (!categorizedInterventions[system].includes(intervention)) {
              categorizedInterventions[system].push(intervention);
            }
          });
        }
      });
      
      // Add interventions based on text analysis
      for (const [keyword, system] of Object.entries(keywordMap)) {
        if (customText.includes(keyword) && interventionsBySystem[system]) {
          if (!categorizedInterventions[system]) {
            categorizedInterventions[system] = [];
          }
          
          // Add unique interventions
          interventionsBySystem[system].forEach(intervention => {
            if (!categorizedInterventions[system].includes(intervention)) {
              categorizedInterventions[system].push(intervention);
            }
          });
        }
      }
      
      // Update the recommendations display
      const immediateList = document.getElementById('individual-immediate-interventions');
      if (!immediateList) return;
      
      // Clear previous recommendations
      immediateList.innerHTML = '';
      
      // Office related interventions that need checkboxes
      const officeRelatedKeywords = [
        'drc', 'office', 'ada', 'ombud', 'ombudsperson', 'graduate', 'school', 
        'coordinator', 'department', 'chair', 'dean', 'director', 'advisor', 'pi',
        'disability', 'resource', 'center', 'compliance', 'affairs', 'academic',
        'faculty', 'financial', 'aid', 'international', 'counseling', 'health'
      ];
      
      // Add new recommendations, grouped by category
      if (Object.keys(categorizedInterventions).length > 0) {
        // First add the "solution map" concept
        const infoDiv = document.createElement('div');
        infoDiv.className = 'solution-map-info';
        infoDiv.innerHTML = `
          <p style="font-size: 14px; font-style: italic; margin-bottom: 15px; color: #4a6fa5;">
            Check boxes next to actions requiring university offices, and AdapTherm will coordinate the pathway through the system.
          </p>
        `;
        immediateList.appendChild(infoDiv);
        
        // Get the top 2 categories
        const topCategories = Object.keys(categorizedInterventions).slice(0, 2);
        
        // For each category, add top recommendations
        topCategories.forEach(category => {
          const recommendations = categorizedInterventions[category].slice(0, 3);
          
          recommendations.forEach(recommendation => {
            const li = document.createElement('li');
            
            // Check if this recommendation involves university offices
            const needsCheckbox = officeRelatedKeywords.some(keyword => 
              recommendation.toLowerCase().includes(keyword)
            );
            
            if (needsCheckbox) {
              li.innerHTML = `
                <div class="checkbox-recommendation">
                  <input type="checkbox" id="rec-${Math.random().toString(36).substring(7)}" class="recommendation-checkbox">
                  <label>${recommendation}</label>
                </div>
              `;
            } else {
              li.textContent = recommendation;
            }
            
            immediateList.appendChild(li);
          });
        });
        
        // Add a "Coordinate Selected Actions" button if there are checkboxes
        const checkboxes = immediateList.querySelectorAll('.recommendation-checkbox');
        if (checkboxes.length > 0) {
          const coordinateBtn = document.createElement('button');
          coordinateBtn.className = 'coordinate-btn';
          coordinateBtn.textContent = 'Coordinate Selected Actions';
          coordinateBtn.style.marginTop = '15px';
          coordinateBtn.style.padding = '8px 15px';
          coordinateBtn.style.backgroundColor = '#4a6fa5';
          coordinateBtn.style.color = 'white';
          coordinateBtn.style.border = 'none';
          coordinateBtn.style.borderRadius = '4px';
          coordinateBtn.style.cursor = 'pointer';
          
          coordinateBtn.onclick = function() {
            // Count selected checkboxes
            const selected = immediateList.querySelectorAll('.recommendation-checkbox:checked');
            
            if (selected.length > 0) {
              alert(`AdapTherm would coordinate ${selected.length} actions across ${Math.min(selected.length * 2, 5)} university offices, creating a streamlined pathway for resolution.`);
            } else {
              alert('Please select at least one action to coordinate.');
            }
          };
          
          immediateList.appendChild(coordinateBtn);
        }
        
      } else {
        const li = document.createElement('li');
        li.textContent = "Click a button above or describe what you're experiencing";
        immediateList.appendChild(li);
      }
    };
  }
  
  // Make symptom buttons toggle (select one at a time) or combine
  function enhanceSymptomButtons() {
    // Add radio button behavior option
    const buttonContainer = document.querySelector('#individual .symptom-buttons');
    if (buttonContainer) {
      // Add a toggle switch for behavior mode
      const toggleDiv = document.createElement('div');
      toggleDiv.style.display = 'flex';
      toggleDiv.style.alignItems = 'center';
      toggleDiv.style.justifyContent = 'flex-end';
      toggleDiv.style.marginBottom = '10px';
      
      const toggleLabel = document.createElement('label');
      toggleLabel.htmlFor = 'button-mode-toggle';
      toggleLabel.style.marginRight = '10px';
      toggleLabel.style.fontSize = '14px';
      toggleLabel.style.color = 'white';
      toggleLabel.textContent = 'Toggle Mode:';
      
      const toggleSelect = document.createElement('select');
      toggleSelect.id = 'button-mode-toggle';
      toggleSelect.style.padding = '5px';
      toggleSelect.style.borderRadius = '4px';
      
      const multiOption = document.createElement('option');
      multiOption.value = 'multi';
      multiOption.textContent = 'Combine Issues';
      
      const singleOption = document.createElement('option');
      singleOption.value = 'single';
      singleOption.textContent = 'One Issue at a Time';
      
      toggleSelect.appendChild(multiOption);
      toggleSelect.appendChild(singleOption);
      
      toggleDiv.appendChild(toggleLabel);
      toggleDiv.appendChild(toggleSelect);
      
      // Insert before the buttons
      buttonContainer.parentNode.insertBefore(toggleDiv, buttonContainer);
      
      // Add event listener to toggle
      toggleSelect.addEventListener('change', function() {
        const buttons = document.querySelectorAll('#individual .symptom-button');
        
        // Reset all buttons
        buttons.forEach(button => {
          button.classList.remove('active');
        });
        
        // Update recommendations
        updateIndividualRecommendations();
      });
      
      // Override button click behavior
      const buttons = document.querySelectorAll('#individual .symptom-button');
      buttons.forEach(button => {
        // Remove any existing event listeners
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Add new click handler
        newButton.addEventListener('click', function() {
          const mode = document.getElementById('button-mode-toggle').value;
          
          if (mode === 'single') {
            // Single selection mode - deselect others
            document.querySelectorAll('#individual .symptom-button').forEach(btn => {
              btn.classList.remove('active');
            });
          }
          
          // Toggle this button
          this.classList.toggle('active');
          
          // Update recommendations
          updateIndividualRecommendations();
        });
      });
    }
  }
  
  // Call the enhancer functions
  addCheckboxesToRecommendations();
  enhanceSymptomButtons();
}

// Call all functions when the document is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log("Applying final fixes to Individual tab");
  
  // Apply all fixes
  addResearchButton();
  fixApplyChanges();
  enhanceFullImpactPanel();
  enhanceEmergencyPanel();
});
</script>
<script>
  // ===== INDIVIDUAL TAB ENHANCEMENTS =====

// 1. Fix References Button
function fixReferencesButton() {
  // Find the button or create it if it doesn't exist
  let referencesBtn = document.getElementById('individual-research-btn');
  if (!referencesBtn) {
    const individualTab = document.getElementById('individual');
    if (!individualTab) return;
    
    // Create research panel if it doesn't exist
    if (!document.getElementById('individual-research-panel')) {
      const researchPanel = document.createElement('div');
      researchPanel.id = 'individual-research-panel';
      researchPanel.className = 'research-panel';
      researchPanel.style.display = 'none';
      individualTab.appendChild(researchPanel);
      
      // Add content to the research panel
      updateReferencesContent();
    }
    
    // Create the button
    referencesBtn = document.createElement('button');
    referencesBtn.id = 'individual-research-btn';
    referencesBtn.className = 'research-references-btn';
    referencesBtn.textContent = 'References ▼';
    individualTab.appendChild(referencesBtn);
  } else {
    // Update existing button text
    referencesBtn.textContent = 'References ▼';
  }
  
  // Update or add click handler
  referencesBtn.onclick = function() {
    const panel = document.getElementById('individual-research-panel');
    if (panel) {
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        this.textContent = 'References ▼';
      } else {
        panel.style.display = 'block';
        this.textContent = 'References ▲';
      }
    }
  };
}

// Update references panel content
function updateReferencesContent() {
  const researchPanel = document.getElementById('individual-research-panel');
  if (!researchPanel) return;
  
  researchPanel.innerHTML = `
    <h4>Research and Sources</h4>
    
    <p><strong>Disability Systems Navigation</strong><br>
    Taylor, A., & Shallish, L. (2019). The logic of bio-meritocracy in the promotion of higher education accessibility. Disability & Society, 34(7-8), 1200-1223.</p>
    
    <p><strong>Functional Neurological Disorders</strong><br>
    Kozlowska, K., Walker, P., McLean, L., & Carrive, P. (2019). Fear and the defense cascade: Clinical implications and management. Harvard Review of Psychiatry, 23(4), 263-287.</p>
    
    <p><strong>Adaptive Capacity Measurement</strong><br>
    Reynolds, S., Lane, S. J., & Gennings, C. (2017). The moderating role of sensory overresponsivity in HPA activity. Journal of Attention Disorders, 21(2), 167-177.</p>
    
    <p><strong>Graduate Education and Disability</strong><br>
    Pearson, H., & Boskovich, L. (2019). Problematizing disability disclosure in higher education: Shifting towards a liberating humanizing intersectional framework. Disability Studies Quarterly, 39(1).</p>
    
    <p><strong>Institutional Barriers in Higher Education</strong><br>
    Dolmage, J. T. (2017). Academic ableism: Disability and higher education. University of Michigan Press.</p>
    
    <p><strong>System Fragmentation Impacts</strong><br>
    Kerschbaum, S. L., Eisenman, L. T., & Jones, J. M. (Eds.). (2017). Negotiating disability: Disclosure and higher education. University of Michigan Press.</p>
    
    <p><strong>Adaptation Models for Disability</strong><br>
    Hutcheon, E. J., & Wolbring, G. (2012). Voices of "disabled" post secondary students: Examining higher education "disability" policy using an ableism lens. Journal of Diversity in Higher Education, 5(1), 39-49.</p>
    
    <p><strong>Intersectional Disability Studies</strong><br>
    Brown, L. X. Z., Ashkenazy, E., & Onaiwu, M. G. (2017). All the weight of our dreams: On living racialized autism. DragonBee Press.</p>
  `;
}

// 2. Add Breakthrough Lines and Functionality
function addBreakthroughLines() {
  // Define crisis data for breakthrough lines
  const crisisData = {
    'diagnosis': {
      title: "PNES Diagnosis Crisis",
      date: "Jan 2023",
      description: "Diagnosed with Psychogenic Non-Epileptic Seizures (PNES), a rare functional neurological disorder, with no coordinated care plan provided.",
      quote: "I was discharged to navigate a labyrinth of fragmented services alone.",
      metrics: {
        "Days Without Treatment Plan": 45,
        "Referrals Without Follow-up": 3,
        "Information Handoffs Failed": 7,
        "Health Impact Severity": "High",
        "Institutional Response Grade": "F"
      }
    },
    'handcuffing': {
      title: "Psychiatric Detention Crisis",
      date: "Sep 2023",
      description: "Despite having documented PNES, was handcuffed and transported to psychiatric hospital, with medical history ignored.",
      quote: "I was stripped into a hospital gown, then handcuffed and transported by sheriffs in the middle of the night.",
      metrics: {
        "Policy Violations": 5,
        "Patient Rights Violations": 8,
        "Information System Failures": 4,
        "Physical Injury Duration": "4 weeks",
        "Trauma Level": "Severe"
      }
    },
    'suicide': {
      title: "Suicide Attempt",
      date: "Jan 2024",
      description: "After months of institutional failures and lack of support, attempted suicide due to deteriorating mental health.",
      quote: "I could not turn myself in again, I would rather die.",
      metrics: {
        "Warning Signs Ignored": 12,
        "Intervention Opportunities Missed": 7,
        "System Coordination Failures": 9,
        "Response Time": "None",
        "Preventability Rating": "100%"
      }
    },
    'assistantship': {
      title: "Research Assistantship Termination",
      date: "Feb 2024",
      description: "Principal Investigator terminated research assistantship without any accommodation deliberation process.",
      quote: "My PI was done with me, my DGS couldn't care less, the message was clear: get out.",
      metrics: {
        "ADA Violations": 5,
        "Documentation Failures": 9,
        "Financial Loss": "$18,000+",
        "Academic Progress Delay": "8 months",
        "Career Impact Severity": "Critical"
      }
    },
    'investigation': {
      title: "Investigation Without Protection",
      date: "Aug 2024",
      description: "Office of Equal Opportunity (OEO) began investigation but provided no interim protection or accommodations.",
      quote: "The investigation continued without regard for protecting the student who was potentially being discriminated against.",
      metrics: {
        "Days Without Protection": 147,
        "Communications Ignored": 12,
        "Policy Violations": 8,
        "Additional Health Incidents": 3,
        "Academic Time Lost": "1 semester"
      }
    }
  };

  // Add or update crisis panel
  let crisisPanel = document.getElementById('crisis-panel');
  if (!crisisPanel) {
    crisisPanel = document.createElement('div');
    crisisPanel.id = 'crisis-panel';
    crisisPanel.className = 'crisis-panel';
    document.body.appendChild(crisisPanel);
  }

  // Add full impact panel if it doesn't exist
  let fullImpactPanel = document.getElementById('full-impact-panel');
  if (!fullImpactPanel) {
    fullImpactPanel = document.createElement('div');
    fullImpactPanel.id = 'full-impact-panel';
    fullImpactPanel.className = 'crisis-panel';
    document.body.appendChild(fullImpactPanel);
  }

  // Add the overlay if it doesn't exist
  let overlay = document.getElementById('panel-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'panel-overlay';
    overlay.className = 'panel-overlay';
    overlay.onclick = function(e) {
      if (e.target === this) {
        document.querySelectorAll('.crisis-panel, .info-panel').forEach(panel => {
          panel.style.display = 'none';
        });
        this.style.display = 'none';
      }
    };
    document.body.appendChild(overlay);
  }

  // Function to show breakthrough info
  window.showBreakthroughInfo = function(crisisId) {
    const crisis = crisisData[crisisId];
    if (!crisis) return;

    crisisPanel.innerHTML = `
      <div class="crisis-header">
        <h2 class="crisis-title">${crisis.title}</h2>
        <span class="crisis-date">${crisis.date}</span>
        <button class="close-panel" onclick="document.getElementById('crisis-panel').style.display='none'; document.getElementById('panel-overlay').style.display='none';">&times;</button>
      </div>
      
      <div class="crisis-content">
        <p>${crisis.description}</p>
        <p class="crisis-quote">${crisis.quote}</p>
        
        <div class="crisis-impact">
          <h3>Impact Metrics</h3>
          <div class="metrics-grid">
            ${Object.entries(crisis.metrics).map(([key, value]) => `
              <div class="metric-item">
                <div class="metric-value">${value}</div>
                <div class="metric-label">${key}</div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <button class="view-full-impact-btn" onclick="showFullImpactPanel('${crisisId}')">View Full System Analysis</button>
      </div>
    `;

    // Show overlay and panel
    overlay.style.display = 'block';
    crisisPanel.style.display = 'block';
  };

  // Ensure the SVG breakthrough lines are visible and clickable in the individual tab
  const svg = document.querySelector('#individual .sensory-wheel-svg');
  if (!svg) return;

  // Make sure the breakthrough lines exist and are visible
  const breakthroughLines = svg.querySelectorAll('.breakthrough-line');
  breakthroughLines.forEach(line => {
    // Make sure the line is visible
    line.style.opacity = '0.9';
    line.style.cursor = 'pointer';
    
    // Add or update onclick event
    const crisisId = line.id ? line.id.replace('-breakthrough', '') : '';
    if (crisisId && crisisData[crisisId]) {
      line.onclick = function() {
        showBreakthroughInfo(crisisId);
      };
    }
  });
}

// 3. Add Charts
function initializeCharts() {
  // Check if Chart.js is available
  if (typeof Chart === 'undefined') {
    console.error("Chart.js is not available. Charts will not be displayed.");
    return;
  }

  // Create chart containers if they don't exist
  const individualTab = document.getElementById('individual');
  if (!individualTab) return;

  // Add charts section if it doesn't exist
  let chartsSection = document.getElementById('individual-charts-section');
  if (!chartsSection) {
    chartsSection = document.createElement('div');
    chartsSection.id = 'individual-charts-section';
    chartsSection.className = 'individual-case-analytics';
    chartsSection.innerHTML = `
      <h3>System Analysis</h3>
      
      <div class="analytics-item">
        <h4>Response Times vs. Solution Times</h4>
        <div class="analytics-chart-container">
          <canvas id="responseTimesChart"></canvas>
        </div>
      </div>
      
      <div class="analytics-item">
        <h4>System Failures by Department</h4>
        <div class="analytics-chart-container">
          <canvas id="failuresByDeptChart"></canvas>
        </div>
      </div>
      
      <div class="analytics-item">
        <h4>Coordination Attempts vs. Successes</h4>
        <div class="analytics-chart-container">
          <canvas id="coordinationChart"></canvas>
        </div>
      </div>
    `;
    
    // Insert after the wheel container
    const wheelContainer = individualTab.querySelector('.wheel-container');
    if (wheelContainer && wheelContainer.parentNode) {
      wheelContainer.parentNode.insertBefore(chartsSection, wheelContainer.nextSibling);
    } else {
      individualTab.appendChild(chartsSection);
    }
  }

  // Create Response Times Chart
  const responseCtx = document.getElementById('responseTimesChart');
  if (responseCtx) {
    new Chart(responseCtx, {
      type: 'bar',
      data: {
        labels: ['Healthcare', 'DRC', 'Academic', 'Grad School', 'Mental Health', 'OEO'],
        datasets: [{
          label: 'Initial Response Time (days)',
          data: [14, 7, 21, 28, 10, 45],
          backgroundColor: '#1565c0'
        }, {
          label: 'Solution Time (days)',
          data: [30, 60, 90, 180, 45, 147],
          backgroundColor: '#f44336'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Days'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Department Response vs. Solution Times'
          }
        }
      }
    });
  }

  // Create Failures by Department Chart
  const failuresCtx = document.getElementById('failuresByDeptChart');
  if (failuresCtx) {
    new Chart(failuresCtx, {
      type: 'pie',
      data: {
        labels: ['Healthcare', 'DRC', 'Academic', 'Grad School', 'Mental Health', 'OEO', 'Admin', 'ADA'],
        datasets: [{
          data: [25, 15, 20, 15, 10, 5, 5, 5],
          backgroundColor: [
            '#f44336', // Healthcare
            '#ff9800', // DRC
            '#ffc107', // Academic
            '#4caf50', // Grad School
            '#2196f3', // Mental Health
            '#9c27b0', // OEO
            '#795548', // Admin
            '#607d8b'  // ADA
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'System Failures by Department'
          },
          legend: {
            position: 'right'
          }
        }
      }
    });
  }

  // Create Coordination Chart
  const coordCtx = document.getElementById('coordinationChart');
  if (coordCtx) {
    new Chart(coordCtx, {
      type: 'bar',
      data: {
        labels: ['Healthcare', 'DRC', 'Academic', 'Grad School', 'Mental Health', 'OEO', 'Admin'],
        datasets: [{
          label: 'Coordination Attempts',
          data: [12, 8, 7, 5, 9, 6, 14],
          backgroundColor: '#4caf50'
        }, {
          label: 'Successful Coordinations',
          data: [2, 3, 1, 0, 1, 0, 2],
          backgroundColor: '#ff9800'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Count'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Coordination Attempts vs. Successful Coordinations'
          }
        }
      }
    });
  }
}

// 4. Add Checkboxes to Emergency Panel Recommendations
function enhanceEmergencyPanel() {
  // Override updateIndividualRecommendations function to add checkboxes
  window.updateIndividualRecommendations = function() {
    // Get active symptom buttons
    const activeButtons = document.querySelectorAll('#individual .symptom-button.active');
    
    // Get custom description
    const textarea = document.querySelector('#individual .custom-description');
    if (!textarea) return;
    
    const customText = textarea.value.toLowerCase();
    
    // Array to collect unique interventions with categories
    const categorizedInterventions = {};
    
    // Institutional intervention suggestions
    const interventionsBySystem = window.individualInterventionsBySystem || {
      'healthcare': [
        "Request complete copies of all medical records",
        "Ask for a patient advocate to coordinate care",
        "Document all treatment recommendations and referrals",
        "Create an emergency care plan with specific protocols for FND/PNES",
        "Bring a trusted friend to all medical appointments",
        "Request a neurologist experienced with functional disorders"
      ],
      'accommodation': [
        "Request accommodations in writing with delivery confirmation",
        "Ask which office is responsible for implementation",
        "Document all accommodation discussions and promises",
        "CC multiple departments in all accommodation communications",
        "Request specific accommodations for research settings",
        "Ask for flexible attendance and remote participation options"
      ],
      'academic': [
        "Request written clarification of academic expectations",
        "Document all meetings with faculty and advisors",
        "Ask the ombudsperson to facilitate department communications",
        "Request accommodations specific to research environment",
        "Create a written work plan with flexibility built in",
        "Inquire about deadline extensions before they're needed"
      ],
      'coordination': [
        "Ask ombudsperson to coordinate a multi-office meeting",
        "Create a contact list of all involved departments",
        "Request written clarification of each office's responsibilities",
        "Document all instances of being referred between offices",
        "Involve external advocacy organization for support",
        "Request a single point of contact for your case"
      ],
      'mental': [
        "Contact crisis services if experiencing suicidal thoughts: 988",
        "Document impact of institutional stress on your health",
        "Request medical leave paperwork if needed",
        "Ask for referrals to external mental health providers",
        "Practice grounding techniques during stressful interactions",
        "Create a safety plan with trusted people in your network"
      ],
      'financial': [
        "Contact financial aid office about hardship options",
        "Document all additional expenses caused by disability barriers",
        "Request emergency funding for disability-related needs",
        "Research external scholarships for disabled students",
        "Consider filing for disability-related loan deferment",
        "Request itemized invoices for all medical costs"
      ],
      'visa': [
        "Contact international student office about medical reduced course load",
        "Document all communications about visa status",
        "Request written clarification of visa requirements during medical issues",
        "Connect with international student advocacy groups",
        "Consult with immigration attorney about medical exceptions",
        "Ask about extensions for international student requirements"
      ]
    };
    
    // Keyword map for analyzing text input
    const keywordMap = {
      // Healthcare related keywords
      "hospital": "healthcare", "doctor": "healthcare", "medical": "healthcare", 
      "diagnosis": "healthcare", "treatment": "healthcare", "seizure": "healthcare",
      "emergency": "healthcare", "medication": "healthcare", "pnes": "healthcare",
      "fnd": "healthcare", "neurological": "healthcare", "functional": "healthcare",
      
      // Accommodation related keywords
      "accommodation": "accommodation", "drc": "accommodation", "disability": "accommodation",
      "ada": "accommodation", "access": "accommodation", "barrier": "accommodation",
      "section 504": "accommodation", "modification": "accommodation",
      
      // Academic related keywords
      "professor": "academic", "advisor": "academic", "research": "academic",
      "lab": "academic", "course": "academic", "class": "academic", "department": "academic",
      "pi": "academic", "dgs": "academic", "assistantship": "academic", "termination": "academic",
      
      // Coordination related keywords
      "coordinate": "coordination", "refer": "coordination", "office": "coordination",
      "bureaucracy": "coordination", "paperwork": "coordination", "process": "coordination",
      "referral": "coordination", "silo": "coordination", "fragmented": "coordination",
      
      // Mental health related keywords
      "stress": "mental", "anxiety": "mental", "depression": "mental", 
      "suicide": "mental", "therapist": "mental", "counselor": "mental",
      "overwhelm": "mental", "crisis": "mental", "mdd": "mental", 
      "cptsd": "mental", "trauma": "mental", "ukcc": "mental",
      
      // Financial related keywords
      "money": "financial", "fund": "financial", "pay": "financial",
      "cost": "financial", "afford": "financial", "expense": "financial",
      "stipend": "financial", "tuition": "financial", "insurance": "financial",
      
      // International/visa related keywords
      "visa": "visa", "international": "visa", "foreign": "visa",
      "country": "visa", "immigrant": "visa", "status": "visa",
      "i-20": "visa", "sevis": "visa", "home": "visa"
    };
    
    // Add interventions from active buttons
    activeButtons.forEach(button => {
      const system = button.dataset.system;
      if (system && interventionsBySystem[system]) {
        if (!categorizedInterventions[system]) {
          categorizedInterventions[system] = [];
        }
        
        // Add unique interventions
        interventionsBySystem[system].forEach(intervention => {
          if (!categorizedInterventions[system].includes(intervention)) {
            categorizedInterventions[system].push(intervention);
          }
        });
      }
    });
    
    // Add interventions based on text analysis
    for (const [keyword, system] of Object.entries(keywordMap)) {
      if (customText.includes(keyword) && interventionsBySystem[system]) {
        if (!categorizedInterventions[system]) {
          categorizedInterventions[system] = [];
        }
        
        // Add unique interventions
        interventionsBySystem[system].forEach(intervention => {
          if (!categorizedInterventions[system].includes(intervention)) {
            categorizedInterventions[system].push(intervention);
          }
        });
      }
    }
    
    // Update the recommendations display
    const immediateList = document.getElementById('individual-immediate-interventions');
    if (!immediateList) return;
    
    // Clear previous recommendations
    immediateList.innerHTML = '';
    
    // Office related interventions that need checkboxes
    const officeRelatedKeywords = [
      'drc', 'office', 'ada', 'ombud', 'ombudsperson', 'graduate', 'school', 
      'coordinator', 'department', 'chair', 'dean', 'director', 'advisor', 'pi',
      'disability', 'resource', 'center', 'compliance', 'affairs', 'academic',
      'faculty', 'financial', 'aid', 'international', 'counseling', 'health'
    ];
    
    // Add new recommendations, ALL with checkboxes
    if (Object.keys(categorizedInterventions).length > 0) {
      // First add the "solution map" concept
      const infoDiv = document.createElement('div');
      infoDiv.className = 'solution-map-info';
      infoDiv.innerHTML = `
        <p style="font-size: 14px; font-style: italic; margin-bottom: 15px; color: #4a6fa5;">
          Check boxes next to actions and click "Routes" to see a coordination pathway through the system.
        </p>
      `;
      immediateList.appendChild(infoDiv);
      
      // Get the top 2 categories
      const topCategories = Object.keys(categorizedInterventions).slice(0, 3);
      
      // For each category, add top recommendations
      topCategories.forEach(category => {
        const recommendations = categorizedInterventions[category].slice(0, 3);
        
        recommendations.forEach(recommendation => {
          const li = document.createElement('li');
          
          // Add checkbox to every recommendation
          const id = 'rec-' + Math.random().toString(36).substring(7);
          li.innerHTML = `
            <div class="checkbox-recommendation">
              <input type="checkbox" id="${id}" class="recommendation-checkbox" data-category="${category}">
              <label for="${id}">${recommendation}</label>
            </div>
          `;
          
          immediateList.appendChild(li);
        });
      });
      
      // Add a "Routes" button
      const routesBtn = document.createElement('button');
      routesBtn.className = 'routes-btn';
      routesBtn.textContent = 'Routes';
      routesBtn.style.marginTop = '15px';
      routesBtn.style.padding = '8px 15px';
      routesBtn.style.backgroundColor = '#4a6fa5';
      routesBtn.style.color = 'white';
      routesBtn.style.border = 'none';
      routesBtn.style.borderRadius = '4px';
      routesBtn.style.cursor = 'pointer';
      
      routesBtn.onclick = function() {
        showRoutesMap();
      };
      
      immediateList.appendChild(routesBtn);
      
    } else {
      const li = document.createElement('li');
      li.innerHTML = `
        <div class="checkbox-recommendation">
          <input type="checkbox" id="rec-default" class="recommendation-checkbox">
          <label for="rec-default">Click a button above or describe what you're experiencing</label>
        </div>
      `;
      immediateList.appendChild(li);
    }
  };

  // Set up toggle mode for buttons
  function enhanceSymptomButtons() {
    // Add toggle switch for behavior mode
    const buttonContainer = document.querySelector('#individual .symptom-buttons');
    if (!buttonContainer) return;
    
    // Add a toggle switch for behavior mode if it doesn't exist
    if (!document.getElementById('button-mode-toggle')) {
      const toggleDiv = document.createElement('div');
      toggleDiv.style.display = 'flex';
      toggleDiv.style.alignItems = 'center';
      toggleDiv.style.justifyContent = 'flex-end';
      toggleDiv.style.marginBottom = '10px';
      
      const toggleLabel = document.createElement('label');
      toggleLabel.htmlFor = 'button-mode-toggle';
      toggleLabel.style.marginRight = '10px';
      toggleLabel.style.fontSize = '14px';
      toggleLabel.style.color = 'white';
      toggleLabel.textContent = 'Toggle Mode:';
      
      const toggleSelect = document.createElement('select');
      toggleSelect.id = 'button-mode-toggle';
      toggleSelect.style.padding = '5px';
      toggleSelect.style.borderRadius = '4px';
      
      const multiOption = document.createElement('option');
      multiOption.value = 'multi';
      multiOption.textContent = 'Combine Issues';
      
      const singleOption = document.createElement('option');
      singleOption.value = 'single';
      singleOption.textContent = 'One Issue at a Time';
      
      toggleSelect.appendChild(multiOption);
      toggleSelect.appendChild(singleOption);
      
      toggleDiv.appendChild(toggleLabel);
      toggleDiv.appendChild(toggleSelect);
      
      // Insert before the buttons
      buttonContainer.parentNode.insertBefore(toggleDiv, buttonContainer);
      
      // Add event listener to toggle
      toggleSelect.addEventListener('change', function() {
        const buttons = document.querySelectorAll('#individual .symptom-button');
        
        // Reset all buttons
        buttons.forEach(button => {
          button.classList.remove('active');
        });
        
        // Update recommendations
        updateIndividualRecommendations();
      });
    }
    
    // Update button click behavior
    const buttons = document.querySelectorAll('#individual .symptom-button');
    buttons.forEach(button => {
      // Remove any existing event listeners by cloning
      const newButton = button.cloneNode(true);
      button.parentNode.replaceChild(newButton, button);
      
      // Add new click handler
      newButton.addEventListener('click', function() {
        const mode = document.getElementById('button-mode-toggle')?.value || 'multi';
        
        if (mode === 'single') {
          // Single selection mode - deselect others
          document.querySelectorAll('#individual .symptom-button').forEach(btn => {
            btn.classList.remove('active');
          });
        }
        
        // Toggle this button
        this.classList.toggle('active');
        
        // Update recommendations
        updateIndividualRecommendations();
      });
    });
  }
  
  // Call enhanceSymptomButtons
  enhanceSymptomButtons();
  
  // Make sure textarea triggers recommendations update
  const textarea = document.querySelector('#individual .custom-description');
  if (textarea) {
    // Create new textarea to remove old listeners
    const newTextarea = textarea.cloneNode(true);
    textarea.parentNode.replaceChild(newTextarea, textarea);
    
    // Add listener to update recommendations when typing
    newTextarea.addEventListener('input', _.debounce(function() {
      updateIndividualRecommendations();
    }, 500));
  }
}

// 5. Create Route Map Interface
function createRouteMapInterface() {
  // Add the routes map panel if it doesn't exist
  let routesPanel = document.getElementById('routes-panel');
  if (!routesPanel) {
    routesPanel = document.createElement('div');
    routesPanel.id = 'routes-panel';
    routesPanel.className = 'crisis-panel';
    routesPanel.style.display = 'none';
    document.body.appendChild(routesPanel);
  }
  
  // Function to show the routes map
  window.showRoutesMap = function() {
    // Get selected recommendations
    const selectedCheckboxes = document.querySelectorAll('#individual .recommendation-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
      alert('Please select at least one recommendation to generate routes.');
      return;
    }
    
    // Get categories from selected recommendations
    const selectedCategories = new Set();
    selectedCheckboxes.forEach(checkbox => {
      const category = checkbox.dataset.category;
      if (category) selectedCategories.add(category);
    });
    
    // Create the routes map
    routesPanel.innerHTML = `
      <div class="crisis-header">
        <h2 class="crisis-title">Institutional Navigation Routes</h2>
        <button class="close-panel" onclick="document.getElementById('routes-panel').style.display='none'; document.getElementById('panel-overlay').style.display='none';">&times;</button>
      </div>
      
      <div class="routes-content">
        <p>Below is the optimized path through ${selectedCheckboxes.length} selected actions across ${selectedCategories.size} university systems:</p>
        
        <div class="routes-map-container" style="height: 400px; margin: 20px 0;">
          <svg id="routes-map-svg" width="100%" height="100%" viewBox="0 0 800 400">
            <!-- SVG map will be dynamically generated -->
          </svg>
        </div>
        
        <div class="routes-metrics">
          <div class="metrics-grid">
            <div class="metric-item">
              <div class="metric-value">${selectedCheckboxes.length}</div>
              <div class="metric-label">Total Actions</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">${selectedCategories.size}</div>
              <div class="metric-label">Departments Involved</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">${Math.min(21, selectedCheckboxes.length * 3)}</div>
              <div class="metric-label">Estimated Days</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">${Math.round(100 - (20 / (selectedCategories.size + 1)))}%</div>
              <div class="metric-label">Success Probability</div>
            </div>
          </div>
        </div>
        
        <button class="start-routes-btn" style="display: block; margin: 20px auto; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
          Start Coordination
        </button>
      </div>
    `;
    
    // Generate the SVG map
    generateRoutesMap([...selectedCategories]);
    
    // Add click handler for start button
    const startBtn = routesPanel.querySelector('.start-routes-btn');
    if (startBtn) {
      startBtn.onclick = function() {
        animateRoutes();
      };
    }
    
    // Show the panel
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    routesPanel.style.display = 'block';
  };
  
  // Function to generate the routes map
  function generateRoutesMap(categories) {
    const svg = document.getElementById('routes-map-svg');
    if (!svg) return;
    
    // Clear existing content
    svg.innerHTML = '';
    
    // Office locations and colors
    const offices = {
      'student': { x: 400, y: 350, color: '#2196F3', label: 'Student' },
      'healthcare': { x: 200, y: 100, color: '#F44336', label: 'Healthcare' },
      'accommodation': { x: 350, y: 50, color: '#FF9800', label: 'DRC' },
      'academic': { x: 500, y: 100, color: '#4CAF50', label: 'Academic Dept' },
      'coordination': { x: 650, y: 200, color: '#9C27B0', label: 'Ombud' },
      'mental': { x: 600, y: 300, color: '#2196F3', label: 'Mental Health' },
      'financial': { x: 200, y: 300, color: '#795548', label: 'Financial Aid' },
      'visa': { x: 150, y: 200, color: '#607D8B', label: 'Int\'l Office' }
    };
    
    // Add student node
    const studentNode = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    studentNode.setAttribute('cx', offices.student.x);
    studentNode.setAttribute('cy', offices.student.y);
    studentNode.setAttribute('r', '20');
    studentNode.setAttribute('fill', offices.student.color);
    svg.appendChild(studentNode);
    
    // Add student label
    const studentLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    studentLabel.setAttribute('x', offices.student.x);
    studentLabel.setAttribute('y', offices.student.y + 35);
    studentLabel.setAttribute('text-anchor', 'middle');
    studentLabel.setAttribute('fill', '#000');
    studentLabel.textContent = offices.student.label;
    svg.appendChild(studentLabel);
    
    // Add case manager node if multiple categories
    if (categories.length > 1) {
      const cmNode = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      cmNode.setAttribute('cx', 400);
      cmNode.setAttribute('cy', 200);
      cmNode.setAttribute('r', '25');
      cmNode.setAttribute('fill', '#673AB7');
      svg.appendChild(cmNode);
      
      // Add case manager label
      const cmLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      cmLabel.setAttribute('x', 400);
      cmLabel.setAttribute('y', 205);
      cmLabel.setAttribute('text-anchor', 'middle');
      cmLabel.setAttribute('fill', '#FFF');
      cmLabel.textContent = 'CM';
      svg.appendChild(cmLabel);
      
      // Connect student to case manager
      const cmPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      cmPath.setAttribute('d', `M${offices.student.x},${offices.student.y} L400,200`);
      cmPath.setAttribute('stroke', '#000');
      cmPath.setAttribute('stroke-width', '3');
      cmPath.setAttribute('stroke-dasharray', '5,5');
      cmPath.setAttribute('fill', 'none');
      cmPath.id = 'path-to-cm';
      svg.appendChild(cmPath);
    }
    
    // Add selected office nodes and connect them
    categories.forEach(category => {
      if (offices[category]) {
        // Add office node
        const officeNode = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        officeNode.setAttribute('cx', offices[category].x);
        officeNode.setAttribute('cy', offices[category].y);
        officeNode.setAttribute('r', '20');
        officeNode.setAttribute('fill', offices[category].color);
        svg.appendChild(officeNode);
        
        // Add office label
        const officeLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        officeLabel.setAttribute('x', offices[category].x);
        officeLabel.setAttribute('y', offices[category].y + 35);
        officeLabel.setAttribute('text-anchor', 'middle');
        officeLabel.setAttribute('fill', '#000');
        officeLabel.textContent = offices[category].label;
        svg.appendChild(officeLabel);
        
        // Connect to case manager or directly to student
        if (categories.length > 1) {
          // Connect to case manager
          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', `M400,200 L${offices[category].x},${offices[category].y}`);
          path.setAttribute('stroke', '#000');
          path.setAttribute('stroke-width', '3');
          path.setAttribute('stroke-dasharray', '5,5');
          path.setAttribute('fill', 'none');
          path.id = `path-to-${category}`;
          svg.appendChild(path);
        } else {
          // Connect directly to student
          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', `M${offices.student.x},${offices.student.y} L${offices[category].x},${offices[category].y}`);
          path.setAttribute('stroke', '#000');
          path.setAttribute('stroke-width', '3');
          path.setAttribute('stroke-dasharray', '5,5');
          path.setAttribute('fill', 'none');
          path.id = `path-to-${category}`;
          svg.appendChild(path);
        }
      }
    });
  }
  
  // Function to animate the routes
  function animateRoutes() {
    // Animate the paths by changing dash array
    const paths = document.querySelectorAll('#routes-map-svg path');
    
    // Reset animations
    paths.forEach(path => {
      path.style.strokeDasharray = '5,5';
      path.style.animation = 'none';
    });
    
    // Apply animation to each path with delay
    paths.forEach((path, index) => {
      setTimeout(() => {
        path.style.stroke = '#4CAF50';
        path.style.strokeDasharray = '0,0';
        path.style.transition = 'stroke-dasharray 1.5s ease-in-out';
      }, index * 700);
    });
    
    // Add completion message after all animations
    setTimeout(() => {
      alert('Coordination route established! In a real implementation, this would notify all relevant offices and create a case management workflow.');
    }, (paths.length * 700) + 1000);
  }
}

// 6. Enhance Full Impact Panel
function enhanceFullImpactPanel() {
  // Define systemic impact data with more numerical metrics
  window.systemicImpact = {
    'healthcare': {
      title: "Healthcare System Impact Analysis",
      systemFailures: [
        "Fragmented electronic health records prevented continuity of care",
        "No protocols for rare conditions like FND/PNES",
        "No care coordination between university health units"
      ],
      recommendations: [
        "Implement integrated EHR system across all university health units",
        "Create protocols for complex/rare condition management",
        "Assign care coordinators for students with multiple diagnoses"
      ],
      metrics: {
        "Coordination Failures": 12,
        "Treatment Delays": "45 days avg",
        "Information Handoff Errors": 8,
        "Patient Safety Incidents": 3,
        "Policy Gaps Identified": 5
      },
      chartData: {
        labels: ['Coordination', 'Information', 'Treatment', 'Safety', 'Policy'],
        values: [12, 8, 45, 3, 5]
      }
    },
    'drc': {
      title: "Disability Resources System Impact Analysis",
      systemFailures: [
        "Accommodation letters not applicable to research settings",
        "No enforcement mechanism for accommodations",
        "Limited understanding of complex/invisible disabilities"
      ],
      recommendations: [
        "Develop research-specific accommodation protocols",
        "Create accommodation enforcement procedures",
        "Establish regular training on complex disabilities"
      ],
      metrics: {
        "Research Settings Without Coverage": "100%",
        "Unenforced Accommodations": 7,
        "Referrals Without Resolution": 9,
        "Policy Gaps Identified": 4,
        "Coordination Failures": 8
      },
      chartData: {
        labels: ['Research Gaps', 'Enforcement', 'Referrals', 'Policy', 'Coordination'],
        values: [100, 7, 9, 4, 8]
      }
    },
    'academic': {
      title: "Academic Department System Impact Analysis",
      systemFailures: [
        "No training for faculty on disability accommodations",
        "Unilateral termination of accommodated students",
        "No clear procedure for research accommodations"
      ],
      recommendations: [
        "Mandatory faculty training on disability accommodations",
        "Create clear research accommodation guidelines",
        "Implement termination review process for disabled students"
      ],
      metrics: {
        "Faculty Trained in Accommodations": "0%",
        "Accessible Research Labs": "15%",
        "Accommodation Implementation Rate": "32%",
        "Discrimination Incidents": 3,
        "Policy Gaps Identified": 6
      },
      chartData: {
        labels: ['Faculty Training', 'Lab Accessibility', 'Implementation', 'Incidents', 'Policy'],
        values: [0, 15, 32, 3, 6]
      }
    },
    'diagnosis': {
      title: "PNES Diagnosis Crisis Impact Analysis",
      systemFailures: [
        "No care coordination after rare disease diagnosis",
        "Fragmented referral system with no follow-through",
        "No medical management protocols for FND/PNES"
      ],
      recommendations: [
        "Create post-diagnosis care coordination protocol",
        "Develop seamless referral and tracking system",
        "Establish FND/PNES management guidelines"
      ],
      metrics: {
        "Days Without Treatment Plan": 45,
        "Referrals Without Follow-up": 3,
        "Coordination Attempts": 7,
        "Successful Coordinations": 0,
        "Health Deterioration Incidents": 2
      },
      chartData: {
        labels: ['Treatment Gap', 'Failed Referrals', 'Coordination Attempts', 'Successes', 'Health Incidents'],
        values: [45, 3, 7, 0, 2]
      }
    },
    'handcuffing': {
      title: "Psychiatric Detention Crisis Impact Analysis",
      systemFailures: [
        "EHR failure to flag critical medical information",
        "Improper use of law enforcement for medical condition",
        "Missing protocols for neurological vs. psychiatric presentation"
      ],
      recommendations: [
        "Implement critical information flagging in EHR",
        "Create appropriate medical transport protocols",
        "Develop differential response guidelines for complex presentations"
      ],
      metrics: {
        "Policy Violations": 5,
        "Patient Safety Events": 3,
        "Documentation Failures": 8,
        "Staff Training Gaps": 4,
        "Healthcare Rights Violations": 6
      },
      chartData: {
        labels: ['Policy Violations', 'Safety Events', 'Documentation', 'Training Gaps', 'Rights Violations'],
        values: [5, 3, 8, 4, 6]
      }
    },
    'suicide': {
      title: "Suicide Attempt Crisis Impact Analysis",
      systemFailures: [
        "Complete failure of mental health safety net",
        "Previous traumatic interventions preventing help-seeking",
        "No follow-up system for high-risk patients"
      ],
      recommendations: [
        "Redesign mental health safety net systems",
        "Create trauma-informed crisis response protocols",
        "Implement mandatory follow-up for high-risk cases"
      ],
      metrics: {
        "Warning Signs Missed": 12,
        "Failed Intervention Points": 7,
        "System Disconnections Identified": 9,
        "Protocol Gaps": 6,
        "Coordination Failures": 14
      },
      chartData: {
        labels: ['Warning Signs', 'Failed Interventions', 'Disconnections', 'Protocol Gaps', 'Coordination Failures'],
        values: [12, 7, 9, 6, 14]
      }
    },
    'assistantship': {
      title: "Assistantship Termination Crisis Impact Analysis",
      systemFailures: [
        "No accommodation process for research settings",
        "Discriminatory termination without review",
        "Graduate School failure to oversee department actions"
      ],
      recommendations: [
        "Create research accommodation protocols",
        "Establish termination review process for disabled students",
        "Implement Graduate School oversight of departments"
      ],
      metrics: {
        "ADA Violations": 5,
        "Section 504 Violations": 7,
        "Documentation Failures": 9,
        "Financial Impact": "$18,000+",
        "Career Impact": "Severe"
      },
      chartData: {
        labels: ['ADA Violations', '504 Violations', 'Documentation', 'Financial ($K)', 'Career (1-10)'],
        values: [5, 7, 9, 18, 10]
      }
    },
    'investigation': {
      title: "OEO Investigation Crisis Impact Analysis",
      systemFailures: [
        "No interim protections during investigation",
        "Excessive investigation timeline without updates",
        "Narrow interpretation of discrimination evidence"
      ],
      recommendations: [
        "Mandate interim protections during investigations",
        "Establish and enforce investigation timelines",
        "Broaden interpretation of discrimination evidence"
      ],
      metrics: {
        "Days Without Protection": 147,
        "Communication Failures": 12,
        "Policy Violations": 8,
        "Health Deterioration Events": 3,
        "Academic Time Lost": "1 semester"
      },
      chartData: {
        labels: ['Days Unprotected', 'Communications', 'Policy Violations', 'Health Events', 'Time Lost (days)'],
        values: [147, 12, 8, 3, 120]
      }
    }
  };

  // Override showFullImpactPanel function
  window.showFullImpactPanel = function(id) {
    // Create or get full impact panel
    let impactPanel = document.getElementById('full-impact-panel');
    if (!impactPanel) {
      impactPanel = document.createElement('div');
      impactPanel.id = 'full-impact-panel';
      impactPanel.className = 'crisis-panel';
      document.body.appendChild(impactPanel);
    }
    
    // Get the relevant impact data
    const impactData = window.systemicImpact[id] || {};
    
    // Create impact panel content
    impactPanel.innerHTML = `
      <div class="crisis-header">
        <h2 class="crisis-title">${impactData.title || 'System Impact Analysis'}</h2>
        <button class="close-panel" onclick="document.getElementById('full-impact-panel').style.display='none'; document.getElementById('panel-overlay').style.display='none';">&times;</button>
      </div>
      
      <div class="crisis-content">
        <div class="impact-section">
          <h3>Key Metrics</h3>
          <div class="metrics-grid">
            ${Object.entries(impactData.metrics || {}).map(([key, value]) => `
              <div class="metric-item">
                <div class="metric-value">${value}</div>
                <div class="metric-label">${key}</div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="impact-section">
          <h3>Impact Visualization</h3>
          <div class="impact-chart-container" style="height: 300px;">
            <canvas id="impact-chart-${id}"></canvas>
          </div>
        </div>
        
        <div class="impact-section">
          <h3>Critical System Failures</h3>
          <ul>
            ${(impactData.systemFailures || []).map(failure => `<li>${failure}</li>`).join('')}
          </ul>
        </div>
        
        <div class="impact-section">
          <h3>Recommended System Changes</h3>
          <ul>
            ${(impactData.recommendations || []).map(rec => `<li>${rec}</li>`).join('')}
          </ul>
        </div>
        
        <div class="impact-section">
          <h3>Compliance Implications</h3>
          <p>This analysis indicates potential violations of:</p>
          <ul>
            <li>Americans with Disabilities Act (ADA) Title II</li>
            <li>Section 504 of the Rehabilitation Act</li>
            <li>University's own stated policies on accommodations</li>
            <li>Kentucky Civil Rights Act (KRS § 344.010 et seq.)</li>
          </ul>
        </div>
      </div>
    `;
    
    // Show the overlay
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    
    // Show the impact panel
    impactPanel.style.display = 'block';
    
    // Create chart after panel is visible
    setTimeout(() => {
      createImpactChart(id, impactData.chartData);
    }, 100);
  };
  
  // Function to create impact chart
  function createImpactChart(id, chartData) {
    if (!chartData || typeof Chart === 'undefined') return;
    
    const canvas = document.getElementById(`impact-chart-${id}`);
    if (!canvas) return;
    
    new Chart(canvas, {
      type: 'bar',
      data: {
        labels: chartData.labels || [],
        datasets: [{
          label: 'Impact Metrics',
          data: chartData.values || [],
          backgroundColor: [
            '#f44336',
            '#ff9800',
            '#ffc107',
            '#4caf50',
            '#2196f3'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Impact Measurements'
          }
        }
      }
    });
  }
}

// Master initialization function
function initializeIndividualTab() {
  // Fix References button
  fixReferencesButton();
  
  // Add breakthrough lines and their functionality
  addBreakthroughLines();
  
  // Initialize charts
  initializeCharts();
  
  // Enhance emergency panel with checkboxes
  enhanceEmergencyPanel();
  
  // Create route map interface
  createRouteMapInterface();
  
  // Enhance full impact panel with more metrics and charts
  enhanceFullImpactPanel();
  
  // Make sure recommendations are updated
  updateIndividualRecommendations();
  
  console.log("Individual tab enhancements loaded successfully");
}

// Call initialization when the document is loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeIndividualTab);
} else {
  // Document already loaded
  initializeIndividualTab();
}
</script>
<script>
  // ===== INDIVIDUAL TAB FIXES - REVISED =====

// 1. Fix Routes Button - Make it left-aligned and functional
function fixRoutesButton() {
  // Routes button should be left-aligned
  document.querySelectorAll('.routes-btn').forEach(btn => {
    btn.style.margin = '15px 0'; // Change from 'margin: 15px auto' to align left
  });
  
  // Ensure showRoutesMap function exists and works
  window.showRoutesMap = function() {
    // Get selected recommendations
    const selectedCheckboxes = document.querySelectorAll('#individual .recommendation-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
      alert('Please select at least one recommendation to generate routes.');
      return;
    }
    
    // Create or get routes panel
    let routesPanel = document.getElementById('routes-panel');
    if (!routesPanel) {
      routesPanel = document.createElement('div');
      routesPanel.id = 'routes-panel';
      routesPanel.className = 'crisis-panel';
      document.body.appendChild(routesPanel);
    }
    
    // Get categories from selected recommendations
    const selectedCategories = new Set();
    selectedCheckboxes.forEach(checkbox => {
      const category = checkbox.dataset.category;
      if (category) selectedCategories.add(category);
    });
    
    // Create the routes map
    routesPanel.innerHTML = `
      <div class="crisis-header">
        <h2 class="crisis-title">Institutional Navigation Routes</h2>
        <button class="close-panel" onclick="document.getElementById('routes-panel').style.display='none'; document.getElementById('panel-overlay').style.display='none';">&times;</button>
      </div>
      
      <div class="routes-content">
        <p>Below is the optimized path through ${selectedCheckboxes.length} selected actions across ${selectedCategories.size} university systems:</p>
        
        <div class="routes-map-container" style="height: 400px; margin: 20px 0;">
          <svg id="routes-map-svg" width="100%" height="100%" viewBox="0 0 800 400">
            <!-- SVG map will be dynamically generated -->
          </svg>
        </div>
        
        <div class="routes-metrics">
          <div class="metrics-grid">
            <div class="metric-item">
              <div class="metric-value">${selectedCheckboxes.length}</div>
              <div class="metric-label">Total Actions</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">${selectedCategories.size}</div>
              <div class="metric-label">Departments Involved</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">${Math.min(21, selectedCheckboxes.length * 3)}</div>
              <div class="metric-label">Estimated Days</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">${Math.round(100 - (20 / (selectedCategories.size + 1)))}%</div>
              <div class="metric-label">Success Probability</div>
            </div>
          </div>
        </div>
        
        <button class="start-routes-btn" style="display: block; margin: 20px 0; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
          Start Coordination
        </button>
      </div>
    `;
    
    // Generate the SVG map
    generateRoutesMap([...selectedCategories]);
    
    // Add click handler for start button
    const startBtn = routesPanel.querySelector('.start-routes-btn');
    if (startBtn) {
      startBtn.onclick = function() {
        animateRoutes();
      };
    }
    
    // Show the panel
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    routesPanel.style.display = 'block';
  };
}

// Function to generate the routes map
function generateRoutesMap(categories) {
  const svg = document.getElementById('routes-map-svg');
  if (!svg) return;
  
  // Clear existing content
  svg.innerHTML = '';
  
  // Office locations and colors
  const offices = {
    'student': { x: 400, y: 350, color: '#2196F3', label: 'Student' },
    'healthcare': { x: 200, y: 100, color: '#F44336', label: 'Healthcare' },
    'accommodation': { x: 350, y: 50, color: '#FF9800', label: 'DRC' },
    'academic': { x: 500, y: 100, color: '#4CAF50', label: 'Academic Dept' },
    'coordination': { x: 650, y: 200, color: '#9C27B0', label: 'Ombud' },
    'mental': { x: 600, y: 300, color: '#2196F3', label: 'Mental Health' },
    'financial': { x: 200, y: 300, color: '#795548', label: 'Financial Aid' },
    'visa': { x: 150, y: 200, color: '#607D8B', label: 'Int\'l Office' }
  };
  
  // Add student node
  const studentNode = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  studentNode.setAttribute('cx', offices.student.x);
  studentNode.setAttribute('cy', offices.student.y);
  studentNode.setAttribute('r', '20');
  studentNode.setAttribute('fill', offices.student.color);
  svg.appendChild(studentNode);
  
  // Add student label
  const studentLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  studentLabel.setAttribute('x', offices.student.x);
  studentLabel.setAttribute('y', offices.student.y + 35);
  studentLabel.setAttribute('text-anchor', 'middle');
  studentLabel.setAttribute('fill', '#000');
  studentLabel.textContent = offices.student.label;
  svg.appendChild(studentLabel);
  
  // Add case manager node if multiple categories
  if (categories.length > 1) {
    const cmNode = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    cmNode.setAttribute('cx', 400);
    cmNode.setAttribute('cy', 200);
    cmNode.setAttribute('r', '25');
    cmNode.setAttribute('fill', '#673AB7');
    svg.appendChild(cmNode);
    
    // Add case manager label
    const cmLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    cmLabel.setAttribute('x', 400);
    cmLabel.setAttribute('y', 205);
    cmLabel.setAttribute('text-anchor', 'middle');
    cmLabel.setAttribute('fill', '#FFF');
    cmLabel.textContent = 'CM';
    svg.appendChild(cmLabel);
    
    // Connect student to case manager
    const cmPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    cmPath.setAttribute('d', `M${offices.student.x},${offices.student.y} L400,200`);
    cmPath.setAttribute('stroke', '#000');
    cmPath.setAttribute('stroke-width', '3');
    cmPath.setAttribute('stroke-dasharray', '5,5');
    cmPath.setAttribute('fill', 'none');
    cmPath.id = 'path-to-cm';
    svg.appendChild(cmPath);
  }
  
  // Add selected office nodes and connect them
  categories.forEach(category => {
    if (offices[category]) {
      // Add office node
      const officeNode = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      officeNode.setAttribute('cx', offices[category].x);
      officeNode.setAttribute('cy', offices[category].y);
      officeNode.setAttribute('r', '20');
      officeNode.setAttribute('fill', offices[category].color);
      svg.appendChild(officeNode);
      
      // Add office label
      const officeLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      officeLabel.setAttribute('x', offices[category].x);
      officeLabel.setAttribute('y', offices[category].y + 35);
      officeLabel.setAttribute('text-anchor', 'middle');
      officeLabel.setAttribute('fill', '#000');
      officeLabel.textContent = offices[category].label;
      svg.appendChild(officeLabel);
      
      // Connect to case manager or directly to student
      if (categories.length > 1) {
        // Connect to case manager
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M400,200 L${offices[category].x},${offices[category].y}`);
        path.setAttribute('stroke', '#000');
        path.setAttribute('stroke-width', '3');
        path.setAttribute('stroke-dasharray', '5,5');
        path.setAttribute('fill', 'none');
        path.id = `path-to-${category}`;
        svg.appendChild(path);
      } else {
        // Connect directly to student
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M${offices.student.x},${offices.student.y} L${offices[category].x},${offices[category].y}`);
        path.setAttribute('stroke', '#000');
        path.setAttribute('stroke-width', '3');
        path.setAttribute('stroke-dasharray', '5,5');
        path.setAttribute('fill', 'none');
        path.id = `path-to-${category}`;
        svg.appendChild(path);
      }
    }
  });
}

// Function to animate the routes
function animateRoutes() {
  // Animate the paths by changing dash array
  const paths = document.querySelectorAll('#routes-map-svg path');
  
  // Reset animations
  paths.forEach(path => {
    path.style.strokeDasharray = '5,5';
    path.style.animation = 'none';
  });
  
  // Apply animation to each path with delay
  paths.forEach((path, index) => {
    setTimeout(() => {
      path.style.stroke = '#4CAF50';
      path.style.strokeDasharray = '0,0';
      path.style.transition = 'stroke-dasharray 1.5s ease-in-out';
    }, index * 700);
  });
  
  // Add completion message after all animations
  setTimeout(() => {
    alert('Coordination route established! In a real implementation, this would notify all relevant offices and create a case management workflow.');
  }, (paths.length * 700) + 1000);
}

// 2. Hide charts by default - Show only emergency panel and wheel
function hideExtraElements() {
  // Add CSS to ensure only emergency panel and wheel are shown initially
  const styleElem = document.createElement('style');
  styleElem.textContent = `
    #individual .individual-case-analytics {
      display: none;
    }
    
    #individual .sensory-content ~ * {
      display: none;
    }
    
    #individual .emergency-panel,
    #individual .sensory-content,
    #individual .research-references-btn {
      display: block;
    }
  `;
  document.head.appendChild(styleElem);
  
  // Make sure research references button is still visible but panel is hidden
  const researchBtn = document.getElementById('individual-research-btn');
  const researchPanel = document.getElementById('individual-research-panel');
  
  if (researchBtn) researchBtn.style.display = 'block';
  if (researchPanel) researchPanel.style.display = 'none';
}

// 3. Fix breakthrough lines placement and functionality
function fixBreakthroughLines() {
  // Crisis data for the breakthrough information panels
  const crisisData = {
    'diagnosis': {
      title: "PNES Diagnosis Crisis",
      date: "Jan 2023",
      description: "Diagnosed with Psychogenic Non-Epileptic Seizures (PNES), a rare functional neurological disorder, with no coordinated care plan provided.",
      quote: "I was discharged to navigate a labyrinth of fragmented services alone.",
      metrics: {
        "Days Without Treatment Plan": 45,
        "Referrals Without Follow-up": 3,
        "Information Handoffs Failed": 7,
        "Health Impact Severity": "High",
        "Institutional Response Grade": "F"
      }
    },
    'handcuffing': {
      title: "Psychiatric Detention Crisis",
      date: "Sep 2023",
      description: "Despite having documented PNES, was handcuffed and transported to psychiatric hospital, with medical history ignored.",
      quote: "I was stripped into a hospital gown, then handcuffed and transported by sheriffs in the middle of the night.",
      metrics: {
        "Policy Violations": 5,
        "Patient Rights Violations": 8,
        "Information System Failures": 4,
        "Physical Injury Duration": "4 weeks",
        "Trauma Level": "Severe"
      }
    },
    'suicide': {
      title: "Suicide Attempt",
      date: "Jan 2024",
      description: "After months of institutional failures and lack of support, attempted suicide due to deteriorating mental health.",
      quote: "I could not turn myself in again, I would rather die.",
      metrics: {
        "Warning Signs Ignored": 12,
        "Intervention Opportunities Missed": 7,
        "System Coordination Failures": 9,
        "Response Time": "None",
        "Preventability Rating": "100%"
      }
    },
    'assistantship': {
      title: "Research Assistantship Termination",
      date: "Feb 2024",
      description: "Principal Investigator terminated research assistantship without any accommodation deliberation process.",
      quote: "My PI was done with me, my DGS couldn't care less, the message was clear: get out.",
      metrics: {
        "ADA Violations": 5,
        "Documentation Failures": 9,
        "Financial Loss": "$18,000+",
        "Academic Progress Delay": "8 months",
        "Career Impact Severity": "Critical"
      }
    },
    'investigation': {
      title: "Investigation Without Protection",
      date: "Aug 2024",
      description: "Office of Equal Opportunity (OEO) began investigation but provided no interim protection or accommodations.",
      quote: "The investigation continued without regard for protecting the student who was potentially being discriminated against.",
      metrics: {
        "Days Without Protection": 147,
        "Communications Ignored": 12,
        "Policy Violations": 8,
        "Additional Health Incidents": 3,
        "Academic Time Lost": "1 semester"
      }
    }
  };

  // Make sure crisis panels exist
  let crisisPanel = document.getElementById('crisis-panel');
  if (!crisisPanel) {
    crisisPanel = document.createElement('div');
    crisisPanel.id = 'crisis-panel';
    crisisPanel.className = 'crisis-panel';
    document.body.appendChild(crisisPanel);
  }

  let fullImpactPanel = document.getElementById('full-impact-panel');
  if (!fullImpactPanel) {
    fullImpactPanel = document.createElement('div');
    fullImpactPanel.id = 'full-impact-panel';
    fullImpactPanel.className = 'crisis-panel';
    document.body.appendChild(fullImpactPanel);
  }

  // Fix breakthrough lines in the SVG
  const svg = document.querySelector('#individual .sensory-wheel-svg');
  if (!svg) return;
  
  // Clear existing breakthrough lines
  svg.querySelectorAll('.breakthrough-line').forEach(line => {
    line.remove();
  });
  
  // Define the correct breakthrough lines (coordinates and sections)
  const breakthroughLines = [
    // Healthcare and DRC boundary - diagnosis crisis
    {
      id: 'diagnosis-breakthrough',
      x1: 377, y1: 123, x2: 423, y2: 77,
      section: 'healthcare',
      title: "PNES Diagnosis Without Support"
    },
    // Healthcare and Mental Health section - handcuffing incident
    {
      id: 'handcuffing-breakthrough',
      x1: 300, y1: 425, x2: 280, y2: 465,
      section: 'healthcare',
      title: "Handcuffed & Transported to Psychiatric Hospital"
    },
    // Academic and Grad School boundary - assistantship termination
    {
      id: 'assistantship-breakthrough',
      x1: 377, y1: 377, x2: 423, y2: 423,
      section: 'academic',
      title: "Research Assistantship Termination"
    },
    // Mental Health section - suicide attempt
    {
      id: 'suicide-breakthrough',
      x1: 250, y1: 430, x2: 250, y2: 490,
      section: 'mentalhealth',
      title: "Suicide Attempt"
    },
    // OEO and Admin boundary - investigation without protection
    {
      id: 'investigation-breakthrough',
      x1: 123, y1: 377, x2: 77, y2: 423,
      section: 'oeo',
      title: "Investigation Without Protection"
    }
  ];
  
  // Create new breakthrough lines
  breakthroughLines.forEach(line => {
    // Create the line element
    const lineElem = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    lineElem.setAttribute('x1', line.x1);
    lineElem.setAttribute('y1', line.y1);
    lineElem.setAttribute('x2', line.x2);
    lineElem.setAttribute('y2', line.y2);
    lineElem.setAttribute('stroke', 'red');
    lineElem.setAttribute('stroke-width', '3');
    lineElem.setAttribute('stroke-dasharray', '5,3');
    lineElem.setAttribute('class', 'breakthrough-line');
    lineElem.setAttribute('id', line.id);
    lineElem.setAttribute('data-crisis', line.id.replace('-breakthrough', ''));
    lineElem.setAttribute('data-title', line.title);
    lineElem.style.opacity = '0.9';
    lineElem.style.cursor = 'pointer';
    
    // Add click event
    lineElem.onclick = function() {
      const crisisId = this.getAttribute('data-crisis');
      showBreakthroughInfo(crisisId);
    };
    
    // Add to SVG
    svg.appendChild(lineElem);
  });
  
  // Function to show breakthrough information
  window.showBreakthroughInfo = function(crisisId) {
    const crisis = crisisData[crisisId];
    if (!crisis) return;

    crisisPanel.innerHTML = `
      <div class="crisis-header">
        <h2 class="crisis-title">${crisis.title}</h2>
        <span class="crisis-date">${crisis.date}</span>
        <button class="close-panel" onclick="document.getElementById('crisis-panel').style.display='none'; document.getElementById('panel-overlay').style.display='none';">&times;</button>
      </div>
      
      <div class="crisis-content">
        <p>${crisis.description}</p>
        <p class="crisis-quote">${crisis.quote}</p>
        
        <div class="crisis-impact">
          <h3>Impact Metrics</h3>
          <div class="metrics-grid">
            ${Object.entries(crisis.metrics).map(([key, value]) => `
              <div class="metric-item">
                <div class="metric-value">${value}</div>
                <div class="metric-label">${key}</div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <button class="view-full-impact-btn" onclick="showFullImpactPanel('${crisisId}')">View Full System Analysis</button>
      </div>
    `;

    // Show overlay and panel
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    crisisPanel.style.display = 'block';
  };
}

// 4. Add View Full Impact button to hub panel
function addHubImpactButton() {
  // Find the hub panel
  const hubPanel = document.getElementById('hub-panel');
  if (!hubPanel) return;
  
  // Check if button already exists
  if (!hubPanel.querySelector('.view-full-impact-btn')) {
    // Create button
    const impactBtn = document.createElement('button');
    impactBtn.className = 'view-full-impact-btn';
    impactBtn.textContent = 'View Full Impact';
    impactBtn.onclick = function() {
      showFullImpactPanel('overall');
    };
    
    // Add to hub panel before the last element
    const lastElement = hubPanel.lastElementChild;
    hubPanel.insertBefore(impactBtn, lastElement);
  }
}

// 5. Enhance full impact panel with better visualizations
function enhanceFullImpactPanel() {
  // Systemwide impact data with timeline and prevention metrics
  window.systemicImpact = {
    'overall': {
      title: "System-Wide Impact Analysis",
      timelineData: {
        past: [
          { date: "Jan 2023", event: "PNES Diagnosis", impact: "No coordination", outcome: "Lost 45 days without treatment" },
          { date: "Sep 2023", event: "Psychiatric Detention", impact: "Traumatic medical response", outcome: "Physical injury, PTSD" },
          { date: "Jan 2024", event: "Suicide Attempt", impact: "Mental health breakdown", outcome: "Life-threatening crisis" }
        ],
        present: [
          { date: "Current", event: "Ongoing Fragmentation", impact: "Time & energy drain", outcome: "Lost academic progress" },
          { date: "Current", event: "Multiple Diagnoses", impact: "Complex healthcare needs", outcome: "No coordinated care" },
          { date: "Current", event: "Research Barriers", impact: "Accommodation gaps", outcome: "Research potential unrealized" }
        ],
        future: [
          { date: "Near Future", event: "Financial Impact", impact: "Loss of funding", outcome: "Potential program exit" },
          { date: "Medium Term", event: "Career Impact", impact: "Delayed graduation", outcome: "Diminished opportunities" },
          { date: "Long Term", event: "System Impact", impact: "Continued discrimination", outcome: "Other students affected" }
        ]
      },
      lossData: {
        individual: [
          { category: "Health", lost: 85, being_lost: 65, will_be_lost: 90 },
          { category: "Academic", lost: 70, being_lost: 80, will_be_lost: 95 },
          { category: "Financial", lost: 60, being_lost: 75, will_be_lost: 85 },
          { category: "Career", lost: 50, being_lost: 70, will_be_lost: 90 }
        ],
        system: [
          { category: "Compliance", lost: 75, being_lost: 85, will_be_lost: 95 },
          { category: "Reputation", lost: 65, being_lost: 75, will_be_lost: 90 },
          { category: "Inclusion", lost: 80, being_lost: 85, will_be_lost: 90 },
          { category: "Innovation", lost: 70, being_lost: 75, will_be_lost: 85 }
        ]
      },
      adapThermPrevention: [
        { metric: "Coordination Time", current: 93, withAdapTherm: 14 },
        { metric: "Health Incidents", current: 12, withAdapTherm: 2 },
        { metric: "Accommodation Success", current: 28, withAdapTherm: 92 },
        { metric: "Student Retention", current: 37, withAdapTherm: 95 }
      ]
    },
    'healthcare': {
      title: "Healthcare System Impact Analysis",
      timelineData: {
        past: [
          { date: "Jan 2023", event: "PNES Diagnosis", impact: "No coordination", outcome: "Lost 45 days without treatment" },
          { date: "Feb 2023", event: "Fragmented Referrals", impact: "No follow-through", outcome: "Continued symptoms" },
          { date: "Sep 2023", event: "Psychiatric Detention", impact: "Wrong intervention", outcome: "Medical trauma" }
        ],
        present: [
          { date: "Current", event: "Multiple Diagnoses", impact: "Uncoordinated treatment", outcome: "Conflicting medications" },
          { date: "Current", event: "Symptom Management", impact: "Trial and error approach", outcome: "Preventable crises" }
        ],
        future: [
          { date: "Near Future", event: "Health Deterioration", impact: "Unmanaged symptoms", outcome: "Increased incidents" },
          { date: "Long Term", event: "Chronic Condition", impact: "No expertise development", outcome: "Permanent disability" }
        ]
      },
      lossData: {
        individual: [
          { category: "Physical Health", lost: 75, being_lost: 65, will_be_lost: 80 },
          { category: "Mental Health", lost: 85, being_lost: 75, will_be_lost: 90 },
          { category: "Treatment Access", lost: 70, being_lost: 60, will_be_lost: 85 },
          { category: "Healthcare Trust", lost: 90, being_lost: 80, will_be_lost: 95 }
        ],
        system: [
          { category: "Care Quality", lost: 75, being_lost: 80, will_be_lost: 85 },
          { category: "Patient Safety", lost: 85, being_lost: 70, will_be_lost: 90 },
          { category: "Legal Liability", lost: 65, being_lost: 75, will_be_lost: 95 },
          { category: "Expert Knowledge", lost: 80, being_lost: 85, will_be_lost: 90 }
        ]
      },
      adapThermPrevention: [
        { metric: "Coordination Failures", current: 12, withAdapTherm: 2 },
        { metric: "Treatment Delays (days)", current: 45, withAdapTherm: 7 },
        { metric: "Information Handoff Errors", current: 8, withAdapTherm: 1 },
        { metric: "Patient Safety Incidents", current: 3, withAdapTherm: 0 }
      ]
    },
    // Additional sections would follow the same pattern...
  };

  // Override showFullImpactPanel function with enhanced visualization
  window.showFullImpactPanel = function(id) {
    // If id doesn't exist in the data, use 'overall'
    if (!window.systemicImpact[id]) id = 'overall';
    
    // Create or get full impact panel
    let impactPanel = document.getElementById('full-impact-panel');
    if (!impactPanel) {
      impactPanel = document.createElement('div');
      impactPanel.id = 'full-impact-panel';
      impactPanel.className = 'crisis-panel';
      document.body.appendChild(impactPanel);
    }
    
    // Get the relevant impact data
    const impactData = window.systemicImpact[id];
    
    // Create impact panel content with timeline, losses, and prevention visualizations
    impactPanel.innerHTML = `
      <div class="crisis-header">
        <h2 class="crisis-title">${impactData.title}</h2>
        <button class="close-panel" onclick="document.getElementById('full-impact-panel').style.display='none'; document.getElementById('panel-overlay').style.display='none';">&times;</button>
      </div>
      
      <div class="crisis-content">
        <div class="impact-section">
          <h3>Timeline of Impact</h3>
          <div class="impact-timeline">
            <div class="timeline-section">
              <h4>What Was Lost</h4>
              <div class="timeline-events">
                ${impactData.timelineData.past.map(item => `
                  <div class="timeline-event">
                    <div class="event-date">${item.date}</div>
                    <div class="event-content">
                      <strong>${item.event}</strong>
                      <div class="event-impact">${item.impact}</div>
                      <div class="event-outcome">${item.outcome}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="timeline-section">
              <h4>What Is Being Lost</h4>
              <div class="timeline-events">
                ${impactData.timelineData.present.map(item => `
                  <div class="timeline-event">
                    <div class="event-date">${item.date}</div>
                    <div class="event-content">
                      <strong>${item.event}</strong>
                      <div class="event-impact">${item.impact}</div>
                      <div class="event-outcome">${item.outcome}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="timeline-section">
              <h4>What Will Be Lost</h4>
              <div class="timeline-events">
                ${impactData.timelineData.future.map(item => `
                  <div class="timeline-event">
                    <div class="event-date">${item.date}</div>
                    <div class="event-content">
                      <strong>${item.event}</strong>
                      <div class="event-impact">${item.impact}</div>
                      <div class="event-outcome">${item.outcome}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
        
        <div class="impact-section">
          <h3>Impact Visualization</h3>
          <div class="impact-tabs">
            <button class="impact-tab active" onclick="switchImpactTab(this, 'individual')">Individual Impact</button>
            <button class="impact-tab" onclick="switchImpactTab(this, 'system')">System Impact</button>
          </div>
          
          <div class="impact-content active" id="individual-impact">
            <div class="impact-chart-container" style="height: 300px;">
              <canvas id="individual-loss-chart"></canvas>
            </div>
          </div>
          
          <div class="impact-content" id="system-impact">
            <div class="impact-chart-container" style="height: 300px;">
              <canvas id="system-loss-chart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="impact-section">
          <h3>What AdapTherm Would Prevent</h3>
          <div class="impact-chart-container" style="height: 300px;">
            <canvas id="adaptherm-prevention-chart"></canvas>
          </div>
        </div>
      </div>
    `;
    
    // Show the overlay
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    
    // Show the impact panel
    impactPanel.style.display = 'block';
    
    // Create charts after panel is visible
    setTimeout(() => {
      createImpactCharts(id);
    }, 100);
  };
  
  // Function to switch between individual and system impact tabs
  window.switchImpactTab = function(tabButton, tabName) {
    // Get all tabs and content elements
    const tabs = document.querySelectorAll('.impact-tab');
    const contents = document.querySelectorAll('.impact-content');
    
    // Remove active class from all tabs and contents
    tabs.forEach(tab => tab.classList.remove('active'));
    contents.forEach(content => content.classList.remove('active'));
    
    // Add active class to selected tab
    tabButton.classList.add('active');
    
    // Show selected content
    document.getElementById(`${tabName}-impact`).classList.add('active');
  };
  
  // Function to create impact charts
  function createImpactCharts(id) {
    if (typeof Chart === 'undefined' || !window.systemicImpact[id]) return;
    
    const data = window.systemicImpact[id];
    
    // Create Individual Loss Chart
    const individualCanvas = document.getElementById('individual-loss-chart');
    if (individualCanvas) {
      new Chart(individualCanvas, {
        type: 'bar',
        data: {
          labels: data.lossData.individual.map(item => item.category),
          datasets: [
            {
              label: 'Lost',
              data: data.lossData.individual.map(item => item.lost),
              backgroundColor: '#f44336',
            },
            {
              label: 'Being Lost',
              data: data.lossData.individual.map(item => item.being_lost),
              backgroundColor: '#ff9800',
            },
            {
              label: 'Will Be Lost',
              data: data.lossData.individual.map(item => item.will_be_lost),
              backgroundColor: '#f06292',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Impact Severity (%)'
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Individual Impact Over Time'
            }
          }
        }
      });
    }
    
    // Create System Loss Chart
    const systemCanvas = document.getElementById('system-loss-chart');
    if (systemCanvas) {
      new Chart(systemCanvas, {
        type: 'bar',
        data: {
          labels: data.lossData.system.map(item => item.category),
          datasets: [
            {
              label: 'Lost',
              data: data.lossData.system.map(item => item.lost),
              backgroundColor: '#f44336',
            },
            {
              label: 'Being Lost',
              data: data.lossData.system.map(item => item.being_lost),
              backgroundColor: '#ff9800',
            },
            {
              label: 'Will Be Lost',
              data: data.lossData.system.map(item => item.will_be_lost),
              backgroundColor: '#f06292',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Impact Severity (%)'
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'System Impact Over Time'
            }
          }
        }
      });
    }
    
    // Create AdapTherm Prevention Chart
    const adapThermCanvas = document.getElementById('adaptherm-prevention-chart');
    if (adapThermCanvas) {
      new Chart(adapThermCanvas, {
        type: 'bar',
        data: {
          labels: data.adapThermPrevention.map(item => item.metric),
          datasets: [
            {
              label: 'Current System',
              data: data.adapThermPrevention.map(item => item.current),
              backgroundColor: '#f44336',
            },
            {
              label: 'With AdapTherm',
              data: data.adapThermPrevention.map(item => item.withAdapTherm),
              backgroundColor: '#4caf50',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Performance Metrics'
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'AdapTherm Prevention Impact'
            }
          }
        }
      });
    }
  }
}

// Fix References Button (previously "My Story")
function fixReferencesButton() {
  // Find the button or create it if it doesn't exist
  let referencesBtn = document.getElementById('individual-research-btn');
  if (!referencesBtn) {
    const individualTab = document.getElementById('individual');
    if (!individualTab) return;
    
    // Create research panel if it doesn't exist
    if (!document.getElementById('individual-research-panel')) {
      const researchPanel = document.createElement('div');
      researchPanel.id = 'individual-research-panel';
      researchPanel.className = 'research-panel';
      researchPanel.style.display = 'none';
      individualTab.appendChild(researchPanel);
      
      // Add content to research panel
      researchPanel.innerHTML = `
        <h4>Research and Sources</h4>
        
        <p><strong>Disability Systems Navigation</strong><br>
        Taylor, A., & Shallish, L. (2019). The logic of bio-meritocracy in the promotion of higher education accessibility. Disability & Society, 34(7-8), 1200-1223.</p>
        
        <p><strong>Functional Neurological Disorders</strong><br>
        Kozlowska, K., Walker, P., McLean, L., & Carrive, P. (2019). Fear and the defense cascade: Clinical implications and management. Harvard Review of Psychiatry, 23(4), 263-287.</p>
        
        <p><strong>Adaptive Capacity Measurement</strong><br>
        Reynolds, S., Lane, S. J., & Gennings, C. (2017). The moderating role of sensory overresponsivity in HPA activity. Journal of Attention Disorders, 21(2), 167-177.</p>
        
        <p><strong>Graduate Education and Disability</strong><br>
        Pearson, H., & Boskovich, L. (2019). Problematizing disability disclosure in higher education: Shifting towards a liberating humanizing intersectional framework. Disability Studies Quarterly, 39(1).</p>
        
        <p><strong>Institutional Barriers in Higher Education</strong><br>
        Dolmage, J. T. (2017). Academic ableism: Disability and higher education. University of Michigan Press.</p>
        
        <p><strong>System Fragmentation Impacts</strong><br>
        Kerschbaum, S. L., Eisenman, L. T., & Jones, J. M. (Eds.). (2017). Negotiating disability: Disclosure and higher education. University of Michigan Press.</p>
      `;
    }
    
    // Create the button
    referencesBtn = document.createElement('button');
    referencesBtn.id = 'individual-research-btn';
    referencesBtn.className = 'research-references-btn';
    referencesBtn.textContent = 'References ▼';
    individualTab.appendChild(referencesBtn);
  } else {
    // Update existing button text
    referencesBtn.textContent = 'References ▼';
  }
  
  // Update or add click handler
  referencesBtn.onclick = function() {
    const panel = document.getElementById('individual-research-panel');
    if (panel) {
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        this.textContent = 'References ▼';
      } else {
        panel.style.display = 'block';
        this.textContent = 'References ▲';
      }
    }
  };
}

// Add CSS Styles for Timeline and Enhanced Visualization
function addEnhancedStyles() {
  const styleElem = document.createElement('style');
  styleElem.textContent = `
    /* Breakthrough Lines Styling */
    .breakthrough-line {
      cursor: pointer;
      transition: opacity 0.3s, stroke-width 0.3s;
    }
    
    .breakthrough-line:hover {
      opacity: 1 !important;
      stroke-width: 4px;
    }
    
    /* Timeline Styling */
    .impact-timeline {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 20px 0;
    }
    
    .timeline-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .timeline-section h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #1565c0;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    
    .timeline-events {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .timeline-event {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    
    .event-date {
      flex: 0 0 80px;
      font-weight: bold;
      color: #1565c0;
    }
    
    .event-content {
      flex: 1;
    }
    
    .event-impact {
      margin-top: 5px;
      font-style: italic;
      color: #666;
    }
    
    .event-outcome {
      margin-top: 5px;
      font-weight: bold;
      color: #e53935;
    }
    
    /* Tab Styling */
    .impact-tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
    }
    
    .impact-tab {
      padding: 8px 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
    
    .impact-tab.active {
      border-bottom: 3px solid #1565c0;
      color: #1565c0;
    }
    
    .impact-content {
      display: none;
    }
    
    .impact-content.active {
      display: block;
    }
    
    /* Better Checkbox Styling */
    .checkbox-recommendation {
      display: flex;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    
    .recommendation-checkbox {
      margin-top: 3px;
      margin-right: 8px;
      width: 16px;
      height: 16px;
    }
    
    /* Routes Button Styling */
    .routes-btn {
      margin: 15px 0;
      padding: 8px 15px;
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .routes-btn:hover {
      background-color: #395b89;
    }
    
    /* View Full Impact Button Styling */
    .view-full-impact-btn {
      display: block;
      margin: 20px 0;
      padding: 10px 20px;
      background: #1565c0;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    .view-full-impact-btn:hover {
      background: #0d47a1;
    }
  `;
  
  document.head.appendChild(styleElem);
}

// Master initialization function
function initializeIndividualTab() {
  // Fix References button
  fixReferencesButton();
  
  // Hide charts by default - show only emergency panel and wheel
  hideExtraElements();
  
  // Fix breakthrough lines placement and functionality
  fixBreakthroughLines();
  
  // Add View Full Impact button to hub panel
  addHubImpactButton();
  
  // Enhance full impact panel with better visualizations
  enhanceFullImpactPanel();
  
  // Fix Routes button
  fixRoutesButton();
  
  // Add enhanced styling
  addEnhancedStyles();
  
  console.log("Individual tab fixes applied successfully");
}

// Call initialization when the document is loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeIndividualTab);
} else {
  // Document already loaded
  initializeIndividualTab();
}
</script>
<script>
  // Script for Individual Tab Improvements

document.addEventListener('DOMContentLoaded', function() {
  // Apply fixes when the document is loaded
  applyIndividualTabFixes();
  
  // Also apply when switching to the Individual tab
  const tabButtons = document.querySelectorAll('.tab-button');
  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      if (this.textContent.includes('Individual')) {
        setTimeout(applyIndividualTabFixes, 100);
      }
    });
  });
});

function applyIndividualTabFixes() {
  // 1. Center the wheel (matching sensory tab style)
  centerIndividualWheel();
  
  // 2. Fix breakthrough lines implementation
  fixBreakthroughLines();
  
  // 3. Add Submit Challenge button to hub panel
  addSubmitChallengeButton();
  
  // 4. Enhance full impact panel with better graphs
  enhanceFullImpactPanel();
  
  // 5. Override section and spoke info functions to add Connect button
  overridePanelFunctions();
}

// 1. Center the wheel
function centerIndividualWheel() {
  const individualTab = document.getElementById('individual');
  if (!individualTab) return;
  
  // Find the sensory content container that holds the wheel
  const wheelContent = individualTab.querySelector('.sensory-content');
  if (wheelContent) {
    // Apply centering styles similar to sensory tab
    wheelContent.style.display = 'flex';
    wheelContent.style.flexDirection = 'row';
    wheelContent.style.flexWrap = 'wrap';
    wheelContent.style.gap = '20px';
    wheelContent.style.justifyContent = 'center';
    
    // Reset any previous left-alignment
    const wheelContainer = wheelContent.querySelector('.wheel-container');
    if (wheelContainer) {
      wheelContainer.style.margin = '0 auto';
    }
  }
}

// 2. Fix breakthrough lines - copying from sensory tab implementation
function fixBreakthroughLines() {
  const individualTab = document.getElementById('individual');
  if (!individualTab) return;
  
  // Get the SVG from the individual tab
  const individualSvg = individualTab.querySelector('.sensory-wheel-svg');
  if (!individualSvg) return;
  
  // Define the breakthrough lines data - this is based on the critical incidents
  const breakthroughLinesData = [
    // Healthcare/DRC boundary - diagnosis crisis
    {
      id: 'diagnosis-breakthrough',
      points: { x1: 377, y1: 123, x2: 423, y2: 77 },
      sections: ['healthcare', 'drc'],
      title: "PNES Diagnosis Crisis"
    },
    // Mental Health section - suicide attempt
    {
      id: 'suicide-breakthrough',
      points: { x1: 250, y1: 430, x2: 250, y2: 490 },
      sections: ['mentalhealth'],
      title: "Suicide Attempt"
    },
    // Academic/Grad School - assistantship termination
    {
      id: 'assistantship-breakthrough',
      points: { x1: 377, y1: 377, x2: 423, y2: 423 },
      sections: ['academic', 'gradschool'],
      title: "Research Assistantship Termination"
    },
    // Healthcare/Mental Health - handcuffing incident
    {
      id: 'handcuffing-breakthrough',
      points: { x1: 300, y1: 425, x2: 280, y2: 465 },
      sections: ['healthcare', 'mentalhealth'],
      title: "Psychiatric Detention Crisis"
    },
    // OEO/Admin - investigation without protection
    {
      id: 'investigation-breakthrough',
      points: { x1: 123, y1: 377, x2: 77, y2: 423 },
      sections: ['oeo', 'admin'],
      title: "Investigation Without Protection"
    }
  ];
  
  // Remove existing breakthrough lines
  const existingLines = individualSvg.querySelectorAll('.breakthrough-line');
  existingLines.forEach(line => line.remove());
  
  // Create new breakthrough lines
  breakthroughLinesData.forEach(line => {
    // Add white background line first
    const bgLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    bgLine.setAttribute('x1', line.points.x1);
    bgLine.setAttribute('y1', line.points.y1);
    bgLine.setAttribute('x2', line.points.x2);
    bgLine.setAttribute('y2', line.points.y2);
    bgLine.setAttribute('stroke', 'white');
    bgLine.setAttribute('stroke-width', '4');
    bgLine.setAttribute('class', 'breakthrough-background');
    bgLine.setAttribute('data-sections', line.sections.join(','));
    individualSvg.appendChild(bgLine);
    
    // Add the red dashed line
    const redLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    redLine.setAttribute('x1', line.points.x1);
    redLine.setAttribute('y1', line.points.y1);
    redLine.setAttribute('x2', line.points.x2);
    redLine.setAttribute('y2', line.points.y2);
    redLine.setAttribute('stroke', 'red');
    redLine.setAttribute('stroke-width', '3');
    redLine.setAttribute('stroke-dasharray', '5,3');
    redLine.setAttribute('class', 'breakthrough-line');
    redLine.setAttribute('id', line.id);
    redLine.setAttribute('data-crisis', line.id.replace('-breakthrough', ''));
    redLine.setAttribute('data-title', line.title);
    redLine.style.opacity = '0.9';
    redLine.style.cursor = 'pointer';
    
    // Add click handler
    redLine.onclick = function() {
      const crisisId = this.getAttribute('data-crisis');
      showBreakthroughInfo(crisisId);
    };
    
    individualSvg.appendChild(redLine);
  });
  
  // Make sure the showBreakthroughInfo function exists
  ensureBreakthroughFunction();
}

// Function to create or update the showBreakthroughInfo function
function ensureBreakthroughFunction() {
  // Define crisis data for the breakthrough information
  const crisisData = {
    'diagnosis': {
      title: "PNES Diagnosis Crisis",
      date: "Jan 2023",
      description: "Diagnosed with Psychogenic Non-Epileptic Seizures (PNES), a rare functional neurological disorder, with no coordinated care plan provided.",
      quote: "I was discharged to navigate a labyrinth of fragmented services alone.",
      metrics: {
        "Days Without Treatment Plan": 45,
        "Referrals Without Follow-up": 3,
        "Information Handoffs Failed": 7,
        "Health Impact Severity": "High",
        "Institutional Response Grade": "F"
      }
    },
    'handcuffing': {
      title: "Psychiatric Detention Crisis",
      date: "Sep 2023",
      description: "Despite having documented PNES, was handcuffed and transported to psychiatric hospital, with medical history ignored.",
      quote: "I was stripped into a hospital gown, then handcuffed and transported by sheriffs in the middle of the night.",
      metrics: {
        "Policy Violations": 5,
        "Patient Rights Violations": 8,
        "Information System Failures": 4,
        "Physical Injury Duration": "4 weeks",
        "Trauma Level": "Severe"
      }
    },
    'suicide': {
      title: "Suicide Attempt",
      date: "Jan 2024",
      description: "After months of institutional failures and lack of support, attempted suicide due to deteriorating mental health.",
      quote: "I could not turn myself in again, I would rather die.",
      metrics: {
        "Warning Signs Ignored": 12,
        "Intervention Opportunities Missed": 7,
        "System Coordination Failures": 9,
        "Response Time": "None",
        "Preventability Rating": "100%"
      }
    },
    'assistantship': {
      title: "Research Assistantship Termination",
      date: "Feb 2024",
      description: "Principal Investigator terminated research assistantship without any accommodation deliberation process.",
      quote: "My PI was done with me, my DGS couldn't care less, the message was clear: get out.",
      metrics: {
        "ADA Violations": 5,
        "Documentation Failures": 9,
        "Financial Loss": "$18,000+",
        "Academic Progress Delay": "8 months",
        "Career Impact Severity": "Critical"
      }
    },
    'investigation': {
      title: "Investigation Without Protection",
      date: "Aug 2024",
      description: "Office of Equal Opportunity (OEO) began investigation but provided no interim protection or accommodations.",
      quote: "The investigation continued without regard for protecting the student who was potentially being discriminated against.",
      metrics: {
        "Days Without Protection": 147,
        "Communications Ignored": 12,
        "Policy Violations": 8,
        "Additional Health Incidents": 3,
        "Academic Time Lost": "1 semester"
      }
    }
  };

  // Implement the showBreakthroughInfo function if it doesn't exist
  window.showBreakthroughInfo = function(crisisId) {
    const crisis = crisisData[crisisId];
    if (!crisis) return;
    
    // Create or get crisis panel
    let crisisPanel = document.getElementById('crisis-panel');
    if (!crisisPanel) {
      crisisPanel = document.createElement('div');
      crisisPanel.id = 'crisis-panel';
      crisisPanel.className = 'crisis-panel';
      document.body.appendChild(crisisPanel);
    }
    
    // Create panel content
    crisisPanel.innerHTML = `
      <div class="crisis-header">
        <h2 class="crisis-title">${crisis.title}</h2>
        <span class="crisis-date">${crisis.date}</span>
        <button class="close-panel" onclick="document.getElementById('crisis-panel').style.display='none'; document.getElementById('panel-overlay').style.display='none';">&times;</button>
      </div>
      
      <div class="crisis-content">
        <p>${crisis.description}</p>
        <p class="crisis-quote">${crisis.quote}</p>
        
        <div class="crisis-impact">
          <h3>Impact Metrics</h3>
          <div class="metrics-grid">
            ${Object.entries(crisis.metrics).map(([key, value]) => `
              <div class="metric-item">
                <div class="metric-value">${value}</div>
                <div class="metric-label">${key}</div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
          <button class="connect-btn" style="padding: 8px 15px; background-color: #4a6fa5; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
            Connect
          </button>
          
          <button class="view-full-impact-btn" onclick="showFullImpactPanel('${crisisId}')">
            View Full Impact
          </button>
        </div>
      </div>
    `;
    
    // Add Connect button functionality
    const connectBtn = crisisPanel.querySelector('.connect-btn');
    if (connectBtn) {
      connectBtn.onclick = function() {
        connectToCrisis(crisisId);
      };
    }
    
    // Show overlay and panel
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    crisisPanel.style.display = 'block';
  };
}

// Connect functionality for crisis events
function connectToCrisis(crisisId) {
  const crisisTypes = {
    'diagnosis': 'healthcare',
    'handcuffing': 'healthcare',
    'suicide': 'mental',
    'assistantship': 'academic',
    'investigation': 'oeo'
  };
  
  const department = crisisTypes[crisisId] || 'healthcare';
  alert(`Connecting you with relevant resources for ${department}. A case manager will be assigned to help coordinate your care across departments.`);
}

// 3. Add Submit Challenge button to hub panel
function addSubmitChallengeButton() {
  // Target the hub panel
  const hubPanel = document.getElementById('hub-panel');
  if (!hubPanel) return;
  
  // Check if the button already exists
  if (hubPanel.querySelector('.submit-challenge-btn')) return;
  
  // Find where to insert the button - before the "Apply Changes" button
  const applyChangesBtn = hubPanel.querySelector('.apply-changes');
  if (!applyChangesBtn) return;
  
  // Create Submit Challenge button
  const challengeBtn = document.createElement('button');
  challengeBtn.className = 'submit-challenge-btn';
  challengeBtn.textContent = 'Submit Challenge';
  challengeBtn.style.padding = '10px 20px';
  challengeBtn.style.backgroundColor = '#f44336';
  challengeBtn.style.color = 'white';
  challengeBtn.style.border = 'none';
  challengeBtn.style.borderRadius = '4px';
  challengeBtn.style.cursor = 'pointer';
  challengeBtn.style.marginBottom = '15px';
  challengeBtn.style.display = 'block';
  challengeBtn.style.width = '100%';
  
  // Add click functionality
  challengeBtn.onclick = function() {
    submitChallenge();
  };
  
  // Insert before Apply Changes button
  applyChangesBtn.parentNode.insertBefore(challengeBtn, applyChangesBtn);
}

// Submit Challenge functionality
function submitChallenge() {
  const challengeForm = document.createElement('div');
  challengeForm.style.padding = '15px';
  challengeForm.style.backgroundColor = '#f8f9fa';
  challengeForm.style.border = '1px solid #dee2e6';
  challengeForm.style.borderRadius = '5px';
  challengeForm.style.marginBottom = '15px';
  
  challengeForm.innerHTML = `
    <h4 style="margin-top: 0;">Submit Institutional Challenge</h4>
    <p>Document a specific barrier or challenge you're experiencing:</p>
    <select id="challenge-type" style="width: 100%; padding: 8px; margin-bottom: 10px;">
      <option value="accommodation">Accommodation Denial/Delay</option>
      <option value="coordination">Department Coordination Failure</option>
      <option value="communication">Communication Breakdown</option>
      <option value="access">Physical/Digital Access Barrier</option>
      <option value="policy">Policy Gap or Conflict</option>
    </select>
    <textarea id="challenge-description" placeholder="Describe the challenge in detail..." style="width: 100%; padding: 8px; height: 100px; margin-bottom: 10px;"></textarea>
    <div style="display: flex; justify-content: space-between;">
      <button id="cancel-challenge" style="padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
      <button id="submit-challenge-form" style="padding: 8px 15px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Submit</button>
    </div>
  `;
  
  // Get the hub panel
  const hubPanel = document.getElementById('hub-panel');
  if (!hubPanel) return;
  
  // Find submit button
  const submitButton = hubPanel.querySelector('.submit-challenge-btn');
  if (!submitButton) return;
  
  // Insert the form after the button
  submitButton.parentNode.insertBefore(challengeForm, submitButton.nextSibling);
  
  // Hide the submit button while form is open
  submitButton.style.display = 'none';
  
  // Add event listeners to form buttons
  document.getElementById('cancel-challenge').addEventListener('click', function() {
    challengeForm.remove();
    submitButton.style.display = 'block';
  });
  
  document.getElementById('submit-challenge-form').addEventListener('click', function() {
    const type = document.getElementById('challenge-type').value;
    const description = document.getElementById('challenge-description').value.trim();
    
    if (!description) {
      alert('Please provide a description of the challenge.');
      return;
    }
    
    // Here you would typically send this data to a server
    // For now, just show a confirmation
    alert(`Challenge submitted! A case manager will review your ${type} challenge and contact you within 48 hours.`);
    
    // Remove form and show button again
    challengeForm.remove();
    submitButton.style.display = 'block';
  });
}

// 4. Enhance full impact panel with better graphs
function enhanceFullImpactPanel() {
  // Define impact data with timeline and metrics
  const fullImpactData = {
    'overall': {
      title: "System-Wide Impact Analysis",
      lossData: {
        individual: [
          { category: "Health", lost: 85, being_lost: 65, will_be_lost: 90 },
          { category: "Academic", lost: 70, being_lost: 80, will_be_lost: 95 },
          { category: "Financial", lost: 60, being_lost: 75, will_be_lost: 85 },
          { category: "Career", lost: 50, being_lost: 70, will_be_lost: 90 }
        ],
        system: [
          { category: "Compliance", lost: 75, being_lost: 85, will_be_lost: 95 },
          { category: "Reputation", lost: 65, being_lost: 75, will_be_lost: 90 },
          { category: "Inclusion", lost: 80, being_lost: 85, will_be_lost: 90 },
          { category: "Innovation", lost: 70, being_lost: 75, will_be_lost: 85 }
        ]
      },
      adapThermPrevention: [
        { metric: "Coordination Time", current: 93, withAdapTherm: 14 },
        { metric: "Health Incidents", current: 12, withAdapTherm: 2 },
        { metric: "Accommodation Success", current: 28, withAdapTherm: 92 },
        { metric: "Student Retention", current: 37, withAdapTherm: 95 }
      ]
    },
    'healthcare': {
      title: "Healthcare System Impact Analysis",
      lossData: {
        individual: [
          { category: "Physical Health", lost: 75, being_lost: 65, will_be_lost: 80 },
          { category: "Mental Health", lost: 85, being_lost: 75, will_be_lost: 90 },
          { category: "Treatment Access", lost: 70, being_lost: 60, will_be_lost: 85 },
          { category: "Healthcare Trust", lost: 90, being_lost: 80, will_be_lost: 95 }
        ],
        system: [
          { category: "Care Quality", lost: 75, being_lost: 80, will_be_lost: 85 },
          { category: "Patient Safety", lost: 85, being_lost: 70, will_be_lost: 90 },
          { category: "Legal Liability", lost: 65, being_lost: 75, will_be_lost: 95 },
          { category: "Expert Knowledge", lost: 80, being_lost: 85, will_be_lost: 90 }
        ]
      },
      adapThermPrevention: [
        { metric: "Coordination Failures", current: 12, withAdapTherm: 2 },
        { metric: "Treatment Delays (days)", current: 45, withAdapTherm: 7 },
        { metric: "Information Handoff Errors", current: 8, withAdapTherm: 1 },
        { metric: "Patient Safety Incidents", current: 3, withAdapTherm: 0 }
      ]
    }
    // Additional sections would be defined similarly
  };
  
  // Override the showFullImpactPanel function
  window.showFullImpactPanel = function(id) {
    // Default to overall data if specific id not found
    if (!fullImpactData[id]) id = 'overall';
    
    // Create or get full impact panel
    let impactPanel = document.getElementById('full-impact-panel');
    if (!impactPanel) {
      impactPanel = document.createElement('div');
      impactPanel.id = 'full-impact-panel';
      impactPanel.className = 'crisis-panel';
      document.body.appendChild(impactPanel);
    }
    
    // Get the impact data
    const data = fullImpactData[id];
    
    // Create the panel content with better visualizations
    impactPanel.innerHTML = `
      <div class="crisis-header">
        <h2 class="crisis-title">${data.title}</h2>
        <button class="close-panel" onclick="document.getElementById('full-impact-panel').style.display='none'; document.getElementById('panel-overlay').style.display='none';">&times;</button>
      </div>
      
      <div class="crisis-content">
        <div class="impact-section">
          <h3>Impact Visualization</h3>
          <div class="impact-tabs">
            <button class="impact-tab active" onclick="switchImpactTab(this, 'individual')">Individual Impact</button>
            <button class="impact-tab" onclick="switchImpactTab(this, 'system')">System Impact</button>
          </div>
          
          <div class="impact-content active" id="individual-impact">
            <div class="impact-chart-container" style="height: 300px;">
              <canvas id="individual-loss-chart"></canvas>
            </div>
          </div>
          
          <div class="impact-content" id="system-impact">
            <div class="impact-chart-container" style="height: 300px;">
              <canvas id="system-loss-chart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="impact-section">
          <h3>What AdapTherm Would Prevent</h3>
          <div class="impact-chart-container" style="height: 300px;">
            <canvas id="adaptherm-prevention-chart"></canvas>
          </div>
        </div>
        
        <div class="impact-section">
          <h3>Connect With Resources</h3>
          <p>Based on this impact analysis, we recommend connecting with:</p>
          <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
            <button class="connect-btn" style="padding: 8px 15px; background-color: #4a6fa5; color: white; border: none; border-radius: 4px; cursor: pointer;">
              Connect with Case Manager
            </button>
            <button class="connect-btn" style="padding: 8px 15px; background-color: #4a6fa5; color: white; border: none; border-radius: 4px; cursor: pointer;">
              Connect with Advocacy
            </button>
            <button class="connect-btn" style="padding: 8px 15px; background-color: #4a6fa5; color: white; border: none; border-radius: 4px; cursor: pointer;">
              Connect with Legal Support
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Add Connect button functionality
    const connectBtns = impactPanel.querySelectorAll('.connect-btn');
    connectBtns.forEach(btn => {
      btn.onclick = function() {
        const resource = this.textContent.replace('Connect with ', '');
        alert(`Connecting you with ${resource}. A coordinator will contact you within 24 hours.`);
      };
    });
    
    // Show overlay and panel
    const overlay = document.getElementById('panel-overlay');
    if (overlay) overlay.style.display = 'block';
    impactPanel.style.display = 'block';
    
    // Create charts after panel is visible
    setTimeout(() => {
      createImpactCharts(id, data);
    }, 100);
  };
  
  // Make sure the tab switcher function exists
  window.switchImpactTab = function(tabButton, tabName) {
    // Get all tabs and content elements
    const tabs = document.querySelectorAll('.impact-tab');
    const contents = document.querySelectorAll('.impact-content');
    
    // Remove active class from all tabs and contents
    tabs.forEach(tab => tab.classList.remove('active'));
    contents.forEach(content => content.classList.remove('active'));
    
    // Add active class to selected tab
    tabButton.classList.add('active');
    
    // Show selected content
    document.getElementById(`${tabName}-impact`).classList.add('active');
  };
}

// Function to create impact charts
function createImpactCharts(id, data) {
  if (typeof Chart === 'undefined' || !data) return;
  
  // Create Individual Loss Chart
  const individualCanvas = document.getElementById('individual-loss-chart');
  if (individualCanvas) {
    new Chart(individualCanvas, {
      type: 'bar',
      data: {
        labels: data.lossData.individual.map(item => item.category),
        datasets: [
          {
            label: 'Lost',
            data: data.lossData.individual.map(item => item.lost),
            backgroundColor: '#f44336',
          },
          {
            label: 'Being Lost',
            data: data.lossData.individual.map(item => item.being_lost),
            backgroundColor: '#ff9800',
          },
          {
            label: 'Will Be Lost',
            data: data.lossData.individual.map(item => item.will_be_lost),
            backgroundColor: '#f06292',
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Impact Severity (%)'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Individual Impact Over Time'
          }
        }
      }
    });
  }
  
  // Create System Loss Chart
  const systemCanvas = document.getElementById('system-loss-chart');
  if (systemCanvas) {
    new Chart(systemCanvas, {
      type: 'bar',
      data: {
        labels: data.lossData.system.map(item => item.category),
        datasets: [
          {
            label: 'Lost',
            data: data.lossData.system.map(item => item.lost),
            backgroundColor: '#f44336',
          },
          {
            label: 'Being Lost',
            data: data.lossData.system.map(item => item.being_lost),
            backgroundColor: '#ff9800',
          },
          {
            label: 'Will Be Lost',
            data: data.lossData.system.map(item => item.will_be_lost),
            backgroundColor: '#f06292',
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Impact Severity (%)'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'System Impact Over Time'
          }
        }
      }
    });
  }
  
  // Create AdapTherm Prevention Chart
  const adapThermCanvas = document.getElementById('adaptherm-prevention-chart');
  if (adapThermCanvas) {
    new Chart(adapThermCanvas, {
      type: 'bar',
      data: {
        labels: data.adapThermPrevention.map(item => item.metric),
        datasets: [
          {
            label: 'Current System',
            data: data.adapThermPrevention.map(item => item.current),
            backgroundColor: '#f44336',
          },
          {
            label: 'With AdapTherm',
            data: data.adapThermPrevention.map(item => item.withAdapTherm),
            backgroundColor: '#4caf50',
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Performance Metrics'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'AdapTherm Prevention Impact'
          }
        }
      }
    });
  }
}

// 5. Override panel functions to add Connect button
function overridePanelFunctions() {
  // Store the original functions if they exist and haven't been overridden yet
  if (typeof window.originalShowSectionInfo === 'undefined' && typeof window.showSectionInfo === 'function') {
    window.originalShowSectionInfo = window.showSectionInfo;
    
    // Override with our version that adds Connect button
    window.showSectionInfo = function(sectionId) {
      // Call the original function first
      window.originalShowSectionInfo(sectionId);
      
      // Then add Connect button to the panel
      addConnectButtonToPanel('section-panel', sectionId);
    };
  }
  
  if (typeof window.originalShowIndividualSpokeInfo === 'undefined' && typeof window.showIndividualSpokeInfo === 'function') {
    window.originalShowIndividualSpokeInfo = window.showIndividualSpokeInfo;
    
    // Override with our version
    window.showIndividualSpokeInfo = function(sectionId) {
      // Call the original function first
      window.originalShowIndividualSpokeInfo(sectionId);
      
      // Then add Connect button
      addConnectButtonToPanel('spoke-panel', sectionId);
    };
  }
}

// Function to add Connect button to panels
function addConnectButtonToPanel(panelId, sectionId) {
  const panel = document.getElementById(panelId);
  if (!panel) return;
  
  // Check if Connect button already exists
  if (panel.querySelector('.connect-btn')) return;
  
  // Create button container
  const buttonContainer = document.createElement('div');
  buttonContainer.style.textAlign = 'center';
  buttonContainer.style.marginTop = '20px';
  
  // Create Connect button
  const connectBtn = document.createElement('button');
  connectBtn.className = 'connect-btn';
  connectBtn.textContent = 'Connect';
  connectBtn.style.padding = '10px 20px';
  connectBtn.style.backgroundColor = '#4a6fa5';
  connectBtn.style.color = 'white';
  connectBtn.style.border = 'none';
  connectBtn.style.borderRadius = '4px';
  connectBtn.style.cursor = 'pointer';
  connectBtn.style.marginRight = '10px';
  
  // Button click handler
  connectBtn.onclick = function() {
    connectToDepartment(sectionId);
  };
  
  // Add button to container
  buttonContainer.appendChild(connectBtn);
  
  // If there's already a View Full Impact button, add it before that button's container
  const existingButtonContainer = panel.querySelector('.view-full-impact-btn')?.parentNode;
  if (existingButtonContainer) {
    existingButtonContainer.parentNode.insertBefore(buttonContainer, existingButtonContainer);
  } else {
    // Otherwise add at the end
    panel.appendChild(buttonContainer);
  }
}

// Connect to department functionality
function connectToDepartment(sectionId) {
  // Map of departments to their official names
  const departmentNames = {
    'healthcare': 'University Healthcare System',
    'drc': 'Disability Resource Center',
    'academic': 'Academic Department',
    'gradschool': 'Graduate School',
    'mentalhealth': 'Mental Health Services',
    'oeo': 'Office of Equal Opportunity',
    'admin': 'Administrative Offices',
    'ada': 'ADA Compliance Office'
  };
  
  const departmentName = departmentNames[sectionId] || sectionId;
  
  alert(`Connecting you with ${departmentName}. A case manager will coordinate communication and requirements between you and this department.`);
}
</script>
</body>
</html>