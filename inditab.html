<!DOCTYPE html>
<html>
<head>
  <title>Adaptherm - Individual Level</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* Individual Tab Specific Styling */

/* Breakthrough Lines Styling */
.breakthrough-line {
  cursor: pointer;
  transition: opacity 0.3s, stroke-width 0.3s;
}

.breakthrough-line:hover {
  opacity: 1 !important;
  stroke-width: 4px;
}

/* Checkbox Recommendation Styling */
.checkbox-recommendation {
  display: flex;
  align-items: flex-start;
  margin-bottom: 8px;
}

.recommendation-checkbox {
  margin-top: 3px;
  margin-right: 8px;
}

/* Routes Button Styling */
.routes-btn {
  display: block;
  margin: 15px auto;
  padding: 8px 15px;
  background-color: #4a6fa5;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.routes-btn:hover {
  background-color: #395b89;
  transform: translateY(-2px);
}

/* Routes Panel Styling */
.routes-map-container {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}

/* Charts Section Styling */
.individual-case-analytics {
  margin: 30px 0;
  padding: 20px;
  background-color: #f0f7ff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.analytics-item {
  margin-bottom: 25px;
}

.analytics-chart-container {
  height: 300px;
  margin: 15px 0;
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Full Impact Panel Styling */
.impact-chart-container {
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  margin: 15px 0;
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
  margin: 15px 0;
}

.metric-item {
  background: #f0f7ff;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-value {
  font-size: 24px;
  font-weight: bold;
  color: #1565c0;
  margin-bottom: 5px;
}

.metric-label {
  font-size: 14px;
  color: #555;
}

/* Research References Button Styling */
.research-references-btn {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  margin-top: 20px;
  display: inline-block;
  transition: background-color 0.2s;
}

.research-references-btn:hover {
  background-color: #e9ecef;
}

.research-panel {
  display: none;
  margin-top: 10px;
  padding: 15px;
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
}

.research-panel h4 {
  margin-top: 0;
  color: #495057;
}

.research-panel p {
  font-size: 14px;
  line-height: 1.5;
  color: #495057;
}
  </style>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow-x: hidden;
    }
    
    h1, h2, h3 {
      color: #1565c0;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    
    /* Tab styling */
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 20px;
    }
    
    .tab-button {
      background: none;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .tab-button.active {
      border-bottom: 3px solid #1565c0;
      font-weight: bold;
      color: #1565c0;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Emergency panel with deep blue background */
    .emergency-panel {
      background-color: #1a3a5f; /* Deep blue color */
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .emergency-panel h3 {
      color: white;
      margin-top: 0;
    }
    
    .emergency-panel p {
      font-size: 15px;
      line-height: 1.4;
      margin-bottom: 8px;
      color: white;
    }
    
    /* Streamlined emergency panel layout */
    .symptom-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
      max-width: 100%;
      justify-content: center;
    }
    
    .symptom-button {
      background-color: #ffffff;
      border: 1px solid #03a9f4;
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      white-space: nowrap;
    }
    
    .symptom-button:hover {
      background-color: #e1f5fe;
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .symptom-button.active {
      background-color: #03a9f4;
      color: white;
      border-color: #0277bd;
    }
    
    /* Contained text entry */
    .custom-description {
      width: 90%;
      max-width: 600px;
      padding: 8px 12px;
      border: 2px solid #81d4fa;
      border-radius: 4px;
      margin: 5px auto 10px;
      font-family: inherit;
      resize: none;
      height: 36px;
      font-size: 14px;
      display: block;
    }
    
    .typing-indicator {
      font-size: 12px;
      color: #e1f5fe;
      margin-top: -5px;
      margin-bottom: 10px;
      visibility: hidden;
      text-align: left;
    }
    
    .typing-indicator.visible {
      visibility: visible;
    }
    
    .recommendations {
      background-color: #f8f9fa;
      border-radius: 4px;
      padding: 15px;
      border: 1px solid #e2e6ea;
      margin-bottom: 20px;
    }
    
    .emergency-panel .recommendations {
      background-color: #25517f;
      border-color: #1a3a5f;
    }
    
    .recommendations h4 {
      margin-top: 0;
      color: #343a40;
      font-size: 15px;
    }
    
    .emergency-panel .recommendations h4 {
      color: white;
    }
    
    .recommendations ul {
      padding-left: 20px;
    }
    
    .recommendations li {
      margin-bottom: 5px;
      line-height: 1.4;
    }
    
    .emergency-panel .recommendations li {
      color: white;
    }
    
    /* Sensory wheel container */
    .sensory-content {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    
    .wheel-container {
      width: 500px;
      height: 500px;
      position: relative;
    }
    
    .sensory-wheel-svg {
      width: 100%;
      height: auto;
    }
    
    /* Clickable elements styling */
    .section-path {
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .section-path:hover {
      filter: brightness(1.1);
      transform: scale(1.01);
      transform-origin: center;
    }
    
    .wheel-hub {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .wheel-hub:hover {
      filter: brightness(1.1);
      transform: scale(1.05);
      transform-origin: center;
    }
    
    /* Enhanced spoke styling - major change to improve clickability */
    .spoke-clickable-area {
      stroke-width: 20px;
      stroke-opacity: 0.1;
      cursor: pointer;
      transition: stroke-opacity 0.2s;
    }
    
    .spoke-clickable-area:hover {
      stroke-opacity: 0.3;
    }
    
    .spoke {
      stroke-width: 2px;
      transition: stroke-width 0.2s;
    }
    
    .spoke-group:hover .spoke {
      stroke-width: 3px;
    }
    .spoke, .spoke-group {
  filter: none !important;
}
    /* Information panels - side-positioned and expandable */
    .info-panel {
      display: none;
      position: fixed;
      top: 10%;
      right: 10px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 100;
      width: 35%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .panel-expanded {
      width: 60%;
      max-width: 800px;
      height: 85vh;
      max-height: 85vh;
    }
    
    .info-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .info-panel-controls {
      display: flex;
      gap: 10px;
    }
    
    .info-panel-title {
      margin: 0;
      color: #1565c0;
    }
    
    .close-panel, .expand-panel {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #495057;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }
    
    .close-panel:hover, .expand-panel:hover {
      background-color: #f1f3f5;
    }
    
    .panel-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 90;
    }
    
    /* Chart container - expandable */
    .chart-container {
      height: 300px;
      margin: 20px 0;
      transition: height 0.3s;
    }
    
    .chart-container.expanded {
      height: 500px;
    }
    
    /* Trend info */
    .trend-info {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .trend-card {
      flex: 1;
      min-width: 110px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .trend-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .trend-label {
      color: #6c757d;
      font-size: 13px;
    }
    
    .trend-direction {
      display: flex;
      align-items: center;
      margin-top: 5px;
      font-weight: bold;
      font-size: 12px;
    }
    
    .trend-up {
      color: #28a745;
    }
    
    .trend-down {
      color: #dc3545;
    }
    
    /* Recommendations styling */
    .recommendations-list {
      margin-top: 15px;
    }
    
    .recommendation-item {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    
    .recommendation-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .recommendation-desc {
      color: #6c757d;
      margin-bottom: 10px;
    }
    
    .contact-options {
      margin-top: 20px;
    }
    
    .contact-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .contact-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .contact-button {
      background: #4a6fa5;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 15px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .contact-button:hover {
      background: #395b89;
      transform: translateY(-2px);
    }
    
    .professional-button {
      background: #28a745;
    }
    
    .professional-button:hover {
      background: #218838;
    }
    
    /* Interactive sliders */
    .stability-slider-section h3 {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0px;
}

.stability-slider-section h3 .section-score {
  color: #1565c0;
  font-weight: bold;
}

.slider-row {
  width: 100%;
}

.slider-input {
  width: 100%;
  margin: 0px 0;
}

.variability-spectrum-info {
  display: flex;
  justify-content: space-between;
  margin-top: 0px;
  font-size: 12px;
  color: #666;
}

.variability-spectrum-info span {
  font-size: 12px;
  color: #666;
}

.variability-spectrum-info span:first-child {
  text-align: left;
}

.variability-spectrum-info span:last-child {
  text-align: right;
}

    .event-input-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .event-input-row label {
      font-size: 15px;
      font-weight: bold;
    }
    
    .event-input {
      width: 70px;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      text-align: center;
      font-size: 15px;
    }
    
    .calculate-btn, .apply-changes {
      background: #4a6fa5;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
      margin-top: 10px;
    }
    
    .apply-changes {
      display: block;
      width: 100%;
    }
    
    .calculate-btn:hover, .apply-changes:hover {
      background: #395b89;
      transform: translateY(-2px);
    }
    
    /* Individual Tab Styles */
    .score-display {
      background-color: #e3f2fd;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .score-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      margin: 10px auto;
    }
    
    .score-label {
      font-weight: bold;
      margin-top: 10px;
    }
    
    /* Compact core metrics styling */
    .core-metrics-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
      justify-content: space-between;
    }
    
    .metric-box {
      flex: 1;
      min-width: 120px;
      max-width: 180px;
      background-color: #f8f9fa;
      border: 1px solid #e2e6ea;
      border-radius: 8px;
      padding: 8px;
    }
    
    .metric-box label {
      font-weight: bold;
      display: block;
      margin-bottom: 3px;
      font-size: 13px;
    }
    
    .metric-box input[type="range"] {
      width: 100%;
      margin: 3px 0;
    }
    
    .custom-metrics {
      margin-bottom: 15px;
    }
    
    .custom-metric {
      position: relative;
      margin-bottom: 10px;
    }
    
    .delete-metric {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #f44336;
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
    }
    
    .delete-metric:hover {
      background-color: #d32f2f;
    }
    
    .add-metric-form {
      background-color: #f0f7ff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .metric-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .metric-input-group input {
      flex: 3;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    .metric-input-group select {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    .add-metric-btn {
      background-color: #43a047;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .add-metric-btn:hover {
      background-color: #2e7d32;
    }
    
    .action-button {
      background-color: #1565c0;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 15px 0;
    }
    
    .action-button:hover {
      background-color: #0d47a1;
    }
    
    .range-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    /* Position gauge styling */
    .position-gauge {
      width: 100%;
      height: 40px;
      background: linear-gradient(to right, 
        #3f51b5 0%, /* Deep blue (hypo) */
        #2196f3 20%, /* Light blue */
        #4caf50 50%, /* Green (balanced) */
        #ffc107 80%, /* Yellow */
        #f44336 100% /* Red (hyper) */
      );
      border-radius: 15px;
      position: relative;
      margin: 15px 0;
    }
    
    .position-marker {
      position: absolute;
      top: -5px;
      width: 10px;
      height: 50px;
      background-color: #ffffff;
      border: 2px solid #333;
      border-radius: 3px;
      transform: translateX(-50%);
    }
    
    .position-labels {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #495057;
      margin-top: 8px;
    }
    
    /* Research references button and panel */
    .research-references-btn {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 20px;
      display: inline-block;
    }
    
    .research-references-btn:hover {
      background-color: #e9ecef;
    }
    
    .research-panel {
      display: none;
      margin-top: 10px;
      padding: 15px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
    }
    
    .research-panel h4 {
      margin-top: 0;
      color: #495057;
    }
    
    .research-panel p {
      font-size: 14px;
      line-height: 1.5;
      color: #495057;
    }
    
    /* Hub panel expanded styles */
    #hub-panel.panel-expanded .stability-inputs {
      padding: 7px;
      margin-bottom: 5px;
    }
    
    #hub-panel.panel-expanded .stability-slider-section, 
    #hub-panel.panel-expanded .event-input-section {
      margin-bottom: 20px;
    }
    
    #hub-panel.panel-expanded .stability-slider-section h3 {font-size: 20px;
      margin-bottom: 5px;
    } 
    #hub-panel.panel-expanded .event-input-section h3 {
      font-size: 20px;
      margin-bottom: -2px;
    }
    
    #hub-panel.panel-expanded .slider-row {
      margin-bottom: 0px;
    }
    
    #hub-panel.panel-expanded .slider-label {
      width: 240px;
      font-size: 16px;
    }
    
    #hub-panel.panel-expanded .slider-value {
      font-size: 18px;
    }
    
    #hub-panel.panel-expanded .spectrum-info {
      margin-top: 0px;
      font-size: 14px;
    }
    
    /* Responsive layout */
    @media (max-width: 768px) {
      .sensory-content {
        flex-direction: column;
        align-items: center;
      }
      
      .wheel-container {
        width: 100%;
        max-width: 400px;
        height: auto;
      }
      
      .info-panel {
        width: 95%;
        max-width: 95%;
      }
      
      .core-metrics-row {
        flex-direction: column;
      }
      .stability-inputs {
  position: relative;
}

/* Position Value Styling */
.position-value-container {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  margin-bottom: 10px;
}

.position-value {
  font-size: 36px;
  font-weight: bold;
  color: #1565c0;
  background-color: #f0f0f0;
  padding: 5px 15px;
  border-radius: 6px;
  margin-left: 15px;
}

/* Interactive Gradient Gauge */
.position-gauge {
  width: 100%;
  height: 30px;
  background: linear-gradient(to right, 
    #3f51b5 0%,   /* Deep blue (shutdown) */
    #2196f3 20%,  /* Light blue */
    #4caf50 50%,  /* Green (balanced) */
    #ffc107 80%,  /* Yellow */
    #f44336 100%  /* Red (meltdown) */
  );
  border-radius: 15px;
  position: relative;
  cursor: pointer;
}

.position-marker {
  position: absolute;
  top: -5px;
  width: 20px;
  height: 40px;
  background-color: white;
  border: 2px solid #333;
  border-radius: 4px;
  transform: translateX(-50%);
  transition: left 0.3s ease;
}

.position-labels {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #666;
  margin-top: 5px;
}

/* Improved Variability Spectrum Info */
.variability-spectrum-info {
  display: flex;
  justify-content: space-between;
  margin-top: -5px;
  font-size: 11px;
  color: #666;
}

.variability-spectrum-info span:first-child {
  text-align: left;
}

.variability-spectrum-info span:last-child {
  text-align: right;
}



/* Improve slider appearance */
.slider-row {
  display: flex;
  align-items: center;
 
}

.slider-input {
  flex-grow: 1;
  margin: 0 5px;
}

.slider-value {
  width: 40px;
  text-align: center;
  font-size: 16px;
}

      
/* Make sure only intended elements appear on main page */
.sensory-content ~ .trend-info,
.sensory-content ~ .chart-container,
.sensory-content ~ .recommendations {
  display: none;
}

/* Ensure these elements are visible only in their proper panels */
#hub-panel .trend-info,
#hub-panel .chart-container,
#hub-panel #individualRecommendations {
  display: block;
}

/* Keep emergency panel visible */
.emergency-panel {
  display: block !important;
}
 /* Timeline styling */
 .individual-timeline {
    margin: 30px 0;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
  }
  
  .timeline-container {
    position: relative;
    margin-top: 20px;
    padding-left: 50px;
  }
  
  .timeline-container::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #1565c0;
  }
  
  .timeline-item {
    margin-bottom: 30px;
    position: relative;
  }
  
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -43px;
    top: 0;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #f44336;
    border: 2px solid #fff;
  }
  
  .timeline-date {
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 5px;
  }
  
  .timeline-content {
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .timeline-content h4 {
    margin-top: 0;
    color: #333;
  }
  
  .timeline-quote {
    font-style: italic;
    border-left: 3px solid #f44336;
    padding-left: 10px;
    margin-top: 10px;
    color: #555;
  }
  
  /* Analytics section */
  .individual-case-analytics {
    margin: 30px 0;
    padding: 20px;
    background-color: #f0f7ff;
    border-radius: 8px;
  }
  
  .analytics-item {
    margin-bottom: 25px;
  }
  
  .analytics-chart-container {
    height: 300px;
    margin: 15px 0;
  }
  
  .analytics-data {
    background-color: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .analytics-data ul {
    list-style-type: none;
    padding-left: 0;
  }
  
  .analytics-data li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }
  
  .analytics-data li:last-child {
    border-bottom: none;
  }
   /* Crisis Panel Styles */
   .crisis-panel {
    display: none;
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    max-width: 700px;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 150;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .crisis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }
  
  .crisis-title {
    margin: 0;
    color: #d32f2f;
    font-size: 24px;
  }
  
  .crisis-date {
    font-style: italic;
    color: #757575;
  }
  
  .crisis-content {
    margin-bottom: 20px;
  }
  
  .crisis-quote {
    font-style: italic;
    font-size: 16px;
    color: #555;
    border-left: 3px solid #d32f2f;
    padding-left: 15px;
    margin: 15px 0;
  }
  
  .crisis-details {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .crisis-impact {
    margin-top: 20px;
  }
  
  .impact-tabs {
    display: flex;
    border-bottom: 1px solid #ccc;
    margin-bottom: 15px;
  }
  
  .impact-tab {
    padding: 8px 15px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }
  
  .impact-tab.active {
    border-bottom: 3px solid #1565c0;
    color: #1565c0;
  }
  
  .impact-content {
    display: none;
  }
  
  .impact-content.active {
    display: block;
  }
  
  .view-full-impact-btn {
    display: block;
    margin: 20px auto;
    padding: 10px 20px;
    background: #1565c0;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
  }
  
  .view-full-impact-btn:hover {
    background: #0d47a1;
  }
  
  /* Timeline entry display styles for crisis panels */
  .crisis-timeline {
    position: relative;
    margin-left: 15px;
    padding-left: 30px;
    border-left: 2px solid #1565c0;
  }
  
  .timeline-entry {
    margin-bottom: 15px;
    position: relative;
  }
  
  .timeline-entry::before {
    content: '';
    position: absolute;
    left: -39px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #1565c0;
    border: 2px solid #fff;
  }
  
  .entry-date {
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 5px;
    font-size: 14px;
  }
  
  .entry-content {
    font-size: 14px;
    color: #555;
  }
  /* Additional styles for the full impact panel - add to your style section */
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.metric-item {
  background: #f0f7ff;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-value {
  font-size: 24px;
  font-weight: bold;
  color: #1565c0;
  margin-bottom: 5px;
}

.metric-label {
  font-size: 14px;
  color: #555;
}

.impact-section {
  margin-bottom: 25px;
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.impact-section h3 {
  color: #1565c0;
  margin-top: 0;
  padding-bottom: 8px;
  border-bottom: 1px solid #eee;
}
    }
  </style>
  <style>
  /* Crisis Panel Styles */
  .crisis-panel {
    display: none;
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    max-width: 700px;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 150;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .crisis-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }
  
  .crisis-title {
    margin: 0;
    color: #d32f2f;
    font-size: 24px;
  }
  
  .crisis-date {
    font-style: italic;
    color: #757575;
  }
  
  .crisis-content {
    margin-bottom: 20px;
  }
  
  .crisis-quote {
    font-style: italic;
    font-size: 16px;
    color: #555;
    border-left: 3px solid #d32f2f;
    padding-left: 15px;
    margin: 15px 0;
  }
  
  .crisis-details {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .crisis-impact {
    margin-top: 20px;
  }
  
  .impact-tabs {
    display: flex;
    border-bottom: 1px solid #ccc;
    margin-bottom: 15px;
  }
  
  .impact-tab {
    padding: 8px 15px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }
  
  .impact-tab.active {
    border-bottom: 3px solid #1565c0;
    color: #1565c0;
  }
  
  .impact-content {
    display: none;
  }
  
  .impact-content.active {
    display: block;
  }
  
  .view-full-impact-btn {
    display: block;
    margin: 20px auto;
    padding: 10px 20px;
    background: #1565c0;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
  }
  
  .view-full-impact-btn:hover {
    background: #0d47a1;
  }
  
  /* Timeline entry display styles for crisis panels */
  .crisis-timeline {
    position: relative;
    margin-left: 15px;
    padding-left: 30px;
    border-left: 2px solid #1565c0;
  }
  
  .timeline-entry {
    margin-bottom: 15px;
    position: relative;
  }
  
  .timeline-entry::before {
    content: '';
    position: absolute;
    left: -39px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #1565c0;
    border: 2px solid #fff;
  }
  
  .entry-date {
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 5px;
    font-size: 14px;
  }
  
  .entry-content {
    font-size: 14px;
    color: #555;
  }
  
  /* Section metrics styling */
  .section-metrics {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .section-metrics h3 {
    margin-top: 0;
    color: #1565c0;
    font-size: 18px;
    margin-bottom: 15px;
  }
  
  .slider-container {
    margin-top: 15px;
  }
  
  .slider-row {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .slider-label {
    width: 150px;
    font-size: 14px;
    font-weight: bold;
  }
  
  .slider-input {
    flex-grow: 1;
    margin: 0 15px;
  }
  
  .slider-value {
    width: 70px;
    font-size: 14px;
    text-align: right;
  }
  
  /* Impact analysis styles */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  .metric-item {
    background: #f0f7ff;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .metric-value {
    font-size: 24px;
    font-weight: bold;
    color: #1565c0;
    margin-bottom: 5px;
  }
  
  .metric-label {
    font-size: 14px;
    color: #555;
  }
  
  .impact-section {
    margin-bottom: 25px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .impact-section h3 {
    color: #1565c0;
    margin-top: 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>Adaptation Thermostat</h1>
    
    <!-- Individual tab content only -->
    <div id="individual" class="tab-content">
  <!-- Emergency Panel -->
  <div class="emergency-panel">
    <h3>Individual Crisis Support</h3>
    
    <p>If you're experiencing institutional barriers, select what you're facing:</p>
    <div class="symptom-buttons">
      <button class="symptom-button" data-system="healthcare">Healthcare Fragmentation</button>
      <button class="symptom-button" data-system="accommodation">Accommodation Denials</button>
      <button class="symptom-button" data-system="academic">Academic Barriers</button>
      <button class="symptom-button" data-system="coordination">Support Coordination</button>
      <button class="symptom-button" data-system="mental">Mental Health Crisis</button>
      <button class="symptom-button" data-system="financial">Financial Stress</button>
      <button class="symptom-button" data-system="visa">Visa/International</button>
    </div>
    
    <textarea class="custom-description" placeholder="Describe your institutional challenges here..."></textarea>
    <div class="typing-indicator">Finding solutions for you...</div>
    
    <div class="recommendations" id="individual-emergency-recommendations">
      <h4>Immediate Actions:</h4>
      <ul id="individual-immediate-interventions">
        <li>Click a button above or describe what you're experiencing</li>
      </ul>
    </div>
  </div>
  
  <!-- Individual Adaptation Wheel and information area -->
  <div class="sensory-content">
    <div class="wheel-container">
      <!-- SVG wheel with institutional components instead of sensory systems -->
      <svg class="sensory-wheel-svg" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
        <!-- Outer circle border -->
        <circle cx="250" cy="250" r="241" fill="none" stroke="black" stroke-width="2"></circle>
        
        <!-- Colored sections in outer ring - each represents an institutional department -->
        <!-- Healthcare - Red (poorly regulated) -->
        <path d="M155.5,28.8 A245,245 0 0,1 344.5,28.8 L319,92 A180,180 0 0,0 179.2,83.6 Z" fill="#f8696b" stroke="none" class="section-path" id="healthcare-section" data-section="healthcare" onclick="showSectionInfo('healthcare')"></path>
        
        <!-- DRC - Yellow (moderately regulated) -->
        <path d="M344.5,28.8 A245,245 0 0,1 471.2,155.5 L412.4,179.2 A180,180 0 0,0 320.8,83.6 Z" fill="#ffe699" stroke="none" class="section-path" id="drc-section" data-section="drc" onclick="showSectionInfo('drc')"></path>
        
        <!-- Academic Department - Yellow (moderately regulated) -->
        <path d="M471.2,155.5 A245,245 0 0,1 471.2,344.5 L412.4,320.8 A180,180 0 0,0 412.4,179.2 Z" fill="#ffe699" stroke="none" class="section-path" id="academic-section" data-section="academic" onclick="showSectionInfo('academic')"></path>
        
        <!-- Graduate School - Red (poorly regulated) -->
        <path d="M471.2,344.5 A245,245 0 0,1 344.5,471.2 L320.8,412.4 A180,180 0 0,0 412.4,320.8 Z" fill="#f8696b" stroke="none" class="section-path" id="gradschool-section" data-section="gradschool" onclick="showSectionInfo('gradschool')"></path>
        
        <!-- Mental Health - Red (poorly regulated) -->
        <path d="M344.5,471.2 A245,245 0 0,1 155.5,471.2 L179.2,412.4 A180,180 0 0,0 320.8,412.4 Z" fill="#f8696b" stroke="none" class="section-path" id="mentalhealth-section" data-section="mentalhealth" onclick="showSectionInfo('mentalhealth')"></path>
        
        <!-- OEO - Yellow (moderately regulated) -->
        <path d="M155.5,471.2 A245,245 0 0,1 28.8,344.5 L87.6,320.8 A180,180 0 0,0 179.2,412.4 Z" fill="#ffe699" stroke="none" class="section-path" id="oeo-section" data-section="oeo" onclick="showSectionInfo('oeo')"></path>
        
        <!-- Admin/Ombud - Yellow (moderately regulated) -->
        <path d="M28.8,344.5 A245,245 0 0,1 28.8,155.5 L87.6,179.2 A180,180 0 0,0 87.6,320.8 Z" fill="#ffe699" stroke="none" class="section-path" id="admin-section" data-section="admin" onclick="showSectionInfo('admin')"></path>
        
        <!-- ADA Compliance - Red (poorly regulated) -->
        <path d="M28.8,155.5 A245,245 0 0,1 155.5,28.8 L179.2,83.6 A180,180 0 0,0 87.6,179.2 Z" fill="#f8696b" stroke="none" class="section-path" id="ada-section" data-section="ada" onclick="showSectionInfo('ada')"></path>
        
        <!-- Middle white ring with border -->
        <circle cx="250" cy="250" r="179.5" fill="white" stroke="black" stroke-width="1"></circle>
        
        <!-- The adaptation score hub in the center -->
        <!-- Main hub circle - its color represents position on spectrum -->
        <circle cx="250" cy="250" r="70" fill="#f44336" stroke="none" id="individual-hub-circle" class="wheel-hub" onclick="showIndividualHubInfo()"></circle>
        
        <!-- Hub border - thickness represents stability (inversely related to variability) -->
        <circle cx="250" cy="250" r="75" fill="none" stroke="#333" stroke-width="6" stroke-opacity="0.7" id="individual-hub-border" onclick="showIndividualHubInfo()"></circle>
        
        <!-- Position value (-10 to +10) -->
        <text x="250" y="240" text-anchor="middle" font-size="28" font-weight="bold" fill="white" pointer-events="none" id="individual-hub-position">-4</text>
        
        <!-- Variability value - representing coin thickness -->
        <text x="250" y="270" text-anchor="middle" font-size="28" font-weight="bold" fill="white" pointer-events="none" id="individual-hub-variability">±8</text>
        
        <!-- Spokes connecting hub to sections - with enhanced clickable areas -->
        
        <!-- Healthcare (Red): Dashed line with wider clickable area -->
        <g class="spoke-group" id="healthcare-spoke-group">
          <line x1="250" y1="180" x2="250" y2="70" class="spoke-clickable-area" stroke="transparent" onclick="showIndividualSpokeInfo('healthcare')"></line>
          <line x1="250" y1="180" x2="250" y2="70" stroke="black" stroke-width="2" stroke-dasharray="5,3" class="spoke" id="healthcare-spoke" data-section="healthcare"></line>
        </g>
        
        <!-- DRC (Yellow): Dashed line with wider clickable area -->
        <g class="spoke-group" id="drc-spoke-group">
          <line x1="302" y1="198" x2="377" y2="123" class="spoke-clickable-area" stroke="transparent" onclick="showIndividualSpokeInfo('drc')"></line>
          <line x1="302" y1="198" x2="377" y2="123" stroke="black" stroke-width="2" stroke-dasharray="5,3" class="spoke" id="drc-spoke" data-section="drc"></line>
        </g>
        
        <!-- Academic (Yellow): Dashed line with wider clickable area -->
        <g class="spoke-group" id="academic-spoke-group">
          <line x1="320" y1="250" x2="430" y2="250" class="spoke-clickable-area" stroke="transparent" onclick="showIndividualSpokeInfo('academic')"></line>
          <line x1="320" y1="250" x2="430" y2="250" stroke="black" stroke-width="2" stroke-dasharray="5,3" class="spoke" id="academic-spoke" data-section="academic"></line>
        </g>
        
        <!-- Graduate School (Red): Dashed line with wider clickable area -->
        <g class="spoke-group" id="gradschool-spoke-group">
          <line x1="302" y1="302" x2="377" y2="377" class="spoke-clickable-area" stroke="transparent" onclick="showIndividualSpokeInfo('gradschool')"></line>
          <line x1="302" y1="302" x2="377" y2="377" stroke="black" stroke-width="2" stroke-dasharray="5,3" class="spoke" id="gradschool-spoke" data-section="gradschool"></line>
        </g>
        
        <!-- Mental Health (Red): Dashed line with wider clickable area -->
        <g class="spoke-group" id="mentalhealth-spoke-group">
          <line x1="250" y1="320" x2="250" y2="430" class="spoke-clickable-area" stroke="transparent" onclick="showIndividualSpokeInfo('mentalhealth')"></line>
          <line x1="250" y1="320" x2="250" y2="430" stroke="black" stroke-width="2" stroke-dasharray="5,3" class="spoke" id="mentalhealth-spoke" data-section="mentalhealth"></line>
        </g>
        
        <!-- OEO (Yellow): Dashed line with wider clickable area -->
        <g class="spoke-group" id="oeo-spoke-group">
          <line x1="198" y1="302" x2="123" y2="377" class="spoke-clickable-area" stroke="transparent" onclick="showIndividualSpokeInfo('oeo')"></line>
          <line x1="198" y1="302" x2="123" y2="377" stroke="black" stroke-width="2" stroke-dasharray="5,3" class="spoke" id="oeo-spoke" data-section="oeo"></line>
        </g>
        
        <!-- Admin/Ombud (Yellow): Dashed line with wider clickable area -->
        <g class="spoke-group" id="admin-spoke-group">
          <line x1="180" y1="250" x2="70" y2="250" class="spoke-clickable-area" stroke="transparent" onclick="showIndividualSpokeInfo('admin')"></line>
          <line x1="180" y1="250" x2="70" y2="250" stroke="black" stroke-width="2" stroke-dasharray="5,3" class="spoke" id="admin-spoke" data-section="admin"></line>
        </g>
        
        <!-- ADA (Red): Dashed line with wider clickable area -->
        <g class="spoke-group" id="ada-spoke-group">
          <line x1="198" y1="198" x2="123" y2="123" class="spoke-clickable-area" stroke="transparent" onclick="showIndividualSpokeInfo('ada')"></line>
          <line x1="198" y1="198" x2="123" y2="123" stroke="black" stroke-width="2" stroke-dasharray="5,3" class="spoke" id="ada-spoke" data-section="ada"></line>
        </g>
        
        <!-- CRISIS BREAKTHROUGH LINES - Historical Critical Incidents -->
        <!-- White background lines at section boundaries -->
        <!-- Healthcare/DRC Boundary (Jan 2023 PNES Diagnosis Event) -->
        <line x1="377" y1="123" x2="423" y2="77" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="healthcare,drc"></line>
        
        <!-- Healthcare/Mental Health Boundary (Sept 2023 Handcuffing Incident) -->
        <line x1="300" y1="425" x2="280" y2="465" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="healthcare,mentalhealth"></line>
        
        <!-- Academic/Graduate School Boundary (Feb 2024 Assistantship Termination) -->
        <line x1="377" y1="377" x2="423" y2="423" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="academic,gradschool"></line>
        
        <!-- Mental Health/Individual (Jan 2024 Suicide Attempt) -->
        <line x1="250" y1="430" x2="250" y2="490" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="mentalhealth"></line>
        
        <!-- Admin/OEO/ADA Boundary (Aug 2024 Investigation Without Protection) -->
        <line x1="123" y1="377" x2="77" y2="423" stroke="white" stroke-width="4" class="breakthrough-background" data-sections="oeo,admin"></line>
        
        <!-- Red dashed lines for crisis events - visible and clickable -->
        <!-- Healthcare/DRC Boundary (Jan 2023 PNES Diagnosis Event) -->
        <line x1="377" y1="123" x2="423" y2="77" stroke="red" stroke-width="3" stroke-dasharray="5,3" class="breakthrough-line" id="diagnosis-breakthrough" data-crisis="diagnosis" data-date="Jan 2023" data-title="PNES Diagnosis Without Support" onclick="showBreakthroughInfo('diagnosis')" style="opacity: 0.9; cursor: pointer;"></line>
        
        <!-- Healthcare/Mental Health Boundary (Sept 2023 Handcuffing Incident) -->
        <line x1="300" y1="425" x2="280" y2="465" stroke="red" stroke-width="3" stroke-dasharray="5,3" class="breakthrough-line" id="handcuffing-breakthrough" data-crisis="handcuffing" data-date="Sep 2023" data-title="Handcuffed &amp; Transported to Psychiatric Hospital" onclick="showBreakthroughInfo('handcuffing')" style="opacity: 0.9; cursor: pointer;"></line>
        
        <!-- Academic/Graduate School Boundary (Feb 2024 Assistantship Termination) -->
        <line x1="377" y1="377" x2="423" y2="423" stroke="red" stroke-width="3" stroke-dasharray="5,3" class="breakthrough-line" id="assistantship-breakthrough" data-crisis="assistantship" data-date="Feb 2024" data-title="Research Assistantship Termination" onclick="showBreakthroughInfo('assistantship')" style="opacity: 0.9; cursor: pointer;"></line>
        
        <!-- Mental Health/Individual (Jan 2024 Suicide Attempt) -->
        <line x1="250" y1="430" x2="250" y2="490" stroke="red" stroke-width="3" stroke-dasharray="5,3" class="breakthrough-line" id="suicide-breakthrough" data-crisis="suicide" data-date="Jan 2024" data-title="Suicide Attempt" onclick="showBreakthroughInfo('suicide')" style="opacity: 0.9; cursor: pointer;"></line>
        
        <!-- Admin/OEO/ADA Boundary (Aug 2024 Investigation Without Protection) -->
        <line x1="123" y1="377" x2="77" y2="423" stroke="red" stroke-width="3" stroke-dasharray="5,3" class="breakthrough-line" id="investigation-breakthrough" data-crisis="investigation" data-date="Aug 2024" data-title="Investigation Without Protection" onclick="showBreakthroughInfo('investigation')" style="opacity: 0.9; cursor: pointer;"></line>
        
        <!-- Section Labels - Positioned in the middle of each section -->
        <text x="250" y="40" text-anchor="middle" font-size="14" font-weight="bold" fill="black" pointer-events="none">Healthcare</text>
        <text x="400" y="100" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(45,400,100)" pointer-events="none">DRC</text>
        <text x="460" y="250" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(-90,460,250)" pointer-events="none">Academic</text>
        <text x="400" y="400" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(-45,400,400)" pointer-events="none">Grad School</text>
        <text x="250" y="460" text-anchor="middle" font-size="14" font-weight="bold" fill="black" pointer-events="none">Mental Health</text>
        <text x="100" y="400" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(45,100,400)" pointer-events="none">OEO</text>
        <text x="40" y="250" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(270,40,250)" pointer-events="none">Admin/Ombud</text>
        <text x="100" y="100" text-anchor="middle" font-size="14" font-weight="bold" fill="black" transform="rotate(-45,100,100)" pointer-events="none">ADA Office</text>
      </svg>
    </div>
  </div>
</div>
    <div class="panel-overlay" id="panel-overlay"></div>
    <div class="info-panel" id="hub-panel">
      <div class="info-panel-header">
        <h2 class="info-panel-title">Stability Coin Model</h2>
        <div class="info-panel-controls">
          <button class="expand-panel" onclick="togglePanelSize('hub-panel')" title="Expand/Collapse Panel">⤢</button>
          <button class="close-panel" onclick="closePanel('hub-panel')" title="Close Panel">×</button>
        </div>
      </div>
      
      <!-- Streamlined stability inputs -->
      <div class="stability-inputs">
        <div class="stability-slider-section">
          <h3>Where You Are Now <span class="position-value" id="position-slider-value">+2</span></h3>
          
          <!-- Position value displayed prominently above gauge - ENHANCED -->
          <div class="position-value-container">
          </div>
          
          <!-- Visual position gauge with no extra sliders -->
          <div class="position-gauge">
            <div class="position-marker" id="position-marker" style="left: 62%;"></div>
          </div>
          
          <!-- Labels below gauge -->
          <div class="position-labels">
            <span>Shutdown</span>
            <span>Balanced</span>
            <span>Meltdown</span>
          </div>
          
          <!-- Completely hidden input just for internal tracking -->
          <input type="range" min="-10" max="10" value="2" class="slider-input" id="position-slider" style="display: none;">
        
        
          <h3>How Much You Change <span class="slider-value" id="variability-slider-value">±5</span></h3>
        <div class="slider-row">
          <input type="range" min="0" max="10" value="5" class="slider-input" id="variability-slider">
        </div>
        
        <!-- FIXED: Modified to use new variability-spectrum-info class -->
        <div class="variability-spectrum-info">
          <span>Stable (Better)</span>
          <span>Frequent flips</span>
        </div>
        
        <div class="event-input-section">
          <h3>Event Tracking</h3>
          <div class="event-input-row">
            <label for="event-count">Incidents (last 30 days):</label>
            <input type="number" id="event-count" min="0" max="30" value="3" class="event-input">
            <button class="calculate-btn" id="calculate-from-events">Calculate</button>
          </div>
        </div>
        
        <button class="apply-changes" id="apply-hub-changes">Apply Changes</button>
        </div>
      </div>
      
      <!-- Trend summary cards - MOVED INTO HUB PANEL -->
      <div class="trend-info">
        <div class="trend-card">
          <div class="trend-value">3.2</div>
          <div class="trend-label">Previous Average</div>
          <div class="trend-direction trend-up">
            <span>▲</span> Getting Better
          </div>
        </div>
        
        <div class="trend-card">
          <div class="trend-value">7</div>
          <div class="trend-label">Recent Events</div>
          <div class="trend-direction trend-down">
            <span>▼</span> Fewer Than Before
          </div>
        </div>
        
        <div class="trend-card">
          <div class="trend-value">45m</div>
          <div class="trend-label">Recovery Time</div>
          <div class="trend-direction trend-down">
            <span>▼</span> Faster Recovery
          </div>
        </div>
      </div>
      
      <!-- Chart container for trends - MOVED INTO HUB PANEL -->
      <div class="chart-container" id="hub-chart-container">
        <canvas id="hubTrendChart"></canvas>
      </div>
      
      <!-- Recommendations section -->
      <h3>What Helps Most</h3>
      <div id="individualRecommendations" class="recommendations">
        <p><strong>Based on your current state (+2 with ±5 changes):</strong></p>
        <ul>
          <li>Notice when you start feeling overstimulated - look for early warning signs</li>
          <li>Create a regular daily schedule with predictable sensory activities</li>
          <li>Reduce environmental triggers when possible (dim lights, lower noise)</li>
          <li>Practice grounding techniques when you notice changes starting</li>
        </ul>
      </div>
    </div>
    <div class="info-panel" id="section-panel">
      <div class="info-panel-header">
        <h2 class="info-panel-title" id="section-panel-title">Sensory System</h2>
        <div class="info-panel-controls">
          <button class="expand-panel" onclick="togglePanelSize('section-panel')" title="Expand/Collapse Panel">⤢</button>
          <button class="close-panel" onclick="closePanel('section-panel')" title="Close Panel">×</button>
        </div>
      </div>
      
      <div class="trend-info">
        <div class="trend-card">
          <div class="trend-value" id="section-score">0.0</div>
          <div class="trend-label">Current Score</div>
          <div class="trend-direction" id="section-trend"></div>
        </div>
        
        <div class="trend-card">
          <div class="trend-value" id="section-events">0</div>
          <div class="trend-label">Related Shutdown Events</div>
          <div class="trend-direction" id="section-events-trend"></div>
        </div>
      </div>
      
      <div class="chart-container" id="section-chart-container">
        <canvas id="sectionTrendChart"></canvas>
      </div>
      
      <h3>Current Challenges</h3>
      <ul id="section-challenges">
        <!-- Populated dynamically based on selected section -->
      </ul>
      
      <!-- Added section performance slider -->
      <div class="slider-container">
        <h3 class="slider-title" id="section-slider-title">Adjust Section Performance</h3>
        <p>Use this slider to see how changes in this sensory system's performance would affect the wheel visualization.</p>
        
        <div class="slider-row">
          <div class="slider-label" id="section-slider-label">Performance Score:</div>
          <input type="range" min="1" max="10" step="0.1" value="5.0" class="slider-input" id="section-slider">
          <div class="slider-value" id="section-slider-value">5.0</div>
        </div>
        
        <button class="apply-changes" id="apply-section-changes">Apply Changes</button>
      </div>
    </div>
    <div class="info-panel" id="spoke-panel">
      <div class="info-panel-header">
        <h2 class="info-panel-title" id="spoke-panel-title">Recommendations</h2>
        <div class="info-panel-controls">
          <button class="expand-panel" onclick="togglePanelSize('spoke-panel')" title="Expand/Collapse Panel">⤢</button>
          <button class="close-panel" onclick="closePanel('spoke-panel')" title="Close Panel">×</button>
        </div>
      </div>
      
      <div class="recommendations-list" id="spoke-recommendations">
        <!-- Populated dynamically based on selected spoke -->
      </div>
      
      <div class="contact-options">
        <h3 class="contact-title">Co-Create Solutions With:</h3>
        <div class="contact-list" id="contact-list">
          <!-- Populated dynamically based on selected spoke -->
        </div>
      </div>
    </div>
    <div id="crisis-panel" class="crisis-panel" style="display: none;">
  <!-- Content will be dynamically generated -->
</div>
    <div id="full-impact-panel" class="crisis-panel" style="display: none;">
  <!-- Content will be dynamically generated -->
</div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // ===== CONSOLIDATED DATA STRUCTURES =====

// Data for each section
const sectionPerformanceData = {
  healthcare: { score: 2.4, previousScore: 1.8, events: 5, previousEvents: 8, color: "#f8696b" },
  drc: { score: 3.6, previousScore: 2.9, events: 4, previousEvents: 6, color: "#f8696b" },
  academic: { score: 5.8, previousScore: 5.2, events: 1, previousEvents: 3, color: "#ffe699" },
  gradschool: { score: 5.9, previousScore: 5.5, events: 1, previousEvents: 2, color: "#ffe699" },
  mentalhealth: { score: 2.4, previousScore: 1.8, events: 5, previousEvents: 8, color: "#f8696b" },
  oeo: { score: 3.6, previousScore: 2.9, events: 4, previousEvents: 6, color: "#f8696b" },
  admin: { score: 5.8, previousScore: 5.2, events: 1, previousEvents: 3, color: "#ffe699" },
  ada: { score: 5.9, previousScore: 5.5, events: 1, previousEvents: 2, color: "#ffe699" }
};

// Individual adaptation data
let individualData = [
  { month: 'Jan', shutdownFrequency: 8, recoveryTime: 4, adaptiveCapacity: 3, overallScore: 3.0 },
  { month: 'Feb', shutdownFrequency: 7, recoveryTime: 5, adaptiveCapacity: 3, overallScore: 3.7 },
  { month: 'Mar', shutdownFrequency: 6, recoveryTime: 6, adaptiveCapacity: 4, overallScore: 4.7 }
];

// Custom metrics tracking
let individualCustomMetrics = [];

// Individual chart reference
let individualChart = null;

// Challenges for each section
const sectionChallenges = {
  'healthcare': [
    "Fragmented care between different health units",
    "Lack of expertise for rare conditions like FND",
    "Harmful protocol application despite contradicting medical history",
    "No continuity of care between ER, hospital and outpatient services"
  ],
  'drc': [
    "Accommodations limited to classroom settings only",
    "No protocols for research environment adaptation",
    "Undefined implementation responsibility",
    "Limited coordination with other departments"
  ],
  'academic': [
    "No structure for implementing accommodations in research",
    "Communication breakdown with PI regarding disability needs",
    "Research assistantship termination without accommodation process",
    "Lack of flexibility with remote meetings and lab work schedules"
  ],
  'gradschool': [
    "No graduate-specific disability accommodation procedures",
    "Pushing for degree downgrade instead of adaptation",
    "Refusal to serve as interim advisor during transition",
    "No advocacy for interdisciplinary committee formation"
  ],
  'mentalhealth': [
    "Treatment termination without transition plan",
    "Referral to external services despite financial limitations",
    "Failure to coordinate with healthcare during crisis",
    "No protocol for complex disability cases"
  ],
  'oeo': [
    "Investigation without interim protections",
    "Months-long delays without updates",
    "Narrow interpretation of discrimination criteria",
    "No enforcement mechanisms for resolutions"
  ],
  'admin': [
    "Circular referrals between offices without resolution",
    "Ambiguous jurisdictional boundaries",
    "Unwillingness to coordinate with other departments",
    "Emphasis on procedure over problem-solving"
  ],
  'ada': [
    "Refusal to address graduate research accommodation needs",
    "Deflection of responsibility to DRC",
    "No clear protocol for complex disability cases",
    "Failure to ensure ADA compliance across departments"
  ]
};

// Recommendations for each section
const spokeRecommendations = {
  'healthcare': [
    { title: "Request Comprehensive Records", desc: "Get full medical documentation from all providers to bridge gaps between fragmented systems." },
    { title: "Bring Advocate to Appointments", desc: "Have someone accompany you who can help communicate needs and document responses." },
    { title: "Create Medical History Card", desc: "Prepare a concise summary of your conditions for emergency situations." },
    { title: "Request Care Coordination", desc: "Explicitly ask for a designated coordinator between different health units." }
  ],
  'drc': [
    { title: "Request Research-Specific Accommodations", desc: "Ask for written guidelines on how DRC accommodations apply to research settings." },
    { title: "Involve Third-Party Advocate", desc: "Bring an outside advocate to DRC meetings who can help articulate research-specific needs." },
    { title: "Document All Communication", desc: "Keep detailed records of all interactions, recommendations, and promises." },
    { title: "Request DRC-Department Liaison", desc: "Ask for a designated person to facilitate implementation in your department." }
  ],
  'academic': [
    { title: "Document All Meetings", desc: "Record dates, participants, and outcomes of all departmental discussions about accommodations." },
    { title: "Establish Communication Protocols", desc: "Create written agreements about preferred communication methods and response times." },
    { title: "Request Clear Expectations", desc: "Ask for written research expectations that incorporate accommodation needs." },
    { title: "Identify Departmental Advocate", desc: "Find a faculty member who can advocate for your needs within department meetings." }
  ],
  'gradschool': [
    { title: "Leverage External Faculty", desc: "Connect with faculty outside your department who may be more supportive of disability needs." },
    { title: "Document Degree Requirements", desc: "Get written confirmation of all requirements and potential modifications." },
    { title: "Request Committee Guidelines", desc: "Ask for written guidelines on forming interdisciplinary committees for disability-related research." },
    { title: "Appeal Directly to Dean", desc: "Bypass department barriers by appealing directly to Graduate School leadership." }
  ],
  'mentalhealth': [
    { title: "Request External Referrals List", desc: "Ask for a comprehensive list of external providers who work on sliding scale." },
    { title: "Document Termination Reasons", desc: "Get written explanation of why services are being terminated and what alternatives exist." },
    { title: "Request Coordination Permission", desc: "Sign release forms allowing communication between mental health and other university services." },
    { title: "Identify Crisis Protocol", desc: "Get written instructions for handling crisis situations when primary services are unavailable." }
  ],
  'oeo': [
    { title: "Request Investigation Timeline", desc: "Ask for a written timeline of investigation steps and expected resolution dates." },
    { title: "Request Interim Measures", desc: "Formally request protective measures during investigation periods." },
    { title: "Document All Evidence", desc: "Keep organized records of all discrimination evidence, including emails and meeting notes." },
    { title: "Request Regular Updates", desc: "Ask for bi-weekly status updates on investigation progress." }
  ],
  'admin': [
    { title: "Create Responsibility Map", desc: "Document which offices are responsible for which aspects of your accommodations." },
    { title: "CC Multiple Offices", desc: "Include all relevant parties in email communications to prevent deflection." },
    { title: "Request Joint Meeting", desc: "Ask the Ombud to coordinate a joint meeting with all relevant offices." },
    { title: "Document Referral Chain", desc: "Track all instances of being referred between offices without resolution." }
  ],
  'ada': [
    { title: "Reference Specific Regulations", desc: "Cite specific ADA Title II and Section 504 requirements in communications." },
    { title: "Request Written Policies", desc: "Ask for the written university policy on accommodations in research settings." },
    { title: "Document Interactive Process", desc: "Keep detailed records of all accommodation discussions and university responses." },
    { title: "Request Coordination Role", desc: "Ask the ADA office to designate a coordinator for your specific situation." }
  ]
};

// Trusted contacts and professionals for each section
const sectionContacts = {
  'healthcare': {
    trusted: ["Patient Advocacy Office", "University Ombudsman"],
    professional: ["National Disability Rights Network", "FND Hope International"]
  },
  'drc': {
    trusted: ["ADA Compliance Office", "Faculty Advocate"],
    professional: ["Office for Civil Rights (Dept of Education)", "National Center for College Students with Disabilities"]
  },
  'academic': {
    trusted: ["Department Disability Liaison", "Graduate Student Association"],
    professional: ["Faculty Mentoring Network", "Academic Accommodations Consultant"]
  },
  'gradschool': {
    trusted: ["Dean of Graduate Studies", "Graduate Student Ombudsperson"],
    professional: ["Council of Graduate Schools", "Accessible Graduate Education Alliance"]
  },
  'mentalhealth': {
    trusted: ["Community Crisis Services", "Peer Support Network"],
    professional: ["National Alliance on Mental Illness", "Psychology Today Provider Directory"]
  },
  'oeo': {
    trusted: ["Civil Rights Compliance Office", "Student Legal Services"],
    professional: ["Equal Employment Opportunity Commission", "Office for Civil Rights"]
  },
  'admin': {
    trusted: ["University Ombudsman", "Student Affairs Office"],
    professional: ["Educational Opportunity Advocates", "Higher Education Access Coalition"]
  },
  'ada': {
    trusted: ["Disability Law Center", "University Legal Counsel"],
    professional: ["ADA National Network", "Disability Rights Education & Defense Fund"]
  }
};

// Emergency interventions by system
const individualInterventionsBySystem = {
  'healthcare': [
    "Request complete copies of all medical records",
    "Ask for a patient advocate to coordinate care",
    "Document all treatment recommendations and referrals",
    "Create an emergency care plan with specific protocols for FND/PNES",
    "Bring a trusted friend to all medical appointments",
    "Request a neurologist experienced with functional disorders"
  ],
  'accommodation': [
    "Request accommodations in writing with delivery confirmation",
    "Ask which office is responsible for implementation",
    "Document all accommodation discussions and promises",
    "CC multiple departments in all accommodation communications",
    "Request specific accommodations for research settings",
    "Ask for flexible attendance and remote participation options"
  ],
  'academic': [
    "Request written clarification of academic expectations",
    "Document all meetings with faculty and advisors",
    "Ask the ombudsperson to facilitate department communications",
    "Request accommodations specific to research environment",
    "Create a written work plan with flexibility built in",
    "Inquire about deadline extensions before they're needed"
  ],
  'coordination': [
    "Ask ombudsperson to coordinate a multi-office meeting",
    "Create a contact list of all involved departments",
    "Request written clarification of each office's responsibilities",
    "Document all instances of being referred between offices",
    "Involve external advocacy organization for support",
    "Request a single point of contact for your case"
  ],
  'mental': [
    "Contact crisis services if experiencing suicidal thoughts: 988",
    "Document impact of institutional stress on your health",
    "Request medical leave paperwork if needed",
    "Ask for referrals to external mental health providers",
    "Practice grounding techniques during stressful interactions",
    "Create a safety plan with trusted people in your network"
  ],
  'financial': [
    "Contact financial aid office about hardship options",
    "Document all additional expenses caused by disability barriers",
    "Request emergency funding for disability-related needs",
    "Research external scholarships for disabled students",
    "Consider filing for disability-related loan deferment",
    "Request itemized invoices for all medical costs"
  ],
  'visa': [
    "Contact international student office about medical reduced course load",
    "Document all communications about visa status",
    "Request written clarification of visa requirements during medical issues",
    "Connect with international student advocacy groups",
    "Consult with immigration attorney about medical exceptions",
    "Ask about extensions for international student requirements"
  ]
};

// Hub trend data
const hubTrendData = {
  labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
  datasets: [
    {
      label: 'Position',
      data: [-2, -1, 0, 1, 1.5, 2],
      borderColor: '#2196f3',
      backgroundColor: 'rgba(33, 150, 243, 0.1)',
      borderWidth: 3,
      tension: 0.2
    },
    {
      label: 'Variability',
      data: [8, 7, 6, 6, 5, 5],
      borderColor: '#ff9800',
      backgroundColor: 'rgba(255, 152, 0, 0.1)',
      borderWidth: 2,
      tension: 0.2
    },
    {
      label: 'Shutdowns',
      data: [12, 11, 9, 8, 7, 7],
      borderColor: '#f44336',
      backgroundColor: 'rgba(244, 67, 54, 0.1)',
      borderWidth: 2,
      tension: 0.2,
      yAxisID: 'y1'
    }
  ]
};

// Section trend data template
const sectionTrendDataTemplate = {
  labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
  datasets: [
    {
      label: 'Section Score',
      borderWidth: 3,
      tension: 0.2
    },
    {
      label: 'Related Shutdowns',
      borderColor: '#f44336',
      backgroundColor: 'rgba(244, 67, 54, 0.1)',
      borderWidth: 2,
      tension: 0.2
    }
  ]
};

// Crisis data for breakthrough lines
const crisisData = {
  'diagnosis': {
    description: "Following seizures, diagnosed with Psychogenic Non-Epileptic Seizures (PNES), a type of Functional Neurological Disorder (FND) at UK Hospital's level 4 epilepsy unit. After diagnosis, was discharged without coordinated care plan.",
    quote: "I was discharged to navigate a labyrinth of fragmented services alone. I was advised to go to the University Health Services (UHS) for Cognitive Behavioral Therapy because there was nothing, they could offer me.",
    details: "The diagnosis of FND indicated a serious condition requiring coordinated care, but resulted in healthcare fragmentation:",
    timeline: [
      { date: "Jan 2023", content: "Initial seizures led to ER visit and overnight stay" },
      { date: "Late Jan 2023", content: "Video-EEG monitoring at UK's level 4 epilepsy unit" },
      { date: "End of Jan 2023", content: "PNES diagnosis with no treatment plan" },
      { date: "Feb 2023", content: "UHS referral to UK Counseling Center (UKCC)" },
      { date: "Mar 2023", content: "UKCC pointed out potential Autism but terminated care citing 'lack of expertise'" }
    ],
    individualImpact: [
      "Left without medical management protocols for a rare disease",
      "Forced to navigate disconnected university health systems alone",
      "Initial disability accommodations impacted by lack of coordinated diagnosis documentation",
      "Foreign student status added barriers to accessing external healthcare",
      "Deteriorating health due to lack of treatment plan"
    ],
    institutionalImpact: [
      "Revealed absence of care coordination protocols for complex conditions",
      "No clear responsibility assignment between departments",
      "Exposed gaps between healthcare units and academic accommodations processes",
      "Failed to meet ethical standards of patient care",
      "Violated ADA/Section 504 requirements for appropriate accommodations"
    ]
  },
  'handcuffing': {
    description: "After experiencing a seizure, self-presented to University Health Services (UHS). Instead of appropriate care, was stripped into a hospital gown at Good Samaritan Hospital, then handcuffed and transported by sheriffs to Eastern State Hospital.",
    quote: "I was stripped into a hospital gown at Good Samaritan Hospital, then handcuffed and transported by sheriffs to Eastern State Hospital in the middle of the night. I looked out the window as I wondered how on earth, I had gotten to this point of being taken like a criminal to an unfamiliar location in a foreign country.",
    details: "Despite being within UK's healthcare system with documented PNES history, staff ignored crucial medical information and implemented harmful protocols:",
    timeline: [
      { date: "Sep 2023", content: "Seizure in lab, leading to mental health deterioration" },
      { date: "Sep 2023", content: "Self-presented to UHS seeking help, with 'JESUS' written on wrists to prevent self-harm" },
      { date: "Sep 2023 (night)", content: "Stripped into hospital gown and handcuffed" },
      { date: "Sep 2023 (late night)", content: "Transported by sheriff to Eastern State Hospital" },
      { date: "Sep 2023", content: "After hours in freezing room, experienced back-to-back seizures that were ignored" },
      { date: "Sep 2023", content: "Subject to traumatic and inappropriate ER interventions" }
    ],
    individualImpact: [
      "Traumatic experience of being criminalized during medical crisis",
      "Physical injuries including chest pain lasting a month and neck sprain",
      "Severe PTSD and exacerbation of existing conditions",
      "Lost trust in university healthcare system",
      "International student vulnerabilities exploited by system"
    ],
    institutionalImpact: [
      "Violation of patient dignity and rights",
      "Failure to follow established medical protocols",
      "Electronic health record system failures with life-threatening consequences",
      "Improper use of law enforcement for medical situation",
      "Potential legal liability for inappropriate patient care"
    ]
  },
  'suicide': {
    description: "After months of institutional neglect and deteriorating mental health, attempted suicide. Rather than seeking institutional help again, self-harmed with a razor while on a call with a friend who intervened.",
    quote: "I could not turn myself in again, I would rather die. Consequently, as I got out a brand-new razor and surveyed my wrist, I called a friend while I watched how my green pulsing vein flayed layer by layer with each slice.",
    details: "This crisis represented the culmination of institutional failures across multiple university systems:",
    timeline: [
      { date: "Dec 2023", content: "Increasing depression and anxiety from institutional barriers" },
      { date: "Jan 1, 2024", content: "Suicide attempt with razor while on phone with friend" },
      { date: "Jan 2024", content: "Friend intervened and took to ER" },
      { date: "Jan 26, 2024", content: "Medical notes indicate 'emotionally exhausted for several months' and 'thoughts of not wanting to wake up more consistently present'" },
      { date: "Jan 2024", content: "Diagnosed with Major Depressive Disorder (MDD) and Chronic Fatigue Syndrome (CFS)" }
    ],
    individualImpact: [
      "Physical self-harm and near-death experience",
      "Additional psychiatric diagnoses beyond original condition",
      "Terror of seeking institutional help due to previous traumatic experiences",
      "Academic progress severely impacted by health crisis",
      "International student isolated from support systems"
    ],
    institutionalImpact: [
      "Direct result of systemic failures to provide appropriate accommodations",
      "Demonstrated lethal consequences of fragmented support systems",
      "Created significant legal liability for the university",
      "Exposed complete failure of mental health safety net",
      "Revealed serious ADA/Section 504 compliance failures"
    ]
  },
  'assistantship': {
    description: "Principal Investigator (PI) terminated research assistantship without any accommodation deliberation process. When asked about future plans, PI responded with 'I don't know.' Director of Graduate Studies (DGS) later suggested Master's as the only option.",
    quote: "My PI was done with me, my DGS couldn't care less, the message was clear: get out, PhD research in UKY is no place for people like you.",
    details: "This event demonstrated how the lack of disability accommodation structures in research environments led to discrimination:",
    timeline: [
      { date: "Dec 2023", content: "PI stopped responding to emails about remote meetings and flexible lab schedule" },
      { date: "Feb 2024", content: "Research assistantship terminated without accommodation process" },
      { date: "Feb 2024", content: "When asked about future beyond funding end in June, PI responded 'I don't know'" },
      { date: "May 2024", content: "DGS suggested Master's as only option rather than accommodation" },
      { date: "May 2024", content: "No interest shown in exploring accommodations for PhD continuation" }
    ],
    individualImpact: [
      "Loss of critical financial support as international student",
      "Research progress halted without accommodation exploration",
      "Career path threatened by forced degree downgrade",
      "Financial crisis on top of health crisis",
      "Further deterioration of mental health due to academic rejection"
    ],
    institutionalImpact: [
      "Clear violation of ADA/Section 504 requirements for academic accommodations",
      "Revealed absence of research accommodation protocols",
      "Demonstrated disability discrimination in graduate education",
      "Failed to engage in required interactive accommodation process",
      "Created additional potential legal liability"
    ]
  },
  'investigation': {
    description: "Office of Equal Opportunity (OEO) began investigation but provided no interim protection or accommodations. Investigation continued without regard for protecting the complainant, who was left without support.",
    quote: "The so-called investigation continued without regard for protection and supporting of the student who was potentially being discriminated against. Like a police investigation with the prime witness left to roam around in the same neighborhood of the crime; very trustworthy according to UKY standards.",
    details: "This process revealed the fundamental failures in the university's discrimination complaint process:",
    timeline: [
      { date: "Aug 2024", content: "OEO investigation began after staff member raised concerns" },
      { date: "Aug 2024", content: "No interim measures or protections provided" },
      { date: "Aug 22, 2024", content: "Academic ombud suggested registration with DGS as default advisor" },
      { date: "Aug 23, 2024", content: "DGS stated inability to evaluate research without primary advisor" },
      { date: "Aug 27, 2024", content: "DRC consultant suggested options were running out" },
      { date: "Dec 2024", content: "After 5 months, OEO determined everything was 'fair'" }
    ],
    individualImpact: [
      "Lost entire semester waiting for investigation outcome",
      "Health deteriorated further due to stress of unresolved situation",
      "Experience of circular referrals between offices without resolution",
      "Increased burden of disability through institutional inaction",
      "Further isolation and academic marginalization"
    ],
    institutionalImpact: [
      "Demonstrated procedural failures in discrimination complaint process",
      "Revealed absence of interim protection protocols",
      "Exposed coordination failures between university offices",
      "Created documentation of systemic discrimination",
      "Further violation of ADA/Section 504 requirements"
    ]
  }
};

// Systemic impact data for full impact panels
const systemicImpact = {
  'healthcare': {
    title: "Healthcare System Impact Analysis",
    systemFailures: [
      "Fragmented electronic health records prevented continuity of care",
      "No protocols for rare conditions like FND/PNES",
      "No care coordination between university health units",
      "Inappropriate psychiatric intervention for neurological symptoms",
      "Medical information silos leading to dangerous treatment errors"
    ],
    recommendations: [
      "Implement integrated EHR system across all university health units",
      "Create protocols for complex/rare condition management",
      "Assign care coordinators for students with multiple diagnoses",
      "Establish consultation team for complex cases",
      "Develop emergency protocols for FND/PNES that prevent harmful interventions"
    ],
    metrics: {
      "Coordination Failures": 12,
      "Treatment Delays": "Average 45 days",
      "Information Handoff Errors": 8,
      "Patient Safety Incidents": 3,
      "Policy Gaps Identified": 5
    }
  },
  'drc': {
    title: "Disability Resources System Impact Analysis",
    systemFailures: [
      "Accommodation letters not applicable to research settings",
      "No enforcement mechanism for accommodations",
      "Limited understanding of complex/invisible disabilities",
      "No integration with academic departments",
      "Failure to advise on graduate-specific accommodations"
    ],
    recommendations: [
      "Develop research-specific accommodation protocols",
      "Create accommodation enforcement procedures",
      "Establish regular training on complex disabilities",
      "Implement liaison system with academic departments",
      "Develop graduate-specific accommodation guidelines"
    ],
    metrics: {
      "Research Settings Without Coverage": "100%",
      "Unenforced Accommodations": 7,
      "Referrals Without Resolution": 9,
      "Policy Gaps Identified": 4,
      "Coordination Failures": 8
    }
  },
  'academic': {
    title: "Academic Department System Impact Analysis",
    systemFailures: [
      "No training for faculty on disability accommodations",
      "Unilateral termination of accommodated students",
      "No clear procedure for research accommodations",
      "Lack of accessibility in research environments",
      "Discrimination masquerading as 'academic standards'"
    ],
    recommendations: [
      "Mandatory faculty training on disability accommodations",
      "Create clear research accommodation guidelines",
      "Implement termination review process for disabled students",
      "Establish accessibility standards for research environments",
      "Regular department audits for disability inclusion"
    ],
    metrics: {
      "Faculty Trained in Accommodations": "0%",
      "Accessible Research Labs": "15%",
      "Accommodation Implementation Rate": "32%",
      "Discrimination Incidents": 3,
      "Policy Gaps Identified": 6
    }
  },
  'gradschool': {
    title: "Graduate School System Impact Analysis",
    systemFailures: [
      "No policies for graduate-specific accommodations",
      "Downgrading degrees instead of providing accommodations",
      "No clear responsibility for implementing accommodations",
      "Interdisciplinary committee barriers for disability research",
      "Lack of disability-knowledgeable advisors"
    ],
    recommendations: [
      "Develop graduate-specific accommodation policies",
      "Create clear responsibility assignment for accommodations",
      "Establish disability as valid research focus",
      "Facilitate interdisciplinary committees for disability research",
      "Train faculty advisors on disability-inclusive mentoring"
    ],
    metrics: {
      "Disabled Graduate Retention Rate": "37%",
      "Accommodation Implementation Rate": "28%",
      "Faculty Trained on Disability Issues": "12%",
      "Successful Accommodated Graduate Students": 3,
      "Policy Gaps Identified": 7
    }
  },
  'mentalhealth': {
    title: "Mental Health Services System Impact Analysis",
    systemFailures: [
      "Premature termination of services without transition",
      "Lack of expertise in complex conditions",
      "No coordination with academic accommodations",
      "Inadequate crisis response protocols",
      "External referrals without affordability consideration"
    ],
    recommendations: [
      "Develop proper service transition protocols",
      "Establish expertise development for complex cases",
      "Create coordination system with academic accommodations",
      "Improve crisis response for disabled students",
      "Develop sliding scale partnerships with community providers"
    ],
    metrics: {
      "Premature Service Terminations": 15,
      "Average Wait Time": "21 days",
      "Crisis Response Failures": 2,
      "Coordination Attempts": 8,
      "Successful Coordination Events": 1
    }
  },
  'oeo': {
    title: "Equal Opportunity Office System Impact Analysis",
    systemFailures: [
      "Investigations without interim protections",
      "No enforced timelines for investigations",
      "Narrow interpretation of disability discrimination",
      "No coordination with accommodation processes",
      "Inadequate remedies for discriminatory incidents"
    ],
    recommendations: [
      "Implement mandatory interim protections",
      "Establish and enforce investigation timelines",
      "Broaden disability discrimination understanding",
      "Create coordination protocol with DRC",
      "Develop stronger remedies for discrimination findings"
    ],
    metrics: {
      "Average Investigation Length": "147 days",
      "Interim Protections Provided": "0%",
      "Discrimination Findings Rate": "12%",
      "Successful Remedies Implemented": 0,
      "Policy Gaps Identified": 5
    }
  },
  'admin': {
    title: "Administrative Offices System Impact Analysis",
    systemFailures: [
      "Circular referrals without resolution",
      "Ambiguous jurisdictional boundaries",
      "Siloed departments with no collaboration",
      "Procedure prioritized over actual solutions",
      "No case management for complex situations"
    ],
    recommendations: [
      "Implement case management for complex needs",
      "Establish clear responsibility boundaries",
      "Create cross-department collaboration protocols",
      "Develop outcome-focused approaches",
      "Regular coordination training for staff"
    ],
    metrics: {
      "Circular Referrals Documented": 14,
      "Average Offices Involved Per Issue": 4.7,
      "Successful Resolutions": 2,
      "Average Resolution Time": "93 days",
      "Policy Gaps Identified": 8
    }
  },
  'ada': {
    title: "ADA Compliance System Impact Analysis",
    systemFailures: [
      "Deflection of graduate accommodation responsibility",
      "No implementation authority for accommodations",
      "Narrow interpretation of 'reasonable accommodations'",
      "Lack of research environment accessibility standards",
      "No regular compliance audits"
    ],
    recommendations: [
      "Establish clear responsibility for graduate accommodations",
      "Create enforcement authority for accommodations",
      "Broaden accommodation interpretations",
      "Develop research accessibility standards",
      "Implement regular compliance audits"
    ],
    metrics: {
      "Accommodation Implementation Rate": "24%",
      "Compliance Audits Conducted": 0,
      "Successful Accommodation Appeals": 1,
      "Documented Compliance Issues": 12,
      "Policy Gaps Identified": 6
    }
  },
  'diagnosis': {
    title: "PNES Diagnosis Crisis Impact Analysis",
    systemFailures: [
      "No care coordination after rare disease diagnosis",
      "Fragmented referral system with no follow-through",
      "No medical management protocols for FND/PNES",
      "Mental health services inadequate for neuropsychiatric condition",
      "International student needs ignored in healthcare planning"
    ],
    recommendations: [
      "Create post-diagnosis care coordination protocol",
      "Develop seamless referral and tracking system",
      "Establish FND/PNES management guidelines",
      "Train mental health staff on neuropsychiatric conditions",
      "Address international student barriers in healthcare planning"
    ],
    metrics: {
      "Days Without Treatment Plan": 45,
      "Referrals Without Follow-up": 3,
      "Coordination Attempts": 7,
      "Successful Coordinations": 0,
      "Health Deterioration Incidents": 2
    }
  },
  'handcuffing': {
    title: "Psychiatric Detention Crisis Impact Analysis",
    systemFailures: [
      "EHR failure to flag critical medical information",
      "Improper use of law enforcement for medical condition",
      "Missing protocols for neurological vs. psychiatric presentation",
      "International student vulnerabilities exploited by system",
      "Traumatic interventions worsening underlying condition"
    ],
    recommendations: [
      "Implement critical information flagging in EHR",
      "Create appropriate medical transport protocols",
      "Develop differential response guidelines for complex presentations",
      "Establish international student protections in crisis",
      "Train staff on trauma-informed crisis response"
    ],
    metrics: {
      "Policy Violations": 5,
      "Patient Safety Events": 3,
      "Documentation Failures": 8,
      "Staff Training Gaps": 4,
      "Healthcare Rights Violations": 6
    }
  },
  'suicide': {
    title: "Suicide Attempt Crisis Impact Analysis",
    systemFailures: [
      "Complete failure of mental health safety net",
      "Previous traumatic interventions preventing help-seeking",
      "No follow-up system for high-risk patients",
      "International student isolation factors ignored",
      "Accommodation failures contributing to crisis"
    ],
    recommendations: [
      "Redesign mental health safety net systems",
      "Create trauma-informed crisis response protocols",
      "Implement mandatory follow-up for high-risk cases",
      "Address international student isolation factors",
      "Integrate accommodation and mental health systems"
    ],
    metrics: {
      "Warning Signs Missed": 12,
      "Failed Intervention Points": 7,
      "System Disconnections Identified": 9,
      "Protocol Gaps": 6,
      "Coordination Failures": 14
    }
  },
  'assistantship': {
    title: "Assistantship Termination Crisis Impact Analysis",
    systemFailures: [
      "No accommodation process for research settings",
      "Discriminatory termination without review",
      "Graduate School failure to oversee department actions",
      "No interactive process for academic accommodations",
      "International student vulnerabilities exploited"
    ],
    recommendations: [
      "Create research accommodation protocols",
      "Establish termination review process for disabled students",
      "Implement Graduate School oversight of departments",
      "Require documented interactive accommodation process",
      "Develop protections for international disabled students"
    ],
    metrics: {
      "ADA Violations": 5,
      "Section 504 Violations": 7,
      "Documentation Failures": 9,
      "Financial Impact": "$18,000+",
      "Career Impact": "Severe"
    }
  },
  'investigation': {
    title: "OEO Investigation Crisis Impact Analysis",
    systemFailures: [
      "No interim protections during investigation",
      "Excessive investigation timeline without updates",
      "Narrow interpretation of discrimination evidence",
      "Complainant left to coordinate their own protection",
      "No accountability for investigation failures"
    ],
    recommendations: [
      "Mandate interim protections during investigations",
      "Establish and enforce investigation timelines",
      "Broaden interpretation of discrimination evidence",
      "Implement case management for complainants",
      "Create accountability metrics for investigations"
    ],
    metrics: {
      "Days Without Protection": 147,
      "Communication Failures": 12,
      "Policy Violations": 8,
      "Health Deterioration Events": 3,
      "Academic Time Lost": "1 semester"
    }
  }
};

// Global variable to track current section
let currentSection = '';

// ===== CORE FUNCTIONS =====

// Calculate overall adaptation score based on all section scores
function calculateAdaptationScore() {
  const scores = Object.values(sectionPerformanceData).map(data => data.score);
  const sum = scores.reduce((total, score) => total + score, 0);
  return (sum / scores.length).toFixed(1);
}

// Enhanced function to update hub visualization based on position and variability
function updateHubVisualization(position, variability) {
  // Update text values
  const positionElem = document.getElementById('individual-hub-position');
  const variabilityElem = document.getElementById('individual-hub-variability');
  const hubCircle = document.getElementById('individual-hub-circle');
  const hubBorder = document.getElementById('individual-hub-border');
  
  if (positionElem) positionElem.textContent = position >= 0 ? `+${position}` : position;
  if (variabilityElem) variabilityElem.textContent = `±${variability}`;
  
  // Calculate color based on position (0 is green, extremes are red/blue)
  let hubColor;
  const absPosition = Math.abs(position);
  
  if (absPosition < 2) {
    hubColor = "#4caf50"; // Green for balanced
  } else if (absPosition < 4) {
    hubColor = position > 0 ? "#8bc34a" : "#2196f3"; // Light green/blue for slight imbalance
  } else if (absPosition < 6) {
    hubColor = position > 0 ? "#ffc107" : "#03a9f4"; // Yellow/blue for moderate imbalance
  } else if (absPosition < 8) {
    hubColor = position > 0 ? "#ff9800" : "#673ab7"; // Orange/purple for significant imbalance
  } else {
    hubColor = position > 0 ? "#f44336" : "#3f51b5"; // Red/indigo for extreme imbalance
  }
  
  // Update hub color
  if (hubCircle) hubCircle.setAttribute("fill", hubColor);
  
  // Update hub border thickness based on variability (stability)
  // Higher variability (less stability) = thinner border
  if (hubBorder) {
    // Calculate border width: 15 - variability (so high variability = thin border)
    const borderWidth = Math.max(2, 15 - variability);
    hubBorder.setAttribute("stroke-width", borderWidth);
    
    // Also subtly adjust hub size based on stability (more stable = slightly larger)
    const hubSize = 70 - (variability / 2); // Base size is 70, reduce slightly with higher variability
    hubCircle.setAttribute("r", hubSize);
    hubBorder.setAttribute("r", hubSize + 5); // Border is slightly larger than hub
  }
  
  // Update recommendations based on position and variability
  updateRecommendations(position, variability);
  
  // Update marker position on the gauge
  const posMarker = document.getElementById('position-marker');
  if (posMarker) {
    const markerPos = 50 + (position * 5);
    posMarker.style.left = `${markerPos}%`;
  }
  
  // Update the position-slider-value display
  const posValueDisplay = document.getElementById('position-slider-value');
  if (posValueDisplay) {
    posValueDisplay.textContent = position >= 0 ? `+${position}` : position;
  }
}

// Function to generate position-based recommendations
function updateRecommendations(position, variability) {
  const recommendationsDiv = document.getElementById('individualRecommendations');
  if (!recommendationsDiv) return;
  
  let recommendations = [];
  const absPosition = Math.abs(position);
  
  // State-specific recommendations
  if (position < -3) {
    // Shutdown state recommendations
    recommendations.push(
      "Add more sensory input to help your system activate",
      "Use upbeat music or bright lights if they help engage you",
      "Try movement activities like stretching or walking",
      "Focus on one task at a time to help build momentum"
    );
  } else if (position > 3) {
    // Meltdown state recommendations
    recommendations.push(
      "Create a calmer sensory environment by reducing input",
      "Find a quiet space with less noise and less visual stimulation",
      "Use deep pressure like a weighted blanket if it helps",
      "Try slow breathing techniques to help regulate"
    );
  } else {
    // Balanced state recommendations
    recommendations.push(
      "Notice what helps you stay in this balanced state",
      "Create a regular daily schedule with predictable activities",
      "Keep a record of what environments work best for you",
      "Practice body awareness to notice early signs of change"
    );
  }
  
  // Add stability-based recommendations
  if (variability > 5) {
    recommendations.push(
      "Work on creating more predictable patterns in your day",
      "Notice early signs of state changes and respond quickly",
      "Develop a consistent sensory diet throughout your day",
      "Practice transitions between different environments"
    );
  }
  
  // Update the recommendations display
  recommendationsDiv.innerHTML = `
    <p><strong>Based on your current state (${position >= 0 ? '+' : ''}${position} with ±${variability} changes):</strong></p>
    <ul>
      ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
    </ul>
  `;
}

// Function to draw the sensory wheel
function drawSensoryWheel() {
  // Update each section color based on individual section score
  Object.keys(sectionPerformanceData).forEach(section => {
    const score = sectionPerformanceData[section].score;
    let color;
    
    if (score >= 8) {
      color = "#a8d08d"; // Green for well-regulated (scores 8-10)
    } else if (score >= 4) {
      color = "#ffe699"; // Yellow for moderately regulated (scores 4-7.9)
    } else {
      color = "#f8696b"; // Red for poorly regulated (scores 1-3.9)
    }
    
    // Update section color
    const sectionElement = document.getElementById(`${section}-section`);
    if (sectionElement) {
      sectionElement.setAttribute("fill", color);
      sectionPerformanceData[section].color = color;
    }
    
    // Update spoke style (solid for well-regulated, dashed for others)
    const spokeElement = document.getElementById(`${section}-spoke`);
    if (spokeElement) {
      if (score >= 8) {
        spokeElement.removeAttribute("stroke-dasharray");
      } else {
        spokeElement.setAttribute("stroke-dasharray", "5,3");
      }
    }
  });
  
  // Update breakthrough line visibility based on section scores
  const breakthroughLines = document.querySelectorAll('.breakthrough-line');
  const breakthroughBackgrounds = document.querySelectorAll('.breakthrough-background');
  
  // First set all breakthrough lines and backgrounds to invisible
  breakthroughLines.forEach(line => {
    line.style.opacity = "0";
  });
  
  breakthroughBackgrounds.forEach(bg => {
    bg.style.opacity = "0";
  });
  
  // Then show only those that correspond to yellow/red sections
  breakthroughLines.forEach(line => {
    const sectionsStr = line.getAttribute('data-sections');
    if (!sectionsStr) return;
    
    const sections = sectionsStr.split(',');
    
    // Calculate max opacity based on the worst section score
    let maxOpacity = 0;
    
    sections.forEach(section => {
      if (!sectionPerformanceData[section]) return;
      
      const score = sectionPerformanceData[section].score;
      
      // No opacity for green sections (score >= 8)
      // Linear fade from 0 to 1 as score goes from 8 down to 4
      if (score < 8) {
        // Calculate opacity: 0 at score 8, 1 at score 4 or below
        const opacity = Math.min(1, Math.max(0, (8 - score) / 4));
        maxOpacity = Math.max(maxOpacity, opacity);
      }
    });
    
    // Apply opacity to the line and its background
    if (maxOpacity > 0) {
      line.style.opacity = maxOpacity.toString();
      
      // Find corresponding background
      const sectionsSelector = `data-sections="${sectionsStr}"`;
      const bg = document.querySelector(`.breakthrough-background[${sectionsSelector}]`);
      if (bg) {
        bg.style.opacity = maxOpacity.toString();
      }
    }
  });
  
  // Get position and variability from hub
  const position = document.getElementById("individual-hub-position");
  const variability = document.getElementById("individual-hub-variability");
  
  if (position && variability) {
    const posValue = parseInt(position.textContent);
    const varValue = parseInt(variability.textContent.replace('±', ''));
    updateHubVisualization(posValue, varValue);
  }
}

// Tab switching function
function openTab(tabName) {
  const tabContents = document.getElementsByClassName('tab-content');
  for (let i = 0; i < tabContents.length; i++) {
    tabContents[i].classList.remove('active');
  }
  
  const tabButtons = document.getElementsByClassName('tab-button');
  for (let i = 0; i < tabButtons.length; i++) {
    tabButtons[i].classList.remove('active');
  }
  
  const tabContent = document.getElementById(tabName);
  if (tabContent) {
    tabContent.classList.add('active');
  }
  
  const buttons = document.getElementsByClassName('tab-button');
  for (let i = 0; i < buttons.length; i++) {
    if (buttons[i].textContent.toLowerCase().includes(tabName.toLowerCase())) {
      buttons[i].classList.add('active');
    }
  }
}

// Toggle panel size (expand/collapse)
function togglePanelSize(panelId) {
  const panel = document.getElementById(panelId);
  if (panel) {
    panel.classList.toggle('panel-expanded');
    
    // Also toggle chart container size if present
    const chartContainerId = panelId.replace('panel', 'chart-container');
    const chartContainer = document.getElementById(chartContainerId);
    if (chartContainer) {
      chartContainer.classList.toggle('expanded');
      
      // Resize charts if expanded
      if (chartContainer.classList.contains('expanded')) {
        if (panelId === 'hub-panel' && window.hubChart) {
          window.hubChart.resize();
        } else if (panelId === 'section-panel' && window.sectionChart) {
          window.sectionChart.resize();
        }
      }
    }
  }
}

// Modified showIndividualHubInfo function to include the "View Full Impact" button
function showIndividualHubInfo() {
  // Show the overlay
  const overlay = document.getElementById('panel-overlay');
  if (overlay) overlay.style.display = 'block';
  
  // Show the hub panel (reusing the same panel from sensory tab)
  const hubPanel = document.getElementById('hub-panel');
  if (hubPanel) {
    // Update panel title
    const panelTitle = hubPanel.querySelector('.info-panel-title');
    if (panelTitle) panelTitle.textContent = 'Individual Stability Status';
    
    // Update recommendations to individual-specific ones
    const recommendations = hubPanel.querySelector('#individualRecommendations');
    if (recommendations) {
      recommendations.innerHTML = `
        <p><strong>Based on current stability (-4 with ±8 volatility):</strong></p>
        <ul>
          <li>Document all interactions with university offices</li>
          <li>Request written confirmation of verbal promises</li>
          <li>Establish a support network of advocates</li>
          <li>Prioritize self-care when navigating institutional barriers</li>
        </ul>
      `;
    }
    
    // Add "View Full Impact" button if it doesn't exist
    if (!hubPanel.querySelector('.view-full-impact-btn')) {
      const impactBtn = document.createElement('button');
      impactBtn.className = 'view-full-impact-btn';
      impactBtn.textContent = 'View Full Impact';
      impactBtn.onclick = function() {
        showFullImpactPanel('overall');
      };
      
      // Add before the recommendations section or at the end of the panel
      if (recommendations) {
        hubPanel.insertBefore(impactBtn, recommendations);
      } else {
        hubPanel.appendChild(impactBtn);
      }
    }
    
    hubPanel.style.display = 'block';
  }
  
  // Update position and variability sliders
  updateSliders();
  
  // Create the hub trend chart
  renderHubTrendChart();
  
  // Update trend chart if it exists
  if (window.hubChart) {
    window.hubChart.data.datasets[0].label = 'Institutional Stability';
    window.hubChart.data.datasets[1].label = 'Administrative Volatility';
    window.hubChart.data.datasets[2].label = 'Health Incidents';
    window.hubChart.update();
  }
}

// Function to update sliders to match hub values
function updateSliders() {
  // Get current position and variability from hub
  const position = document.getElementById('hub-position');
  const variability = document.getElementById('hub-variability');
  
  if (position && variability) {
    const posValue = parseInt(position.textContent);
    const varValue = parseInt(variability.textContent.replace('±', ''));
    
    // Update slider values
    const posSlider = document.getElementById('position-slider');
    const posSliderValue = document.getElementById('position-slider-value');
    const posMarker = document.getElementById('position-marker');
    
    if (posSlider) posSlider.value = posValue;
    if (posSliderValue) posSliderValue.textContent = posValue >= 0 ? `+${posValue}` : posValue;
    
    if (posMarker) {
      // Calculate position (50% is center, each unit is 5%)
      const markerPos = 50 + (posValue * 5);
      posMarker.style.left = `${markerPos}%`;
    }
    
    const varSlider = document.getElementById('variability-slider');
    const varSliderValue = document.getElementById('variability-slider-value');
    
    if (varSlider) varSlider.value = varValue;
    if (varSliderValue) varSliderValue.textContent = `±${varValue}`;
  }
}

// Function to show section information
function showSectionInfo(sectionId) {
  // Store current section
  currentSection = sectionId;
  
  // Get the data for this section
  const sectionData = sectionPerformanceData[sectionId];
  if (!sectionData) return;
  
  // Show the overlay
  const overlay = document.getElementById('panel-overlay');
  if (overlay) overlay.style.display = 'block';
  
  // Show the section panel
  const sectionPanel = document.getElementById('section-panel');
  if (sectionPanel) {
    // Update panel title based on section
    const panelTitle = sectionPanel.querySelector('.info-panel-title');
    if (panelTitle) {
      const titleMap = {
        'healthcare': 'University Healthcare System',
        'drc': 'Disability Resource Center',
        'academic': 'Academic Department',
        'gradschool': 'Graduate School',
        'mentalhealth': 'Mental Health Services',
        'oeo': 'Office of Equal Opportunity',
        'admin': 'Administrative Offices',
        'ada': 'ADA Compliance Office'
      };
      
      panelTitle.textContent = titleMap[sectionId] || (sectionId.charAt(0).toUpperCase() + sectionId.slice(1));
    }
    
    // Update section score and trend
    const scoreElem = document.getElementById('section-score');
    const trendElement = document.getElementById('section-trend');
    
    if (scoreElem) {
      scoreElem.textContent = sectionData.score.toFixed(1);
    }
    
    if (trendElement) {
      const scoreDiff = (sectionData.score - sectionData.previousScore).toFixed(1);
      
      if (scoreDiff > 0) {
        trendElement.innerHTML = `<span>&#9650;</span> Improved by ${scoreDiff} points`;
        trendElement.className = 'trend-direction trend-up';
      } else if (scoreDiff < 0) {
        trendElement.innerHTML = `<span>&#9660;</span> Decreased by ${Math.abs(scoreDiff)} points`;
        trendElement.className = 'trend-direction trend-down';
      } else {
        trendElement.innerHTML = `<span>&#8644;</span> No change`;
        trendElement.className = 'trend-direction';
      }
    }
    
    // Update section events and trend
    const eventsElem = document.getElementById('section-events');
    const eventsTrendElement = document.getElementById('section-events-trend');
    
    if (eventsElem) {
      eventsElem.textContent = sectionData.events;
    }
    
    if (eventsTrendElement) {
      const eventsDiff = sectionData.previousEvents - sectionData.events;
      
      if (eventsDiff > 0) {
        eventsTrendElement.innerHTML = `<span>&#9660;</span> Decreased from ${sectionData.previousEvents}`;
        eventsTrendElement.className = 'trend-direction trend-up';
      } else if (eventsDiff < 0) {
        eventsTrendElement.innerHTML = `<span>&#9650;</span> Increased from ${sectionData.previousEvents}`;
        eventsTrendElement.className = 'trend-direction trend-down';
      } else {
        eventsTrendElement.innerHTML = `<span>&#8644;</span> No change`;
        eventsTrendElement.className = 'trend-direction';
      }
    }
    
    // Populate challenges
    const challengesElement = document.getElementById('section-challenges');
    if (challengesElement && sectionChallenges[sectionId]) {
      challengesElement.innerHTML = '';
      
      sectionChallenges[sectionId].forEach(challenge => {
        const li = document.createElement('li');
        li.textContent = challenge;
        challengesElement.appendChild(li);
      });
    }
    
    // Update slider
    const slider = document.getElementById('section-slider');
    const sliderValue = document.getElementById('section-slider-value');
    const sliderTitle = document.getElementById('section-slider-title');
    const sliderLabel = document.getElementById('section-slider-label');
    
    if (slider) slider.value = sectionData.score;
    if (sliderValue) sliderValue.textContent = sectionData.score.toFixed(1);
    if (sliderTitle) sliderTitle.textContent = `Adjust ${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)} Performance`;
    if (sliderLabel) sliderLabel.textContent = `${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)} Score:`;
    
    // Add "View Full Impact" button to panel
    const addFullImpactButton = function(panel) {
      // Check if button already exists
      let existingButton = panel.querySelector('.view-full-impact-btn');
      if (existingButton) return;
      
      const buttonsDiv = document.createElement('div');
      buttonsDiv.style.textAlign = 'center';
      buttonsDiv.style.marginTop = '20px';
      
      const viewImpactBtn = document.createElement('button');
      viewImpactBtn.className = 'view-full-impact-btn';
      viewImpactBtn.textContent = 'View Full Impact';
      viewImpactBtn.onclick = function() {
        showFullImpactPanel(sectionId);
      };
      
      buttonsDiv.appendChild(viewImpactBtn);
      panel.appendChild(buttonsDiv);
    };
    
    // Add the button to the panel
    addFullImpactButton(sectionPanel);
    
    sectionPanel.style.display = 'block';
  }
  
  // Create the section trend chart
  renderSectionTrendChart(sectionId);
}

// Function to show spoke information
function showIndividualSpokeInfo(sectionId) {
  // Show the overlay
  const overlay = document.getElementById('panel-overlay');
  if (overlay) overlay.style.display = 'block';
  
  // Show the spoke panel
  const spokePanel = document.getElementById('spoke-panel');
  if (spokePanel) {
    // Update panel title
    const panelTitle = spokePanel.querySelector('.info-panel-title');
    if (panelTitle) {
      const titleMap = {
        'healthcare': 'Healthcare Navigation Strategies',
        'drc': 'Effective DRC Engagement Tactics',
        'academic': 'Academic Department Interactions',
        'gradschool': 'Graduate School Advocacy Approaches',
        'mentalhealth': 'Mental Health Support Navigation',
        'oeo': 'OEO Interaction Strategies',
        'admin': 'Administrative Office Navigation',
        'ada': 'ADA Compliance Engagement'
      };
      
      panelTitle.textContent = titleMap[sectionId] || (sectionId.charAt(0).toUpperCase() + sectionId.slice(1) + ' Recommendations');
    }
    
    // Populate recommendations
    const recommendationsElement = spokePanel.querySelector('#spoke-recommendations');
    if (recommendationsElement && spokeRecommendations[sectionId]) {
      recommendationsElement.innerHTML = '';
      
      spokeRecommendations[sectionId].forEach(rec => {
        const div = document.createElement('div');
        div.className = 'recommendation-item';
        
        const title = document.createElement('div');
        title.className = 'recommendation-title';
        title.textContent = rec.title;
        
        const desc = document.createElement('div');
        desc.className = 'recommendation-desc';
        desc.textContent = rec.desc;
        
        div.appendChild(title);
        div.appendChild(desc);
        recommendationsElement.appendChild(div);
      });
    }
    
    // Populate contact options
    const contactsElement = spokePanel.querySelector('#contact-list');
    if (contactsElement && sectionContacts[sectionId]) {
      contactsElement.innerHTML = '';
      
      // Add trusted contacts
      sectionContacts[sectionId].trusted.forEach(contact => {
        const button = document.createElement('button');
        button.className = 'contact-button';
        button.textContent = contact;
        button.onclick = function() { alert(`Connecting with ${contact}...`); };
        contactsElement.appendChild(button);
      });
      
      // Add professional contacts
      sectionContacts[sectionId].professional.forEach(contact => {
        const button = document.createElement('button');
        button.className = 'contact-button professional-button';
        button.textContent = contact;
        button.onclick = function() { alert(`Scheduling appointment with ${contact}...`); };
        contactsElement.appendChild(button);
      });
    }
    
    // Add "View Full Impact" button to panel
    const addFullImpactButton = function(panel) {
      // Check if button already exists
      let existingButton = panel.querySelector('.view-full-impact-btn');
      if (existingButton) return;
      
      const buttonsDiv = document.createElement('div');
      buttonsDiv.style.textAlign = 'center';
      buttonsDiv.style.marginTop = '20px';
      
      const viewImpactBtn = document.createElement('button');
      viewImpactBtn.className = 'view-full-impact-btn';
      viewImpactBtn.textContent = 'View Full Impact';
      viewImpactBtn.onclick = function() {
        showFullImpactPanel(sectionId);
      };
      
      buttonsDiv.appendChild(viewImpactBtn);
      panel.appendChild(buttonsDiv);
    };
    
    // Add the button to the panel
    addFullImpactButton(spokePanel);
    
    spokePanel.style.display = 'block';
  }
}

// Function to show critical breakthrough information when clicking on red lines
function showBreakthroughInfo(crisisId) {
  // Create or get crisis panel
  let crisisPanel = document.getElementById('crisis-panel');
  if (!crisisPanel) {
    crisisPanel = document.createElement('div');
    crisisPanel.id = 'crisis-panel';
    crisisPanel.className = 'crisis-panel';
    document.body.appendChild(crisisPanel);
  }
  
  // Get crisis data
  const crisis = crisisData[crisisId];
  if (!crisis) return;
  
  // Create crisis panel content
  crisisPanel.innerHTML = `
    <div class="crisis-header">
      <h2 class="crisis-title">${crisis.title}</h2>
      <span class="crisis-date">${crisis.date}</span>
      <button class="close-panel" onclick="document.getElementById('crisis-panel').style.display='none';">&times;</button>
    </div>
    
    <div class="crisis-content">
      <p>${crisis.description}</p>
      <p class="crisis-quote">${crisis.quote}</p>
      
      <div class="crisis-details">
        <h3>What Happened</h3>
        <p>${crisis.details}</p>
        
        <div class="crisis-timeline">
          ${crisis.timeline.map(entry => `
            <div class="timeline-entry">
              <div class="entry-date">${entry.date}</div>
              <div class="entry-content">${entry.content}</div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <div class="crisis-impact">
        <div class="impact-tabs">
          <button class="impact-tab active" onclick="switchImpactTab(this, 'individual')">Individual Impact</button>
          <button class="impact-tab" onclick="switchImpactTab(this, 'institutional')">Institutional Impact</button>
        </div>
        
        <div class="impact-content active" id="individual-impact">
          <ul>
            ${crisis.individualImpact.map(impact => `<li>${impact}</li>`).join('')}
          </ul>
        </div>
        
        <div class="impact-content" id="institutional-impact">
          <ul>
            ${crisis.institutionalImpact.map(impact => `<li>${impact}</li>`).join('')}
          </ul>
        </div>
      </div>
      
      <button class="view-full-impact-btn" onclick="showFullImpactPanel('${crisisId}')">View Full System Analysis</button>
    </div>
  `;
  
  // Show the overlay
  const overlay = document.getElementById('panel-overlay');
  if (overlay) overlay.style.display = 'block';
  
  // Show the crisis panel
  crisisPanel.style.display = 'block';
}

// Function to switch between impact tabs
function switchImpactTab(tabButton, tabName) {
  // Get all tabs and content elements
  const tabs = document.querySelectorAll('.impact-tab');
  const contents = document.querySelectorAll('.impact-content');
  
  // Remove active class from all tabs and contents
  tabs.forEach(tab => tab.classList.remove('active'));
  contents.forEach(content => content.classList.remove('active'));
  
  // Add active class to selected tab
  tabButton.classList.add('active');
  
  // Show selected content
  document.getElementById(`${tabName}-impact`).classList.add('active');
}

// Enhanced full impact panel with data visualization
function showFullImpactPanel(id) {
  // Create or get full impact panel
  let impactPanel = document.getElementById('full-impact-panel');
  if (!impactPanel) {
    impactPanel = document.createElement('div');
    impactPanel.id = 'full-impact-panel';
    impactPanel.className = 'crisis-panel panel-expanded'; // Start expanded
    document.body.appendChild(impactPanel);
  }
  
  // Create panel content with tabs for different visualizations
  impactPanel.innerHTML = `
    <div class="crisis-header">
      <h2 class="crisis-title">Comprehensive System Impact Analysis</h2>
      <button class="close-panel" onclick="document.getElementById('full-impact-panel').style.display='none';">&times;</button>
    </div>
    
    <div class="crisis-content">
      <div class="impact-tabs" style="display: flex; border-bottom: 1px solid #ccc; margin-bottom: 15px;">
        <button class="impact-tab active" onclick="switchImpactPanel(this, 'current')">Current System Impact</button>
        <button class="impact-tab" onclick="switchImpactPanel(this, 'timeline')">Impact Timeline</button>
        <button class="impact-tab" onclick="switchImpactPanel(this, 'adaptherm')">AdapTherm Solution</button>
        <button class="impact-tab" onclick="switchImpactPanel(this, 'outcomes')">Projected Outcomes</button>
      </div>
      
      <div class="impact-content active" id="current-impact">
        <div class="impact-section">
          <h3>Current System Impact by Department</h3>
          <div class="impact-chart-container" style="height: 300px;">
            <canvas id="departments-impact-chart"></canvas>
          </div>
          <p class="chart-description">This visualization shows the degree of institutional fragmentation across departments and its impact on individual success metrics.</p>
        </div>
        
        <div class="impact-section">
          <h3>Critical Metrics Analysis</h3>
          <div class="metrics-grid">
            <div class="metric-item">
              <div class="metric-value">42</div>
              <div class="metric-label">Coordination Failures</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">93 days</div>
              <div class="metric-label">Avg. Resolution Time</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">28%</div>
              <div class="metric-label">Implementation Rate</div>
            </div>
            <div class="metric-item">
              <div class="metric-value">38</div>
              <div class="metric-label">Policy Gaps</div>
            </div>
          </div>
        </div>
        
        <div class="impact-section">
          <h3>Success Probability Analysis</h3>
          <div class="impact-chart-container" style="height: 300px;">
            <canvas id="success-probability-chart"></canvas>
          </div>
          <p class="chart-description">Current fragmented systems create multiple failure points that compound, drastically reducing success probability.</p>
        </div>
      </div>
      
      <div class="impact-content" id="timeline-impact">
        <div class="impact-section">
          <h3>Cumulative Impact Timeline</h3>
          <div class="impact-chart-container" style="height: 300px;">
            <canvas id="impact-timeline-chart"></canvas>
          </div>
          <p class="chart-description">The cumulative effect of unaddressed institutional barriers compounds over time, creating escalating adverse impacts.</p>
        </div>
        
        <div class="impact-section">
          <h3>Critical Incidents</h3>
          <div class="timeline-container" style="margin-top: 20px;">
            <div class="timeline-entry">
              <div class="entry-date">Jan 2023</div>
              <div class="entry-content">
                <strong>PNES Diagnosis Without Support</strong>
                <p>Fragmented healthcare system provided no coordinated care plan</p>
                <div class="entry-impact" style="color: #d32f2f;">High Impact: Medical Crisis</div>
              </div>
            </div>
            <div class="timeline-entry">
              <div class="entry-date">Sep 2023</div>
              <div class="entry-content">
                <strong>Psychiatric Detention Crisis</strong>
                <p>System failed to recognize medical history, leading to traumatic detention</p>
                <div class="entry-impact" style="color: #d32f2f;">High Impact: Traumatic Harm</div>
              </div>
            </div>
            <div class="timeline-entry">
              <div class="entry-date">Jan 2024</div>
              <div class="entry-content">
                <strong>Suicide Attempt</strong>
                <p>Culmination of system failures led to life-threatening crisis</p>
                <div class="entry-impact" style="color: #d32f2f;">Severe Impact: Life-Threatening</div>
              </div>
            </div>
            <div class="timeline-entry">
              <div class="entry-date">Feb 2024</div>
              <div class="entry-content">
                <strong>Research Assistantship Termination</strong>
                <p>No accommodation process for research settings</p>
                <div class="entry-impact" style="color: #d32f2f;">High Impact: Financial/Career Crisis</div>
              </div>
            </div>
            <div class="timeline-entry">
              <div class="entry-date">Aug 2024</div>
              <div class="entry-content">
                <strong>Investigation Without Protection</strong>
                <p>OEO investigation provided no interim protections</p>
                <div class="entry-impact" style="color: #d32f2f;">High Impact: Academic Time Loss</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="impact-content" id="adaptherm-impact">
        <div class="impact-section">
          <h3>AdapTherm Integration Impact</h3>
          <div class="impact-chart-container" style="height: 300px;">
            <canvas id="adaptherm-comparison-chart"></canvas>
          </div>
          <p class="chart-description">AdapTherm transforms fragmented systems into coordinated networks, dramatically improving response times and success rates.</p>
        </div>
        
        <div class="impact-section">
          <h3>Key System Transformations</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px;">
            <div style="flex: 1; min-width: 250px; background: #f5f5f5; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <h4 style="color: #d32f2f; margin-top: 0;">Current System</h4>
              <ul style="padding-left: 20px; margin-bottom: 0;">
                <li>Fragmented departments</li>
                <li>No coordination mechanisms</li>
                <li>Unclear responsibilities</li>
                <li>93-day average resolution</li>
                <li>28% implementation rate</li>
              </ul>
            </div>
            <div style="flex: 1; min-width: 250px; background: #e8f5e9; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <h4 style="color: #2e7d32; margin-top: 0;">AdapTherm System</h4>
              <ul style="padding-left: 20px; margin-bottom: 0;">
                <li>Integrated case management</li>
                <li>Cross-department coordination</li>
                <li>Clear responsibility assignment</li>
                <li>14-day average resolution</li>
                <li>92% implementation rate</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="impact-section">
          <h3>Process Transformation</h3>
          <div class="impact-chart-container" style="height: 300px;">
            <canvas id="process-transformation-chart"></canvas>
          </div>
          <p class="chart-description">AdapTherm reduces process complexity while increasing coordination, dramatically improving efficiency.</p>
        </div>
      </div>
      
      <div class="impact-content" id="outcomes-impact">
        <div class="impact-section">
          <h3>Projected Success Outcomes</h3>
          <div class="impact-chart-container" style="height: 300px;">
            <canvas id="success-outcomes-chart"></canvas>
          </div>
          <p class="chart-description">AdapTherm transforms institutional barriers into opportunities for innovation and growth.</p>
        </div>
        
        <div class="impact-section">
          <h3>Transforming Challenges to Opportunities</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px;">
            <div style="flex: 1; min-width: 250px; background: #f5f5f5; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <h4 style="margin-top: 0;">Healthcare Fragmentation</h4>
              <p style="font-weight: bold; color: #4caf50;">Transforms into:</p>
              <p>Innovative integrated care model research opportunity</p>
            </div>
            <div style="flex: 1; min-width: 250px; background: #f5f5f5; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <h4 style="margin-top: 0;">Research Accommodation Gaps</h4>
              <p style="font-weight: bold; color: #4caf50;">Transforms into:</p>
              <p>Pioneering accessible research methodology development</p>
            </div>
            <div style="flex: 1; min-width: 250px; background: #f5f5f5; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <h4 style="margin-top: 0;">Crisis Response Failures</h4>
              <p style="font-weight: bold; color: #4caf50;">Transforms into:</p>
              <p>Revolutionary crisis intervention protocol design</p>
            </div>
          </div>
        </div>
        
        <div class="impact-section">
          <h3>Institutional ROI Analysis</h3>
          <div class="impact-chart-container" style="height: 300px;">
            <canvas id="roi-analysis-chart"></canvas>
          </div>
          <p class="chart-description">AdapTherm provides significant return on investment through retention improvement, reduced liability, and innovation benefits.</p>
        </div>
      </div>
    </div>
  `;
  
  // Show the overlay
  const overlay = document.getElementById('panel-overlay');
  if (overlay) overlay.style.display = 'block';
  
  // Show the impact panel
  impactPanel.style.display = 'block';
  
  // Create charts once panel is visible
  setTimeout(() => {
    createImpactCharts();
  }, 100);
}

// Function to switch between impact panel tabs
function switchImpactPanel(tabButton, panelName) {
  // Get all tabs and content elements
  const tabs = document.querySelectorAll('.impact-tab');
  const contents = document.querySelectorAll('.impact-content');
  
  // Remove active class from all tabs and contents
  tabs.forEach(tab => tab.classList.remove('active'));
  contents.forEach(content => content.classList.remove('active'));
  
  // Add active class to selected tab
  tabButton.classList.add('active');
  
  // Show selected content
  document.getElementById(`${panelName}-impact`).classList.add('active');
}

// Function to create impact visualization charts
function createImpactCharts() {
  // Create department impact chart
  const deptCtx = document.getElementById('departments-impact-chart');
  if (deptCtx) {
    new Chart(deptCtx, {
      type: 'radar',
      data: {
        labels: ['Healthcare', 'DRC', 'Academic', 'Grad School', 'Mental Health', 'OEO', 'Admin', 'ADA'],
        datasets: [{
          label: 'System Failures',
          data: [85, 75, 80, 70, 90, 65, 60, 75],
          fill: true,
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          borderColor: 'rgb(255, 99, 132)',
          pointBackgroundColor: 'rgb(255, 99, 132)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgb(255, 99, 132)'
        }, {
          label: 'Response Effectiveness',
          data: [15, 25, 20, 30, 10, 35, 40, 25],
          fill: true,
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgb(54, 162, 235)',
          pointBackgroundColor: 'rgb(54, 162, 235)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgb(54, 162, 235)'
        }]
      },
      options: {
        elements: {
          line: {
            borderWidth: 3
          }
        },
        scales: {
          r: {
            angleLines: {
              display: true
            },
            suggestedMin: 0,
            suggestedMax: 100
          }
        }
      }
    });
  }
  
  // Create success probability chart
  const successCtx = document.getElementById('success-probability-chart');
  if (successCtx) {
    new Chart(successCtx, {
      type: 'bar',
      data: {
        labels: ['Accommodation Implementation', 'Disability Recognition', 'Research Success', 'Graduation Probability', 'Mental Health Stability'],
        datasets: [{
          label: 'Current System',
          data: [28, 35, 20, 15, 25],
          backgroundColor: 'rgba(255, 99, 132, 0.5)',
          borderColor: 'rgb(255, 99, 132)',
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y',
        scales: {
          x: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Success Probability (%)'
            }
          }
        }
      }
    });
  }
  
  // Create impact timeline chart
  const timelineCtx = document.getElementById('impact-timeline-chart');
  if (timelineCtx) {
    new Chart(timelineCtx, {
      type: 'line',
      data: {
        labels: ['Jan 2023', 'Mar 2023', 'Jun 2023', 'Sep 2023', 'Jan 2024', 'Feb 2024', 'Jun 2024', 'Aug 2024', 'Dec 2024'],
        datasets: [{
          label: 'Cumulative Health Impact',
          data: [20, 30, 40, 65, 90, 95, 95, 95, 95],
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.1)',
          fill: true,
          tension: 0.4
        }, {
          label: 'Cumulative Academic Impact',
          data: [10, 15, 25, 40, 55, 85, 85, 90, 95],
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.1)',
          fill: true,
          tension: 0.4
        }, {
          label: 'Cumulative Financial Impact',
          data: [5, 10, 20, 35, 45, 80, 90, 90, 95],
          borderColor: 'rgb(255, 159, 64)',
          backgroundColor: 'rgba(255, 159, 64, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Impact Severity (%)'
            }
          }
        }
      }
    });
  }
  
  // Create AdapTherm comparison chart
  const adapthermCtx = document.getElementById('adaptherm-comparison-chart');
  if (adapthermCtx) {
    new Chart(adapthermCtx, {
      type: 'bar',
      data: {
        labels: ['Response Time (days)', 'Implementation Rate (%)', 'Coordination Efficiency (%)', 'Successful Resolutions (%)', 'Student Retention (%)'],
        datasets: [{
          label: 'Current System',
          data: [93, 28, 15, 25, 37],
          backgroundColor: 'rgba(255, 99, 132, 0.5)'
        }, {
          label: 'With AdapTherm',
          data: [14, 92, 85, 95, 93],
          backgroundColor: 'rgba(75, 192, 192, 0.5)'
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Performance Metrics'
            }
          }
        }
      }
    });
  }
  
  // Create process transformation chart
  const processCtx = document.getElementById('process-transformation-chart');
  if (processCtx) {
    new Chart(processCtx, {
      type: 'radar',
      data: {
        labels: ['Care Coordination', 'Response Time', 'Clear Responsibility', 'Communication Clarity', 'Implementation Rate', 'Follow-up Process'],
        datasets: [{
          label: 'Current System',
          data: [20, 15, 25, 30, 28, 10],
          fill: true,
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          borderColor: 'rgb(255, 99, 132)',
          pointBackgroundColor: 'rgb(255, 99, 132)',
          pointBorderColor: '#fff'
        }, {
          label: 'With AdapTherm',
          data: [90, 85, 95, 90, 92, 95],
          fill: true,
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgb(75, 192, 192)',
          pointBackgroundColor: 'rgb(75, 192, 192)',
          pointBorderColor: '#fff'
        }]
      },
      options: {
        elements: {
          line: {
            borderWidth: 3
          }
        },
        scales: {
          r: {
            angleLines: {
              display: true
            },
            suggestedMin: 0,
            suggestedMax: 100
          }
        }
      }
    });
  }
  
  // Create success outcomes chart
  const outcomesCtx = document.getElementById('success-outcomes-chart');
  if (outcomesCtx) {
    new Chart(outcomesCtx, {
      type: 'bar',
      data: {
        labels: ['Academic Completion', 'Research Innovation', 'Health Stability', 'Career Development', 'Knowledge Contribution'],
        datasets: [{
          label: 'Current System',
          data: [15, 20, 25, 10, 5],
          backgroundColor: 'rgba(255, 99, 132, 0.5)'
        }, {
          label: 'With AdapTherm',
          data: [95, 90, 85, 95, 90],
          backgroundColor: 'rgba(75, 192, 192, 0.5)'
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Success Probability (%)'
            }
          }
        }
      }
    });
  }
  
  // Create ROI analysis chart
  const roiCtx = document.getElementById('roi-analysis-chart');
  if (roiCtx) {
    new Chart(roiCtx, {
      type: 'doughnut',
      data: {
        labels: [
          'Reduced Legal Liability',
          'Improved Research Output',
          'Retention Benefits',
          'Innovation Outcomes',
          'Reputation Enhancement'
        ],
        datasets: [{
          label: 'ROI Breakdown',
          data: [35, 25, 20, 15, 5],
          backgroundColor: [
            'rgb(255, 99, 132)',
            'rgb(54, 162, 235)',
            'rgb(255, 205, 86)',
            'rgb(75, 192, 192)',
            'rgb(153, 102, 255)'
          ],
          hoverOffset: 4
        }]
      }
    });
  }
}

// Function to update emergency recommendations based on selected individual challenges
function updateIndividualRecommendations() {
  try {
    // Get active symptom buttons
    const activeButtons = document.querySelectorAll('.symptom-button.active');
    if (!activeButtons) return;
    
    // Get custom description
    const textarea = document.querySelector('.custom-description');
    if (!textarea) return;
    
    const customText = textarea.value.toLowerCase();
    
    // Array to collect unique interventions
    const interventions = new Set();
    
    // Add interventions from active buttons
    activeButtons.forEach(button => {
      if (button && button.dataset && button.dataset.system && 
          individualInterventionsBySystem && 
          individualInterventionsBySystem[button.dataset.system]) {
        
        individualInterventionsBySystem[button.dataset.system].forEach(intervention => {
          interventions.add(intervention);
        });
      }
    });
    
    // Simplified keyword map with everyday language
    const keywordMap = {
      // Healthcare related keywords
      "hospital": "healthcare", "doctor": "healthcare", "medical": "healthcare", 
      "diagnosis": "healthcare", "treatment": "healthcare", "seizure": "healthcare",
      "emergency": "healthcare", "medication": "healthcare", "pnes": "healthcare",
      "fnd": "healthcare", "neurological": "healthcare", "functional": "healthcare",
      
      // Accommodation related keywords
      "accommodation": "accommodation", "drc": "accommodation", "disability": "accommodation",
      "ada": "accommodation", "access": "accommodation", "barrier": "accommodation",
      "section 504": "accommodation", "modification": "accommodation",
      
      // Academic related keywords
      "professor": "academic", "advisor": "academic", "research": "academic",
      "lab": "academic", "course": "academic", "class": "academic", "department": "academic",
      "pi": "academic", "dgs": "academic", "assistantship": "academic", "termination": "academic",
      
      // Coordination related keywords
      "coordinate": "coordination", "refer": "coordination", "office": "coordination",
      "bureaucracy": "coordination", "paperwork": "coordination", "process": "coordination",
      "referral": "coordination", "silo": "coordination", "fragmented": "coordination",
      
      // Mental health related keywords
      "stress": "mental", "anxiety": "mental", "depression": "mental", 
      "suicide": "mental", "therapist": "mental", "counselor": "mental",
      "overwhelm": "mental", "crisis": "mental", "mdd": "mental", 
      "cptsd": "mental", "trauma": "mental", "ukcc": "mental",
      
      // Financial related keywords
      "money": "financial", "fund": "financial", "pay": "financial",
      "cost": "financial", "afford": "financial", "expense": "financial",
      "stipend": "financial", "tuition": "financial", "insurance": "financial",
      
      // International/visa related keywords
      "visa": "visa", "international": "visa", "foreign": "visa",
      "country": "visa", "immigrant": "visa", "status": "visa",
      "i-20": "visa", "sevis": "visa", "home": "visa"
    };
    
    if (individualInterventionsBySystem) {
      for (const [keyword, system] of Object.entries(keywordMap)) {
        if (customText.includes(keyword) && 
            individualInterventionsBySystem[system]) {
          
          individualInterventionsBySystem[system].forEach(intervention => {
            interventions.add(intervention);
          });
        }
      }
    }
    
    // Update the recommendations display
    const immediateList = document.getElementById('individual-immediate-interventions');
    if (!immediateList) return;
    
    // Clear previous recommendations
    immediateList.innerHTML = '';
    
    // Add new recommendations
    if (interventions.size > 0) {
      Array.from(interventions).forEach(intervention => {
        const li = document.createElement('li');
        
        // Add checkbox to recommendations for emergency panel
        li.innerHTML = `
          <div class="checkbox-recommendation">
            <input type="checkbox" id="${Math.random().toString(36).substring(7)}" class="recommendation-checkbox">
            <label>${intervention}</label>
          </div>
        `;
        
        immediateList.appendChild(li);
      });
      
      // Add Routes button if we have recommendations
      if (!immediateList.querySelector('.routes-btn')) {
        const routesBtn = document.createElement('button');
        routesBtn.className = 'routes-btn';
        routesBtn.textContent = 'Routes';
        routesBtn.onclick = function() {
          showRoutesMap();
        };
        immediateList.appendChild(routesBtn);
      }
    } else {
      const li = document.createElement('li');
      li.textContent = "Click a button above or describe what you're experiencing";
      immediateList.appendChild(li);
    }
  } catch (e) {
    console.log("Error updating recommendations:", e);
  }
}

// Function to generate routes map
function generateRoutesMap(categories) {
  const svg = document.getElementById('routes-map-svg');
  if (!svg) return;
  
  // Clear existing content
  svg.innerHTML = '';
  
  // Office locations and colors
  const offices = {
    'student': { x: 400, y: 350, color: '#2196F3', label: 'Student' },
    'healthcare': { x: 200, y: 100, color: '#F44336', label: 'Healthcare' },
    'accommodation': { x: 350, y: 50, color: '#FF9800', label: 'DRC' },
    'academic': { x: 500, y: 100, color: '#4CAF50', label: 'Academic Dept' },
    'coordination': { x: 650, y: 200, color: '#9C27B0', label: 'Ombud' },
    'mental': { x: 600, y: 300, color: '#2196F3', label: 'Mental Health' },
    'financial': { x: 200, y: 300, color: '#795548', label: 'Financial Aid' },
    'visa': { x: 150, y: 200, color: '#607D8B', label: 'Int\'l Office' }
  };
  
  // Add student node
  const studentNode = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  studentNode.setAttribute('cx', offices.student.x);
  studentNode.setAttribute('cy', offices.student.y);
  studentNode.setAttribute('r', '20');
  studentNode.setAttribute('fill', offices.student.color);
  svg.appendChild(studentNode);
  
  // Add student label
  const studentLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  studentLabel.setAttribute('x', offices.student.x);
  studentLabel.setAttribute('y', offices.student.y + 35);
  studentLabel.setAttribute('text-anchor', 'middle');
  studentLabel.setAttribute('fill', '#000');
  studentLabel.textContent = offices.student.label;
  svg.appendChild(studentLabel);
  
  // Add case manager node if multiple categories
  if (categories.length > 1) {
    const cmNode = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    cmNode.setAttribute('cx', 400);
    cmNode.setAttribute('cy', 200);
    cmNode.setAttribute('r', '25');
    cmNode.setAttribute('fill', '#673AB7');
    svg.appendChild(cmNode);
    
    // Add case manager label
    const cmLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    cmLabel.setAttribute('x', 400);
    cmLabel.setAttribute('y', 205);
    cmLabel.setAttribute('text-anchor', 'middle');
    cmLabel.setAttribute('fill', '#FFF');
    cmLabel.textContent = 'CM';
    svg.appendChild(cmLabel);
    
    // Connect student to case manager
    const cmPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    cmPath.setAttribute('d', `M${offices.student.x},${offices.student.y} L400,200`);
    cmPath.setAttribute('stroke', '#000');
    cmPath.setAttribute('stroke-width', '3');
    cmPath.setAttribute('stroke-dasharray', '5,5');
    cmPath.setAttribute('fill', 'none');
    cmPath.id = 'path-to-cm';
    svg.appendChild(cmPath);
  }
  
  // Add selected office nodes and connect them
  categories.forEach(category => {
    if (offices[category]) {
      // Add office node
      const officeNode = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      officeNode.setAttribute('cx', offices[category].x);
      officeNode.setAttribute('cy', offices[category].y);
      officeNode.setAttribute('r', '20');
      officeNode.setAttribute('fill', offices[category].color);
      svg.appendChild(officeNode);
      
      // Add office label
      const officeLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      officeLabel.setAttribute('x', offices[category].x);
      officeLabel.setAttribute('y', offices[category].y + 35);
      officeLabel.setAttribute('text-anchor', 'middle');
      officeLabel.setAttribute('fill', '#000');
      officeLabel.textContent = offices[category].label;
      svg.appendChild(officeLabel);
      
      // Connect to case manager or directly to student
      if (categories.length > 1) {
        // Connect to case manager
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M400,200 L${offices[category].x},${offices[category].y}`);
        path.setAttribute('stroke', '#000');
        path.setAttribute('stroke-width', '3');
        path.setAttribute('stroke-dasharray', '5,5');
        path.setAttribute('fill', 'none');
        path.id = `path-to-${category}`;
        svg.appendChild(path);
      } else {
        // Connect directly to student
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M${offices.student.x},${offices.student.y} L${offices[category].x},${offices[category].y}`);
        path.setAttribute('stroke', '#000');
        path.setAttribute('stroke-width', '3');
        path.setAttribute('stroke-dasharray', '5,5');
        path.setAttribute('fill', 'none');
        path.id = `path-to-${category}`;
        svg.appendChild(path);
      }
    }
  });
}

// Function to animate the routes
function animateRoutes() {
  // Animate the paths by changing dash array
  const paths = document.querySelectorAll('#routes-map-svg path');
  
  // Reset animations
  paths.forEach(path => {
    path.style.strokeDasharray = '5,5';
    path.style.animation = 'none';
  });
  
  // Apply animation to each path with delay
  paths.forEach((path, index) => {
    setTimeout(() => {
      path.style.stroke = '#4CAF50';
      path.style.strokeDasharray = '0,0';
      path.style.transition = 'stroke-dasharray 1.5s ease-in-out';
    }, index * 700);
  });
  
  // Add completion message after all animations
  setTimeout(() => {
    alert('Coordination route established! In a real implementation, this would notify all relevant offices and create a case management workflow.');
  }, (paths.length * 700) + 1000);
}

// Function to show the routes map
function showRoutesMap() {
  // Get selected recommendations
  const selectedCheckboxes = document.querySelectorAll('.recommendation-checkbox:checked');
  if (selectedCheckboxes.length === 0) {
    alert('Please select at least one recommendation to generate routes.');
    return;
  }
  
  // Create or get routes panel
  let routesPanel = document.getElementById('routes-panel');
  if (!routesPanel) {
    routesPanel = document.createElement('div');
    routesPanel.id = 'routes-panel';
    routesPanel.className = 'crisis-panel';
    document.body.appendChild(routesPanel);
  }
  
  // Get categories from selected recommendations
  const selectedCategories = new Set();
  selectedCheckboxes.forEach(checkbox => {
    const category = checkbox.closest('li')?.textContent.toLowerCase();
    
    // Try to determine category from the checkbox text
    if (category) {
      if (category.includes('healthcare') || category.includes('hospital') || category.includes('medical')) {
        selectedCategories.add('healthcare');
      } else if (category.includes('accommodation') || category.includes('drc')) {
        selectedCategories.add('accommodation');
      } else if (category.includes('academic') || category.includes('professor') || category.includes('advisor')) {
        selectedCategories.add('academic');
      } else if (category.includes('mental') || category.includes('therapy') || category.includes('counseling')) {
        selectedCategories.add('mental');
      } else if (category.includes('financial') || category.includes('money') || category.includes('fund')) {
        selectedCategories.add('financial');
      } else if (category.includes('visa') || category.includes('international')) {
        selectedCategories.add('visa');
      } else if (category.includes('coordinate') || category.includes('ombuds')) {
        selectedCategories.add('coordination');
      } else {
        // Default to coordination if we can't determine
        selectedCategories.add('coordination');
      }
    }
  });
  
  // Create the routes map
  routesPanel.innerHTML = `
    <div class="crisis-header">
      <h2 class="crisis-title">Institutional Navigation Routes</h2>
      <button class="close-panel" onclick="document.getElementById('routes-panel').style.display='none'; document.getElementById('panel-overlay').style.display='none';">&times;</button>
    </div>
    
    <div class="routes-content">
      <p>Below is the optimized path through ${selectedCheckboxes.length} selected actions across ${selectedCategories.size} university systems:</p>
      
      <div class="routes-map-container" style="height: 400px; margin: 20px 0;">
        <svg id="routes-map-svg" width="100%" height="100%" viewBox="0 0 800 400">
          <!-- SVG map will be dynamically generated -->
        </svg>
      </div>
      
      <div class="routes-metrics">
        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-value">${selectedCheckboxes.length}</div>
            <div class="metric-label">Total Actions</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">${selectedCategories.size}</div>
            <div class="metric-label">Departments Involved</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">${Math.min(21, selectedCheckboxes.length * 3)}</div>
            <div class="metric-label">Estimated Days</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">${Math.round(100 - (20 / (selectedCategories.size + 1)))}%</div>
            <div class="metric-label">Success Probability</div>
          </div>
        </div>
      </div>
      
      <button class="start-routes-btn" style="display: block; margin: 20px auto; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
        Start Coordination
      </button>
    </div>
  `;
  
  // Generate the SVG map
  generateRoutesMap([...selectedCategories]);
  
  // Add click handler for start button
  const startBtn = routesPanel.querySelector('.start-routes-btn');
  if (startBtn) {
    startBtn.onclick = function() {
      animateRoutes();
    };
  }
  
  // Show the panel
  const overlay = document.getElementById('panel-overlay');
  if (overlay) overlay.style.display = 'block';
  routesPanel.style.display = 'block';
}

// Function to close information panels
function closePanel(panelId) {
  const panel = document.getElementById(panelId);
  if (panel) panel.style.display = 'none';
  
  const overlay = document.getElementById('panel-overlay');
  if (overlay) overlay.style.display = 'none';
  
  // Reset panel expanded state
  if (panel) panel.classList.remove('panel-expanded');
  
  // Reset chart container expanded state if present
  const chartContainerId = panelId.replace('panel', 'chart-container');
  const chartContainer = document.getElementById(chartContainerId);
  if (chartContainer) {
    chartContainer.classList.remove('expanded');
  }
}

// Function to render hub trend chart
function renderHubTrendChart() {
  const canvas = document.getElementById('hubTrendChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (!ctx) return;
  
  // Check if chart already exists and destroy it
  if (window.hubChart) {
    window.hubChart.destroy();
  }
  
  // Create new chart with proper scales
  window.hubChart = new Chart(ctx, {
    type: 'line',
    data: hubTrendData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: false,
          min: -10,
          max: 10,
          title: {
            display: true,
            text: 'Position / Variability'
          }
        },
        y1: {
          position: 'right',
          beginAtZero: true,
          min: 0,
          max: 15,
          title: {
            display: true,
            text: 'Events'
          },
          grid: {
            drawOnChartArea: false
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'Stability Metrics Over Time'
        },
        legend: {
          position: 'top'
        }
      }
    }
  });
}

// Function to render section trend chart
function renderSectionTrendChart(sectionId) {
  const canvas = document.getElementById('sectionTrendChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (!ctx) return;
  
  const sectionData = sectionPerformanceData[sectionId];
  if (!sectionData) return;
  
  // Generate randomized but improving data for the demo
  const sectionScores = [
    sectionData.score - 1.8,
    sectionData.score - 1.5,
    sectionData.score - 1.2,
    sectionData.score - 0.8,
    sectionData.score - 0.3,
    sectionData.score
  ].map(score => Math.max(1, Math.min(10, score))); // Keep between 1-10
  
  const relatedShutdowns = [
    sectionData.events + 3,
    sectionData.events + 2,
    sectionData.events + 2,
    sectionData.events + 1,
    sectionData.events + 0,
    sectionData.events
  ].map(events => Math.max(0, events)); // Keep positive
  
  // Create data with the template
  const chartData = JSON.parse(JSON.stringify(sectionTrendDataTemplate));
  chartData.datasets[0].data = sectionScores;
  chartData.datasets[0].borderColor = sectionData.color;
  chartData.datasets[0].backgroundColor = sectionData.color + '33'; // Add transparency
  chartData.datasets[1].data = relatedShutdowns;
  
  // Check if chart already exists and destroy it
  if (window.sectionChart) {
    window.sectionChart.destroy();
  }
  
  // Create new chart with proper range
  window.sectionChart = new Chart(ctx, {
    type: 'line',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          min: 0,
          max: 10,
          title: {
            display: true,
            text: 'Score'
          }
        },
        y1: {
          position: 'right',
          beginAtZero: true,
          min: 0,
          max: relatedShutdowns.reduce((a, b) => Math.max(a, b), 0) + 1,
          title: {
            display: true,
            text: 'Events'
          },
          grid: {
            drawOnChartArea: false
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: sectionId.charAt(0).toUpperCase() + sectionId.slice(1) + ' System Progress'
        },
        legend: {
          position: 'top'
        }
      }
    }
  });
}

// ===== INITIALIZATION AND EVENT HANDLING =====

// Safe helper for adding event listeners
function safeAddEventListener(selector, event, callback) {
  const element = document.querySelector(selector);
  if (element) {
    element.addEventListener(event, callback);
    return true;
  }
  return false;
}

// Function to set up sliders
function setupSliders() {
  try {
    // Position gauge interaction
    const gauge = document.querySelector('.position-gauge');
    const marker = document.querySelector('.position-marker');
    const positionValue = document.getElementById('position-slider-value');
    const positionSlider = document.getElementById('position-slider');

    if (gauge && marker && positionValue && positionSlider) {
      // Make gauge clickable
      gauge.addEventListener('click', function(event) {
        const rect = gauge.getBoundingClientRect();
        const clickPosition = event.clientX - rect.left;
        const percentage = (clickPosition / rect.width) * 100;
        
        // Convert percentage to position value (-10 to +10)
        const position = Math.round(((percentage - 50) / 5));
        
        // Update marker position
        marker.style.left = `${percentage}%`;
        
        // Update position value and slider
        positionSlider.value = position;
        positionValue.textContent = position >= 0 ? `+${position}` : position;
        
        // Trigger visualization update
        updateHubVisualization(position, parseInt(document.getElementById('variability-slider').value));
      });
    }
    
    // Position slider
    const posSlider = document.getElementById('position-slider');
    if (posSlider) {
      posSlider.addEventListener('input', function() {
        const value = parseInt(this.value);
        const posValue = document.getElementById('position-slider-value');
        const posMarker = document.getElementById('position-marker');
        
        if (posValue) {
          posValue.textContent = value >= 0 ? `+${value}` : value;
        }
        
        if (posMarker) {
          const markerPos = 50 + (value * 5);
          posMarker.style.left = `${markerPos}%`;
        }
      });
    }
    
    // Variability slider
    const variabilitySlider = document.getElementById('variability-slider');
    const variabilitySliderValue = document.getElementById('variability-slider-value');
    
    if (variabilitySlider && variabilitySliderValue) {
      variabilitySlider.addEventListener('input', function() {
        variabilitySliderValue.textContent = `±${this.value}`;
      });
    }
    
    // Apply hub changes button
    safeAddEventListener('#apply-hub-changes', 'click', function() {
      // Get values from sliders
      const positionSlider = document.getElementById('position-slider');
      const variabilitySlider = document.getElementById('variability-slider');
      
      if (!positionSlider || !variabilitySlider) return;
      
      const position = parseInt(positionSlider.value);
      const variability = parseInt(variabilitySlider.value);
      
      // Update hub values
      const hubPosition = document.getElementById('individual-hub-position');
      const hubVariability = document.getElementById('individual-hub-variability');
      
      if (hubPosition) hubPosition.textContent = position >= 0 ? `+${position}` : position;
      if (hubVariability) hubVariability.textContent = `±${variability}`;
      
      // Update hub visualization
      updateHubVisualization(position, variability);
      
      // Update recommendations
      updateRecommendations(position, variability);
      
      // Close the panel automatically
      closePanel('hub-panel');
    });
    
    // Section slider
    const sectionSlider = document.getElementById('section-slider');
    const sectionSliderValue = document.getElementById('section-slider-value');
    
    if (sectionSlider && sectionSliderValue) {
      sectionSlider.addEventListener('input', function() {
        sectionSliderValue.textContent = parseFloat(this.value).toFixed(1);
      });
    }
    
    // Apply section changes button
    safeAddEventListener('#apply-section-changes', 'click', function() {
      // Verify we have current section
      if (!currentSection) return;
      
      // Get target score
      const sectionSlider = document.getElementById('section-slider');
      if (!sectionSlider) return;
      
      const targetScore = parseFloat(sectionSlider.value);
      
      // Update section score
      sectionPerformanceData[currentSection].score = targetScore;
      
      // Update section panel display
      const scoreElement = document.getElementById('section-score');
      if (scoreElement) {
        scoreElement.textContent = targetScore.toFixed(1);
      }
      
      // Call drawSensoryWheel to update the visualization
      drawSensoryWheel();
      
      // Close the panel automatically
      closePanel('section-panel');
    });
  } catch (e) {
    console.log("Error setting up sliders:", e);
  }
}

// Setup event counter for the hub
function setupEventCounter() {
  try {
    safeAddEventListener('#calculate-from-events', 'click', function() {
      const eventCount = document.getElementById('event-count');
      if (!eventCount) return;
      
      const count = parseInt(eventCount.value);
      
      // Calculate only variability based on event count
      let variability;
      
      if (count === 0) {
        variability = 2;
      } else if (count < 3) {
        variability = 4;
      } else if (count < 7) {
        variability = 6;
      } else if (count < 12) {
        variability = 8;
      } else {
        variability = 10;
      }
      
      // Update only variability slider and value
      const variabilitySlider = document.getElementById('variability-slider');
      const variabilitySliderValue = document.getElementById('variability-slider-value');
      
      if (variabilitySlider) variabilitySlider.value = variability;
      if (variabilitySliderValue) variabilitySliderValue.textContent = `±${variability}`;
      
      // Keep position as-is, only update variability
      const currentPosition = parseInt(document.getElementById('position-slider').value);
      
      // Update hub visualization
      updateHubVisualization(currentPosition, variability);
    });
  } catch (e) {
    console.log("Error setting up event counter:", e);
  }
}

// Function to toggle research references panel
function setupResearchReferences() {
  const referencesBtn = document.getElementById('research-references-btn');
  const referencesPanel = document.getElementById('research-panel');
  
  if (referencesBtn && referencesPanel) {
    referencesBtn.addEventListener('click', function() {
      if (referencesPanel.style.display === 'block') {
        referencesPanel.style.display = 'none';
        this.textContent = 'Research References ▼';
      } else {
        referencesPanel.style.display = 'block';
        this.textContent = 'Research References ▲';
      }
    });
  }
}

// Function to handle symptom button clicks
function setupSymptomButtons() {
  try {
    // Make sure buttons exist before trying to add event listeners
    const buttons = document.querySelectorAll('.symptom-button');
    if (buttons.length === 0) {
      console.log("No symptom buttons found, will try again after full load");
      return;
    }
    
    // Add toggle mode selector if it doesn't exist
    const emergencyPanel = document.querySelector('.emergency-panel');
    if (emergencyPanel && !document.getElementById('button-mode-toggle')) {
      const toggleDiv = document.createElement('div');
      toggleDiv.style.display = 'flex';
      toggleDiv.style.alignItems = 'center';
      toggleDiv.style.justifyContent = 'flex-end';
      toggleDiv.style.marginBottom = '10px';
      
      const toggleLabel = document.createElement('label');
      toggleLabel.htmlFor = 'button-mode-toggle';
      toggleLabel.style.marginRight = '10px';
      toggleLabel.style.fontSize = '14px';
      toggleLabel.style.color = 'white';
      toggleLabel.textContent = 'Toggle Mode:';
      
      const toggleSelect = document.createElement('select');
      toggleSelect.id = 'button-mode-toggle';
      toggleSelect.style.padding = '5px';
      toggleSelect.style.borderRadius = '4px';
      
      const multiOption = document.createElement('option');
      multiOption.value = 'multi';
      multiOption.textContent = 'Combine Issues';
      
      const singleOption = document.createElement('option');
      singleOption.value = 'single';
      singleOption.textContent = 'One Issue at a Time';
      
      toggleSelect.appendChild(multiOption);
      toggleSelect.appendChild(singleOption);
      
      toggleDiv.appendChild(toggleLabel);
      toggleDiv.appendChild(toggleSelect);
      
      // Insert before the symptom buttons
      const buttonContainer = document.querySelector('.symptom-buttons');
      if (buttonContainer) {
        buttonContainer.parentNode.insertBefore(toggleDiv, buttonContainer);
      }
    }
    
    buttons.forEach(button => {
      button.addEventListener('click', function() {
        // Check toggle mode
        const mode = document.getElementById('button-mode-toggle')?.value || 'multi';
        
        if (mode === 'single') {
          // Single selection mode - deselect others
          document.querySelectorAll('.symptom-button').forEach(btn => {
            btn.classList.remove('active');
          });
        }
        
        // Toggle active state
        this.classList.toggle('active');
        
        // Update recommendations based on selected symptoms
        updateIndividualRecommendations();
      });
    });
    
    // Set up text area listener with visual feedback
    const textarea = document.querySelector('.custom-description');
    if (!textarea) {
      console.log("Text area not found");
      return;
    }
    
    const typingIndicator = document.querySelector('.typing-indicator');
    let typingTimer;
    
    textarea.addEventListener('keyup', function() {
      // Show typing indicator
      if (typingIndicator) {
        typingIndicator.classList.add('visible');
        typingIndicator.textContent = "Analyzing your situation...";
      }
      
      clearTimeout(typingTimer);
      typingTimer = setTimeout(function() {
        // Update recommendations when typing stops
        updateIndividualRecommendations();
        
        // Update typing indicator
        if (typingIndicator) {
          if (textarea.value.trim() !== '') {
            typingIndicator.textContent = "Analysis complete";
            setTimeout(() => {
              typingIndicator.classList.remove('visible');
            }, 1500);
          } else {
            typingIndicator.classList.remove('visible');
          }
        }
      }, 1000);
    });
  } catch (error) {
    console.log("Error setting up symptom buttons:", error);
  }
}

// Function to enhance individual hub information
function setupIndividualHub() {
  // Make hub clickable to show info panel
  const hubCircle = document.getElementById('individual-hub-circle');
  if (hubCircle) {
    hubCircle.addEventListener('click', showIndividualHubInfo);
  }
  
  const hubBorder = document.getElementById('individual-hub-border');
  if (hubBorder) {
    hubBorder.addEventListener('click', showIndividualHubInfo);
  }
}

// Function to enhance sections and spokes
function setupSectionsAndSpokes() {
  // Make sections clickable
  document.querySelectorAll('.section-path').forEach(section => {
    section.addEventListener('click', function() {
      const sectionId = this.getAttribute('data-section');
      if (sectionId) {
        showSectionInfo(sectionId);
      }
    });
  });
  
  // Make spokes clickable
  document.querySelectorAll('.spoke-clickable-area').forEach(spoke => {
    spoke.addEventListener('click', function() {
      const spokeId = this.parentNode.id.replace('-spoke-group', '');
      if (spokeId) {
        showIndividualSpokeInfo(spokeId);
      }
    });
  });
}

// Function to enhance breakthrough lines
function setupBreakthroughLines() {
  // Make breakthrough lines clickable
  document.querySelectorAll('.breakthrough-line').forEach(line => {
    line.addEventListener('click', function() {
      const crisisId = this.getAttribute('data-crisis');
      if (crisisId) {
        showBreakthroughInfo(crisisId);
      }
    });
  });
}

// Modify the addSubmitChallengeButton function
function addSubmitChallengeButton() {
  // Target the hub panel
  const hubPanel = document.getElementById('hub-panel');
  if (!hubPanel) return;
  
  // Check if the button already exists
  if (hubPanel.querySelector('.submit-challenge-btn')) return;
  
  // Find the "Apply Changes" button
  const applyChangesBtn = hubPanel.querySelector('.apply-changes');
  if (!applyChangesBtn) return;
  
  // Create Submit Challenge button
  const challengeBtn = document.createElement('button');
  challengeBtn.className = 'submit-challenge-btn';
  challengeBtn.textContent = 'Submit Challenge';
  challengeBtn.style.padding = '10px 20px';
  challengeBtn.style.backgroundColor = '#f44336';
  challengeBtn.style.color = 'white';
  challengeBtn.style.border = 'none';
  challengeBtn.style.borderRadius = '4px';
  challengeBtn.style.cursor = 'pointer';
  challengeBtn.style.marginTop = '15px'; // Add margin to separate from Apply Changes
  challengeBtn.style.display = 'block';
  challengeBtn.style.width = '100%';
  
  // Add click functionality
  challengeBtn.onclick = function() {
    submitChallenge();
  };
  
  // Insert AFTER Apply Changes button
  applyChangesBtn.parentNode.insertBefore(challengeBtn, applyChangesBtn.nextSibling);
}

// Modified submitChallenge function to combine Submit and Find Routes
function submitChallenge() {
  const challengeForm = document.createElement('div');
  challengeForm.style.padding = '15px';
  challengeForm.style.backgroundColor = '#f8f9fa';
  challengeForm.style.border = '1px solid #dee2e6';
  challengeForm.style.borderRadius = '5px';
  challengeForm.style.marginBottom = '15px';
  
  // Remove the classification dropdown and keep just the text area
  challengeForm.innerHTML = `
    <h4 style="margin-top: 0;">Submit Institutional Challenge</h4>
    <p>Document specific barriers or challenges you're experiencing in the university:</p>
    <textarea id="challenge-description" placeholder="Describe the challenges in detail..." style="width: 100%; padding: 8px; height: 120px; margin-bottom: 10px;"></textarea>
    <div style="display: flex; justify-content: space-between;">
      <button id="cancel-challenge" style="padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
      <button id="submit-challenge-form" style="padding: 8px 15px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Submit</button>
    </div>
  `;
  
  // Get the hub panel
  const hubPanel = document.getElementById('hub-panel');
  if (!hubPanel) return;
  
  // Find submit button
  const submitButton = hubPanel.querySelector('.submit-challenge-btn');
  if (!submitButton) return;
  
  // Insert the form after the button
  submitButton.parentNode.insertBefore(challengeForm, submitButton.nextSibling);
  
  // Hide the submit button while form is open
  submitButton.style.display = 'none';
  
  // Add event listeners to form buttons
  document.getElementById('cancel-challenge').addEventListener('click', function() {
    challengeForm.remove();
    submitButton.style.display = 'block';
  });
  
document.getElementById('submit-challenge-form').addEventListener('click', function() {
  const description = document.getElementById('challenge-description').value.trim();
  
  if (!description) {
    alert('Please provide a description of your challenges.');
    return;
  }
  
  // Identify departments based on keywords in the text
  const departments = identifyDepartmentsFromText(description);
  
  // Show routes if departments were identified
  if (departments.length > 0) {
    showRoutesMapForChallenge(departments);
  } else {
    // Only show alert if no departments were found
    alert('No specific departments were identified in your description. A case manager will review your submission.');
  }
  
  // Remove form and show button again
  challengeForm.remove();
  submitButton.style.display = 'block';
});
}

// Function to identify departments from challenge text
function identifyDepartmentsFromText(text) {
  text = text.toLowerCase();
  const departments = [];
  
  // Keywords mapped to department categories
  const keywordMap = {
    'healthcare': ['health', 'medical', 'doctor', 'hospital', 'nurse', 'treatment', 'diagnosis', 'fnd', 'pnes', 'seizure'],
    'accommodation': ['drc', 'disability', 'accommodation', 'ada', 'section 504', 'reasonable', 'access'],
    'academic': ['professor', 'advisor', 'department', 'class', 'course', 'research', 'pi', 'lab', 'faculty'],
    'gradschool': ['graduate', 'grad school', 'phd', 'masters', 'thesis', 'dissertation', 'committee', 'dgs'],
    'mentalhealth': ['mental', 'counseling', 'therapy', 'psychologist', 'psychiatrist', 'depression', 'anxiety', 'stress'],
    'oeo': ['equal opportunity', 'discrimination', 'harassment', 'investigation', 'complaint', 'oeo', 'title ix'],
    'admin': ['administration', 'dean', 'chair', 'ombuds', 'ombud', 'policy', 'procedure', 'appeal'],
    'visa': ['international', 'visa', 'i-20', 'sevis', 'foreign', 'immigration', 'country'],
    'financial': ['money', 'funding', 'financial', 'payment', 'stipend', 'loan', 'scholarship', 'cost']
  };
  
  // Check for keywords
  for (const [dept, keywords] of Object.entries(keywordMap)) {
    for (const keyword of keywords) {
      if (text.includes(keyword)) {
        departments.push(dept);
        break; // Only add department once
      }
    }
  }
  
  return departments;
}

// Function to show routes for challenge
function showRoutesMapForChallenge(departments) {
  // Create or get routes panel
  let routesPanel = document.getElementById('routes-panel');
  if (!routesPanel) {
    routesPanel = document.createElement('div');
    routesPanel.id = 'routes-panel';
    routesPanel.className = 'crisis-panel';
    document.body.appendChild(routesPanel);
  }
  
  // Create the routes map
  routesPanel.innerHTML = `
    <div class="crisis-header">
      <h2 class="crisis-title">Challenge Resolution Routes</h2>
      <button class="close-panel" onclick="document.getElementById('routes-panel').style.display='none'; document.getElementById('panel-overlay').style.display='none';">&times;</button>
    </div>
    
    <div class="routes-content">
      <p>Here is the optimal resolution pathway through ${departments.length} institutional systems for your challenge:</p>
      
      <div class="routes-map-container" style="height: 400px; margin: 20px 0;">
        <svg id="routes-map-svg" width="100%" height="100%" viewBox="0 0 800 400">
          <!-- SVG map will be dynamically generated -->
        </svg>
      </div>
      
      <div class="routes-metrics">
        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-value">${departments.length}</div>
            <div class="metric-label">Departments Involved</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">${Math.min(21, departments.length * 5)}</div>
            <div class="metric-label">Estimated Days</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">${Math.round(100 - (20 / (departments.length + 1)))}%</div>
            <div class="metric-label">Success Probability</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">${departments.length > 1 ? 'Required' : 'Optional'}</div>
            <div class="metric-label">Case Management</div>
          </div>
        </div>
      </div>
      
      <button class="start-routes-btn" style="display: block; margin: 20px auto; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
        Start Coordination
      </button>
    </div>
  `;
  
  // Generate the SVG map
  generateRoutesMap(departments);
  
  // Add click handler for start button
  const startBtn = routesPanel.querySelector('.start-routes-btn');
  if (startBtn) {
    startBtn.onclick = function() {
      animateRoutes();
    };
  }
  
  // Show the panel
  const overlay = document.getElementById('panel-overlay');
  if (overlay) overlay.style.display = 'block';
  routesPanel.style.display = 'block';
}

// Function to initialize the individual tab
function initializeIndividualTab() {
  try {
    // Draw the wheel with correct colors and breakthrough lines
    drawSensoryWheel();
    
    // Set up the submit challenge button for the hub panel
    addSubmitChallengeButton();

    // Set up symptom buttons for individual tab
    setupSymptomButtons();
    
    // Set up sliders and interactive elements
    setupSliders();
    
    // Set up event counter
    setupEventCounter();
    
    // Set up research references toggle
    setupResearchReferences();
    updateResearchPanel();

    // Set up interactive hub
    setupIndividualHub();
    
    // Set up sections and spokes
    setupSectionsAndSpokes();
    
    // Set up breakthrough lines
    setupBreakthroughLines();
    
    // Set up panel overlay click to close
    const panelOverlay = document.getElementById('panel-overlay');
    if (panelOverlay) {
      panelOverlay.addEventListener('click', function(e) {
        // Only close if clicking directly on the overlay (not on panels)
        if (e.target === this) {
          const panels = document.querySelectorAll('.info-panel, .crisis-panel');
          panels.forEach(panel => {
            panel.style.display = 'none';
          });
          this.style.display = 'none';
        }
      });
    }
    
    // Initial update of recommendations
    const position = parseInt(document.getElementById('individual-hub-position')?.textContent || '-4');
    const variability = parseInt(document.getElementById('individual-hub-variability')?.textContent.replace('±', '') || '8');
    updateRecommendations(position, variability);
    
  } catch (error) {
    console.log("Error during initialization:", error);
  }
}

// Call initialization when the document is fully loaded
document.addEventListener('DOMContentLoaded', initializeIndividualTab);

// Fix for research references panel issue
function initializeResearchPanel() {
  // Find or create the research panel
  let researchPanel = document.getElementById('individual-research-panel');
  if (!researchPanel) {
    researchPanel = document.createElement('div');
    researchPanel.id = 'individual-research-panel';
    researchPanel.className = 'research-panel';
    researchPanel.style.display = 'none';
    
    // Add to individual tab
    const individualTab = document.getElementById('individual');
    if (individualTab) {
      individualTab.appendChild(researchPanel);
    }
  }
  
  // Create the research button if it doesn't exist
  let researchBtn = document.getElementById('individual-research-btn');
  if (!researchBtn) {
    researchBtn = document.createElement('button');
    researchBtn.id = 'individual-research-btn';
    researchBtn.className = 'research-references-btn';
    researchBtn.textContent = 'References ▼';
    
    // Add click handler
    researchBtn.addEventListener('click', function() {
      if (researchPanel.style.display === 'block') {
        researchPanel.style.display = 'none';
        this.textContent = 'References ▼';
      } else {
        researchPanel.style.display = 'block';
        this.textContent = 'References ▲';
      }
    });
    
    // Add to individual tab
    const individualTab = document.getElementById('individual');
    if (individualTab) {
      individualTab.appendChild(researchBtn);
    }
  }
  
  // Update content of research panel
  updateResearchPanel();
}

// Call this in initializeIndividualTab function
// Add this line at the end of initializeIndividualTab():
initializeResearchPanel();

// Make sure the individual tab is displayed by default
document.addEventListener('DOMContentLoaded', function() {
  const individualTab = document.getElementById('individual');
  if (individualTab) {
    individualTab.style.display = 'block';
    individualTab.classList.add('active');
  }
});

// Function to ensure the "My Story" content is preserved in the research panel
function updateResearchPanel() {
  const researchPanel = document.getElementById('individual-research-panel');
  if (!researchPanel) return;
  
  researchPanel.innerHTML = `
    <h4>My Journey Through the Institution</h4>
    
    <p><strong>I: Initial Crisis (January 2023 - Diagnosis)</strong><br>
    When you grow up watching gas flares turn night into toxic day in Nigeria's Niger Delta, you
    learn early that systems meant to bring light can destroy life. Regardless, you also learn
    something more powerful, how communities innovate to thrive despite systemic barriers. I am
    Chiziterem Onyenekwe, and my journey from setting the highest academic record in my
    Nigerian university department's history to fighting for disability rights at the University of
    Kentucky isn't just about institutional failure. It's about transforming systemic violence into
    revolutionary change.</p>
    
    <p>I arrived at Kentucky's Biomedical Engineering PhD program already fluent in adaptation,
    daughter of a Biafran war veteran, graduate of a nation where scarcity breeds innovation,
    international scholar selected by EducationUSA. Maintaining a 3.9 GPA while navigating
    American academia showcased not just excellence, but resilience. I didn't know then that my
    intersectional identity as an African, international and disabled woman in STEM would soon
    collide with systemic discrimination in ways that would both endanger and transform me.</p>
    
    <p><strong>II: Healthcare Fragmentation (September 2023 Suicide attempt)</strong><br>
    I did not know what to do, I could not even afford $50 dollar a session especially when FND
    means no knowledge or cure guarantee. My friend encouraged me, and I found an external
    therapist who took me on charity. She confirmed that I was Autistic and being undiagnosed
    contributed to cPTSD and FND exacerbation.</p>
    
    <p>What followed was my final initiation into the reality behind the illusion of care and support. I was stripped into a hospital gown at Good Samaritan Hospital, then handcuffed and transported by sheriffs to Eastern State Hospital in the middle of the night. I looked out the window as I wondered how on earth, I had gotten to this point of being taken like a criminal to an unfamiliar location in a foreign country.</p>
    
    <p><strong>III: Academic Impact (Fall 2023 - Spring 2024)</strong><br>
    It was at this time I realized and accepted that I needed to register with the DRC to get academic
    support. I registered with the Disability Resource Center (DRC) in fall 2023 to obtain academic accommodations. 
    Despite registering with the Disability Resource Center, I discovered that being a disabled
    graduate student meant navigating another endless maze of fragmented offices. Accommodation
    meant having to use my limited capacity to coordinate offices to get some flexibility which ends
    up being spent on coordinating.</p>
    
    <p>In February 2024, my PI ended my research assistantship without any
    official accommodation deliberation. I would be paid till June "and afterwards?", I asked my PI
    and he said "I don't know". The
    Director of Graduate Studies (DGS) came in later in May 2024, and they both told me that a
    master's was the best option I had. They both had no interest in cooperating with me to find a
    way to get what I came for, I was not asked what I wanted. My PI was done with me, my DGS
    couldn't care less, the message was clear: get out, PhD research in UKY is no place for people
    like you.</p>
    
    <p><strong>IV: Institutional Response (2024-2025)</strong><br>
    As I looked around the institution for any form of help because the DGS claimed he could not
    approve my fellowship and I had no assistantship or any idea of exactly how I was capable, a
    concerned staff triggered an investigation with the Office of Equal Opportunity. Here is how the deflection merry-go-round began...</p>
    
    <p>The so-called investigation continued without regard for protection and supporting of the student
    who was potentially being discriminated against. Like a police investigation with the prime
    witness left to roam around in the same neighborhood of the crime; very trustworthy according
    to UKY standards.</p>
    
    <p>As you can imagine, it felt like hearing echoes of my voice in a drum after being told I could find
    water there. The ADA Compliance Office refused to implement DRC compliance and asked me
    to report the same problem in the same breath, another dead end.</p>
    
    <p><strong>V: CONCLUSION</strong><br>
    University of Kentucky almost killed me, but I am still here fighting for everyone who believes
    in me and themselves, that everyone's potential should not be abandoned in light of their
    struggles. Struggles are what makes us human and brings the best out of us. I am here now
    saying I will do my PhD research to design products for acute recovery from dissociative or
    shutdown states in emergency situations, sediment the answers to the why and how of FND and
    co-occurring conditions, and most importantly, leave a legacy on which no other disabled
    graduate student would ever have to suffer like I did because of institutional fragmentation and
    neglect.</p>
  `;
}
  </script>
</body>
</html>